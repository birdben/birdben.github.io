<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>birdben</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="birdben">
<meta property="og:url" content="https://github.com/birdben/page/2/index.html">
<meta property="og:site_name" content="birdben">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="birdben">
  
    <link rel="alternative" href="/atom.xml" title="birdben" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260188951'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260188951' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/logo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">birdben</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AWK/" style="font-size: 10.83px;">AWK</a> <a href="/tags/Akka/" style="font-size: 10.83px;">Akka</a> <a href="/tags/Dockerfile/" style="font-size: 20px;">Dockerfile</a> <a href="/tags/Docker命令/" style="font-size: 19.17px;">Docker命令</a> <a href="/tags/Docker环境/" style="font-size: 15px;">Docker环境</a> <a href="/tags/ELK/" style="font-size: 16.67px;">ELK</a> <a href="/tags/ElasticSearch/" style="font-size: 10.83px;">ElasticSearch</a> <a href="/tags/Elasticsearch/" style="font-size: 12.5px;">Elasticsearch</a> <a href="/tags/Flume/" style="font-size: 17.5px;">Flume</a> <a href="/tags/Git命令/" style="font-size: 13.33px;">Git命令</a> <a href="/tags/Go/" style="font-size: 14.17px;">Go</a> <a href="/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/tags/HDFS/" style="font-size: 18.33px;">HDFS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Hadoop原理架构体系/" style="font-size: 13.33px;">Hadoop原理架构体系</a> <a href="/tags/Hive/" style="font-size: 16.67px;">Hive</a> <a href="/tags/JVM/" style="font-size: 11.67px;">JVM</a> <a href="/tags/Java-Web，Socket，Python/" style="font-size: 10px;">Java Web，Socket，Python</a> <a href="/tags/Jenkins环境/" style="font-size: 10px;">Jenkins环境</a> <a href="/tags/Kafka/" style="font-size: 15.83px;">Kafka</a> <a href="/tags/Kibana/" style="font-size: 14.17px;">Kibana</a> <a href="/tags/Linux命令/" style="font-size: 12.5px;">Linux命令</a> <a href="/tags/Logstash/" style="font-size: 15.83px;">Logstash</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/MapReduce/" style="font-size: 11.67px;">MapReduce</a> <a href="/tags/Maven配置/" style="font-size: 11.67px;">Maven配置</a> <a href="/tags/MongoDB/" style="font-size: 11.67px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shadowsocks/" style="font-size: 10px;">Shadowsocks</a> <a href="/tags/Shell/" style="font-size: 16.67px;">Shell</a> <a href="/tags/Spring/" style="font-size: 10.83px;">Spring</a> <a href="/tags/Storm/" style="font-size: 12.5px;">Storm</a> <a href="/tags/Zookeeper/" style="font-size: 12.5px;">Zookeeper</a> <a href="/tags/其他/" style="font-size: 10px;">其他</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/birdben">我的CSDN的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">birdben</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/logo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">birdben</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-JVM/JVM常用命令学习（二）jstat的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/09/JVM/JVM常用命令学习（二）jstat的使用/" class="article-date">
  	<time datetime="2017-02-09T15:18:01.000Z" itemprop="datePublished">2017-02-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/09/JVM/JVM常用命令学习（二）jstat的使用/">JVM常用命令学习（二）jstat的使用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Java环境说明"><a href="#Java环境说明" class="headerlink" title="Java环境说明"></a>Java环境说明</h3><p>注意：不同版本的JDK可能略有差异</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ java -version</div><div class="line">java version &quot;1.7.0_79&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.7.0_79-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.79-b02, mixed mode)</div></pre></td></tr></table></figure>
<h3 id="jstat命令"><a href="#jstat命令" class="headerlink" title="jstat命令"></a>jstat命令</h3><p>jstat(Java Virtual Machine Statistics Monitoring Tool)。jstat用于监控基于HotSpot的JVM，对其堆的使用情况进行实时的命令行的统计，使用jstat我们可以对指定的JVM做如下监控：</p>
<ul>
<li>类的加载及卸载情况</li>
<li>查看新生代、老生代及持久代的容量及使用情况</li>
<li>查看新生代、老生代及持久代的垃圾收集情况，包括垃圾回收的次数及垃圾回收所占用的时间</li>
<li>查看新生代中Eden区及Survior区中容量及分配情况等</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ jstat -help</div><div class="line">Usage: jstat -help|-options</div><div class="line">       jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]</div><div class="line"></div><div class="line">Definitions:</div><div class="line">  &lt;option&gt;      An option reported by the -options option</div><div class="line">  &lt;vmid&gt;        Virtual Machine Identifier. A vmid takes the following form:</div><div class="line">                     &lt;lvmid&gt;[@&lt;hostname&gt;[:&lt;port&gt;]]</div><div class="line">                Where &lt;lvmid&gt; is the local vm identifier for the target</div><div class="line">                Java virtual machine, typically a process id; &lt;hostname&gt; is</div><div class="line">                the name of the host running the target Java virtual machine;</div><div class="line">                and &lt;port&gt; is the port number for the rmiregistry on the</div><div class="line">                target host. See the jvmstat documentation for a more complete</div><div class="line">                description of the Virtual Machine Identifier.</div><div class="line">  &lt;lines&gt;       Number of samples between header lines.</div><div class="line">  &lt;interval&gt;    Sampling interval. The following forms are allowed:</div><div class="line">                    &lt;n&gt;[&quot;ms&quot;|&quot;s&quot;]</div><div class="line">                Where &lt;n&gt; is an integer and the suffix specifies the units as </div><div class="line">                milliseconds(&quot;ms&quot;) or seconds(&quot;s&quot;). The default units are &quot;ms&quot;.</div><div class="line">  &lt;count&gt;       Number of samples to take before terminating.</div><div class="line">  -J&lt;flag&gt;      Pass &lt;flag&gt; directly to the runtime system.</div></pre></td></tr></table></figure>
<p>通过help提示可以看出基本的命令格式</p>
<ul>
<li>jstat [option] : 根据jstat统计的维度不同，可以使用如下表中的选项进行不同维度的统计</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[option]参数：</div><div class="line"></div><div class="line">- class : 用于查看类加载情况的统计</div><div class="line">- compiler : 用于查看HotSpot中即时编译器编译情况的统计</div><div class="line">- gc : 用于查看JVM中堆的垃圾收集情况的统计</div><div class="line">- gccapacity : 用于查看新生代、老生代及持久代的存储容量情况</div><div class="line">- gccause : 用于查看垃圾收集的统计情况（这个和-gcutil选项一样），如果有发生垃圾收集，它还会显示最后一次及当前正在发生垃圾收集的原因。</div><div class="line">- gcnew : 用于查看新生代垃圾收集的情况</div><div class="line">- gcnewcapacity : 用于查看新生代的存储容量情况</div><div class="line">- gcold : 用于查看老生代及持久代发生GC的情况</div><div class="line">- gcoldcapacity : 用于查看老生代的容量</div><div class="line">- gcpermcapacity : 用于查看持久代的容量</div><div class="line">- gcutil : 用于查看新生代、老生代及持代垃圾收集的情况</div><div class="line">- printcompilation : HotSpot编译方法的统计</div><div class="line"></div><div class="line">- h n : 用于指定每隔几行就输出列头，如果不指定，默认是只在第一行出现列头。</div><div class="line">- J javaOption : 用于将给定的javaOption传给java应用程序加载器，例如，“-J-Xms48m”将把启动内存设置为48M。如果想查看可以传递哪些选项到应用程序加载器中</div><div class="line">- t n : 用于在输出内容的第一列显示时间戳，这个时间戳代表的时JVM开始启动到现在的时间（注：在IBM JDK5中是没有这个选项的）。</div><div class="line">- vmid : VM的进程号，即当前运行的java进程号。</div><div class="line"></div><div class="line">- interval : 间隔时间，单位可以是秒或者毫秒，通过指定s或ms确定，默认单位为毫秒。</div><div class="line">- count : 打印次数，如果缺省则打印无数次。</div></pre></td></tr></table></figure>
<p>-class : 类加载情况的统计</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Loaded</td>
<td>加载了的类的数量</td>
</tr>
<tr>
<td>Bytes</td>
<td>加载了的类的大小，单为Kb</td>
</tr>
<tr>
<td>Unloaded</td>
<td>卸载了的类的数量</td>
</tr>
<tr>
<td>Bytes</td>
<td>卸载了的类的大小，单为Kb</td>
</tr>
<tr>
<td>Time</td>
<td>花在类的加载及卸载的时间</td>
</tr>
</tbody>
</table>
<p>-compiler : HotSpot中即时编译器编译情况的统计</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compiled</td>
<td>编译任务执行的次数</td>
</tr>
<tr>
<td>Failed</td>
<td>编译任务执行失败的次数</td>
</tr>
<tr>
<td>Invalid</td>
<td>编译任务非法执行的次数</td>
</tr>
<tr>
<td>Time</td>
<td>执行编译花费的时间</td>
</tr>
<tr>
<td>FailedType</td>
<td>最后一次编译失败的编译类型</td>
</tr>
<tr>
<td>FailedMethod</td>
<td>最后一次编译失败的类名及方法名</td>
</tr>
</tbody>
</table>
<p>-gc : JVM中堆的垃圾收集情况的统计</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0C</td>
<td>新生代中Survivor space中S0当前容量的大小（KB）</td>
</tr>
<tr>
<td>S1C</td>
<td>新生代中Survivor space中S1当前容量的大小（KB）</td>
</tr>
<tr>
<td>S0U</td>
<td>新生代中Survivor space中S0容量使用的大小（KB）</td>
</tr>
<tr>
<td>S1U</td>
<td>新生代中Survivor space中S1容量使用的大小（KB）</td>
</tr>
<tr>
<td>EC</td>
<td>Eden space当前容量的大小（KB）</td>
</tr>
<tr>
<td>EU</td>
<td>Eden space容量使用的大小（KB）</td>
</tr>
<tr>
<td>OC</td>
<td>Old space当前容量的大小（KB）</td>
</tr>
<tr>
<td>OU</td>
<td>Old space使用容量的大小（KB）</td>
</tr>
<tr>
<td>PC</td>
<td>Permanent space当前容量的大小（KB）</td>
</tr>
<tr>
<td>PU</td>
<td>Permanent space使用容量的大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>从应用程序启动到采样时 Young GC 所用的时间(秒)</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时 Full GC 所用的时间(秒)</td>
</tr>
<tr>
<td>GCT    T</td>
<td>从应用程序启动到采样时用于垃圾回收的总时间(单位秒)，它的值等于YGC+FGC</td>
</tr>
</tbody>
</table>
<p>-gccapacity : 新生代、老生代及持久代的存储容量情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>NGCMN</td>
<td>新生代的最小容量大小（KB）</td>
</tr>
<tr>
<td>NGCMX</td>
<td>新生代的最大容量大小（KB）</td>
</tr>
<tr>
<td>NGC</td>
<td>当前新生代的容量大小（KB）</td>
</tr>
<tr>
<td>S0C</td>
<td>当前新生代中survivor space 0的容量大小（KB）</td>
</tr>
<tr>
<td>S1C</td>
<td>当前新生代中survivor space 1的容量大小（KB）</td>
</tr>
<tr>
<td>EC</td>
<td>Eden space当前容量的大小（KB）</td>
</tr>
<tr>
<td>OGCMN</td>
<td>老生代的最小容量大小（KB）</td>
</tr>
<tr>
<td>OGCMX</td>
<td>老生代的最大容量大小（KB）</td>
</tr>
<tr>
<td>OGC</td>
<td>当前老生代的容量大小（KB）</td>
</tr>
<tr>
<td>OC</td>
<td>当前老生代的空间容量大小（KB）</td>
</tr>
<tr>
<td>PGCMN</td>
<td>持久代的最小容量大小（KB）</td>
</tr>
<tr>
<td>PGCMX</td>
<td>持久代的最大容量大小（KB）</td>
</tr>
<tr>
<td>PGC</td>
<td>当前持久代的容量大小（KB）</td>
</tr>
<tr>
<td>PC</td>
<td>当前持久代的空间容量大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
</tbody>
</table>
<p>-gccause : 用于查看垃圾收集的统计情况，包括最近发生垃圾的原因</p>
<p>这个选项用于查看垃圾收集的统计情况（这个和-gcutil选项一样），如果有发生垃圾收集，它还会显示最后一次及当前正在发生垃圾收集的原因，它比-gcutil会多出最后一次垃圾收集原因以及当前正在发生的垃圾收集的原因。</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>LGCC</td>
<td>最后一次垃圾收集的原因，可能为“unknown GCCause”、“System.gc()”等</td>
</tr>
<tr>
<td>GCC</td>
<td>当前垃圾收集的原因</td>
</tr>
</tbody>
</table>
<p>-gcnew : 新生代垃圾收集的情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0C</td>
<td>当前新生代中survivor space 0的容量大小（KB）</td>
</tr>
<tr>
<td>S1C</td>
<td>当前新生代中survivor space 1的容量大小（KB）</td>
</tr>
<tr>
<td>S0U</td>
<td>S0已经使用的大小（KB）</td>
</tr>
<tr>
<td>S1U</td>
<td>S1已经使用的大小（KB）</td>
</tr>
<tr>
<td>TT</td>
<td>Tenuring threshold，要了解这个参数，我们需要了解一点Java内存对象的结构，在Sun JVM中，（除了数组之外的）对象都有两个机器字（words）的头部。第一个字中包含这个对象的标示哈希码以及其他一些类似锁状态和等标识信息，第二个字中包含一个指向对象的类的引用，其中第二个字节就会被垃圾收集算法使用到。在新生代中做垃圾收集的时候，每次复制一个对象后，将增加这个对象的收集计数，当一个对象在新生代中被复制了一定次数后，该算法即判定该对象是长周期的对象，把他移动到老生代，这个阈值叫着tenuring threshold。这个阈值用于表示某个/些在执行批定次数youngGC后还活着的对象，即使此时新生的的Survior没有满，也同样被认为是长周期对象，将会被移到老生代中。</td>
</tr>
<tr>
<td>MTT</td>
<td>Maximum tenuring threshold，用于表示TT的最大值。</td>
</tr>
<tr>
<td>DSS</td>
<td>Desired survivor size (KB).可以参与这里：<a href="http://blog.csdn.net/yangjun2/article/details/6542357" target="_blank" rel="external">http://blog.csdn.net/yangjun2/article/details/6542357</a></td>
</tr>
<tr>
<td>EC</td>
<td>Eden space当前容量的大小（KB）</td>
</tr>
<tr>
<td>EU</td>
<td>Eden space已经使用的大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>从应用程序启动到采样时 Young GC 所用的时间(单位秒)</td>
</tr>
</tbody>
</table>
<p>-gcnewcapacity : 新生代的存储容量情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>NGCMN</td>
<td>新生代的最小容量大小（KB）</td>
</tr>
<tr>
<td>NGCMX</td>
<td>新生代的最大容量大小（KB）</td>
</tr>
<tr>
<td>NGC</td>
<td>当前新生代的容量大小（KB）</td>
</tr>
<tr>
<td>S0CMX</td>
<td>新生代中SO的最大容量大小（KB）</td>
</tr>
<tr>
<td>S0C</td>
<td>当前新生代中SO的容量大小（KB）</td>
</tr>
<tr>
<td>S1CMX</td>
<td>新生代中S1的最大容量大小（KB）</td>
</tr>
<tr>
<td>S1C</td>
<td>当前新生代中S1的容量大小（KB）</td>
</tr>
<tr>
<td>ECMX</td>
<td>新生代中Eden的最大容量大小（KB）</td>
</tr>
<tr>
<td>EC</td>
<td>当前新生代中Eden的容量大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
</tbody>
</table>
<p>-gcold : 老生代及持久代发生GC的情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PC</td>
<td>当前持久代容量的大小（KB）</td>
</tr>
<tr>
<td>PU</td>
<td>持久代使用容量的大小（KB）</td>
</tr>
<tr>
<td>OC</td>
<td>当前老年代容量的大小（KB）</td>
</tr>
<tr>
<td>OU</td>
<td>老年代使用容量的大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时 Full GC 所用的时间(单位秒)</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时用于垃圾回收的总时间(单位秒)，它的值等于YGC+FGC</td>
</tr>
</tbody>
</table>
<p>-gcoldcapacity : 老生代的存储容量情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>OGCMN</td>
<td>老生代的最小容量大小（KB）</td>
</tr>
<tr>
<td>OGCMX</td>
<td>老生代的最大容量大小（KB）</td>
</tr>
<tr>
<td>OGC</td>
<td>当前老生代的容量大小（KB）</td>
</tr>
<tr>
<td>OC</td>
<td>当前新生代的空间容量大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时 Full GC 所用的时间(单位秒)</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时用于垃圾回收的总时间(单位秒)，它的值等于YGC+FGC</td>
</tr>
</tbody>
</table>
<p>-gcpermcapacity : 持久代的存储容量情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PGCMN</td>
<td>持久代的最小容量大小（KB）</td>
</tr>
<tr>
<td>PGCMX</td>
<td>持久代的最大容量大小（KB）</td>
</tr>
<tr>
<td>PGC</td>
<td>当前持久代的容量大小（KB）</td>
</tr>
<tr>
<td>PC</td>
<td>当前持久代的空间容量大小（KB）</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时 Full GC 所用的时间(单位秒)</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时用于垃圾回收的总时间(单位秒)，它的值等于YGC+FGC</td>
</tr>
</tbody>
</table>
<p>-gcutil : 新生代、老生代及持代垃圾收集的情况</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>Heap上的 Survivor space 0 区已使用空间的百分比</td>
</tr>
<tr>
<td>S1</td>
<td>Heap上的 Survivor space 1 区已使用空间的百分比</td>
</tr>
<tr>
<td>E</td>
<td>Heap上的 Eden space 区已使用空间的百分比</td>
</tr>
<tr>
<td>O</td>
<td>Heap上的 Old space 区已使用空间的百分比</td>
</tr>
<tr>
<td>P</td>
<td>Perm space 区已使用空间的百分比</td>
</tr>
<tr>
<td>YGC</td>
<td>从应用程序启动到采样时发生 Young GC 的次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>从应用程序启动到采样时 Young GC 所用的时间(单位秒)</td>
</tr>
<tr>
<td>FGC</td>
<td>从应用程序启动到采样时发生 Full GC 的次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>从应用程序启动到采样时 Full GC 所用的时间(单位秒)</td>
</tr>
<tr>
<td>GCT</td>
<td>从应用程序启动到采样时用于垃圾回收的总时间(单位秒)，它的值等于YGC+FGC</td>
</tr>
</tbody>
</table>
<p>-printcompilation : HotSpot编译方法的统计</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compiled</td>
<td>编译任务执行的次数</td>
</tr>
<tr>
<td>Size</td>
<td>方法的字节码所占的字节数</td>
</tr>
<tr>
<td>Type</td>
<td>编译类型</td>
</tr>
<tr>
<td>Method</td>
<td>指定确定被编译方法的类名及方法名，类名中使名“/”而不是“.”做为命名分隔符，方法名是被指定的类中的方法，这两个字段的格式是由HotSpot中的“-XX:+PrintComplation”选项确定的。</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ jstat -gc 22549</div><div class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT   </div><div class="line">2560.0 512.0   0.0   384.0   8704.0   4758.8   11264.0     1326.3   21504.0 8845.8      7    0.014   2      0.061    0.075</div><div class="line"></div><div class="line">$ jstat -class 22549</div><div class="line">Loaded  Bytes  Unloaded  Bytes     Time   </div><div class="line">  1543  2945.3        3     4.9       0.30</div><div class="line">  </div><div class="line">$ jstat -compiler 22549</div><div class="line">Compiled Failed Invalid   Time   FailedType FailedMethod</div><div class="line">     235      0       0     0.70          0</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/fenglibing/article/details/6411951" target="_blank" rel="external">http://blog.csdn.net/fenglibing/article/details/6411951</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/">JVM</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-JVM/JVM常用命令学习（一）jps的使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/09/JVM/JVM常用命令学习（一）jps的使用/" class="article-date">
  	<time datetime="2017-02-09T10:23:28.000Z" itemprop="datePublished">2017-02-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/09/JVM/JVM常用命令学习（一）jps的使用/">JVM常用命令学习（一）jps的使用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Java环境说明"><a href="#Java环境说明" class="headerlink" title="Java环境说明"></a>Java环境说明</h3><p>注意：不同版本的JDK可能略有差异</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ java -versionjava version &quot;1.7.0_79&quot;Java(TM) SE Runtime Environment (build 1.7.0_79-b15)Java HotSpot(TM) 64-Bit Server VM (build 24.79-b02, mixed mode)</div></pre></td></tr></table></figure>
<h3 id="jps命令"><a href="#jps命令" class="headerlink" title="jps命令"></a>jps命令</h3><p>jps(Java Virtual Machine Process Status Tool)。jps只是用来显示Java进程信息，用来查看基于HotSpot的JVM里面中，所有具有访问权限的Java进程的具体状态, 包括进程ID，进程启动的路径及启动参数等等。</p>
<p>如果使用jps查看远程服务器的Java进程信息，需要在远程服务器上开启jstatd服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ jps -helpusage: jps [-help]       jps [-q] [-mlvV] [&lt;hostid&gt;]Definitions:    &lt;hostid&gt;:      &lt;hostname&gt;[:&lt;port&gt;]</div></pre></td></tr></table></figure>
<p>通过help提示可以看出基本的命令格式</p>
<ul>
<li>jps [option] : 查看Java进程信息</li>
<li>jps [option] <hostname>[:<port>] : 查看一个远程server的Java进程信息，port是远程rmi的端口，如果没有指定则默认为1099。</port></hostname></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[option]参数：</div><div class="line"></div><div class="line">- q : 只输出进程的pid</div><div class="line">- m : 输出传递给main方法的参数，如果是内嵌的JVM则输出为null。</div><div class="line">- l : 输出应用程序主类的完整包名，或者是应用程序JAR文件的完整路径。</div><div class="line">- v : 输出传给JVM的参数</div><div class="line">- V : 输出通过标记的文件传递给JVM的参数（.hotspotrc文件，或者是通过参数-XX:Flags=&lt;filename&gt;指定的文件）。</div></pre></td></tr></table></figure>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">$ jps22549 QuorumPeerMain18187 Jps14983 Jstatd</div><div class="line"></div><div class="line"># 只输出进程的pid</div><div class="line">$ jps -q225491498318259</div><div class="line"></div><div class="line"># 输出应用程序主类的完整包名，或者是应用程序JAR文件的完整路径。</div><div class="line">$ jps -l22549 org.apache.zookeeper.server.quorum.QuorumPeerMain18113 sun.tools.jps.Jps14983 sun.tools.jstatd.Jstatd</div><div class="line"></div><div class="line"># 输出传递给main方法的参数，如果是内嵌的JVM则输出为null。</div><div class="line">$ jps -m22549 QuorumPeerMain /usr/local/zookeeper/bin/../conf/zoo.cfg18344 Jps -m14983 Jstatd</div><div class="line"></div><div class="line"># 输出传给JVM的参数</div><div class="line">$ jps -v22549 QuorumPeerMain -Dzookeeper.log.dir=. -Dzookeeper.root.logger=INFO,CONSOLE -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=false17992 Jps -Dapplication.home=/data/jdk1.7.0_79 -Xms8m14983 Jstatd -Dapplication.home=/data/jdk1.7.0_79 -Xms8m -Djava.security.policy=jstatd.all.policy</div><div class="line"></div><div class="line"># 在hadoop1的机器的$&#123;JAVA_HOME&#125;/bin目录下创建jstatd.all.policy安全策略文件</div><div class="line">grant codebase &quot;file:$&#123;java.home&#125;/../lib/tools.jar&quot; &#123;</div><div class="line">    permission java.security.AllPermission;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"># 在hadoop1的机器启动jstatd服务，使用内部RMI Registry默认端口号1099</div><div class="line">$ ./jstatd -J-Djava.security.policy=jstatd.all.policy</div><div class="line"></div><div class="line"># 在其他机器查看hadoop1的Java进程信息</div><div class="line">$ jps -l hadoop1</div><div class="line">$ jps -l hadoop1:1099</div><div class="line">14983 sun.tools.jstatd.Jstatd</div><div class="line">22549 org.apache.zookeeper.server.quorum.QuorumPeerMain</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/fenglibing/article/details/6411932" target="_blank" rel="external">http://blog.csdn.net/fenglibing/article/details/6411932</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM/">JVM</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Java/">Java</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Kibana/Kibana学习（六）Kibana设置登录认证" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/08/Kibana/Kibana学习（六）Kibana设置登录认证/" class="article-date">
  	<time datetime="2017-02-08T11:00:35.000Z" itemprop="datePublished">2017-02-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/08/Kibana/Kibana学习（六）Kibana设置登录认证/">Kibana学习（六）Kibana设置登录认证</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前阵子MongoDB和Elasticsearch被黑客利用漏洞入侵并删除数据的事情闹得沸沸扬扬，我们公司使用Elasticsearch也是受害者之一，幸好我们使用Elasticsearch只是应用日志数据，不涉及到业务数据，所以被删除的日志数据对我们影响不是很大。这里我总结一下我们遇到的问题，和处理措施。</p>
<p>Elasticsearch被黑客入侵的事情发生在2017年1月份，当时Elasticsearch技术群有人遇到了索引数据无故丢失的现象，然后出现非法的.warning索引，正好当天我也发现我们Elasticsearch的索引也少了几天的日志索引，打开.warning索引之后发现类似如下信息。</p>
<p><img src="http://img.blog.csdn.net/20170212154312823?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Warning_Index"></p>
<p>索引的描述信息说明你的数据已经被backup到黑客的服务器上，如果想要恢复需要给他们0.5比特币。</p>
<p>看来这回是真的中招了，开始分析黑客能够入侵的原因。首先想到的就是先把ES的http端口9200禁止对外开放，以前是为了维护ES索引方便，所以把9200端口对外网开放了，虽然做了外网IP的访问控制，但是仍然被入侵进来，说明对外开放ES的9200端口并不安全。然后开始检查服务器的防火墙，对外网开放的IP过滤情况。这里我检查了服务器本身的防火墙并没有问题，然后也咨询过运维的同学ES服务器做了外网IP访问的限制。</p>
<p>但是为什么还会出现这种情况呢？我又仔细的检查了一遍全部的服务器配置，这里我们的服务器使用的是阿里云的服务器，访问的流程是：client客户端 -&gt; SLB服务器 -&gt; Kibana/ES服务器，通过和运维的同学一起排查，终于找到了问题的原因，原因是运维同学的马虎，只对ES服务器进行了外网IP的过滤，没有对SLB服务器进行外网IP的访问限制，而且我们的ES服务器也使用的默认9200端口，所以直接访问SLB的9200即可直接操作我们的ES的索引数据。</p>
<p>问题的原因：</p>
<ol>
<li>ES的http服务端口9200对外网开放</li>
<li>使用了ES的9200端口，极容易被黑客攻击</li>
<li>SLB服务器并没有对外网IP进行访问限制</li>
<li>访问Kibana也没有用户名和密码限制，任何人都可以通过公网IP直接看到我们的数据</li>
</ol>
<p>处理措施：</p>
<ol>
<li>关闭ES的http服务端口9200对外网开放</li>
<li>在阿里云的SLB代理层做端口的映射，SLB使用19200端口映射到ES服务的9200端口，15601端口映射到Kibana服务的5601端口</li>
<li>SLB服务器和ES服务器都设置对外网IP访问限制</li>
<li>在访问Kibana和ES之前加一层Nginx的反向代理服务器，并且设置http-base认证来实现Kibana和ES的登录</li>
</ol>
<p>问题的原因就分析到这里，下面我们说明一下如何在Nginx中设置的用户登录认证。</p>
<p>主要就是利用Nginx接管所有Kibana请求，通过Nginx配置将Kibana的访问加上权限控制，简单常见的方式可以使用如下两种方式：</p>
<p>方式一：使用Nginx的用户认证模块（ngx_http_auth_basic_module模块，Nginxg一般已经默认安装），用户访问时会直接弹出登录提示，要求输入用户名及密码后登录。<br>此方案需要依赖htpasswd命令生成密码文件。</p>
<p>方式二：利用Nginx的IP访问控制，限定允许和禁止访问的IP，非允许的IP访问后网页会显示403 Forbidden信息。</p>
<p>这里我们在本地可以尝试方式二，因为我们的线上环境使用了阿里云的SLB代理，SLB已经提供了类似的功能，所以就不在自己的Nginx中进行IP访问设置了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 需要先安装htpasswd</div><div class="line">$ apt-get -y install apache2-utils</div><div class="line"></div><div class="line"># 生成passwd.db文件，接下来需要输入访问Nginx的密码</div><div class="line">$ htpasswd -c -d /usr/local/nginx-1.8.0/passwd.db elk_user</div><div class="line">New password:</div><div class="line">Re-type new password:</div><div class="line">Adding password for user elk_user</div></pre></td></tr></table></figure>
<p>nginx.conf配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"># 如果是大规模集群环境，此处配置多台Kibana服务器即可（访问Nginx的15601端口后，会轮询访问下面的多台Kibana服务器）</div><div class="line">upstream kibana_server &#123;</div><div class="line">  server 192.168.99.128:5601;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">        listen       15601;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            # 权限的描述</div><div class="line">            auth_basic &quot;Protect Kibana&quot;;</div><div class="line">            # 指定我们刚才生成好的passwd.db文件</div><div class="line">            auth_basic_user_file /usr/local/nginx-1.8.0/passwd.db;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">            # 代理的访问地址是Kibana的地址</div><div class="line">            # proxy_pass http://localhost:5601;</div><div class="line">            # 如果有多台服务器建议使用upstream配置方式进行访问的负载均衡</div><div class="line">            proxy_pass http://kibana_server$request_uri;</div><div class="line">            </div><div class="line">            # 只允许公司的外网IP，局域网IP可以访问</div><div class="line">            # allow   123.**.**.***;</div><div class="line">            # allow   192.168.99.0/255;</div><div class="line">            # deny    all;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 如果是大规模集群环境，此处配置多台ES服务器即可（访问Nginx的19200端口后，会轮询访问下面的多台ES服务器）</div><div class="line">upstream es_server &#123;</div><div class="line">  server 192.168.99.128:9200;</div><div class="line">  server 192.168.99.212:9200;</div><div class="line">  server 192.168.99.213:9200;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">        listen       19200;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            # 权限的描述</div><div class="line">            auth_basic &quot;Protect Elasticsearch&quot;;</div><div class="line">            # 指定我们刚才生成好的passwd.db文件</div><div class="line">            auth_basic_user_file /usr/local/nginx-1.8.0/passwd.db;</div><div class="line">            root   html;</div><div class="line">            index  index.html index.htm;</div><div class="line">            # 代理的访问地址是Elasticsearch的地址</div><div class="line">            # proxy_pass http://localhost:9200;</div><div class="line">            # 如果有多台服务器建议使用upstream配置方式进行访问的负载均衡</div><div class="line">            proxy_pass http://es_server$request_uri;</div><div class="line">            </div><div class="line">            # 只允许公司的外网IP，局域网IP可以访问</div><div class="line">            # allow   123.**.**.***;</div><div class="line">            # allow   192.168.99.0/255;</div><div class="line">            # deny    all;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置好Nginx的配置文件之后，需要重新加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 重新加载Nginx配置文件</div><div class="line">$ ./nginx -s reload</div></pre></td></tr></table></figure>
<p>通过上面的配置访问<a href="http://localhost:15601和http://localhost:19200就会弹出用户名密码的验证框，如果输入正确就会跳转到对应http://localhost:5601和http://localhost:9200的地址，也就是Kibana和ES的访问地址。" target="_blank" rel="external">http://localhost:15601和http://localhost:19200就会弹出用户名密码的验证框，如果输入正确就会跳转到对应http://localhost:5601和http://localhost:9200的地址，也就是Kibana和ES的访问地址。</a></p>
<p><img src="http://img.blog.csdn.net/20170212165640900?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="ES Protected"></p>
<p>也可以通过curl命令来进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># elk_user是用户名和密码</div><div class="line"># 192.168.99.128:19200是访问Nginx的IP地址，和Nginx监听的端口号</div><div class="line"># 如果upstream配置多台ES服务器进行轮询访问，那么下面的name可能每访问一次都会不同</div><div class="line">$ curl -i elk_user:elk_user@192.168.99.128:19200</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: nginx/1.4.6 (Ubuntu)</div><div class="line">Date: Sun, 12 Feb 2017 08:59:37 GMT</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">Content-Length: 308</div><div class="line">Connection: keep-alive</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;name&quot; : &quot;node-1&quot;,</div><div class="line">  &quot;cluster_name&quot; : &quot;ben-es&quot;,</div><div class="line">  &quot;version&quot; : &#123;</div><div class="line">    &quot;number&quot; : &quot;2.3.5&quot;,</div><div class="line">    &quot;build_hash&quot; : &quot;90f439ff60a3c0f497f91663701e64ccd01edbb4&quot;,</div><div class="line">    &quot;build_timestamp&quot; : &quot;2016-07-27T10:36:52Z&quot;,</div><div class="line">    &quot;build_snapshot&quot; : false,</div><div class="line">    &quot;lucene_version&quot; : &quot;5.5.0&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更多关于ES的安全防护措施请阅读参考文章</p>
<p>参考文章：</p>
<ul>
<li><a href="http://elasticsearch.cn/article/129" target="_blank" rel="external">http://elasticsearch.cn/article/129</a></li>
<li><a href="https://sanwen8.cn/p/2382AEa.html" target="_blank" rel="external">https://sanwen8.cn/p/2382AEa.html</a></li>
<li><a href="http://blog.csdn.net/yangwenbo214/article/details/54576747" target="_blank" rel="external">http://blog.csdn.net/yangwenbo214/article/details/54576747</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kibana/">Kibana</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Logstash/Logstash学习（七）Logstash的webhdfs插件" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/07/Logstash/Logstash学习（七）Logstash的webhdfs插件/" class="article-date">
  	<time datetime="2017-02-07T09:31:30.000Z" itemprop="datePublished">2017-02-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/07/Logstash/Logstash学习（七）Logstash的webhdfs插件/">Logstash学习（七）Logstash的webhdfs插件</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近公司有需要查询历史日志的需求，但是之前在ES设置只保存了最近7天的日志，为了满足需求我将ES服务器的磁盘存储升级到了500G，同时延长了日志的周期至30天，但是这只是临时的解决方案，因为查询历史日志的需求仅仅是最近一个月还不够，所以为了长远考虑需要做日志的持久化存储。</p>
<h3 id="方案选型"><a href="#方案选型" class="headerlink" title="方案选型"></a>方案选型</h3><p>目前公司的架构比较简单，现在需要同时写入到HDFS中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file -&gt; logstash -&gt; kafka -&gt; logstash -&gt; elasticsearch</div></pre></td></tr></table></figure>
<p>这里考虑继续使用Logstash写入到HDFS中，当然也可以选择其他方案从Kafka读取数据写入HDFS的（例如：Flume，KafkaConnector等等），使用Logstash会有下面两种方案。</p>
<ul>
<li><p>方案一</p>
<ul>
<li>优点：Logstash读取一次日志，然后双写到ES和HDFS中</li>
<li>缺点：日志经过Logstash处理之后，无法将原始日志写入到HDFS中，只能将处理后的日志写入到HDFS中。而且Logstash挂掉之后，会影响ES和HDFS的数据的实时性。</li>
</ul>
</li>
<li><p>方案二</p>
<ul>
<li>优点：Logstash单独写入ES和HDFS，这样其中一个Logstash挂掉之后，不会影响另一个的数据实时性。而且Logstash单独写入HDFS可以直接保留了原始日志。</li>
<li>缺点：需要两套Logstash集群来读取Kafka中的数据，系统开销增加。</li>
</ul>
</li>
</ul>
<p><img src="http://img.blog.csdn.net/20170208115731052?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p>
<p>这里我们的需求是要在HDFS中保存原始的日志，所以选择的方案二。</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>其实Logstash官方并没有提供写入HDFS的插件，但是这里官网推荐社区开发的插件logstash-output-webhdfs</p>
<p>logstash-output-webhdfs插件地址：</p>
<ul>
<li><a href="https://github.com/logstash-plugins/logstash-output-webhdfs">https://github.com/logstash-plugins/logstash-output-webhdfs</a></li>
</ul>
<h4 id="安装logstash-output-webhdfs插件"><a href="#安装logstash-output-webhdfs插件" class="headerlink" title="安装logstash-output-webhdfs插件"></a>安装logstash-output-webhdfs插件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ cd $LS_HOME</div><div class="line">$ ./bin/logstash-plugin install logstash-output-webhdfs</div><div class="line">Validating logstash-output-webhdfs</div><div class="line">Installing logstash-output-webhdfs</div><div class="line">Installation successful</div></pre></td></tr></table></figure>
<h4 id="Logstash配置文件"><a href="#Logstash配置文件" class="headerlink" title="Logstash配置文件"></a>Logstash配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [&quot;/home/yunyu/Downloads/rpserver.INFO&quot;]</div><div class="line">        type =&gt; &quot;go&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">        ignore_older =&gt; 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    webhdfs &#123;</div><div class="line">        workers =&gt; 2</div><div class="line">        # hdfs的namenode地址</div><div class="line">        host =&gt; &quot;hadoop1&quot;</div><div class="line">        # Hadoop的webhdfs使用的端口</div><div class="line">        port =&gt; 50070</div><div class="line">        # hadoop运行的用户，以这个用户的权限去写入hdfs</div><div class="line">        user =&gt; &quot;yunyu&quot;</div><div class="line">        # 按年月日建目录，按type和小时建log文件</div><div class="line">        path =&gt; &quot;/logstash/%&#123;+YYYY&#125;/%&#123;+MM&#125;/%&#123;+dd&#125;/%&#123;type&#125;-%&#123;+HH&#125;.log&quot;</div><div class="line">        flush_size =&gt; 1000</div><div class="line">        # 压缩格式，可以不压缩</div><div class="line">        # compression =&gt; &quot;snappy&quot;</div><div class="line">        idle_flush_time =&gt; 10</div><div class="line">        retry_interval =&gt; 1</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="查看HDFS文件"><a href="#查看HDFS文件" class="headerlink" title="查看HDFS文件"></a>查看HDFS文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># hadoop启动步骤略过，直接查看HDFS文件目录</div><div class="line">$ hdfs dfs -ls /logstash/2017/02/08/</div><div class="line">Found 1 items</div><div class="line">-rwxr-xr-x   2 yunyu supergroup        282 2017-02-07 19:53 /logstash/2017/02/08/go-03.log</div></pre></td></tr></table></figure>
<p>可以导出或者cat输出HDFS中的日志文件查看内容，就先写到这里了。</p>
<h3 id="遇到问题和解决方法"><a href="#遇到问题和解决方法" class="headerlink" title="遇到问题和解决方法"></a>遇到问题和解决方法</h3><p>刚开始在使用Logstash写入HDFS的并没有遇到什么问题，然后我把收集Go，Node，PHP的日志3个Logstash进程全部配置完成并启动，一切都很正常。然后开始在线上进行部署，但是第二天发现Go的Logstash进程已经挂掉了，查看Logstash的日志发现，我发现Logstash的日志开始出现如下的错误信息。仔细观察了一下错误信息，发现</p>
<p>SSH登录到服务器发现Logstash报错，连接不上Hadoop的50075端口，于是查找了一下Hadoop的50075端口是什么服务使用的，发现50075是Hadoop的DataNode的http服务端口号，jps查看了一下果然没有DataNode进程，说明DataNode进程已经挂了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">50070 : NameNode的http服务的端口</div><div class="line">50075 : DataNode的http服务的端口</div></pre></td></tr></table></figure>
<p>然后查看DataNode的日志文件，发现如下的错误信息，DataNode的进程挂掉是因为内存不够用了，无法创建新的线程了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2017-02-10 13:38:03,040 WARN org.apache.hadoop.hdfs.server.datanode.DataNode: Unexpected exception in block pool Block pool BP-316305454-10.253.43.185-1486538923200 (Datanode Uuid 3aa12dfa-9686-462c-b871-fa995534ad11) service to yy-logs-hdfs01/10.253.43.185:9000</div><div class="line">java.lang.OutOfMemoryError: unable to create new native thread</div><div class="line">        at java.lang.Thread.start0(Native Method)</div><div class="line">        at java.lang.Thread.start(Thread.java:714)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.DataNode.recoverBlocks(DataNode.java:2529)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.BPOfferService.processCommandFromActive(BPOfferService.java:699)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.BPOfferService.processCommandFromActor(BPOfferService.java:611)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.processCommand(BPServiceActor.java:857)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.offerService(BPServiceActor.java:672)</div><div class="line">        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.run(BPServiceActor.java:823)</div><div class="line">        at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure>
<p>既然找到是内存不足的原因，就只能从这方面进行优化了，这里我尝试修改Hadoop的启动HeapSize大小来控制内存的使用，Hadoop的HeapSize默认是1000m。可以在环境变量配置如下信息来控制Hadoop各个进程的HeapSize大小。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">export HADOOP_NAMENODE_OPTS=&quot;-Xms512m -Xmx512m&quot;</div><div class="line">export HADOOP_SECONDARYNAMENODE_OPTS=&quot;-Xms256m -Xmx256m&quot;</div><div class="line">export HADOOP_DATANODE_OPTS=&quot;-Xms512m -Xmx512m&quot;</div><div class="line">export HADOOP_CLIENT_OPTS=&quot;-Xms256m -Xmx256m&quot;</div><div class="line">export YARN_OPTS=&quot;-Xms256m -Xmx256m&quot;</div></pre></td></tr></table></figure>
<p>控制Hadoop的启动HeapSize大小之后，我开始重启HDFS服务和YARN服务，服务启动都正常。但是当我尝试启动Logstash开始写入数据到HDFS时，Logstash报错如下。错误信息大概的意思是HDFS的文件/logstash/2017/02/10/node_proxy-05.log被锁住了，当前Logstash进程无法写入到这个文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to APPEND_FILE /logstash/2017/02/10/go-03.log for DFSClient_NONMAPREDUCE_1910367742_31 on 10.253.43.185 because this file lease is currently owned by DFSClient_NONMAPREDUCE_-73615217_30 on 10.253.43.185\\n\\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.recoverLeaseInternal</div></pre></td></tr></table></figure>
<p>我有开始Google百度相关错误信息，发现HDFS为了防止文件并发写，有一个Lease（租约）的概念。实际上HDFS（及大多数分布式文件系统）不支持文件并发写，Lease是HDFS用于保证唯一写的手段。Lease可以看做是一把带时间限制的写锁，仅持有写锁的客户端可以写文件。更多Lease相关的知识请看参考文章。</p>
<p>既然已经知道是HDFS的Lease锁住了文件，那就去Hadoop官网找相应释放Lease的方法即可。最后我在Hadoop的官网找到了相关的命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">recoverLease</div><div class="line"></div><div class="line">Usage: hdfs debug recoverLease [-path &lt;path&gt;] [-retries &lt;num-retries&gt;]</div><div class="line"></div><div class="line">COMMAND_OPTION	Description</div><div class="line">[-path path]	HDFS path for which to recover the lease.</div><div class="line">[-retries num-retries]	Number of times the client will retry calling recoverLease. The default number of retries is 1.</div><div class="line">Recover the lease on the specified path. The path must reside on an HDFS filesystem. The default number of retries is 1.</div><div class="line"></div><div class="line"># 执行recoverLease来释放文件的锁</div><div class="line">$ hdfs debug recoverLease -path /logstash/2017/02/10/go-03.log</div></pre></td></tr></table></figure>
<p>释放完HDFS的Lease之后，我继续尝试重启Logstash，发现Logstash可以开始写入数据到HDFS中。但是还是偶尔会报下面的错误信息。仔细看错误信息发现和上面的错误类似，仍然是Lease的问题。但是这里的错误只是说Lease正在被另一个进程释放中，需要等会再试。这样就说明可能是我们Logstash写入HDFS的频率过快，导致HDFS来不及释放Lease。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;:timestamp=&gt;&quot;2017-02-10T17:19:47.073000+0800&quot;, :message=&gt;&quot;webhdfs write caused an exception: &#123;\&quot;RemoteException\&quot;:&#123;\&quot;exception\&quot;:\&quot;RecoveryInProgressException\&quot;,\&quot;javaClassName\&quot;:\&quot;org.apache.hadoop.hdfs.protocol.RecoveryInProgressException\&quot;,\&quot;message\&quot;:\&quot;Failed to APPEND_FILE /logstash/2017/02/10/go-03.log for DFSClient_NONMAPREDUCE_464764675_30 on 10.253.43.185 because lease recovery is in progress. Try again later.\\n\\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.recoverLeaseInternal(FSNamesystem.java:2920)\\n\\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFileInternal(FSNamesystem.java:2685)\\n\\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFileInt(FSNamesystem.java:2985)\\n\\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.appendFile(FSNamesystem.java:2952)\\n\\tat org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.append(NameNodeRpcServer.java:653)\\n\\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.append(ClientNamenodeProtocolServerSideTranslatorPB.java:421)\\n\\tat org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)\\n\\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)\\n\\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:969)\\n\\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2049)\\n\\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2045)\\n\\tat java.security.AccessController.doPrivileged(Native Method)\\n\\tat javax.security.auth.Subject.doAs(Subject.java:422)\\n\\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1657)\\n\\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:2043)\\n\&quot;&#125;&#125;. Maybe you should increase retry_interval or reduce number of workers. Retrying...&quot;, :level=&gt;:warn&#125;</div></pre></td></tr></table></figure>
<p>然后我尝试优化Logstash的如下配置</p>
<ul>
<li>flush_size : 如果event计数超出flush_size设置的值，即使未达到store_interval_in_secs，也会将数据发送到webhdfs</li>
<li>idle_flush_time : 以x秒为间隔将数据发送到webhdfs</li>
<li><p>retry_interval : 两次重试之间等待多长时间</p>
</li>
<li><p>提高flush_size的值，来减少访问webhdfs的频率，同时提高HDFS的写入量</p>
</li>
<li>降低idle_flush_time的值，因为提高了flush_size，所以可以适当的减少数据发送到webhdfs的时间间隔</li>
<li>提高retry_interval的值，来减少高频重试带来的额外负载</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    kafka &#123;</div><div class="line">        # 指定Zookeeper集群地址</div><div class="line">        zk_connect =&gt; &quot;zk1:2181,zk2:2181,zk3:2181&quot;</div><div class="line">        # 指定当前消费者的group_id，group_id不能和其他logstash消费者相同，&gt;否则同时启动多个Logstash消费者offset会被覆盖</div><div class="line">        group_id =&gt; &quot;logstash_hdfs_go&quot;</div><div class="line">        # 指定消费的Topic</div><div class="line">        topic_id =&gt; &quot;log_go&quot;</div><div class="line">        # 指定消费的内容类型（默认是json）</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    webhdfs &#123;</div><div class="line">        workers =&gt; 1</div><div class="line">        host =&gt; &quot;hadoop1&quot;</div><div class="line">        port =&gt; 50070</div><div class="line">        user =&gt; &quot;hadoop&quot;</div><div class="line">        path =&gt; &quot;/logstash/%&#123;+YYYY&#125;/%&#123;+MM&#125;/%&#123;+dd&#125;/%&#123;type&#125;-%&#123;+HH&#125;.log&quot;</div><div class="line">        </div><div class="line">        # flush_size =&gt; 500</div><div class="line">        flush_size =&gt; 5000</div><div class="line">        </div><div class="line">        # idle_flush_time =&gt; 10</div><div class="line">        idle_flush_time =&gt; 5</div><div class="line">        </div><div class="line">        # retry_interval =&gt; 3</div><div class="line">        retry_interval =&gt; 3</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用新的配置之后，重启Logstash已经看不到上面因为Lease未释放导致重试的异常信息了。折腾了一个下午也是不容易啊，最后写个博客记录一下处理过程，辛苦了。。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-webhdfs.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-webhdfs.html</a></li>
<li><a href="https://github.com/logstash-plugins/logstash-output-webhdfs">https://github.com/logstash-plugins/logstash-output-webhdfs</a></li>
<li><a href="http://heqin.blog.51cto.com/8931355/1796776" target="_blank" rel="external">http://heqin.blog.51cto.com/8931355/1796776</a></li>
<li><a href="http://www.cnblogs.com/ZisZ/p/3253570.html" target="_blank" rel="external">http://www.cnblogs.com/ZisZ/p/3253570.html</a></li>
<li><a href="http://hadoop.apache.org/docs/r2.7.3/hadoop-project-dist/hadoop-hdfs/HDFSCommands.html#datanode" target="_blank" rel="external">http://hadoop.apache.org/docs/r2.7.3/hadoop-project-dist/hadoop-hdfs/HDFSCommands.html#datanode</a></li>
<li><a href="http://jxy.me/2015/06/09/hdfs-data-visibility/" target="_blank" rel="external">http://jxy.me/2015/06/09/hdfs-data-visibility/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logstash/">Logstash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（二十六）Docker的run命令使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/07/Docker/Docker实战（二十六）Docker的run命令使用/" class="article-date">
  	<time datetime="2017-02-07T02:14:24.000Z" itemprop="datePublished">2017-02-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/07/Docker/Docker实战（二十六）Docker的run命令使用/">Docker实战（二十六）Docker的run命令使用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇介绍了Dockerfile的配置详情用法，这里具体在讲解一下Docker的run命令使用，之前在构建自己的Docker镜像时，很多参数都没有深入研究，只是保证Docker容器的正常使用，这里run命令可以动态设置一些启动Docker容器的参数。</p>
<h3 id="Docker-run命令格式"><a href="#Docker-run命令格式" class="headerlink" title="Docker run命令格式"></a>Docker run命令格式</h3><p>最基本的docker run命令的格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run [OPTIONS] IMAGE[:TAG] [COMMAND] [ARG...]</div></pre></td></tr></table></figure>
<p>之前第一篇Docker文章介绍过Docker的基础命令，其中也说明了run命令的一些参数，这里我们在回顾一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 指定配置启动</div><div class="line">$ sudo docker run -d -p 10.211.55.4:9999:22 birdben/ubuntu:v1 &apos;/usr/sbin/sshd&apos; -D</div><div class="line"></div><div class="line"># 参数：</div><div class="line"># -d：表示以“守护模式”执行，日志不会出现在输出终端上(输出结果可以用docker logs 查看)。使用 -d 参数启动后会返回一个唯一的 id，也可以通过 docker ps 命令来查看容器信息。</div><div class="line"># -i：表示以“交互模式”运行容器，-i 则让容器的标准输入保持打开</div><div class="line"># -t：表示容器启动后会进入其命令行，-t 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上</div><div class="line"># -v：表示需要将本地哪个目录挂载到容器中，格式：-v &lt;宿主机目录&gt;:&lt;容器目录&gt;，-v 标记来创建一个数据卷并挂载到容器里。在一次 run 中多次使用可以挂载多个数据卷。</div><div class="line"># -p：表示宿主机与容器的端口映射，此时将容器内部的 22 端口映射为宿主机的 9999 端口，这样就向外界暴露了 9999 端口，可通过 Docker 网桥来访问容器内部的 22 端口了。</div><div class="line"></div><div class="line"># 注意：</div><div class="line"># 这里使用的是宿主机的 IP 地址：10.211.55.4，与对外暴露的端口号 9999，它映射容器内部的端口号 22。ssh外部需要访问：ssh root@10.211.55.4 -p 9999</div><div class="line"># 容器是否会长久运行，是和docker run指定的命令有关，和 -d 参数无关。</div><div class="line"># run启动不一定要使用“镜像 ID”，也可以使用“仓库名:标签名”</div></pre></td></tr></table></figure>
<p>注意：</p>
<p>这里在说明一下自己的之前构建的镜像的问题，这里不推荐在Docker中安装SSH，通过SSH来远程登录到Docker容器，应该通过在宿主机运行docker exec的方式进入Docker容器来进行操作，这样安全性更好，这是自己之前构建Docker镜像存在的一些问题。</p>
<h3 id="容器识别"><a href="#容器识别" class="headerlink" title="容器识别"></a>容器识别</h3><h4 id="Name（–name）"><a href="#Name（–name）" class="headerlink" title="Name（–name）"></a>Name（–name）</h4><p>可以通过三种方式为容器命名：</p>
<ul>
<li>使用UUID长命名（”f78375b1c487e03c9438c729345e54db9d20cfa2ac1fc3494b6eb60872e74778”）</li>
<li>使用UUID短命令（”f78375b1c487”）</li>
<li>使用Name(“evil_ptolemy”)</li>
</ul>
<p>这个UUID标示是由Docker deamon生成的。如果你在执行docker run时没有指定–name，那么deamon会自动生成一个随机字符串UUID。但是对于一个容器来说有个name会非常方便，当你需要连接其它容器时或者类似需要区分其它容器时，使用容器名称可以简化操作。无论容器运行在前台或者后台，这个名字都是有效的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -itd -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name docker_shadowsocks birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<p>推荐运行Docker容器的时候指定一个容器名字，后续对于Docker容器的操作比较容易，否则每次使用Docker容器的ID操作都需要使用docker ps来查看比较麻烦。</p>
<h3 id="PID-equivalent"><a href="#PID-equivalent" class="headerlink" title="PID equivalent"></a>PID equivalent</h3><p>如果在使用Docker时有自动化的需求，你可以将containerID输出到指定的文件中（PIDfile），类似于某些应用程序将自身ID输出到文件中，方便后续脚本操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -itd -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --cidfile=&quot;/var/run/docker_shadowsocks.pid&quot; --name docker_shadowsocks birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<h4 id="Image-tag"><a href="#Image-tag" class="headerlink" title="Image[:tag]"></a>Image[:tag]</h4><p>当一个镜像的名称不足以分辨这个镜像所代表的含义时，你可以通过tag将版本信息添加到run命令中，以执行特定版本的镜像。这个也是我之前比较常用的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -itd -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<h4 id="Network-Settings"><a href="#Network-Settings" class="headerlink" title="Network Settings"></a>Network Settings</h4><p>默认情况下，所有的容器都开启了网络接口，同时可以接受任何外部的数据请求。这个是设置Docker网络配置的参数，如果你有多个Docker容器之前需要网络通信，那么这个参数是比较常用的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--dns=[]         : Set custom dns servers for the container</div><div class="line">--net=&quot;bridge&quot;   : Set the Network mode for the container</div><div class="line">  &apos;bridge&apos;: creates a new network stack for the container on the docker bridge</div><div class="line">  &apos;none&apos;: no networking for this container</div><div class="line">  &apos;container:&lt;name|id&gt;&apos;: reuses another container network stack</div><div class="line">  &apos;host&apos;: use the host network stack inside the container</div><div class="line">--add-host=&quot;&quot;    : Add a line to /etc/hosts (host:IP)</div><div class="line">--mac-address=&quot;&quot; : Sets the container&apos;s Ethernet device&apos;s MAC address</div></pre></td></tr></table></figure>
<p>你可以通过docker run –net none来关闭网络接口，此时将关闭所有网络数据的输入输出，你只能通过STDIN、STDOUT或者files来完成I/O操作。默认情况下，容器使用主机的DNS设置，你也可以通过–dns来覆盖容器内的DNS设置。同时Docker为容器默认生成一个MAC地址，你可以通过–mac-address 12:34:56:78:9a:bc来设置你自己的MAC地址。</p>
<p>Docker支持的网络模式有：</p>
<ul>
<li>none : 关闭容器内的网络连接</li>
<li>bridge : 通过veth接口来连接容器，默认配置。</li>
<li>host : 允许容器使用host的网络堆栈信息。 注意：这种方式将允许容器访问host中类似D-BUS之类的系统服务，所以认为是不安全的。</li>
<li>container : 使用另外一个容器的网络堆栈信息。</li>
</ul>
<h4 id="管理-etc-hosts"><a href="#管理-etc-hosts" class="headerlink" title="管理/etc/hosts"></a>管理/etc/hosts</h4><p>/etc/hosts文件中会包含容器的hostname信息，我们也可以使用–add-host这个参数来动态添加/etc/hosts中的数据。使用–add-host参数我们就可以动态配置hosts，而不需要在构建镜像的时候将/etc/hosts文件写好并且覆盖到Docker镜像中，这个也是我之前所犯下的错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ /docker run -it --add-host mysql:192.168.2.108 birdben/shadowsocks:v1 cat /etc/hosts127.0.0.1	localhost192.168.2.109  hadoop1192.168.2.110  hadoop2192.168.2.111  hadoop3192.168.2.108  mysql</div></pre></td></tr></table></figure>
<h4 id="Clean-up-–rm"><a href="#Clean-up-–rm" class="headerlink" title="Clean up (–rm)"></a>Clean up (–rm)</h4><p>默认情况下，每个容器在退出时，它的文件系统也会保存下来，这样一方面调试会方便些，因为你可以通过查看日志等方式来确定最终状态。另外一方面，你也可以保存容器所产生的数据。但是当你仅仅需要短暂的运行一个容器，并且这些数据不需要保存，你可能就希望Docker能在容器结束时自动清理其所产生的数据。这个时候你就需要–rm这个参数了，–rm参数设置为true会在停止Docker容器的时候自动删除该容器的，在构建调试Docker容器的时候比较方便，省去手动反复删除Docker容器的操作，自己深有体会推荐构建调试的时候使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 。</div><div class="line"># 注意：--rm 和 -d不能共用！</div><div class="line">$ docker run -itd --rm=true -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div><div class="line">Conflicting options: --rm and -d</div><div class="line"></div><div class="line"># 正确用法，挂载到宿主机的日志文件是不会被删除的</div><div class="line">$ docker run -it --rm=true -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<h3 id="覆盖Dockerfile配置文件默认值"><a href="#覆盖Dockerfile配置文件默认值" class="headerlink" title="覆盖Dockerfile配置文件默认值"></a>覆盖Dockerfile配置文件默认值</h3><p>Docker run命令可以指定参数来覆盖Dockerfile中的配置，这些参数中，有四个是无法被覆盖的：FROM、MAINTAINER、RUN和ADD（这里可能是原作者写漏了，COPY也应该是无法被覆盖的），其余参数都可以通过docker run进行覆盖。我们将介绍如何对这些参数进行覆盖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CMD (Default Command or Options)</div><div class="line">ENTRYPOINT (Default Command to Execute at Runtime)</div><div class="line">EXPOSE (Incoming Ports)</div><div class="line">ENV (Environment Variables)</div><div class="line">VOLUME (Shared Filesystems)</div><div class="line">USER</div><div class="line">WORKDIR</div></pre></td></tr></table></figure>
<h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run [OPTIONS] IMAGE[:TAG] [COMMAND] [ARG...]</div></pre></td></tr></table></figure>
<p>这个命令中的COMMAND部分是可选的。因为这个IMAGE在build时，开发人员可能已经设定了默认执行的命令。作为操作人员，你可以使用上面命令中新的command来覆盖旧的command。</p>
<p>如果镜像中设定了ENTRYPOINT，那么命令中的CMD也可以作为参数追加到ENTRYPOINT中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 这里使用/bin/bash命令覆盖原来启动supervisor的命令，这里是直接进入Docker容器了，并且检查supervisor进程并没有启动</div><div class="line">$ docker run -it -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1 /bin/bash</div><div class="line">root@77d46c117967:/# ps -ef | grep supervisor</div><div class="line">root        16     1  0 03:54 ?        00:00:00 grep --color=auto supervisor</div></pre></td></tr></table></figure>
<h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">--entrypoint=&quot;&quot;: Overwrite the default entrypoint set by the image</div></pre></td></tr></table></figure>
<p>这个ENTRYPOINT和COMMAND类似，它指定了当容器执行时，需要启动哪些进程。相对COMMAND而言，ENTRYPOINT是很难进行覆盖的，这个ENTRYPOINT可以让容器设定默认启动行为，所以当容器启动时，你可以执行任何一个二进制可执行程序。你也可以通过COMMAND为ENTRYPOINT传递参数。但当你需要在容器中执行其它进程时，你就可以指定其它ENTRYPOINT了。</p>
<p>下面就是一个例子，容器可以在启动时自动执行Shell，然后启动其它进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ sudo docker run -i -t --entrypoint /bin/bash example/redis</div><div class="line">#or two examples of how to pass more parameters to that ENTRYPOINT:</div><div class="line">$ sudo docker run -i -t --entrypoint /bin/bash example/redis -c ls -l</div><div class="line">$ sudo docker run -i -t --entrypoint /usr/bin/redis-cli example/redis --help</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 常见问题：&quot;docker-entrypoint.sh&quot;: executable file not found in $PATH.</div><div class="line"></div><div class="line"># 多数原因是因为docker-entrypoint.sh脚本文件没有执行权限，需要在Dockerfile修改脚本文件的执行权限，或者在宿主机修改挂载的docker-entrypoint.sh脚本文件的执行权限</div><div class="line"></div><div class="line">RUN chmod +x docker-entrypoint.sh</div></pre></td></tr></table></figure>
<h4 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--expose=[]: Expose a port or a range of ports from the container</div><div class="line">        without publishing it to your host</div><div class="line">-P=false   : Publish all exposed ports to the host interfaces</div><div class="line">-p=[]      : Publish a container᾿s port to the host (format:</div><div class="line">         ip:hostPort:containerPort | ip::containerPort |</div><div class="line">         hostPort:containerPort | containerPort)</div><div class="line">         (use &apos;docker port&apos; to see the actual mapping)</div><div class="line">--link=&quot;&quot;  : Add link to another container (name:alias)</div></pre></td></tr></table></figure>
<p>–expose可以让容器接受外部传入的数据。容器内监听的端口不需要和外部主机的端口相同。比如说在容器内部，一个HTTP服务监听在80端口，对应外部主机的端口就可能是49880.</p>
<p>如果使用-p或者-P，那么容器会开放部分端口到主机，只要对方可以连接到主机，就可以连接到容器内部。当使用-P时，Docker会在主机中随机从49153和65535之间查找一个未被占用的端口绑定到容器。你可以使用docker port来查找这个随机绑定端口。</p>
<p>当你使用–link方式时，作为客户端的容器可以通过私有网络形式访问到这个容器。同时Docker会在客户端的容器中设定一些环境变量来记录绑定的IP和PORT。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 这里设置宿主机和Docker容器的端口都是443</div><div class="line">$ docker run -itd -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run -e MYVAR1 --env MYVAR2=foo --env-file ./env.list ubuntu bash</div></pre></td></tr></table></figure>
<p>这将在容器中设置简单（非数组）环境变量。 为了说明这里显示所有三个标志。 其中-e，-env取一个环境变量和值，或者如果没有提供”=”，那么通过export设置该变量的当前值（即，来自主机的$MYVAR1被设置为容器中的$MYVAR1） 。当没有提供”=”且该变量没有在客户端环境中定义时，那个变量将从容器的环境变量列表中删除。所有三个标志，-e，–env和–env文件可以重复。</p>
<p>不管这三个标志的顺序如何，首先处理–env文件，然后处理-e，-env标志。 这样，-e或–env将根据需要覆盖变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cat ./env.list</div><div class="line">TEST_FOO=BAR</div><div class="line">$ docker run --env TEST_FOO=&quot;This is a test&quot; --env-file ./env.list busybox env | grep TEST_FOO</div><div class="line">TEST_FOO=This is a test</div></pre></td></tr></table></figure>
<p>–env-file标志采用文件名作为参数，并且期望每一行都处于VAR = VAL格式，模拟传递给–env的参数。 注释行只需要前缀为＃</p>
<p>使用–env-file传递的文件示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">$ cat ./env.list</div><div class="line">TEST_FOO=BAR</div><div class="line"></div><div class="line"># this is a comment</div><div class="line">TEST_APP_DEST_HOST=10.10.0.127</div><div class="line">TEST_APP_DEST_PORT=8888</div><div class="line">_TEST_BAR=FOO</div><div class="line">TEST_APP_42=magic</div><div class="line">helloWorld=true</div><div class="line">123qwe=bar</div><div class="line">org.spring.config=something</div><div class="line"></div><div class="line"># pass through this variable from the caller</div><div class="line">TEST_PASSTHROUGH</div><div class="line">$ TEST_PASSTHROUGH=howdy docker run --env-file ./env.list busybox env</div><div class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</div><div class="line">HOSTNAME=5198e0745561</div><div class="line">TEST_FOO=BAR</div><div class="line">TEST_APP_DEST_HOST=10.10.0.127</div><div class="line">TEST_APP_DEST_PORT=8888</div><div class="line">_TEST_BAR=FOO</div><div class="line">TEST_APP_42=magic</div><div class="line">helloWorld=true</div><div class="line">TEST_PASSTHROUGH=howdy</div><div class="line">HOME=/root</div><div class="line">123qwe=bar</div><div class="line">org.spring.config=something</div><div class="line"></div><div class="line">$ docker run --env-file ./env.list busybox env</div><div class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</div><div class="line">HOSTNAME=5198e0745561</div><div class="line">TEST_FOO=BAR</div><div class="line">TEST_APP_DEST_HOST=10.10.0.127</div><div class="line">TEST_APP_DEST_PORT=8888</div><div class="line">_TEST_BAR=FOO</div><div class="line">TEST_APP_42=magic</div><div class="line">helloWorld=true</div><div class="line">TEST_PASSTHROUGH=</div><div class="line">HOME=/root</div><div class="line">123qwe=bar</div><div class="line">org.spring.config=something</div></pre></td></tr></table></figure>
<h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h4><p>通过”-v”参数来覆盖挂载路径，这个是比较常用的，因为大多数日志或者数据文件都会挂载到宿主机目录的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-v=[]: Create a bind mount with: [host-dir]:[container-dir]:[rw|ro].</div><div class="line">   If &quot;container-dir&quot; is missing, then docker creates a new volume.</div><div class="line">--volumes-from=&quot;&quot;: Mount all volumes from the given container(s)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 宿主机目录：/Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks</div><div class="line"># Docker容器目录：/var/log/shadowsocks</div><div class="line">$ docker run -itd -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div></pre></td></tr></table></figure>
<h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h4><p>容器中默认的用户是root，但是开发人员创建新的用户之后，这些新用户也是可以使用的。开发人员可以通过Dockerfile的USER设定默认的用户，并通过”-u”来覆盖这些参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 这里我通过-u参数指定的shadowsocks用户来运行，但是我并没有创建过shadowsocks用户，所以下面报错了</div><div class="line">$ docker run -it --rm=true -u=&quot;shadowsocks&quot; -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div><div class="line">docker: Error response from daemon: linux spec user: unable to find user shadowsocks: no matching entries in passwd file.</div></pre></td></tr></table></figure>
<h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h4><p>容器中默认的工作目录是根目录（/）。开发人员可以通过Dockerfile的WORKDIR来设定默认工作目录，操作人员可以通过”-w”来覆盖默认的工作目录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># -w指定默认工作目录是&quot;/usr/local&quot;</div><div class="line">$ docker run -itd -w=&quot;/usr/local&quot; -p 443:443 -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/shadowsocks:/var/log/shadowsocks -v /Users/yunyu/workspace_git/birdDocker/shadowsocks/logs/supervisor:/var/log/supervisor --name shadowsocks_docker birdben/shadowsocks:v1</div><div class="line">358618f9aa4d1c388b3dc9c7e5c6236bb9b6b150728e474710e83f0409dd6007</div><div class="line"></div><div class="line">$ docker exec -it 358618f9aa4d /bin/bash</div><div class="line">root@358618f9aa4d:/usr/local#</div></pre></td></tr></table></figure>
<p>这里我只记录了自己使用Docker常用的配置，更多详细配置用法请看参考文章，谢谢!</p>
<p>参考文章：</p>
<ul>
<li><a href="http://dockone.io/article/152" target="_blank" rel="external">http://dockone.io/article/152</a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/run/" target="_blank" rel="external">https://docs.docker.com/engine/reference/commandline/run/</a></li>
<li><a href="https://github.com/docker/docker/issues/27182">https://github.com/docker/docker/issues/27182</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（二十五）Dockerfile文件配置" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/06/Docker/Docker实战（二十五）Dockerfile文件配置/" class="article-date">
  	<time datetime="2017-02-06T13:19:02.000Z" itemprop="datePublished">2017-02-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/06/Docker/Docker实战（二十五）Dockerfile文件配置/">Docker实战（二十五）Dockerfile文件配置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>虽然自己构建了很多自己的Docker镜像，但是随着自己对于Docker的慢慢熟悉，发现自己之前构建的Docker镜像的用法不是很推荐使用，还有就是很多Docker的细节用法不是很熟悉，本篇具体记录了Docker配置文件的一些用法，以及比较容易混淆的配置。</p>
<p>Docker配置文件详解</p>
<h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><p>指定基础镜像，用于继承其他镜像使用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FROM ubuntu:14.04</div></pre></td></tr></table></figure>
<h3 id="MAINTAINER"><a href="#MAINTAINER" class="headerlink" title="MAINTAINER"></a>MAINTAINER</h3><p>镜像创建者的基本信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MAINTAINER birdben (191654006@163.com)</div></pre></td></tr></table></figure>
<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><p>RUN用来执行命令行命令的，只是在构建镜像build的时候执行</p>
<p>RUN的两种格式：</p>
<ul>
<li>shell 格式 : RUN &lt;命令&gt;，就像直接在命令行中输入的命令一样</li>
<li>exec 格式 : RUN [“可执行文件”, “参数1”, “参数2”]，更像是函数调用中的格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RUN sudo apt-get update \</div><div class="line">    &amp;&amp; sudo apt-get install -y vim wget curl openssh-server sudo</div><div class="line">    </div><div class="line">RUN [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</div></pre></td></tr></table></figure>
<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>CMD指令的主要功能是在build完成后，为了给docker run启动到容器时提供默认命令或参数，构建镜像build时不执行。如果用户启动容器run时指定了运行的命令，则会覆盖掉CMD指定的命令。</p>
<p>注意：CMD只有最后一个有效</p>
<p>CMD的格式：</p>
<ul>
<li>CMD [“executable”, “param1”, “param2”]</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CMD [&quot;/usr/bin/supervisord&quot;, &quot;-c&quot;, &quot;/etc/supervisor/supervisord.conf&quot;]</div><div class="line"></div><div class="line"># 这里的配置相当于在终端执行下面的命令：</div><div class="line"></div><div class="line">$ /usr/bin/supervisord -c /etc/supervisor/supervisord.conf</div></pre></td></tr></table></figure>
<h3 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h3><p>ENTRYPOINT配置容器启动后执行的命令，构建镜像build时不执行，并且不可被 docker run 提供的参数覆盖。</p>
<p>注意：每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有最后一个起效。</p>
<p>ENTRYPOINT的格式：</p>
<ul>
<li>ENTRYPOINT [“executable”, “param1”, “param2”]</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ENTRYPOINT [&quot;/bin/echo&quot;]</div><div class="line">CMD [&quot;this is a echo test&quot;]</div><div class="line"></div><div class="line"># 那么docker build出来的镜像以后的容器功能就像一个/bin/echo程序，如果docker run期间如果没有参数的传递，会默认CMD指定的参数&quot;this is a echo test&quot;，这里就会输出&quot;this is a test&quot;这串字符。如果docker run使用传递参数了，例如：build出来的镜像名称叫birdDocker，那么我可以像下面这样传递参数</div><div class="line"></div><div class="line">$ docker run -it birdDocker &quot;this is a run test&quot;</div><div class="line"></div><div class="line"># 这里birdDocker镜像对应的容器表现出来的功能就像一个echo程序一样。这里docker run的参数&quot;this is a run test&quot;会添加到ENTRYPOINT后面，就成了这样/bin/echo &quot;this is a run test&quot;。</div><div class="line"></div><div class="line"># 也就是说CMD的参数只是docker run没有传参的时，使用的默认参数。</div><div class="line"></div><div class="line"># 同理，下面的docker-entrypoint.sh脚本文件也可以通过上面的docker run的方式来接收参数。</div><div class="line"></div><div class="line">ENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]</div><div class="line">CMD [&quot;zkServer.sh&quot;, &quot;start-foreground&quot;]</div></pre></td></tr></table></figure>
<h3 id="RUN-CMD-ENTRYPOINT区别"><a href="#RUN-CMD-ENTRYPOINT区别" class="headerlink" title="RUN, CMD, ENTRYPOINT区别"></a>RUN, CMD, ENTRYPOINT区别</h3><p>RUN是在build成镜像时就运行的，先于CMD和ENTRYPOINT的。Build完成了，RUN也运行完成后，再运行CMD或者ENTRYPOINT。CMD会在每次启动容器的时候运行，而RUN只在创建镜像时执行一次，固化在image中。</p>
<p>ENTRYPOINT和CMD的不同点在于执行docker run时参数传递方式，CMD指定的命令可以被docker run传递的命令覆盖，如果docker run没有指定参数，则会使用CMD的默认参数执行，例如，如果用CMD指定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">CMD [&quot;echo&quot;]</div></pre></td></tr></table></figure>
<p>然后运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run CONTAINER_NAME echo foo</div></pre></td></tr></table></figure>
<p>那么CMD里指定的echo会被新指定的echo覆盖，所以最终相当于运行echo foo，所以最终打印出的结果就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo</div></pre></td></tr></table></figure>
<p>而ENTRYPOINT会把容器名后面的所有内容都当成参数传递给其指定的命令（不会对命令覆盖），比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ENTRYPOINT [&quot;echo&quot;]</div></pre></td></tr></table></figure>
<p>然后运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run CONTAINER_NAME echo foo</div></pre></td></tr></table></figure>
<p>则CONTAINER_NAME后面的echo foo都作为参数传递给ENTRYPOING里指定的echo命令了，所以相当于执行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;echo foo&quot;</div></pre></td></tr></table></figure>
<p>最终打印出的结果就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo foo</div></pre></td></tr></table></figure>
<p>另外，在Dockerfile中，ENTRYPOINT指定的参数比运行docker run时指定的参数更靠前，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ENTRYPOINT [&quot;echo&quot;, &quot;foo&quot;]</div></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run CONTAINER_NAME bar</div></pre></td></tr></table></figure>
<p>相当于执行了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo foo bar</div></pre></td></tr></table></figure>
<p>打印出的结果就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo bar</div></pre></td></tr></table></figure>
<p>Dockerfile中只能指定一个ENTRYPOINT，如果指定了很多，只有最后一个有效。</p>
<p>执行docker run命令时，也可以添加-entrypoint参数，会把指定的参数继续传递给ENTRYPOINT，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">ENTRYPOINT [&quot;echo&quot;,&quot;foo&quot;]</div></pre></td></tr></table></figure>
<p>然后执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run CONTAINER_NAME --entrypoint bar</div></pre></td></tr></table></figure>
<p>那么，就相当于执行了echo foo bar，最终结果就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo bar</div></pre></td></tr></table></figure>
<h3 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h3><p>设置Docker容器对外暴露的本地端口，需要在启动容器run时使用-p指定Docker容器外的端口和Docker容器内的端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">EXPOSE $ZOO_PORT 2888 3888</div><div class="line"></div><div class="line"># 启动Docker容器时，需要-p指定端口映射</div><div class="line">$ docker run -p 9999:22 -p 2181:2181 -t -i &quot;birdben/zookeeper:v1&quot;</div></pre></td></tr></table></figure>
<h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><p>定义Docker容器内的环境变量</p>
<p>ENV的格式：</p>
<ul>
<li>ENV <key> <value>       # 只能设置一个变量</value></key></li>
<li>ENV <key>=<value> …   # 允许一次设置多个变量</value></key></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ENV ZOOKEEPER_HOME /software/zookeeper-3.4.8</div><div class="line">ENV PATH $&#123;ZOOKEEPER_HOME&#125;/bin:$PATH</div></pre></td></tr></table></figure>
<h3 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h3><p>将本地主机目录挂载到目标容器中，将其他容器挂载的挂载点挂载到目标容器中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">VOLUME [&quot;/home/golang/birdTracker&quot;]</div><div class="line"></div><div class="line"># VOLUME 选项是将本地的目录挂载到容器中　此处要注意：当你运行-v ＜hostdir&gt;:&lt;Containerdir&gt; 时要确保目录内容相同否则会出现数据丢失</div><div class="line"># /Users/yunyu/workspace_git/birdTracker:/home/golang/birdTracker</div><div class="line"># /Users/yunyu/workspace_git/birdTracker是宿主机中的目录</div><div class="line"># /home/golang/birdTracker是Docker容器中的目录</div><div class="line"># 这里挂载的路径是birdTracker项目的目录</div><div class="line"></div><div class="line"># 这里可以在启动Docker容器时，通过-v参数来指定映射的目录</div><div class="line">$ docker run -it -v /Users/yunyu/workspace_git/birdTracker:/home/golang/birdTracker birdben/golang:v1</div></pre></td></tr></table></figure>
<h3 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h3><p>将复制指定的 <src> 到容器中的 <dest></dest></src></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 源可以是URL</div><div class="line">ADD &lt;src&gt;... &lt;dest&gt;</div><div class="line"></div><div class="line"># 复制当前目录下文件到容器/temp目录，如果是压缩文件则自动解压缩复制</div><div class="line">ADD local_tar_file /temp</div></pre></td></tr></table></figure>
<h3 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h3><p>将复制本地主机的 <src>（为 Dockerfile 所在目录的相对路径）到容器中的 <dest></dest></src></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 源不可以是URL</div><div class="line">COPY &lt;src&gt;... &lt;dest&gt;</div><div class="line"></div><div class="line"># 复制当前目录下文件到容器/temp目录</div><div class="line">COPY local_files /temp</div></pre></td></tr></table></figure>
<h3 id="ADD与COPY的区别"><a href="#ADD与COPY的区别" class="headerlink" title="ADD与COPY的区别"></a>ADD与COPY的区别</h3><p>ADD与COPY是完全不同的命令。COPY是这两个中最简单的，它只是从主机复制一份文件或者目录到镜像里。ADD同样可以这么做，但是它还有更神奇的功能，像解压TAR文件或从远程URLs获取文件。为了降低Dockerfile的复杂度以及防止意外的操作，最好用COPY来复制文件。Best Practices for Writing Dockerfiles建议尽量使用COPY，并使用RUN与COPY的组合来代替ADD，这是因为虽然COPY只支持本地文件拷贝到container，但它的处理比ADD更加透明，建议只在复制tar文件时使用ADD，如ADD trusty-core-amd64.tar.gz /。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FROM busybox:1.24</div><div class="line"></div><div class="line">ADD example.tar.gz /add #解压缩文件到add目录</div><div class="line">COPY example.tar.gz /copy #直接复制文件</div></pre></td></tr></table></figure>
<h3 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h3><p>指定运行容器时的用户名或UID，后续的RUN、CMD、ENTRYPOINT也会使用指定用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 当服务不需要管理员权限时，可以通过该命令指定运行用户。并且可以在之前创建所需要的用户，要临时获取管理员权限可以使用 gosu，而不推荐 sudo。</div><div class="line"></div><div class="line">ENV SSS_USER=shadowsocks</div><div class="line">ENV SSS_SUPERVISOR_LOG_DIR=/var/log/supervisor</div><div class="line">ENV SSS_SHADOWSOCKS_LOG_DIR=/var/log/shadowsocks</div><div class="line"></div><div class="line">RUN set -x \</div><div class="line">    &amp;&amp; useradd $SSS_USER \</div><div class="line">    &amp;&amp; mkdir -p $SSS_SUPERVISOR_LOG_DIR \</div><div class="line">    &amp;&amp; mkdir -p $SSS_SHADOWSOCKS_LOG_DIR \</div><div class="line">    &amp;&amp; chown $SSS_USER:$SSS_USER $SSS_SUPERVISOR_LOG_DIR \</div><div class="line">    &amp;&amp; chown $SSS_USER:$SSS_USER $SSS_SHADOWSOCKS_LOG_DIR \</div><div class="line">    &amp;&amp; chmod 777 /var/run</div><div class="line">    </div><div class="line">USER $SSS_USER</div></pre></td></tr></table></figure>
<h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><p>进入容器的默认路径，相当于cd，后续的RUN、CMD、ENTRYPOINT也会使用指定路径。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 可以使用多个 WORKDIR 指令，后续命令如果参数是相对路径，则会基于之前命令指定的路径。例如</div><div class="line"></div><div class="line">WORKDIR /a</div><div class="line">WORKDIR b</div><div class="line">WORKDIR c</div><div class="line">RUN pwd</div><div class="line"></div><div class="line"># 则最终路径为 /a/b/c</div></pre></td></tr></table></figure>
<h3 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h3><p>基础镜像Dockerfile，基础镜像更新，各个项目不用同步 Dockerfile 的变化，重新构建后就继承了基础镜像的更新。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FROM node:slim</div><div class="line">RUN &quot;mkdir /app&quot;</div><div class="line">WORKDIR /app</div><div class="line">CMD [ &quot;npm&quot;, &quot;start&quot; ]</div></pre></td></tr></table></figure>
<p>这里我们把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 my-node 的话，各个项目内的自己的 Dockerfile 就变为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FROM my-node</div><div class="line">COPY ./package.json /app</div><div class="line">RUN [ &quot;npm&quot;, &quot;install&quot; ]</div><div class="line">COPY . /app/</div></pre></td></tr></table></figure>
<p>基础镜像变化后，各个项目都用这个 Dockerfile 重新构建镜像，会继承基础镜像的更新。</p>
<p>如果这个 Dockerfile 里面有些东西需要调整呢？比如 npm install 都需要加一些参数，那怎么办？这一行 RUN 是不可能放入基础镜像的，因为涉及到了当前项目的 ./package.json，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 Dockerfile 的前4条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p>
<p>ONBUILD 可以解决这个问题。让我们用 ONBUILD 重新写一下基础镜像的 Dockerfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">FROM node:slim</div><div class="line">RUN &quot;mkdir /app&quot;</div><div class="line">WORKDIR /app</div><div class="line">ONBUILD COPY ./package.json /app</div><div class="line">ONBUILD RUN [ &quot;npm&quot;, &quot;install&quot; ]</div><div class="line">ONBUILD COPY . /app/</div><div class="line">CMD [ &quot;npm&quot;, &quot;start&quot; ]</div></pre></td></tr></table></figure>
<p>这次我们回到原始的 Dockerfile，但是这次将项目相关的指令加上 ONBUILD，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 Dockerfile 就变成了简单地：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">FROM my-node</div></pre></td></tr></table></figure>
<p>是的，只有这么一行。当在各个项目目录中，用这个只有一行的 Dockerfile 构建镜像时，之前基础镜像的那三行 ONBUILD 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 npm install，生成应用镜像。</p>
<p>参考文章：</p>
<ul>
<li><a href="http://www.cnblogs.com/lienhua34/p/5170335.html" target="_blank" rel="external">http://www.cnblogs.com/lienhua34/p/5170335.html</a></li>
<li><a href="https://yeasy.gitbooks.io/docker_practice/content/image/dockerfile/onbuild.html" target="_blank" rel="external">https://yeasy.gitbooks.io/docker_practice/content/image/dockerfile/onbuild.html</a></li>
<li><a href="http://seanlook.com/2014/11/17/dockerfile-introduction/" target="_blank" rel="external">http://seanlook.com/2014/11/17/dockerfile-introduction/</a></li>
<li><a href="https://docs.docker.com/articles/dockerfile_best-practices/" target="_blank" rel="external">https://docs.docker.com/articles/dockerfile_best-practices/</a></li>
<li><a href="https://segmentfault.com/q/1010000000417103" target="_blank" rel="external">https://segmentfault.com/q/1010000000417103</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（二十四）Docker安装Golang环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/02/06/Docker/Docker实战（二十四）Docker安装Golang环境/" class="article-date">
  	<time datetime="2017-02-05T16:45:08.000Z" itemprop="datePublished">2017-02-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/06/Docker/Docker实战（二十四）Docker安装Golang环境/">Docker实战（二十四）Docker安装Golang环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在使用Golang开发，使用Docker创建一个Golang环境的镜像方便以后开发使用。这里是外置挂在了我自己的birdTracker项目，使用Docker的Golang环境启动运行birdTracker项目。</p>
<p>Dockerfile文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/golang:v1</div><div class="line"># desc : 当前版本安装的golang</div><div class="line">############################################</div><div class="line"># 设置继承自ubuntu官方镜像</div><div class="line">FROM ubuntu:14.04</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line">ENV GO_USER=golang</div><div class="line">ENV GO_LOG_DIR=/var/log/golang</div><div class="line"># 这里的GOPATH路径是挂载的birdTracker项目的目录</div><div class="line">ENV GOPATH=/home/golang/birdTracker</div><div class="line">ENV PATH $GOPATH/bin:/usr/local/go/bin:$PATH</div><div class="line"></div><div class="line">#ENV GOLANG_VERSION 1.7.4</div><div class="line">#ENV GOLANG_DOWNLOAD_URL https://golang.org/dl/go$GOLANG_VERSION.linux-amd64.tar.gz</div><div class="line">#ENV GOLANG_DOWNLOAD_SHA256 47fda42e46b4c3ec93fa5d4d4cc6a748aa3f9411a2a2b7e08e3a6d80d753ec8b</div><div class="line"></div><div class="line"># 替换 sources.list 的配置文件，并复制配置文件到对应目录下面。</div><div class="line"># 这里使用的AWS国内的源，也可以替换成其他的源（例如：阿里云的源）</div><div class="line">COPY sources.list /etc/apt/sources.list</div><div class="line"></div><div class="line"># 安装基础工具</div><div class="line">RUN sudo apt-get clean</div><div class="line">RUN sudo rm -rf /var/lib/apt/lists/*</div><div class="line">RUN sudo apt-get update</div><div class="line">RUN sudo apt-get install -y vim wget curl git</div><div class="line"></div><div class="line"># 使用apt方式安装golang</div><div class="line">RUN sudo apt-get -y install golang</div><div class="line"></div><div class="line"># 下载并安装golang</div><div class="line">#RUN curl -fsSL &quot;$GOLANG_DOWNLOAD_URL&quot; -o golang.tar.gz \</div><div class="line">#	&amp;&amp; echo &quot;$GOLANG_DOWNLOAD_SHA256  golang.tar.gz&quot; | sha256sum -c - \</div><div class="line">#	&amp;&amp; tar -C /usr/local -xzf golang.tar.gz \</div><div class="line">#	&amp;&amp; rm golang.tar.gz</div><div class="line"></div><div class="line"># 创建用户和创建目录</div><div class="line">RUN set -x &amp;&amp; useradd $GO_USER &amp;&amp; mkdir -p $GO_LOG_DIR $GOPATH &amp;&amp; chown $GO_USER:$GO_USER $GO_LOG_DIR $GOPATH</div><div class="line"></div><div class="line">WORKDIR $GOPATH</div><div class="line"></div><div class="line"># VOLUME 选项是将本地的目录挂载到容器中　此处要注意：当你运行-v　＜hostdir&gt;:&lt;Containerdir&gt; 时要确保目录内容相同否则会出现数据丢失</div><div class="line"># 对应关系如下</div><div class="line"># /Users/yunyu/workspace_git/birdTracker:/home/golang/birdTracker</div><div class="line"># 这里挂载的路径是birdTracker项目的目录</div><div class="line">VOLUME [&quot;/home/golang/birdTracker&quot;]</div><div class="line"></div><div class="line"># 执行go_docker.sh脚本，该脚本在birdTracker项目根目录下，用于打包编译启动golang项目的</div><div class="line"># 注意挂载的go_docker.sh必须有可执行权限，需要执行chmod +x /Users/yunyu/workspace_git/birdTracker/go_docker.sh</div><div class="line">CMD [&quot;/home/golang/birdTracker/go_docker.sh&quot;]</div></pre></td></tr></table></figure>
<p>Dockerfile源文件链接：</p>
<ul>
<li><a href="https://github.com/birdben/birdDocker/blob/master/golang/Dockerfile">https://github.com/birdben/birdDocker/blob/master/golang/Dockerfile</a></li>
</ul>
<p>go_docker.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">MAIN_PATH=`pwd`/src/main/</div><div class="line">LOG_PATH=`pwd`/logs</div><div class="line"></div><div class="line">cd $MAIN_PATH</div><div class="line"># 下载第三方引用包</div><div class="line">go get github.com/golang/glog</div><div class="line">go install</div><div class="line"></div><div class="line">echo &quot;日志目录：&quot;$LOG_PATH</div><div class="line">if [ ! -d &quot;$LOG_PATH&quot; ]; then</div><div class="line">    mkdir -p &quot;$LOG_PATH&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">cd $GOPATH</div><div class="line">./bin/main -v 10 -log_dir=$LOG_PATH -stderrthreshold=INFO</div></pre></td></tr></table></figure>
<p>构建Docker镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t &quot;birdben/golang:v1&quot; .</div></pre></td></tr></table></figure>
<p>运行Docker容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CURRENT_UID=`whoami`</div><div class="line">docker run -it -v /Users/yunyu/workspace_git/birdTracker:/home/golang/birdTracker --name golang_$&#123;CURRENT_UID&#125; birdben/golang:v1</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker环境/">Docker环境</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ELK/ELK学习（三）ELK处理URL参数" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/24/ELK/ELK学习（三）ELK处理URL参数/" class="article-date">
  	<time datetime="2017-01-24T03:16:23.000Z" itemprop="datePublished">2017-01-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/24/ELK/ELK学习（三）ELK处理URL参数/">ELK学习（三）ELK处理URL参数</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇我们对Nginx的access.log进行了初步的解析和提取字段处理，如果想进一步对客户端的IP来源进行分析和地理定位，我们需要借助第三方库GeoIP来进行地理定位。</p>
<h3 id="提取特殊字段"><a href="#提取特殊字段" class="headerlink" title="提取特殊字段"></a>提取特殊字段</h3><h5 id="提取URL参数"><a href="#提取URL参数" class="headerlink" title="提取URL参数"></a>提取URL参数</h5><p>如果想要让URL参数也解析并且成为索引字段，比如一些通用参数，如uid, country, language, etc. 那么可以使用KV插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    # 再单独将取得的URL、request字段取出来进行key-value值匹配</div><div class="line">    # 需要kv插件。提供字段分隔符&quot;&amp;?&quot;，值键分隔符&quot;=&quot;，则会自动将字段和值采集出来。</div><div class="line">    kv &#123;</div><div class="line">        source =&gt; &quot;request&quot; # 默认是message，我们这里只需要解析上面grok抽取出来的request字段</div><div class="line">        field_split =&gt; &quot;&amp;?&quot;</div><div class="line">        value_split =&gt; &quot;=&quot;</div><div class="line">        include_keys =&gt; [ &quot;network&quot;, &quot;country&quot;, &quot;language&quot;, &quot;deviceId&quot; ]</div><div class="line">    &#125;</div><div class="line">　</div><div class="line">    # 把所有字段进行urldecode（显示中文）</div><div class="line">    urldecode &#123;</div><div class="line">        all_fields =&gt; true</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了，现在还有一个问题，如果请求中有中文，那么日志中的中文是被urlencode之后存储的。我们具体分析的时候，比如有个接口是/api/search?keyword=我们，需要统计的是keyword被查询的热门顺序，那么就需要解码了。logstash牛逼的也有urldecode命令，urldecode可以设置对某个字段，也可以设置对所有字段进行解码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">urldecode &#123;</div><div class="line">    all_fields =&gt; true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="过滤掉安全扫描"><a href="#过滤掉安全扫描" class="headerlink" title="过滤掉安全扫描"></a>过滤掉安全扫描</h5><p>对于安全扫描，只需要过滤 http_user_agent 中含有 inf-ssl-duty-scan 的请求就可以了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 过滤安全扫描</div><div class="line">if [http_user_agent] =~ &quot;inf-ssl-duty-scan&quot; &#123;</div><div class="line">    drop &#123; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 将client_ip为&quot;-&quot;的转换成&quot;0.0.0.0&quot;，或者直接删除client_ip字段，两种方式的效果都一样，如果IP地址是&quot;-&quot;就会删除client_ip字段，否则geoip转换会报错</div><div class="line">if [client_ip] == &quot;-&quot; &#123;</div><div class="line">    mutate &#123;</div><div class="line">        replace =&gt; &#123; &quot;client_ip&quot; =&gt; &quot;0.0.0.0&quot; &#125;</div><div class="line">        # remove_field =&gt; [ &quot;client_ip&quot; ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="查询Nginx请求日志"><a href="#查询Nginx请求日志" class="headerlink" title="查询Nginx请求日志"></a>查询Nginx请求日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 按照服务器响应时间区间查询请求</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;range&quot;:&#123;&quot;upstream_response_time&quot;:&#123;&quot;gte&quot;:0.001,&quot;lte&quot;:0.002&#125;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div><div class="line"></div><div class="line"># 按照整体响应时间区间查询请求</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;range&quot;:&#123;&quot;request_time&quot;:&#123;&quot;gte&quot;:0.001,&quot;lte&quot;:0.002&#125;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div><div class="line"></div><div class="line"># 查询某一个指定的请求</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;term&quot;:&#123;&quot;fastcgi_script_name.raw&quot;:&quot;/token/sign&quot;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div><div class="line"></div><div class="line"># 查询某一个指定的请求，服务器相应时间大于5s的</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;range&quot;:&#123;&quot;upstream_response_time&quot;:&#123;&quot;gte&quot;:5&#125;&#125;&#125;,&#123;&quot;term&quot;:&#123;&quot;fastcgi_script_name.raw&quot;:&quot;/token/sign&quot;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div><div class="line"></div><div class="line"># 查询某一IP端的请求</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;range&quot;:&#123;&quot;client_ip&quot;:&#123;&quot;gte&quot;:&quot;0.0.0.0&quot;&#125;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div><div class="line"></div><div class="line"># 查询某一个IP的请求</div><div class="line">&#123;&quot;query&quot;:&#123;&quot;filtered&quot;:&#123;&quot;filter&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;term&quot;:&#123;&quot;client_ip&quot;:&quot;112.17.244.47&quot;&#125;&#125;]&#125;&#125;&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://www.cnblogs.com/yjf512/p/4199105.html" target="_blank" rel="external">http://www.cnblogs.com/yjf512/p/4199105.html</a></li>
<li><a href="http://www.cnblogs.com/Orgliny/p/5592186.html" target="_blank" rel="external">http://www.cnblogs.com/Orgliny/p/5592186.html</a></li>
<li><a href="http://blog.csdn.net/babauyang/article/details/8471090" target="_blank" rel="external">http://blog.csdn.net/babauyang/article/details/8471090</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ELK/ELK学习（二）ELK利用GeoIP进行地理定位" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/23/ELK/ELK学习（二）ELK利用GeoIP进行地理定位/" class="article-date">
  	<time datetime="2017-01-23T12:15:20.000Z" itemprop="datePublished">2017-01-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/23/ELK/ELK学习（二）ELK利用GeoIP进行地理定位/">ELK学习（二）ELK利用GeoIP进行地理定位</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇我们对Nginx的access.log进行了初步的解析和提取字段处理，如果想进一步对客户端的IP来源进行分析和地理定位，我们需要借助第三方库GeoIP来进行地理定位。</p>
<h3 id="GeoIP的使用"><a href="#GeoIP的使用" class="headerlink" title="GeoIP的使用"></a>GeoIP的使用</h3><p>这里要说明一下GeoIP是一个免费的IP定位数据库，现在目前有两个版本GeoIP和GeoIP2</p>
<p>GeoIP官网地址：</p>
<ul>
<li><a href="https://www.maxmind.com/zh/home" target="_blank" rel="external">https://www.maxmind.com/zh/home</a></li>
</ul>
<p>这里GeoIP和GeoIP2我都尝试过了，使用GeoIP2是因为GeoIP不支持IPv6，开始access.log日志的IP使用的IPv6，但是ES 2.x版本也只支持IPv4类型，所以为了简单把access.log日志的IP改为了IPv4。下面说一下GeoIP和GeoIP2的安装和使用</p>
<h5 id="安装GeoIP数据库"><a href="#安装GeoIP数据库" class="headerlink" title="安装GeoIP数据库"></a>安装GeoIP数据库</h5><p>GeoIP（免费版叫GeoLite）数据库下载地址</p>
<ul>
<li><a href="http://dev.maxmind.com/zh-hans/geoip/legacy/geolite/" target="_blank" rel="external">http://dev.maxmind.com/zh-hans/geoip/legacy/geolite/</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz</div><div class="line">gunzip GeoLiteCity.dat.gz</div><div class="line"># 将数据库文件移动到Logstash的安装目录下</div><div class="line">mv GeoLiteCity.dat /usr/local/logstash/geoip/</div></pre></td></tr></table></figure>
<h5 id="Logstash配置文件中指定GeoIP数据库文件"><a href="#Logstash配置文件中指定GeoIP数据库文件" class="headerlink" title="Logstash配置文件中指定GeoIP数据库文件"></a>Logstash配置文件中指定GeoIP数据库文件</h5><p>Logstash默认是安装了logstash-filter-geoip插件的，所以可以直接使用下面的配置。我们继续上一篇的Logstash配置文件修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">if [type] == &quot;nginx_access&quot; &#123;</div><div class="line">	grok &#123;</div><div class="line">	    match =&gt; &#123;</div><div class="line">	        &quot;message&quot; =&gt; &quot;%&#123;NGINX_ACCESS_LOGS&#125;&quot;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	if &quot;_grokparsefailure&quot; in [tags] &#123;</div><div class="line">	    drop &#123; &#125;</div><div class="line">	&#125;</div><div class="line">	# 将client_ip为&quot;-&quot;的转换成&quot;0.0.0.0&quot;，或者直接删除client_ip字段，两种方式的效果都一样，如果IP地址是&quot;-&quot;就会删除client_ip字段，否则geoip转换会报错</div><div class="line">	if [client_ip] == &quot;-&quot; &#123;</div><div class="line">	    mutate &#123;</div><div class="line">	        replace =&gt; &#123; &quot;client_ip&quot; =&gt; &quot;0.0.0.0&quot; &#125;</div><div class="line">	        # remove_field =&gt; [ &quot;client_ip&quot; ]</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	# 这里是geoip指定字段的用法，不适用于geoip2</div><div class="line">	geoip &#123;</div><div class="line">		source =&gt; &quot;client_ip&quot;</div><div class="line">		target =&gt; &quot;geoip&quot;</div><div class="line">		# 这里指定好解压后GeoIP数据库文件的位置</div><div class="line">		database =&gt; &quot;/usr/local/logstash/geoip/GeoLiteCity.dat&quot;</div><div class="line">		# 直接使用location字段即可，不需要add_field和remove_field，除非不想使用location这个名字把字段换成别的名字</div><div class="line">		# 添加自己的坐标字段名称my_location</div><div class="line">		# add_field =&gt; [ &quot;[geoip][my_location]&quot;, &quot;%&#123;[geoip][longitude]&#125;&quot; ]</div><div class="line">		# add_field =&gt; [ &quot;[geoip][my_location]&quot;, &quot;%&#123;[geoip][latitude]&#125;&quot;  ]</div><div class="line">		# 指定保留geoip的字段，注意geoip和geoip2字段的区别</div><div class="line">		# fields =&gt; [&quot;country_name&quot;, &quot;country_code2&quot;,&quot;region_name&quot;, &quot;city_name&quot;, &quot;real_region_name&quot;, &quot;latitude&quot;, &quot;longitude&quot;]</div><div class="line">		# remove_field =&gt; [ &quot;[geoip][longitude]&quot;, &quot;[geoip][latitude]&quot; ]</div><div class="line">	&#125;</div><div class="line">	mutate &#123;</div><div class="line">		# 使用自己的坐标字段名称my_location</div><div class="line">		# convert =&gt; [ &quot;[geoip][my_location]&quot;, &quot;float&quot; ]</div><div class="line">		convert =&gt; [ &quot;[geoip][location]&quot;, &quot;float&quot; ]</div><div class="line">		# 将request_time和upstream_response_time转换成float，否则ES查询出来的是string类型</div><div class="line">		convert =&gt; [ &quot;[request_time]&quot;, &quot;float&quot; ]</div><div class="line">		convert =&gt; [ &quot;[upstream_response_time]&quot;, &quot;float&quot; ]</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="GeoIP的格式"><a href="#GeoIP的格式" class="headerlink" title="GeoIP的格式"></a>GeoIP的格式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">geoip.city_name：城市名称</div><div class="line">geoip.continent_code：洲际编码</div><div class="line">geoip.country_code2：国家编码，国际域名缩写</div><div class="line">geoip.country_code3：国家编码，国际域名缩写</div><div class="line">geoip.country_name：国家名称</div><div class="line">geoip.ip：IP地址</div><div class="line">* geoip.region_name：中国区域编码</div><div class="line">* geoip.real_region_name：中国区域名称</div><div class="line">geoip.timezone：时区</div><div class="line">geoip.location：经纬度坐标</div><div class="line">geoip.latitude：纬度坐标</div><div class="line">geoip.longitude：经度坐标</div></pre></td></tr></table></figure>
<h5 id="安装GeoIP2数据库"><a href="#安装GeoIP2数据库" class="headerlink" title="安装GeoIP2数据库"></a>安装GeoIP2数据库</h5><p>GeoIP2（免费版叫GeoLite2）数据库下载地址</p>
<ul>
<li><a href="http://dev.maxmind.com/zh-hans/geoip/geoip2/geolite2-开源数据库/" target="_blank" rel="external">http://dev.maxmind.com/zh-hans/geoip/geoip2/geolite2-开源数据库/</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz</div><div class="line">gunzip GeoLite2-City.mmdb.gz</div><div class="line"># 将数据库文件移动到Logstash的安装目录下</div><div class="line">mv GeoLite2-City.mmdb /usr/local/logstash/geoip/</div></pre></td></tr></table></figure>
<h5 id="Logstash配置文件中指定GeoIP2数据库文件"><a href="#Logstash配置文件中指定GeoIP2数据库文件" class="headerlink" title="Logstash配置文件中指定GeoIP2数据库文件"></a>Logstash配置文件中指定GeoIP2数据库文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd $&#123;LS_HOME&#125;/bin</div><div class="line">$ logstash-plugin install logstash-filter-geoip2</div></pre></td></tr></table></figure>
<p>这里需要单独安装geoip2插件，因为geoip2插件不是Logstash的官方插件。不使用geoip是因为对IPv6支持的不好，但是ES 2.x版本也只支持IPv4，不支持IPv6类型存储，所以后来只是将access.log的IP地址改为IPv4了。这里只是介绍下如何使用GeoIP2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">if [type] == &quot;nginx_access&quot; &#123;</div><div class="line">	grok &#123;</div><div class="line">	    match =&gt; &#123;</div><div class="line">	        &quot;message&quot; =&gt; &quot;%&#123;NGINX_ACCESS_LOGS&#125;&quot;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	if &quot;_grokparsefailure&quot; in [tags] &#123;</div><div class="line">	    drop &#123; &#125;</div><div class="line">	&#125;</div><div class="line">	# 将client_ip为&quot;-&quot;的转换成&quot;0.0.0.0&quot;，或者直接删除client_ip字段，两种方式的效果都一样，如果IP地址是&quot;-&quot;就会删除client_ip字段，否则geoip转换会报错</div><div class="line">	if [client_ip] == &quot;-&quot; &#123;</div><div class="line">	    mutate &#123;</div><div class="line">	        replace =&gt; &#123; &quot;client_ip&quot; =&gt; &quot;0.0.0.0&quot; &#125;</div><div class="line">	        # remove_field =&gt; [ &quot;client_ip&quot; ]</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	geoip2 &#123;</div><div class="line">	    source =&gt; &quot;client_ip&quot;</div><div class="line">	    target =&gt; &quot;geoip&quot;</div><div class="line">	    # 这里指定好解压后GeoIP数据库文件的位置</div><div class="line">	    database =&gt; &quot;/usr/local/logstash/geoip/GeoLite2-City.mmdb&quot;</div><div class="line">	    # 这里是geoip2指定字段的用法</div><div class="line">	    # fields =&gt; [&quot;city_name&quot;, &quot;continent_code&quot;, &quot;country_code2&quot;, &quot;country_code3&quot;, &quot;country_name&quot;, &quot;dma_code&quot;, &quot;ip&quot;, &quot;postal_code&quot;, &quot;region_name&quot;, &quot;region_code&quot;, &quot;timezone&quot;, &quot;location&quot;]</div><div class="line">	&#125;</div><div class="line">	mutate &#123;</div><div class="line">		convert =&gt; [ &quot;[geoip][location]&quot;, &quot;float&quot; ]</div><div class="line">		# 将request_time和upstream_response_time转换成float，否则ES查询出来的是string类型</div><div class="line">		convert =&gt; [ &quot;[request_time]&quot;, &quot;float&quot; ]</div><div class="line">		convert =&gt; [ &quot;[upstream_response_time]&quot;, &quot;float&quot; ]</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意这里的field不能直接用geoip插件的写法，因为有一些字段在geoip2中已经被去掉了，例如：real_region_name，否则会报如下错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Unknown error while looking up GeoIP data &#123;:exception=&gt;#&lt;Exception: [real_region_name] is not a supported field option.&gt;, :field=&gt;&quot;client_ip&quot;, :event=&gt;#&lt;LogStash::Event:0x4b6443d9 @metadata=&#123;&quot;path&quot;=&gt;&quot;/home/yunyu/Downloads/access.log&quot;&#125;, @accessors=#&lt;LogStash::Util::Accessors:0x213c01d</div></pre></td></tr></table></figure>
<p>下面是GeoIP2的格式，可以对比一下GeoIP的格式，不同的地方用*号标识出来了。</p>
<h5 id="GeoIP2的格式"><a href="#GeoIP2的格式" class="headerlink" title="GeoIP2的格式"></a>GeoIP2的格式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">geoip.city_name：城市名称</div><div class="line">geoip.continent_code：洲际编码</div><div class="line">geoip.country_code2：国家编码，国际域名缩写</div><div class="line">geoip.country_code3：国家编码，国际域名缩写</div><div class="line">geoip.country_name：国家名称</div><div class="line">* geoip.dma_code：指定市场区域，Designated Market Area（DMA）</div><div class="line">geoip.ip：IP地址</div><div class="line">* geoip.postal_code：邮政编码</div><div class="line">* geoip.region_code：中国区域编码</div><div class="line">* geoip.region_name：中国区域名称</div><div class="line">geoip.timezone：时区</div><div class="line">geoip.location：经纬度坐标</div><div class="line">geoip.latitude：纬度坐标</div><div class="line">geoip.longitude：经度坐标</div></pre></td></tr></table></figure>
<h3 id="ES的索引Template模板"><a href="#ES的索引Template模板" class="headerlink" title="ES的索引Template模板"></a>ES的索引Template模板</h3><p>引用GeoIP之后，对应的ES的索引Template模板也有相应的变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;template&quot;: &quot;nginx_access_logs_index_*&quot;,</div><div class="line">  &quot;order&quot;:0,</div><div class="line">  &quot;settings&quot;: &#123;</div><div class="line">      &quot;index.number_of_replicas&quot;: &quot;1&quot;,</div><div class="line">      &quot;index.number_of_shards&quot;: &quot;5&quot;,</div><div class="line">      &quot;index.refresh_interval&quot;: &quot;10s&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;_default_&quot;: &#123;</div><div class="line">      &quot;_all&quot;: &#123;</div><div class="line">        &quot;enabled&quot;: false</div><div class="line">      &#125;,</div><div class="line">      &quot;dynamic_templates&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;my_string&quot;: &#123;</div><div class="line">            &quot;match_mapping_type&quot;: &quot;string&quot;,</div><div class="line">            &quot;mapping&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;fields&quot;: &#123;</div><div class="line">                &quot;raw&quot;: &#123;</div><div class="line">                  &quot;type&quot;: &quot;string&quot;,</div><div class="line">                  &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;nginx_access&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;ident&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;auth&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;client_ip&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;ip&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;client_timestamp&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_method&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;url&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;refer_url&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;status_code&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_bytes&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;ua&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;device_id&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;sdk_version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;geoip&quot;: &#123;</div><div class="line">          &quot;dynamic&quot;: true,</div><div class="line">          &quot;type&quot;: &quot;object&quot;,</div><div class="line">          &quot;properties&quot;: &#123;</div><div class="line">            &quot;location&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;geo_point&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;host&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;path&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;type&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@timestamp&quot;: &#123;</div><div class="line">          &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;,</div><div class="line">          &quot;type&quot;: &quot;date&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里添加了一个geoip字段，并且使用dynamic，这样允许Logstash的geoip插件将解析后的详细字段也保存到ES索引中。这里geoip插件解析出来会带有一个location字段，这个字段就是经纬度的坐标点，所以这里设置geoip.location字段的类型是geo_point。</p>
<p>从Logstash的1.3.0版本开始，如果GeoIP查询返回纬度和经度，则会创建一个[geoip] [location]字段。 该字段存储为GeoJSON格式。 此外，弹性搜索输出提供的默认Elasticsearch模板将[geoip] [location]字段映射到Elasticsearch geo_point。</p>
<p>以下是elastic.co官方文档对于geo_point类型的解释</p>
<h5 id="用于索引字段"><a href="#用于索引字段" class="headerlink" title="用于索引字段"></a>用于索引字段</h5><p>geo_point映射将索引具有lat，lon格式的单个字段。lat_lon选项可以设置为也将.lat和.lon作为数字字段索引，geohash可以设置为true以索引.geohash值。</p>
<p>一个好的做法是启用索引lat_lon，因为geo距离和边界框过滤器可以使用内存检查或使用索引的lat lon值执行，并且它实际上取决于哪个数据集执行得更好。请注意，索引lat lon只有当字段有一个地理点值，而不是多个值时才有意义。</p>
<h5 id="Geohashes"><a href="#Geohashes" class="headerlink" title="Geohashes"></a>Geohashes</h5><p>地理散列是一种纬度/经度编码的形式，它将地球分成网格。此网格中的每个单元格都由geohash字符串表示。每个单元又可以被进一步细分成由较长串表示的较小单元。因此，geohash越长，单元格越小（从而更精确）。</p>
<p>因为geohash只是字符串，它们可以像任何其他字符串一样存储在倒排索引中，这使得查询非常有效。</p>
<p>如果启用geohash选项，geohash“子字段”将被索引为，例如pin.geohash。geohash的长度由geohash_precision参数控制，geohash_precision参数可以设置为绝对长度（例如12，默认值）或距离（例如1km）。</p>
<p>更有用的是，将geohash_prefix选项设置为true不仅可以索引geohash值，还可以索引所有包围的单元格。例如，u30的geohash将被索引为[u，u3，u30]。此选项可以由Geohash单元格过滤器用于非常有效地查找特定单元格中的地理位置。</p>
<p>geo_point类型支持4种方式，下面是官网给出的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"># mapping类型是geo_point</div><div class="line">PUT my_index</div><div class="line">&#123;</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;my_type&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;location&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;geo_point&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 方式1</div><div class="line">PUT my_index/my_type/1</div><div class="line">&#123;</div><div class="line">  &quot;text&quot;: &quot;Geo-point as an object&quot;,</div><div class="line">  &quot;location&quot;: &#123; </div><div class="line">    &quot;lat&quot;: 41.12,</div><div class="line">    &quot;lon&quot;: -71.34</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 方式2</div><div class="line">PUT my_index/my_type/2</div><div class="line">&#123;</div><div class="line">  &quot;text&quot;: &quot;Geo-point as a string&quot;,</div><div class="line">  &quot;location&quot;: &quot;41.12,-71.34&quot; </div><div class="line">&#125;</div><div class="line"></div><div class="line"># 方式3</div><div class="line">PUT my_index/my_type/3</div><div class="line">&#123;</div><div class="line">  &quot;text&quot;: &quot;Geo-point as a geohash&quot;,</div><div class="line">  &quot;location&quot;: &quot;drm3btev3e86&quot; </div><div class="line">&#125;</div><div class="line"></div><div class="line"># 方式4</div><div class="line">PUT my_index/my_type/4</div><div class="line">&#123;</div><div class="line">  &quot;text&quot;: &quot;Geo-point as an array&quot;,</div><div class="line">  &quot;location&quot;: [ -71.34, 41.12 ] </div><div class="line">&#125;</div><div class="line"></div><div class="line"># 查询方式</div><div class="line">GET my_index/_search</div><div class="line">&#123;</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;geo_bounding_box&quot;: &#123; </div><div class="line">      &quot;location&quot;: &#123;</div><div class="line">        &quot;top_left&quot;: &#123;</div><div class="line">          &quot;lat&quot;: 42,</div><div class="line">          &quot;lon&quot;: -72</div><div class="line">        &#125;,</div><div class="line">        &quot;bottom_right&quot;: &#123;</div><div class="line">          &quot;lat&quot;: 40,</div><div class="line">          &quot;lon&quot;: -74</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是翻译自elastic.co官方文档</p>
<p>说明：</p>
<ul>
<li>方式1：Geo-point表示为一个object，具有lat和lon两个key</li>
<li>方式2：Geo-point表示为一个string，格式为”lat,lon”</li>
<li>方式3：Geo-point表示为geohash</li>
<li>方式4：Geo-point表示为一个array，格式为: [lon, lat]</li>
<li>查询方式：地理边界框查询，它查找落在框内的所有geo-points</li>
</ul>
<p>注意：</p>
<p>string方式的geo-points顺序是lat,lon，而数组方式的geo-points顺序是反过来的lon,lat。最初，lat,lon用于数组和字符串，但是数组格式早期改变以符合GeoJSON使用的格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Please note that string geo-points are ordered as lat,lon, while array geo-points are ordered as the reverse: lon,lat.</div><div class="line"></div><div class="line">Originally, lat,lon was used for both array and string, but the array format was changed early on to conform to the format used by GeoJSON.</div></pre></td></tr></table></figure>
<h3 id="Kibana配置TileMap"><a href="#Kibana配置TileMap" class="headerlink" title="Kibana配置TileMap"></a>Kibana配置TileMap</h3><h5 id="创建TileMap视图"><a href="#创建TileMap视图" class="headerlink" title="创建TileMap视图"></a>创建TileMap视图</h5><p>在Visualization中选择创建TileMap</p>
<p><img src="http://img.blog.csdn.net/20170124100943166?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="配置TileMap"></p>
<h5 id="TileMap配置后的效果图"><a href="#TileMap配置后的效果图" class="headerlink" title="TileMap配置后的效果图"></a>TileMap配置后的效果图</h5><p>然后在索引中选择geoip.location字段，如下图左边所示。注意：我这里替换成了高德地图后的效果，具体可以参考Kibana系列的文章。</p>
<p><img src="http://img.blog.csdn.net/20170124101512772?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="ChinaMap"></p>
<h5 id="配置错误处理"><a href="#配置错误处理" class="headerlink" title="配置错误处理"></a>配置错误处理</h5><p>如果配置的过程中报错”No Compatible Fields: The “[nginx_access_logs<em>index</em>*]” index pattern does not contain any of the following field types: geo_point”</p>
<p>错误原因：这个错误是因为我们的geoip的location字段类型不是geo_point，之前尝试Logstash写入数据到ES的时候没有在nginx_access_logs<em>index</em>*索引模板中明确的指定geoip.location的类型，所以默认使用的dynamic_templates的配置，动态创建出来的geoip.location字段是string类型的，所以需要在ES的模板中指定好geoip.location字段的类型是geo_point。</p>
<p><img src="http://img.blog.csdn.net/20170123230821712?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmlyZGJlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Geohash错误"></p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.maxmind.com/zh/home" target="_blank" rel="external">https://www.maxmind.com/zh/home</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/ip.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/2.4/ip.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/geo-point.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/2.4/geo-point.html</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.4/plugins-filters-geoip.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.4/plugins-filters-geoip.html</a></li>
<li><a href="http://kibana.logstash.es/content/logstash/plugins/filter/geoip.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/plugins/filter/geoip.html</a></li>
<li><a href="https://github.com/logstash-plugins/logstash-filter-geoip/issues/12">https://github.com/logstash-plugins/logstash-filter-geoip/issues/12</a></li>
<li><a href="http://dev.maxmind.com/geoip/legacy/codes/iso3166/" target="_blank" rel="external">http://dev.maxmind.com/geoip/legacy/codes/iso3166/</a></li>
<li><a href="http://www.stats.gov.cn/tjsj/tjbz/xzqhdm/" target="_blank" rel="external">http://www.stats.gov.cn/tjsj/tjbz/xzqhdm/</a></li>
<li><a href="http://blog.csdn.net/yanggd1987/article/details/50469113" target="_blank" rel="external">http://blog.csdn.net/yanggd1987/article/details/50469113</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ELK/ELK学习（一）ELK收集Nginx日志" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/01/23/ELK/ELK学习（一）ELK收集Nginx日志/" class="article-date">
  	<time datetime="2017-01-23T09:35:14.000Z" itemprop="datePublished">2017-01-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/23/ELK/ELK学习（一）ELK收集Nginx日志/">ELK学习（一）ELK收集Nginx日志</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近公司的系统遇到了并发性能问题，需要分析系统各个接口的请求和响应时间，所以提议收集Nginx日志来进行分析。</p>
<h3 id="Nginx日志格式"><a href="#Nginx日志格式" class="headerlink" title="Nginx日志格式"></a>Nginx日志格式</h3><p>默认的Nginx配置文件/etc/nginx/nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">##</div><div class="line"># Logging Settings</div><div class="line">##</div><div class="line">log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; [$http_cookie] &quot;$http_x_forwarded_for&quot; $request_time $upstream_response_time $fastcgi_script_name&apos;;</div><div class="line"></div><div class="line">access_log  /var/log/nginx/access.log  main;</div><div class="line">error_log /var/log/nginx/error.log;</div></pre></td></tr></table></figure>
<h3 id="日志实例"><a href="#日志实例" class="headerlink" title="日志实例"></a>日志实例</h3><p>下面是几个具有典型代表的access.log日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">10.XXX.XXX.XX - - [23/Jan/2017:18:54:19 +0800] &quot;HEAD / HTTP/1.0&quot; 204 0 &quot;-&quot; &quot;-&quot; [-] &quot;-&quot; 0.019 0.001 /</div><div class="line">10.XXX.XXX.XX - - [23/Jan/2017:18:54:19 +0800] &quot;HEAD / HTTP/1.0&quot; 301 0 &quot;-&quot; &quot;-&quot; [-] &quot;-&quot; 0.018 - /</div><div class="line">10.XXX.XXX.XX - - [23/Jan/2017:18:54:18 +0800] &quot;GET /api/user/detail?ID=1234567890 HTTP/1.0&quot; 200 1778 &quot;-&quot; &quot;XYZ/2.1.1 (iPhone; iOS 10.2; Scale/2.00)&quot; [-] &quot;XXX.XXX.XX.XXX&quot; 0.011 0.010 /api/user/detail</div><div class="line">10.XXX.XXX.XX - - [23/Jan/2017:18:54:16 +0800] &quot;POST /api/user/relation HTTP/1.0&quot; 200 125 &quot;-&quot; &quot;ABC/4.2.1 (iPhone; iOS 10.2; Scale/2.00)&quot; [-] &quot;XXX.XXX.XX.XXX&quot; 0.073 0.071 /api/user/relation</div></pre></td></tr></table></figure>
<p>看到上面的日志实例，可能已经看出来不同的日志差别还是挺大的，有些日志缺少client_ip, upstream_response_time, ua等等，这些日志是阿里云健康检查的日志，所以后面我们会想办法处理这些日志的。</p>
<h3 id="Nginx日志参数"><a href="#Nginx日志参数" class="headerlink" title="Nginx日志参数"></a>Nginx日志参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$remote_addr : remote_addr代表客户端的IP，但它的值不是由客户端提供的，而是服务端根据客户端的IP指定的，当你的浏览器访问某个网站时，假设中间没有任何代理，那么网站的Web服务器（Nginx，Apache等）就会把remote_addr设为你的机器IP，如果你用了某个代理，那么你的浏览器会先访问这个代理，然后再由这个代理转发到网站，这样web服务器就会把remote_addr设为这台代理机器的IP。这里使用了阿里云的代理，所以是阿里云的内部IP地址。</div><div class="line">$remote_user : 已经经过Auth Basic Module验证的用户名</div><div class="line">$time_local : 通用日志格式下的本地时间</div><div class="line">$request : 客户端请求的动作（通常为GET或POST），请求的URL（带参数），HTTP协议版本</div><div class="line">$status : 请求状态</div><div class="line">$body_bytes_sent : 发送给客户端的字节数，不包括响应头的大小； 该变量与Apache模块mod_log_config里的“%B”参数兼容。</div><div class="line">$http_referer : 从哪个页面链接访问过来的</div><div class="line">$http_user_agent : 记录客户端浏览器相关信息</div><div class="line">$http_cookie : cookie的key和value</div><div class="line">$http_x_forwarded_for : 正如上面所述，当你使用了代理时，Web服务器就不知道你的真实IP了，为了避免这个情况，代理服务器通常会增加一个叫做x_forwarded_for的头信息，把连接它的客户端IP（即你的上网机器IP）加到这个头信息里，这样就能保证网站的Web服务器能获取到真实IP。一般情况下有可能是多个IP地址，第一个就是客户端的真实IP地址。</div><div class="line">$request_time : 指的就是从接受用户请求的第一个字节到发送完响应数据的时间，即包括接收请求数据时间、程序响应时间、输出响应数据时间。单位为秒，精度毫秒。</div><div class="line">$upstream_response_time : 是指从Nginx向后端（php-cgi)建立连接开始到接受完数据然后关闭连接为止的时间。</div><div class="line">$fastcgi_script_name : 请求的URL（不带参数）</div></pre></td></tr></table></figure>
<p>注意：</p>
<p>从上面的描述可以看出，$request_time肯定比$upstream_response_time值大，特别是使用POST方式传递参数时，因为Nginx会把request body缓存住，接受完毕后才会把数据一起发给后端。所以如果用户网络较差，或者传递数据较大时，$request_time会比$upstream_response_time大很多。</p>
<h3 id="Grok表达式"><a href="#Grok表达式" class="headerlink" title="Grok表达式"></a>Grok表达式</h3><p>Grok表达式的调试工具推荐使用</p>
<ul>
<li><a href="http://grokdebug.herokuapp.com" target="_blank" rel="external">http://grokdebug.herokuapp.com</a></li>
</ul>
<p>这里定义了一个名为NGINX_ACCESS_LOGS的Grok表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NGUSERNAME [a-zA-Z\.\@\-\+_%]+</div><div class="line">NGUSER %&#123;NGUSERNAME&#125;</div><div class="line">NGINX_ACCESS_LOGS %&#123;IPORHOST:server_ip&#125; %&#123;NGUSER:ident&#125; %&#123;NGUSER:auth&#125; \[%&#123;HTTPDATE:client_timestamp&#125;\] &quot;%&#123;WORD:http_method&#125; %&#123;DATA:url&#125; HTTP/%&#123;NUMBER:http_version&#125;&quot; %&#123;NUMBER:status_code&#125; (?:%&#123;NUMBER:http_bytes&#125;|-) &quot;(?:%&#123;DATA:refer_url&#125;|-)&quot; &quot;%&#123;DATA:ua&#125;&quot; \[(?:%&#123;GREEDYDATA:cookie&#125;|-)\] &quot;(?:%&#123;IPORHOST:client_ip&#125;|-)&quot; (?:%&#123;NUMBER:request_time&#125;|-) (?:%&#123;NUMBER:upstream_response_time&#125;|-) %&#123;GREEDYDATA:fastcgi_script_name&#125;</div></pre></td></tr></table></figure>
<p>Grok表达式的匹配结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;NGINX_ACCESS_LOGS&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX - - [23/Jan/2017:18:54:16 +0800] &quot;POST /api/user/relation HTTP/1.0&quot; 200 125 &quot;-&quot; &quot;ABC/4.2.1 (iPhone; iOS 10.2; Scale/2.00)&quot; [-] &quot;XXX.XXX.XX.XXX&quot; 0.073 0.071 /api/user/relation&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;server_ip&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;HOSTNAME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX&quot;,</div><div class="line">      &quot;XXX.XXX.XX.XXX&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IP&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IPV6&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IPV4&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;ident&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;NGUSERNAME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;,</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;auth&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;client_timestamp&quot;: [</div><div class="line">    [</div><div class="line">      &quot;23/Jan/2017:18:54:16 +0800&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MONTHDAY&quot;: [</div><div class="line">    [</div><div class="line">      &quot;23&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MONTH&quot;: [</div><div class="line">    [</div><div class="line">      &quot;Jan&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;YEAR&quot;: [</div><div class="line">    [</div><div class="line">      &quot;2017&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;TIME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;18:54:16&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;HOUR&quot;: [</div><div class="line">    [</div><div class="line">      &quot;18&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MINUTE&quot;: [</div><div class="line">    [</div><div class="line">      &quot;54&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;SECOND&quot;: [</div><div class="line">    [</div><div class="line">      &quot;16&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;INT&quot;: [</div><div class="line">    [</div><div class="line">      &quot;+0800&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_method&quot;: [</div><div class="line">    [</div><div class="line">      &quot;POST&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;url&quot;: [</div><div class="line">    [</div><div class="line">      &quot;/api/user/relation&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_version&quot;: [</div><div class="line">    [</div><div class="line">      &quot;1.0&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;BASE10NUM&quot;: [</div><div class="line">    [</div><div class="line">      &quot;1.0&quot;,</div><div class="line">      &quot;200&quot;,</div><div class="line">      &quot;125&quot;,</div><div class="line">      &quot;0.073&quot;,</div><div class="line">      &quot;0.071&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;status_code&quot;: [</div><div class="line">    [</div><div class="line">      &quot;200&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_bytes&quot;: [</div><div class="line">    [</div><div class="line">      &quot;125&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;refer_url&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;ua&quot;: [</div><div class="line">    [</div><div class="line">      &quot;ABC/4.2.1 (iPhone; iOS 10.2; Scale/2.00)&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;cookie&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;client_ip&quot;: [</div><div class="line">    [</div><div class="line">      &quot;XXX.XXX.XX.XXX&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;request_time&quot;: [</div><div class="line">    [</div><div class="line">      &quot;0.073&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;upstream_response_time&quot;: [</div><div class="line">    [</div><div class="line">      &quot;0.071&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;fastcgi_script_name&quot;: [</div><div class="line">    [</div><div class="line">      &quot;/api/user/relation&quot;</div><div class="line">    ]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里使用了Logstash默认定义的一些Grok表达式，下面列举了一些常用的Grok表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- IPORHOST : 匹配IP(IPv4或IPv6地址)</div><div class="line">- HTTPDATE : 匹配时间(默认格式：01/Jan/2017:00:00:01 +0800)</div><div class="line">- GREEDYDATA : 匹配字符串（.*）</div><div class="line">- DATA : 匹配字符串（.*?）</div><div class="line">- NUMBER : 匹配数字</div><div class="line">- QS : 带引号的字符串</div><div class="line">- WORD : 字符串，包括数字和大小写字母</div><div class="line">- NOTSPACE : 不带任何空格的字符串</div><div class="line">- SPACE : 空格字符串</div><div class="line">- URIPROTO : URI协议</div><div class="line">  比如：http、ftp等</div><div class="line">- URIHOST : URI主机</div><div class="line">  比如：www.baidu.com、10.10.1.11:8080等</div><div class="line">- URIPATH : URI路径</div><div class="line">  比如：//www.baidu.com/test/、/aaa.html等</div><div class="line">- URIPARAM : URI里的GET参数</div><div class="line">  比如：?a=1&amp;b=2&amp;c=3</div><div class="line">- URIPATHPARAM : URI路径+GET参数</div><div class="line">  比如：//www.baidu.com/test/aaa.html?a=1&amp;b=2&amp;c=3</div><div class="line">- URI : 完整的URI</div><div class="line">  比如：http://www.baidu.com/test/aaa.html?a=1&amp;b=2&amp;c=3</div></pre></td></tr></table></figure>
<p>具体内置的Grok表达式可以参考：</p>
<ul>
<li><a href="http://grokdebug.herokuapp.com/patterns#" target="_blank" rel="external">http://grokdebug.herokuapp.com/patterns#</a></li>
<li><a href="http://blog.csdn.net/tkchen/article/details/51815998" target="_blank" rel="external">http://blog.csdn.net/tkchen/article/details/51815998</a></li>
</ul>
<p>这里有几个地方让我有些迷惑：</p>
<ul>
<li>DATA和GREEDYDATA有什么区别</li>
<li>client_ip是”-“的情况怎么处理</li>
<li>upstream_response_time是”-“的情况怎么处理</li>
</ul>
<h5 id="DATA和GREEDYDATA的区别"><a href="#DATA和GREEDYDATA的区别" class="headerlink" title="DATA和GREEDYDATA的区别"></a>DATA和GREEDYDATA的区别</h5><p>实际上是下面正则表达式的区别</p>
<ul>
<li>.* : 贪婪模式</li>
<li>.*? : 勉强模式</li>
<li>.*+ : 侵占模式</li>
</ul>
<p>具体区别请参考：</p>
<ul>
<li><a href="http://stackoverflow.com/questions/3075130/what-is-the-difference-between-and-regular-expressions" target="_blank" rel="external">http://stackoverflow.com/questions/3075130/what-is-the-difference-between-and-regular-expressions</a></li>
<li><a href="http://www.cnblogs.com/kevin-yuan/archive/2012/09/02/2667428.html" target="_blank" rel="external">http://www.cnblogs.com/kevin-yuan/archive/2012/09/02/2667428.html</a></li>
</ul>
<h5 id="如何处理client-ip是”-“的情况"><a href="#如何处理client-ip是”-“的情况" class="headerlink" title="如何处理client_ip是”-“的情况"></a>如何处理client_ip是”-“的情况</h5><p>在Logstash中匹配client_ip为”-“的情况，然后将client_ip字段去掉，这样geoip解析的时候就不会报错了，后续会提供详细的配置文件</p>
<h5 id="如何处理upstream-response-time是”-“的情况"><a href="#如何处理upstream-response-time是”-“的情况" class="headerlink" title="如何处理upstream_response_time是”-“的情况"></a>如何处理upstream_response_time是”-“的情况</h5><p>upstream_response_time是”-“的情况比较好解决，只要稍微修改下Grok表达式即可，修改后如果upstream_response_time是”-“，Grok表达式提取出来的upstream_response_time的值就是null</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">修改前：%&#123;NUMBER:upstream_response_time&#125;</div><div class="line">修改后：(?:%&#123;NUMBER:upstream_response_time&#125;|-)</div></pre></td></tr></table></figure>
<p>以阿里云的健康检查请求日志为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">10.XXX.XXX.XX - - [23/Jan/2017:18:54:19 +0800] &quot;HEAD / HTTP/1.0&quot; 301 0 &quot;-&quot; &quot;-&quot; [-] &quot;-&quot; 0.018 - /</div></pre></td></tr></table></figure>
<p>匹配结果如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;NGINX_ACCESS_LOGS&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX - - [23/Jan/2017:18:54:19 +0800] &quot;HEAD / HTTP/1.0&quot; 301 0 &quot;-&quot; &quot;-&quot; [-] &quot;-&quot; 0.018 - /&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;server_ip&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;HOSTNAME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;10.XXX.XXX.XX&quot;,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IP&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IPV6&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;IPV4&quot;: [</div><div class="line">    [</div><div class="line">      null,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;ident&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;NGUSERNAME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;,</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;auth&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;client_timestamp&quot;: [</div><div class="line">    [</div><div class="line">      &quot;23/Jan/2017:18:54:19 +0800&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MONTHDAY&quot;: [</div><div class="line">    [</div><div class="line">      &quot;23&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MONTH&quot;: [</div><div class="line">    [</div><div class="line">      &quot;Jan&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;YEAR&quot;: [</div><div class="line">    [</div><div class="line">      &quot;2017&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;TIME&quot;: [</div><div class="line">    [</div><div class="line">      &quot;18:54:19&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;HOUR&quot;: [</div><div class="line">    [</div><div class="line">      &quot;18&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;MINUTE&quot;: [</div><div class="line">    [</div><div class="line">      &quot;54&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;SECOND&quot;: [</div><div class="line">    [</div><div class="line">      &quot;19&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;INT&quot;: [</div><div class="line">    [</div><div class="line">      &quot;+0800&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_method&quot;: [</div><div class="line">    [</div><div class="line">      &quot;HEAD&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;url&quot;: [</div><div class="line">    [</div><div class="line">      &quot;/&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_version&quot;: [</div><div class="line">    [</div><div class="line">      &quot;1.0&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;BASE10NUM&quot;: [</div><div class="line">    [</div><div class="line">      &quot;1.0&quot;,</div><div class="line">      &quot;301&quot;,</div><div class="line">      &quot;0&quot;,</div><div class="line">      &quot;0.018&quot;,</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;status_code&quot;: [</div><div class="line">    [</div><div class="line">      &quot;301&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;http_bytes&quot;: [</div><div class="line">    [</div><div class="line">      &quot;0&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;refer_url&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;ua&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;cookie&quot;: [</div><div class="line">    [</div><div class="line">      &quot;-&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;client_ip&quot;: [</div><div class="line">    [</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;request_time&quot;: [</div><div class="line">    [</div><div class="line">      &quot;0.018&quot;</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;upstream_response_time&quot;: [</div><div class="line">    [</div><div class="line">      null</div><div class="line">    ]</div><div class="line">  ],</div><div class="line">  &quot;fastcgi_script_name&quot;: [</div><div class="line">    [</div><div class="line">      &quot;/&quot;</div><div class="line">    ]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Logstash配置文件"><a href="#Logstash配置文件" class="headerlink" title="Logstash配置文件"></a>Logstash配置文件</h3><p>这里我们尽量把处理方式简化，在单一的服务器上安装好Nginx和ELK环境，对Nginx的access.log日志进行收集，解析，最终写入到ES中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [&quot;/home/yunyu/Downloads/access.log&quot;]</div><div class="line">        type =&gt; &quot;nginx_access&quot;</div><div class="line">        codec =&gt; &quot;plain&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">        ignore_older =&gt; 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    if [type] == &quot;nginx_access&quot; &#123;</div><div class="line">        grok &#123;</div><div class="line">            match =&gt; &#123;</div><div class="line">                &quot;message&quot; =&gt; &quot;%&#123;NGINX_ACCESS_LOGS&#125;&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if &quot;_grokparsefailure&quot; in [tags] &#123;</div><div class="line">            drop &#123; &#125;</div><div class="line">        &#125;</div><div class="line">        date &#123;</div><div class="line">            match =&gt; [&quot;client_timestamp&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</div><div class="line">            target =&gt; &quot;@timestamp&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    if [type] == &quot;nginx_access&quot; &#123;</div><div class="line">        elasticsearch &#123;</div><div class="line">            codec =&gt; &quot;json&quot;</div><div class="line">            hosts =&gt; [&quot;hadoop1:9200&quot;, &quot;hadoop2:9200&quot;, &quot;hadoop3:9200&quot;]</div><div class="line">            index =&gt; &quot;nginx_access_logs_index_%&#123;+YYYY.MM.dd&#125;&quot;</div><div class="line">            document_type =&gt; &quot;%&#123;type&#125;&quot;</div><div class="line">            template =&gt; &quot;/usr/local/elasticsearch/template/nginx_access_logs_template.json&quot;</div><div class="line">            template_name =&gt; &quot;nginx_access_logs_template&quot;</div><div class="line">            template_overwrite =&gt; true</div><div class="line">            workers =&gt; 1</div><div class="line">            flush_size =&gt; 20000</div><div class="line">            idle_flush_time =&gt; 10</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ES的索引Template模板"><a href="#ES的索引Template模板" class="headerlink" title="ES的索引Template模板"></a>ES的索引Template模板</h3><p>上面Logstash写入日志数据到ES的时候，使用了nginx_access_logs_template.json模板，下面是ES模板的具体配置。这里我们只是把Logstash提取出来的值按照ES的Template定义好的类型写入到ES索引中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;template&quot;: &quot;nginx_access_logs_index_*&quot;,</div><div class="line">  &quot;order&quot;:0,</div><div class="line">  &quot;settings&quot;: &#123;</div><div class="line">      &quot;index.number_of_replicas&quot;: &quot;1&quot;,</div><div class="line">      &quot;index.number_of_shards&quot;: &quot;5&quot;,</div><div class="line">      &quot;index.refresh_interval&quot;: &quot;10s&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;_default_&quot;: &#123;</div><div class="line">      &quot;_all&quot;: &#123;</div><div class="line">        &quot;enabled&quot;: false</div><div class="line">      &#125;,</div><div class="line">      &quot;dynamic_templates&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;my_string&quot;: &#123;</div><div class="line">            &quot;match_mapping_type&quot;: &quot;string&quot;,</div><div class="line">            &quot;mapping&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;fields&quot;: &#123;</div><div class="line">                &quot;raw&quot;: &#123;</div><div class="line">                  &quot;type&quot;: &quot;string&quot;,</div><div class="line">                  &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;nginx_access&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;ident&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;auth&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;client_ip&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;ip&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;client_timestamp&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_method&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;url&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;refer_url&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;status_code&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;http_bytes&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;ua&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;,</div><div class="line">          &quot;fields&quot;: &#123;</div><div class="line">            &quot;raw&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &quot;device_id&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;sdk_version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;host&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;path&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;type&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@timestamp&quot;: &#123;</div><div class="line">          &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;,</div><div class="line">          &quot;type&quot;: &quot;date&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-map-user-location-with-geoip-and-elk-elasticsearch-logstash-and-kibana" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-map-user-location-with-geoip-and-elk-elasticsearch-logstash-and-kibana</a></li>
<li><a href="http://kibana.logstash.es/content/logstash/examples/nginx-access.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/examples/nginx-access.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 birdben
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82900755-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>