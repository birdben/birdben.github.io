<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>birdben</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="birdben">
<meta property="og:url" content="https://github.com/birdben/page/12/index.html">
<meta property="og:site_name" content="birdben">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="birdben">
  
    <link rel="alternative" href="/atom.xml" title="birdben" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260188951'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260188951' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/logo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">birdben</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AWK/" style="font-size: 10.83px;">AWK</a> <a href="/tags/Akka/" style="font-size: 10.83px;">Akka</a> <a href="/tags/Dockerfile/" style="font-size: 20px;">Dockerfile</a> <a href="/tags/Docker命令/" style="font-size: 19.17px;">Docker命令</a> <a href="/tags/Docker环境/" style="font-size: 15px;">Docker环境</a> <a href="/tags/ELK/" style="font-size: 16.67px;">ELK</a> <a href="/tags/ElasticSearch/" style="font-size: 10.83px;">ElasticSearch</a> <a href="/tags/Elasticsearch/" style="font-size: 12.5px;">Elasticsearch</a> <a href="/tags/Flume/" style="font-size: 17.5px;">Flume</a> <a href="/tags/Git命令/" style="font-size: 13.33px;">Git命令</a> <a href="/tags/Go/" style="font-size: 14.17px;">Go</a> <a href="/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/tags/HDFS/" style="font-size: 18.33px;">HDFS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Hadoop原理架构体系/" style="font-size: 13.33px;">Hadoop原理架构体系</a> <a href="/tags/Hive/" style="font-size: 16.67px;">Hive</a> <a href="/tags/JVM/" style="font-size: 11.67px;">JVM</a> <a href="/tags/Java-Web，Socket，Python/" style="font-size: 10px;">Java Web，Socket，Python</a> <a href="/tags/Jenkins环境/" style="font-size: 10px;">Jenkins环境</a> <a href="/tags/Kafka/" style="font-size: 15.83px;">Kafka</a> <a href="/tags/Kibana/" style="font-size: 14.17px;">Kibana</a> <a href="/tags/Linux命令/" style="font-size: 12.5px;">Linux命令</a> <a href="/tags/Logstash/" style="font-size: 15.83px;">Logstash</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/MapReduce/" style="font-size: 11.67px;">MapReduce</a> <a href="/tags/Maven配置/" style="font-size: 11.67px;">Maven配置</a> <a href="/tags/MongoDB/" style="font-size: 11.67px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shadowsocks/" style="font-size: 10px;">Shadowsocks</a> <a href="/tags/Shell/" style="font-size: 16.67px;">Shell</a> <a href="/tags/Spring/" style="font-size: 10.83px;">Spring</a> <a href="/tags/Storm/" style="font-size: 12.5px;">Storm</a> <a href="/tags/Zookeeper/" style="font-size: 12.5px;">Zookeeper</a> <a href="/tags/其他/" style="font-size: 10px;">其他</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/birdben">我的CSDN的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">birdben</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/logo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">birdben</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Docker/Docker实战（十五）Docker安装Hive环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/25/Docker/Docker实战（十五）Docker安装Hive环境/" class="article-date">
  	<time datetime="2016-06-25T12:30:28.000Z" itemprop="datePublished">2016-06-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/25/Docker/Docker实战（十五）Docker安装Hive环境/">Docker实战（十五）Docker安装Hive环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="Hive安装"><a href="#Hive安装" class="headerlink" title="Hive安装"></a>Hive安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># Hive必须运行在Hadoop之上，则需要先安装Hadoop环境，而且还需要MySQL数据库，具体Hadoop安装请参考上一篇文章，我们这里继承上一篇已经安装好的Hadoop镜像</div><div class="line"></div><div class="line"># 下载Hive</div><div class="line">$ wget http://apache.mirrors.ionfish.org/hive/hive-1.2.1/apache-hive-1.2.1-bin.tar.gz</div><div class="line"></div><div class="line"># 解压Hive压缩包</div><div class="line">$ tar -zxvf apache-hive-1.2.1-bin.tar.gz</div><div class="line"></div><div class="line"># 下载MySQL驱动包</div><div class="line">$ wget http://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.38.tar.gz</div><div class="line"></div><div class="line"># 解压MySQL驱动压缩包</div><div class="line">$ tar -zxvf mysql-connector-java-5.1.38.tar.gz</div><div class="line"></div><div class="line"># 需要修改下面Hive相关的配置文件</div></pre></td></tr></table></figure>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/hive:v1</div><div class="line"># desc : 当前版本安装的hive</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 hadoop 镜像</div><div class="line">FROM birdben/hadoop:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 复制 hive-1.2.1 文件到镜像中（hive-1.2.1 文件夹要和Dockerfile文件在同一路径），这里直接把上一篇Hadoop环境直接用上了</div><div class="line">ADD apache-hive-1.2.1-bin /software/hive-1.2.1</div><div class="line"></div><div class="line"># 复制MySQL的驱动包到镜像中</div><div class="line">COPY mysql-connector-java-5.1.38/mysql-connector-java-5.1.38-bin.jar /software/hive-1.2.1/lib/mysql-connector-java-5.1.38-bin.jar</div><div class="line"></div><div class="line"># 授权HIVE_HOME路径给admin用户</div><div class="line">RUN sudo chown -R admin /software/hive-1.2.1</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/hive/Dockerfile">https://github.com/birdben/birdDocker/blob/master/hive/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:metastore]</div><div class="line">command=/software/hive-1.2.1/bin/hive --service metastore</div><div class="line"></div><div class="line">[program:hiveserver2]</div><div class="line">command=/software/hive-1.2.1/bin/hive --service hiveserver2</div></pre></td></tr></table></figure>
<h5 id="配置HIVE-HOME-conf-hive-env-sh（默认不存在，将hive-env-sh-template复制并改名为hive-env-sh）"><a href="#配置HIVE-HOME-conf-hive-env-sh（默认不存在，将hive-env-sh-template复制并改名为hive-env-sh）" class="headerlink" title="配置HIVE_HOME/conf/hive-env.sh（默认不存在，将hive-env.sh.template复制并改名为hive-env.sh）"></a>配置HIVE_HOME/conf/hive-env.sh（默认不存在，将hive-env.sh.template复制并改名为hive-env.sh）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">HADOOP_HOME=/software/hadoop-2.7.1</div></pre></td></tr></table></figure>
<h5 id="配置HIVE-HOME-conf-hive-log4j-properties（默认不存在，将hive-log4j-properties-template复制并改名为hive-log4j-properties）"><a href="#配置HIVE-HOME-conf-hive-log4j-properties（默认不存在，将hive-log4j-properties-template复制并改名为hive-log4j-properties）" class="headerlink" title="配置HIVE_HOME/conf/hive-log4j.properties（默认不存在，将hive-log4j.properties.template复制并改名为hive-log4j.properties）"></a>配置HIVE_HOME/conf/hive-log4j.properties（默认不存在，将hive-log4j.properties.template复制并改名为hive-log4j.properties）</h5><h5 id="配置HIVE-HOME-conf-hdfs-site-xml（默认不存在，将hive-default-xml-template复制并改名为hive-site-xml）"><a href="#配置HIVE-HOME-conf-hdfs-site-xml（默认不存在，将hive-default-xml-template复制并改名为hive-site-xml）" class="headerlink" title="配置HIVE_HOME/conf/hdfs-site.xml（默认不存在，将hive-default.xml.template复制并改名为hive-site.xml）"></a>配置HIVE_HOME/conf/hdfs-site.xml（默认不存在，将hive-default.xml.template复制并改名为hive-site.xml）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</div><div class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</div><div class="line"></div><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">    &lt;!-- metastore我的mysql不是在该server上，是在另一台Docker镜像中 --&gt;</div><div class="line">    &lt;name&gt;hive.metastore.local&lt;/name&gt;</div><div class="line">    &lt;value&gt;false&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">    &lt;!-- mysql服务的ip和端口号 --&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</div><div class="line">		&lt;value&gt;jdbc:mysql://172.17.0.2:3306/hive&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionDriveName&lt;/name&gt;</div><div class="line">		&lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</div><div class="line">		&lt;value&gt;root&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</div><div class="line">		&lt;value&gt;root&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">    &lt;!-- hive的仓库目录，需要在HDFS上创建，并修改权限 --&gt;</div><div class="line">		&lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;</div><div class="line">		&lt;value&gt;/hive/warehouse&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">    &lt;!-- 运行hive得主机地址及端口，即本机ip和端口号，启动metastore服务 --&gt;</div><div class="line">	  &lt;name&gt;hive.metastore.uris&lt;/name&gt;</div><div class="line">    &lt;value&gt;thrift://Ben:9083&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div></pre></td><td class="code"><pre><div class="line"># 先启动MySQL的Docker容器</div><div class="line">$ sudo docker run -p 9999:22 -p 3306:3306 -t -i -v /docker/mysql/data:/software/mysql-5.6.22/data birdben/mysql:v1</div><div class="line"></div><div class="line"># 然后查看MySQL的Docker容器的IP地址，Hive连接MySQL的IP地址需要配置这个IP</div><div class="line">$ sudo docker inspect --format &apos;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&apos; 34b5ac61b8bd</div><div class="line">$ 172.17.0.2</div><div class="line"></div><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/hive:v1&quot; .</div><div class="line"># 执行已经构件好的镜像，挂载在宿主机器的存储路径也不同，-h设置hostname，Hadoop配置文件需要使用</div><div class="line">$ docker run -h Ben -p 9998:22 -p 9083:9083 -p 9000:9000 -p 8088:8088 -p 50020:50020 -p 50070:50070 -p 50075:50075 -p 50090:50090 -t -i &apos;birdben/hive:v1&apos;</div><div class="line"></div><div class="line"></div><div class="line"># 然后直接通过ssh远程连接使用admin账号远程登录Hive的Docker容器</div><div class="line">$ ssh root@10.211.55.4 -p 9998</div><div class="line"></div><div class="line"># 启动hive shell，发现如下的错误，原因是还没有启动Hadoop，所以hive连接Hadoop时，报错java.net.ConnectException: Call From Ben/172.17.0.3 to Ben:9000 failed on connection exception: java.net.ConnectException: Connection refused;</div><div class="line"></div><div class="line">$ admin@Ben:/$ cd /software/hive-1.2.1/bin</div><div class="line">$ admin@Ben:/$ ./hive shell</div><div class="line">16/06/25 10:48:40 WARN conf.HiveConf: HiveConf of name hive.metastore.local does not exist</div><div class="line"></div><div class="line">Logging initialized using configuration in file:/software/hive-1.2.1/conf/hive-log4j.properties</div><div class="line">Exception in thread &quot;main&quot; java.lang.RuntimeException: java.net.ConnectException: Call From Ben/172.17.0.3 to Ben:9000 failed on connection exception: java.net.ConnectException: Connection refused; For more details see:  http://wiki.apache.org/hadoop/ConnectionRefused</div><div class="line"></div><div class="line"># 所以我们先启动Hadoop</div><div class="line"># 先初始化namenode</div><div class="line">$ admin@Ben:/$ cd /software/hadoop-2.7.1/bin</div><div class="line">$ admin@Ben:/software/hadoop-2.7.1/sbin$ ./hdfs namenode -format</div><div class="line"></div><div class="line"># 启动所有服务</div><div class="line">admin@Ben:/$ cd /software/hadoop-2.7.1/sbin</div><div class="line">admin@Ben:/software/hadoop-2.7.1/sbin$ ./start-all.sh</div><div class="line"></div><div class="line"># 执行jps命令之前需要先把$JAVA_HOME/bin添加到PATH环境变量</div><div class="line">admin@Ben:/$ export PATH=/software/jdk7/bin/:$PATH</div><div class="line"></div><div class="line"># 执行jps命令如果能看到下面的6个进程就说明Hadoop启动的没有问题</div><div class="line">admin@Ben:/software/hadoop-2.7.1/sbin$ jps</div><div class="line">985 Jps</div><div class="line">282 DataNode</div><div class="line">587 ResourceManager</div><div class="line">436 SecondaryNameNode</div><div class="line">166 NameNode</div><div class="line">691 NodeManager</div><div class="line"></div><div class="line"># 此时重新启动hive shell，就可以成功登录hive了</div><div class="line">$ admin@Ben:/$ cd /software/hive-1.2.1/bin</div><div class="line">$ admin@Ben:/$ ./hive shell</div><div class="line">hive&gt;</div><div class="line">hive&gt; show databases;</div><div class="line">OK</div><div class="line">default</div><div class="line">Time taken: 1.323 seconds, Fetched: 1 row(s)</div><div class="line"></div><div class="line"># 注意：这里我是使用了之前的MySQL的Docker镜像，因为之前的MySQL的Docker镜像已经处理了root账号的更改密码和远程登录授权问题，所以这里没有涉及这些问题，具体设置可以参考之前的Docker安装MySQL镜像的文章</div><div class="line"></div><div class="line"># 我们需要预先在mysql中创建一个hive的数据库，因为hive-site.xml是连接到这个hive数据库的，所有的hive元数据都是存在这个hive数据库中的</div><div class="line"># 我们在hive中创建新的数据库和表来验证hive的元数据都存储在mysql了</div><div class="line"></div><div class="line"># 在hive中创建一个新的数据库test_hive，test_hive这个数据库会对应mysql中的hive数据库中的DBS表中的一条记录</div><div class="line">hive&gt; CREATE DATABASE test_hive;</div><div class="line"></div><div class="line"># 在hive中创建一个新的表test_person，test_person这个表会对应mysql中的hive数据库中的TBLS表中的一条记录</div><div class="line">hive&gt; USE test_hive;</div><div class="line">hive&gt; CREATE TABLE test_person (id INT,name string) ROW FORMAT DELIMITED FIELDS TERMINATED BY &apos;\t&apos;;</div><div class="line"></div><div class="line"></div><div class="line"># 在hive创建表的时候可能会遇到如下问题，是因为MySQL数据库字符集设置的utf-8导致的</div><div class="line"># Specified key was too long; max key length is 767 bytes</div><div class="line"># 修改MySQL的hive数据库的字符集为latin1就好用了</div><div class="line">$ alter database hive character set latin1;</div><div class="line"># 参考：http://blog.163.com/zhangjie_0303/blog/static/990827062013112623615941/</div><div class="line"></div><div class="line"># test_person.txt</div><div class="line">1	John</div><div class="line">2	Ben</div><div class="line">3	Allen</div><div class="line">4	Jimmy</div><div class="line">5	Will</div><div class="line">6	Jackson</div><div class="line"></div><div class="line"># 用scp命令将本地test_person.txt文件传到hive的Docker容器中</div><div class="line">$ scp -P 9998 /Users/ben/workspace_git/birdDocker/hive/test_person.txt admin@10.211.55.4:/software/hive-1.2.1/</div><div class="line"></div><div class="line"># 导入数据到test_person.txt到test_person表</div><div class="line">hive&gt; LOAD DATA LOCAL INPATH &apos;/software/hive-1.2.1/test_person.txt&apos; OVERWRITE INTO TABLE test_person;</div><div class="line">Loading data to table test_hive.test_person</div><div class="line">Table test_hive.test_person stats: [numFiles=1, numRows=0, totalSize=45, rawDataSize=0]</div><div class="line">OK</div><div class="line">Time taken: 2.885 seconds</div><div class="line"></div><div class="line"># 查看test_person表数据</div><div class="line">hive&gt; select * from test_person;</div><div class="line">OK</div><div class="line">1	John</div><div class="line">2	Ben</div><div class="line">3	Allen</div><div class="line">4	Jimmy</div><div class="line">5	Will</div><div class="line">6	Jackson</div><div class="line">Time taken: 0.7 seconds, Fetched: 6 row(s)</div><div class="line"></div><div class="line"># 查看test_hive数据库在HDFS中存储的目录</div><div class="line">$ admin@Ben:$ cd /software/hadoop-2.7.1/bin</div><div class="line"></div><div class="line"># 查看HDFS中/hive/warehouse目录下的所有文件，此目录是在hive-site.xml中hive.metastore.warehouse.dir参数配置的路径/hive/warehouse</div><div class="line">$ admin@Ben:/software/hadoop-2.7.1/bin$ ./hdfs dfs -ls /hive/warehouse/</div><div class="line">Found 1 items</div><div class="line">drwxr-xr-x   - admin supergroup          0 2016-06-25 11:39 /hive/warehouse/test_hive.db</div><div class="line"></div><div class="line"># 查看test_person表在HDFS中存储的目录</div><div class="line">$ admin@Ben:/software/hadoop-2.7.1/bin$ ./hdfs dfs -ls /hive/warehouse/test_hive.db/</div><div class="line">Found 1 items</div><div class="line">drwxr-xr-x   - admin supergroup          0 2016-06-25 11:52 /hive/warehouse/test_hive.db/test_person</div><div class="line"></div><div class="line"># 在深入一层就能看到我们导入的文件test_person.txt了</div><div class="line">$ admin@Ben:/software/hadoop-2.7.1/bin$ ./hdfs dfs -ls /hive/warehouse/test_hive.db/test_person/</div><div class="line">Found 1 items</div><div class="line">-rwxr-xr-x   3 admin supergroup         45 2016-06-25 11:52 /hive/warehouse/test_hive.db/test_person/test_person.txt</div><div class="line"></div><div class="line"># 查看test_person.txt文件里的内容，就是我们导入的内容</div><div class="line">$ admin@Ben:/software/hadoop-2.7.1/bin$ ./hdfs dfs -cat /hive/warehouse/test_hive.db/test_person/test_person.txt</div><div class="line">1	John</div><div class="line">2	Ben</div><div class="line">3	Allen</div><div class="line">4	Jimmy</div><div class="line">5	Will</div><div class="line">6	Jackson</div><div class="line"></div><div class="line"># OK，大功告成了，可以回家了 ^_^</div></pre></td></tr></table></figure>
<h5 id="test-hive数据库在MySQL的hive数据库中的DBS表中的一条记录"><a href="#test-hive数据库在MySQL的hive数据库中的DBS表中的一条记录" class="headerlink" title="test_hive数据库在MySQL的hive数据库中的DBS表中的一条记录"></a>test_hive数据库在MySQL的hive数据库中的DBS表中的一条记录</h5><p><img src="http://img.blog.csdn.net/20160625194151411?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="DBS表"></p>
<h5 id="test-person表在MySQL的hive数据库中的TBLS表中的一条记录"><a href="#test-person表在MySQL的hive数据库中的TBLS表中的一条记录" class="headerlink" title="test_person表在MySQL的hive数据库中的TBLS表中的一条记录"></a>test_person表在MySQL的hive数据库中的TBLS表中的一条记录</h5><p><img src="http://img.blog.csdn.net/20160625194314403?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="TBLS表"></p>
<h5 id="元数据解析"><a href="#元数据解析" class="headerlink" title="元数据解析"></a>元数据解析</h5><p>在MySQL可以查看Hive元数据表，除了DBS和TBLS存储数据库和表的基本信息，其他表的说明见下表:</p>
<table>
<thead>
<tr>
<th>MySQL的表</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BUCKETING_COLS</td>
<td>Hive表CLUSTERED BY字段信息(字段名，字段序号)</td>
</tr>
<tr>
<td>CDS</td>
</tr>
<tr>
<td>COLUMNS_V2</td>
<td>存放表格的字段信息</td>
</tr>
<tr>
<td>DATABASE_PARAMS    </td>
</tr>
<tr>
<td>DBS</td>
<td>存放hive所有数据库信息</td>
</tr>
<tr>
<td>FUNCS    </td>
</tr>
<tr>
<td>FUNC_RU    </td>
</tr>
<tr>
<td>GLOBAL_PRIVS    </td>
</tr>
<tr>
<td>PARTITIONS</td>
<td>Hive表分区信息(创建时间，具体的分区)</td>
</tr>
<tr>
<td>PARTITION_KEYS</td>
<td>Hive分区表分区键(名称，类型，comment，序号)</td>
</tr>
<tr>
<td>PARTITION_KEY_VALS</td>
<td>Hive表分区名(键值，序号)</td>
</tr>
<tr>
<td>PARTITION_PARAMS    </td>
</tr>
<tr>
<td>PART_COL_STATS    </td>
</tr>
<tr>
<td>ROLES    </td>
</tr>
<tr>
<td>SDS</td>
<td>所有hive表、表分区所对应的hdfs数据目录和数据格式。</td>
</tr>
<tr>
<td>SD_PARAMS    </td>
</tr>
<tr>
<td>SEQUENCE_TABLE</td>
<td>SEQUENCE_TABLE表保存了hive对象的下一个可用ID，如’org.apache.hadoop.hive.metastore.model.MTable’, 21，则下一个新创建的hive表其TBL_ID就是21，同时SEQUENCE_TABLE表中271786被更新为26(这里每次都是+5)。同样，COLUMN，PARTITION等都有相应的记录</td>
</tr>
<tr>
<td>SERDES</td>
<td>Hive表序列化反序列化使用的类库信息</td>
</tr>
<tr>
<td>SERDE_PARAMS</td>
<td>序列化反序列化信息，如行分隔符、列分隔符、NULL的表示字符等</td>
</tr>
<tr>
<td>SKEWED_COL_NAMES    </td>
</tr>
<tr>
<td>SKEWED_COL_VALUE_LOC_MAP    </td>
</tr>
<tr>
<td>SKEWED_STRING_LIST    </td>
</tr>
<tr>
<td>SKEWED_STRING_LIST_VALUES    </td>
</tr>
<tr>
<td>SKEWED_VALUES    </td>
</tr>
<tr>
<td>SORT_COLS</td>
<td>Hive表SORTED BY字段信息(字段名，sort类型，字段序号)</td>
</tr>
<tr>
<td>TABLE_PARAMS</td>
<td>表级属性，如是否外部表，表注释等</td>
</tr>
<tr>
<td>TAB_COL_STATS    </td>
</tr>
<tr>
<td>TBLS</td>
<td>所有hive表的基本信息</td>
</tr>
<tr>
<td>VERSION    </td>
</tr>
</tbody>
</table>
<p>参考文章：</p>
<ul>
<li><a href="http://my.oschina.net/u/204498/blog/522772" target="_blank" rel="external">http://my.oschina.net/u/204498/blog/522772</a></li>
<li><a href="http://blog.fens.me/hadoop-hive-intro/" target="_blank" rel="external">http://blog.fens.me/hadoop-hive-intro/</a></li>
<li><a href="http://www.mincoder.com/article/5809.shtml" target="_blank" rel="external">http://www.mincoder.com/article/5809.shtml</a></li>
<li><a href="http://blog.163.com/zhangjie_0303/blog/static/990827062013112623615941/" target="_blank" rel="external">http://blog.163.com/zhangjie_0303/blog/static/990827062013112623615941/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hive/">Hive</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Linux/Linux常用命令（二）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/25/Linux/Linux常用命令（二）/" class="article-date">
  	<time datetime="2016-06-25T05:38:11.000Z" itemprop="datePublished">2016-06-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/25/Linux/Linux常用命令（二）/">Linux常用命令（二）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="scp命令"><a href="#scp命令" class="headerlink" title="scp命令"></a>scp命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># 获取远程服务器上的文件</div><div class="line">$ scp -P 2222 root@192.168.1.100:/root/tomcat.tar.gz /home/tomcat.tar.gz</div><div class="line"></div><div class="line"># -P是端口号参数，2222表示更改SSH端口后的端口，如果没有更改SSH端口可以不用添加该参数 </div><div class="line"># root@192.168.1.100 表示使用root用户登录远程服务器192.168.1.100</div><div class="line"># :/root/tomcat.tar.gz 表示远程服务器上的文件</div><div class="line"># /home/tomcat.tar.gz 表示保存在本地上的路径和文件名</div><div class="line"></div><div class="line"># 获取远程服务器上的目录</div><div class="line">$ scp -P 2222 -r root@192.168.1.100:/root/tomcat/ /home/ben/dev/</div><div class="line"></div><div class="line"># -P是端口号参数，2222表示更改SSH端口后的端口，如果没有更改SSH端口可以不用添加该参数</div><div class="line"># -r参数表示递归复制（即复制该目录下面的文件和目录）</div><div class="line"># root@192.168.1.100 表示使用root用户登录远程服务器192.168.1.100</div><div class="line"># :/root/tomcat/ 表示远程服务器上的目录</div><div class="line"># /home/ben/dev/ 表示保存在本地上的路径。</div><div class="line"></div><div class="line"># 将本地文件上传到服务器上</div><div class="line">$ scp -P 2222 /home/tomcat.tar.gz root@192.168.1.100:/root/tomcat.tar.gz</div><div class="line"></div><div class="line"># -P是端口号参数，2222表示更改SSH端口后的端口，如果没有更改SSH端口可以不用添加该参数。 </div><div class="line"># /home/tomcat.tar.gz 表示本地上准备上传文件的路径和文件名</div><div class="line"># root@192.168.1.100 表示使用root用户登录远程服务器</div><div class="line"></div><div class="line"># 将本地目录上传到服务器上</div><div class="line">$ scp -P 2222 -r /home/tomcat/ root@192.168.1.100:/root/dev/tomcat/</div><div class="line"></div><div class="line"># -P是端口号参数，2222表示更改SSH端口后的端口，如果没有更改SSH端口可以不用添加该参数。</div><div class="line"># -r 参数表示递归复制（即复制该目录下面的文件和目录）</div><div class="line"># /home/tomcat/表示准备要上传的目录</div><div class="line"># root@192.168.1.100 表示使用root用户登录远程服务器192.168.1.100</div><div class="line"># :/root/dev/tomcat/ 表示保存在远程服务器上的目录位置。</div></pre></td></tr></table></figure>
<h3 id="nc命令"><a href="#nc命令" class="headerlink" title="nc命令"></a>nc命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 今天学到了另一种远程传输文件的方式，原来只知道scp，rz/sz</div><div class="line"># 远程服务器（目的主机监听）</div><div class="line"># 命令格式：nc -l 监听端口&lt;未使用端口&gt; &gt; 要接收的文件名</div><div class="line">$ nc -l 9999 &gt; elasticsearch-jdbc-1.7.3.0-dist.zip</div><div class="line"># 解释：远程服务器开启一个9999的端口进行监听，并且等待接收elasticsearch-jdbc-1.7.3.0-dist.zip文件</div><div class="line"></div><div class="line"># 本地机器（源主机发起请求）</div><div class="line"># 命令格式：nc 目的主机ip 目的端口 &lt; 要发送的文件</div><div class="line">$ nc 10.120.10.105 9999 &lt; /Users/ben/Downloads/letv/ES/elasticsearch-jdbc-1.7.3.0-dist.zip</div><div class="line"># 解释：本地机器指定远程服务器的ip地址和port端口号将指定的本地文件传送到远程服务器</div></pre></td></tr></table></figure>
<h3 id="rz-sz命令"><a href="#rz-sz命令" class="headerlink" title="rz/sz命令"></a>rz/sz命令</h3><h5 id="Zmodem（rz-sz命令）一般需要和SSH客户端一起配合使用"><a href="#Zmodem（rz-sz命令）一般需要和SSH客户端一起配合使用" class="headerlink" title="Zmodem（rz/sz命令）一般需要和SSH客户端一起配合使用"></a>Zmodem（rz/sz命令）一般需要和SSH客户端一起配合使用</h5><p>下面介绍两种客户端</p>
<ol>
<li>iterm2（适用Mac环境）</li>
<li>secureCRT（适用Windows环境）</li>
</ol>
<h4 id="iterm2"><a href="#iterm2" class="headerlink" title="iterm2"></a>iterm2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">1. 安装brew工具</div><div class="line">$ brew install lszrz</div><div class="line"># 如果没有brew工具，请参考：http://blog.csdn.net/tsxw24/article/details/15500517</div><div class="line">2. 下载iterm2-zmodem到/usr/local/bin目录（将两个shell脚本放到/usr/local/bin/目录下然后开始配置）</div><div class="line">$ sudo wget https://raw.github.com/mmastrac/iterm2-zmodem/master/iterm2-send-zmodem.sh </div><div class="line">$ sudo wget https://raw.github.com/mmastrac/iterm2-zmodem/master/iterm2-recv-zmodem.sh </div><div class="line">$ sudo chmod 777 /usr/local/bin/iterm2-*</div><div class="line">3. 运行下载的iterm，添加trigger</div><div class="line">打开iterm2 --&gt;  同时按command和,键 --&gt; Profiles --&gt; Default --&gt; Advanced --&gt; Triggers的Edit按钮</div><div class="line">4. Triggers的设置代码如下 </div><div class="line">Regular expression: \*\*B0100</div><div class="line">Action: Run Silent Coprocess </div><div class="line">Parameters: /usr/local/bin/iterm2-send-zmodem.sh</div><div class="line"></div><div class="line">Regular expression: \*\*B00000000000000</div><div class="line">Action: Run Silent Coprocess </div><div class="line">Parameters: /usr/local/bin/iterm2-recv-zmodem.sh</div><div class="line">5. 上传和下载文件和secureCRT方式一样</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160622214939271?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="iterm2"></p>
<h4 id="secureCRT"><a href="#secureCRT" class="headerlink" title="secureCRT"></a>secureCRT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 上传文件</div><div class="line">1. 打开secureCRT,通过SSH连到至远程linux主机</div><div class="line">2. 键入rz命令</div><div class="line">3. 在跳出的窗口选择想要上传的文件</div><div class="line">4. 点击ADD后加入传输列表</div><div class="line">5. 点击确认以后传送文件</div><div class="line">6. 查看状态，一般都是发送正功</div><div class="line">7. 查看目录，确定刚才选的文件已经上传成功</div><div class="line"></div><div class="line"># 下载文件</div><div class="line">1. 远程连接到linux主机</div><div class="line">2. 输入sz fileName</div><div class="line">3. 在弹出的窗口中选择保存文件到本地的目录</div><div class="line">4. 确定后，等待文件下载完成</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://www.vpser.net/manage/scp.html" target="_blank" rel="external">http://www.vpser.net/manage/scp.html</a></li>
<li><a href="http://blog.csdn.net/u014552288/article/details/38349827" target="_blank" rel="external">http://blog.csdn.net/u014552288/article/details/38349827</a></li>
<li><a href="http://blog.csdn.net/tsxw24/article/details/15500517" target="_blank" rel="external">http://blog.csdn.net/tsxw24/article/details/15500517</a></li>
<li><a href="http://wenku.baidu.com/link?url=QV3BHlMEVRd7c2Nlw8p4_o9z6qXecNoGACOLLGdYxP3qnM8XIujaUPk4ZZZl83Docq4fxxl3BMRijuVAy4yryGVdlFB1jM9JDzGs5L5eHuO" target="_blank" rel="external">http://wenku.baidu.com/link?url=QV3BHlMEVRd7c2Nlw8p4_o9z6qXecNoGACOLLGdYxP3qnM8XIujaUPk4ZZZl83Docq4fxxl3BMRijuVAy4yryGVdlFB1jM9JDzGs5L5eHuO</a></li>
<li><a href="http://jingyan.baidu.com/article/b24f6c822bdabc86bee5da64.html" target="_blank" rel="external">http://jingyan.baidu.com/article/b24f6c822bdabc86bee5da64.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（十四）Docker安装Hadoop环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/20/Docker/Docker实战（十四）Docker安装Hadoop环境/" class="article-date">
  	<time datetime="2016-06-20T15:42:27.000Z" itemprop="datePublished">2016-06-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/20/Docker/Docker实战（十四）Docker安装Hadoop环境/">Docker实战（十四）Docker安装Hadoop环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="Hadoop安装"><a href="#Hadoop安装" class="headerlink" title="Hadoop安装"></a>Hadoop安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 需要提前安装ssh</div><div class="line">$ apt-get install ssh</div><div class="line">$ apt-get install openssh-server</div><div class="line"></div><div class="line"># 设置免密码登录，生成私钥和公钥</div><div class="line">$ ssh-keygen -t rsa -P &quot;&quot;</div><div class="line">$ cat ~/.ssh/id_rsa.put &gt;&gt; ~/.ssh/authorized_keys</div><div class="line"></div><div class="line"># 测试是否可以免密码登录</div><div class="line">$ ssh localhost</div><div class="line"></div><div class="line"># 下载Hadoop</div><div class="line">$ curl -O http://mirrors.cnnic.cn/apache/hadoop/common/hadoop-2.7.1/hadoop-2.7.1.tar.gz</div><div class="line"></div><div class="line"># 解压Hadoop压缩包</div><div class="line">$ tar -xf hadoop-2.7.1.tar.gz</div></pre></td></tr></table></figure>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/hadoop:v1</div><div class="line"># desc : 当前版本安装的hadoop</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 jdk7 镜像</div><div class="line">FROM birdben/jdk7:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 设置 hadoop 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV HADOOP_HOME /software/hadoop-2.7.1</div><div class="line">ENV PATH $&#123;HADOOP_HOME&#125;/bin:$PATH</div><div class="line"></div><div class="line"># 复制 hadoop-2.7.1 文件到镜像中（hadoop-2.7.1 文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD hadoop-2.7.1 /software/hadoop-2.7.1</div><div class="line"></div><div class="line"># 创建HDFS存储路径</div><div class="line">RUN mkdir -p $HADOOP_HOME/hdfs/name</div><div class="line">RUN mkdir -p $HADOOP_HOME/hdfs/data</div><div class="line"></div><div class="line"># 授权HADOOP_HOME路径给admin用户</div><div class="line">RUN sudo chown -R admin /software/hadoop-2.7.1</div><div class="line"></div><div class="line"># 容器需要开放Hadoop 9000端口</div><div class="line">EXPOSE 9000</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/hadoop/Dockerfile">https://github.com/birdben/birdDocker/blob/master/hadoop/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line"># 暂时没用使用supervsord启动Hadoop，因为没研究明白如何启动的时候不需要ssh输入密码，即使设置了ENV DEBIAN_FRONTEND noninteractive所有的操作的是非交互的也不好用，所以只能启动Docker容器之后手动再启动Hadoop</div><div class="line"># [program:hadoop]</div><div class="line"># command=$HADOOP_HOME/bin/hdfs namenode -format</div><div class="line"># command=$HADOOP_HOME/sbin/start_all.sh</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-hadoop-env-sh，添加以下内容"><a href="#配置HADOOP-HOME-etc-hadoop-hadoop-env-sh，添加以下内容" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/hadoop-env.sh，添加以下内容"></a>配置HADOOP_HOME/etc/hadoop/hadoop-env.sh，添加以下内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export JAVA_HOME=/software/jdk7</div><div class="line">export PATH=$PATH:/software/hadoop-2.7.1/bin</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-yarn-env-sh，添加以下内容"><a href="#配置HADOOP-HOME-etc-hadoop-yarn-env-sh，添加以下内容" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/yarn-env.sh，添加以下内容"></a>配置HADOOP_HOME/etc/hadoop/yarn-env.sh，添加以下内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export JAVA_HOME=/software/jdk7</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-core-site-xml，这里的Ben是我Docker容器的hostname，读者自行把Ben替换成自己的hostname（下同）"><a href="#配置HADOOP-HOME-etc-hadoop-core-site-xml，这里的Ben是我Docker容器的hostname，读者自行把Ben替换成自己的hostname（下同）" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/core-site.xml，这里的Ben是我Docker容器的hostname，读者自行把Ben替换成自己的hostname（下同）"></a>配置HADOOP_HOME/etc/hadoop/core-site.xml，这里的Ben是我Docker容器的hostname，读者自行把Ben替换成自己的hostname（下同）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;fs.defaultFS&lt;/name&gt;</div><div class="line">    &lt;value&gt;hdfs://Ben:9000&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:/software/hadoop-2.7.1/tmp&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-hdfs-site-xml"><a href="#配置HADOOP-HOME-etc-hadoop-hdfs-site-xml" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/hdfs-site.xml"></a>配置HADOOP_HOME/etc/hadoop/hdfs-site.xml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.datanode.ipc.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;Ben:50020&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.datanode.http.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;Ben:50075&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:/software/hadoop-2.7.1/hdfs/name&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:/software/hadoop-2.7.1/hdfs/data&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.namenode.secondary.http-address&lt;/name&gt;</div><div class="line">    &lt;value&gt;Ben:50090&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-mapred-site-xml-默认不存在，需要自建"><a href="#配置HADOOP-HOME-etc-hadoop-mapred-site-xml-默认不存在，需要自建" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/mapred-site.xml,默认不存在，需要自建"></a>配置HADOOP_HOME/etc/hadoop/mapred-site.xml,默认不存在，需要自建</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</div><div class="line">    &lt;value&gt;yarn&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="配置HADOOP-HOME-etc-hadoop-yarn-site-xml"><a href="#配置HADOOP-HOME-etc-hadoop-yarn-site-xml" class="headerlink" title="配置HADOOP_HOME/etc/hadoop/yarn-site.xml"></a>配置HADOOP_HOME/etc/hadoop/yarn-site.xml</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</div><div class="line">    &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/hadoop:v1&quot; .</div><div class="line"># 执行已经构件好的镜像，挂载在宿主机器的存储路径也不同，-h设置hostname（即上面所说的Docker容器的hostname【Ben】），Hadoop配置文件需要使用</div><div class="line">$ docker run -h Ben -p 9999:22 -p 9000:9000 -p 8088:8088 -p 50020:50020 -p 50070:50070 -p 50075:50075 -p 50090:50090 -t -i &apos;birdben/hadoop:v1&apos;</div></pre></td></tr></table></figure>
<h5 id="用SSH登录admin账号启动Hadoop并且查看JPS"><a href="#用SSH登录admin账号启动Hadoop并且查看JPS" class="headerlink" title="用SSH登录admin账号启动Hadoop并且查看JPS"></a>用SSH登录admin账号启动Hadoop并且查看JPS</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"># 此时可以通过ssh远程连接Docker容器了</div><div class="line">$ ssh root@10.211.55.4 -p 9999</div><div class="line"></div><div class="line"># 先初始化namenode</div><div class="line">admin@Ben:/$ cd /software/hadoop-2.7.1/bin</div><div class="line">admin@Ben:/software/hadoop-2.7.1/sbin$ ./hdfs namenode -format</div><div class="line"></div><div class="line"># 看到类似下面的信息就说明初始化namenode成功了</div><div class="line">16/06/06 03:27:57 INFO namenode.FSNamesystem: Retry cache will use 0.03 of total heap and retry cache entry expiry time is 600000 millis</div><div class="line">16/06/06 03:27:57 INFO util.GSet: Computing capacity for map NameNodeRetryCache</div><div class="line">16/06/06 03:27:57 INFO util.GSet: VM type       = 64-bit</div><div class="line">16/06/06 03:27:57 INFO util.GSet: 0.029999999329447746% max memory 889 MB = 273.1 KB</div><div class="line">16/06/06 03:27:57 INFO util.GSet: capacity      = 2^15 = 32768 entries</div><div class="line">16/06/06 03:27:57 INFO namenode.FSImage: Allocated new BlockPoolId: BP-581626940-172.17.0.2-1465183677567</div><div class="line">16/06/06 03:27:57 INFO common.Storage: Storage directory /software/hadoop-2.7.1/hdfs/name has been successfully formatted.</div><div class="line">16/06/06 03:27:57 INFO namenode.NNStorageRetentionManager: Going to retain 1 images with txid &gt;= 0</div><div class="line">16/06/06 03:27:57 INFO util.ExitUtil: Exiting with status 0</div><div class="line">16/06/06 03:27:57 INFO namenode.NameNode: SHUTDOWN_MSG:</div><div class="line">/************************************************************</div><div class="line">SHUTDOWN_MSG: Shutting down NameNode at Ben/172.17.0.2</div><div class="line">************************************************************/</div><div class="line"></div><div class="line"># 启动所有服务</div><div class="line">admin@Ben:/$ cd /software/hadoop-2.7.1/sbin</div><div class="line">admin@Ben:/software/hadoop-2.7.1/sbin$ ./start-all.sh</div><div class="line"></div><div class="line"># 下面的过程就是启动Hadoop的过程，但是始终需要输入ssh的密码，不知道为啥</div><div class="line">This script is Deprecated. Instead use start-dfs.sh and start-yarn.sh</div><div class="line">Starting namenodes on [Ben]</div><div class="line">Ben: Could not create directory &apos;/home/admin/.ssh&apos;.</div><div class="line">The authenticity of host &apos;ben (172.17.0.2)&apos; can&apos;t be established.</div><div class="line">ECDSA key fingerprint is ae:ec:44:6d:64:48:e8:34:17:33:cf:86:07:20:e3:4d.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Ben: Failed to add the host to the list of known hosts (/home/admin/.ssh/known_hosts).</div><div class="line">admin@ben&apos;s password:</div><div class="line">Ben: Could not chdir to home directory /home/admin: No such file or directory</div><div class="line">Ben: starting namenode, logging to /software/hadoop-2.7.1/logs/hadoop-admin-namenode-Ben.out</div><div class="line">localhost: Could not create directory &apos;/home/admin/.ssh&apos;.</div><div class="line">The authenticity of host &apos;localhost (::1)&apos; can&apos;t be established.</div><div class="line">ECDSA key fingerprint is ae:ec:44:6d:64:48:e8:34:17:33:cf:86:07:20:e3:4d.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">localhost: Failed to add the host to the list of known hosts (/home/admin/.ssh/known_hosts).</div><div class="line">admin@localhost&apos;s password:</div><div class="line">localhost: Could not chdir to home directory /home/admin: No such file or directory</div><div class="line">localhost: starting datanode, logging to /software/hadoop-2.7.1/logs/hadoop-admin-datanode-Ben.out</div><div class="line">Starting secondary namenodes [Ben]</div><div class="line">Ben: Could not create directory &apos;/home/admin/.ssh&apos;.</div><div class="line">The authenticity of host &apos;ben (172.17.0.2)&apos; can&apos;t be established.</div><div class="line">ECDSA key fingerprint is ae:ec:44:6d:64:48:e8:34:17:33:cf:86:07:20:e3:4d.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Ben: Failed to add the host to the list of known hosts (/home/admin/.ssh/known_hosts).</div><div class="line">admin@ben&apos;s password:</div><div class="line">Ben: Could not chdir to home directory /home/admin: No such file or directory</div><div class="line">Ben: starting secondarynamenode, logging to /software/hadoop-2.7.1/logs/hadoop-admin-secondarynamenode-Ben.out</div><div class="line">starting yarn daemons</div><div class="line">starting resourcemanager, logging to /software/hadoop-2.7.1/logs/yarn-admin-resourcemanager-Ben.out</div><div class="line">localhost: Could not create directory &apos;/home/admin/.ssh&apos;.</div><div class="line">The authenticity of host &apos;localhost (::1)&apos; can&apos;t be established.</div><div class="line">ECDSA key fingerprint is ae:ec:44:6d:64:48:e8:34:17:33:cf:86:07:20:e3:4d.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">localhost: Failed to add the host to the list of known hosts (/home/admin/.ssh/known_hosts).</div><div class="line">admin@localhost&apos;s password:</div><div class="line">localhost: Could not chdir to home directory /home/admin: No such file or directory</div><div class="line">localhost: starting nodemanager, logging to /software/hadoop-2.7.1/logs/yarn-admin-nodemanager-Ben.out</div><div class="line"></div><div class="line"># 执行jps命令之前需要先把$JAVA_HOME/bin添加到PATH环境变量</div><div class="line">admin@Ben:/$ export PATH=/software/jdk7/bin/:$PATH</div><div class="line"></div><div class="line"># 执行jps命令如果能看到下面的6个进程就说明Hadoop启动的没有问题</div><div class="line">admin@Ben:/software/hadoop-2.7.1/sbin$ jps</div><div class="line">985 Jps</div><div class="line">282 DataNode</div><div class="line">587 ResourceManager</div><div class="line">436 SecondaryNameNode</div><div class="line">166 NameNode</div><div class="line">691 NodeManager</div></pre></td></tr></table></figure>
<h5 id="在Ubuntu宿主机浏览器查看"><a href="#在Ubuntu宿主机浏览器查看" class="headerlink" title="在Ubuntu宿主机浏览器查看"></a>在Ubuntu宿主机浏览器查看</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 查看namenode状态：</div><div class="line">http://127.0.0.1:50070/</div><div class="line"></div><div class="line"># 查看yarn状态：</div><div class="line">http://127.0.0.1:8088/</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://my.oschina.net/adrianlynn/blog/505475?fromerr=n1qLgsaT" target="_blank" rel="external">http://my.oschina.net/adrianlynn/blog/505475?fromerr=n1qLgsaT</a></li>
<li><a href="http://my.oschina.net/u/204498/blog/519789?fromerr=9ZYyEtZm" target="_blank" rel="external">http://my.oschina.net/u/204498/blog/519789?fromerr=9ZYyEtZm</a></li>
<li><a href="http://blog.csdn.net/zhaogezhuoyuezhao/article/details/8426910" target="_blank" rel="external">http://blog.csdn.net/zhaogezhuoyuezhao/article/details/8426910</a></li>
<li><a href="http://tashan10.com/yong-dockerda-jian-hadoopwei-fen-bu-shi-ji-qun/" target="_blank" rel="external">http://tashan10.com/yong-dockerda-jian-hadoopwei-fen-bu-shi-ji-qun/</a></li>
<li>集群</li>
<li><a href="http://blog.csdn.net/peace1213/article/details/51334508" target="_blank" rel="external">http://blog.csdn.net/peace1213/article/details/51334508</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（十三）Docker安装MySQL数据库" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/19/Docker/Docker实战（十三）Docker安装MySQL数据库/" class="article-date">
  	<time datetime="2016-06-19T07:20:57.000Z" itemprop="datePublished">2016-06-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/19/Docker/Docker实战（十三）Docker安装MySQL数据库/">Docker实战（十三）Docker安装MySQL数据库</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基本步骤和之前几篇文章一样，请参考前面的相关文章</p>
<h5 id="Ubuntu安装MySQL安装"><a href="#Ubuntu安装MySQL安装" class="headerlink" title="Ubuntu安装MySQL安装"></a>Ubuntu安装MySQL安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line">（1）安装编译源码需要的包</div><div class="line">sudo apt-get install make cmake gcc g++ bison libncurses5-dev build-essential</div><div class="line"></div><div class="line">（2）下载并解压缩</div><div class="line">mysql-5.6.26.tar.gz</div><div class="line">tar -zxvf mysql-5.6.26.tar.gz</div><div class="line">cd mysql-5.6.26</div><div class="line"></div><div class="line">（3）编译安装</div><div class="line">编译配置：</div><div class="line">cmake . </div><div class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql </div><div class="line">-DMYSQL_DATADIR=/usr/local/mysql/data </div><div class="line">-DSYSCONFDIR=/etc </div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 </div><div class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 </div><div class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 </div><div class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 </div><div class="line">-DWITH_PERFSCHEMA_STORAGE_ENGINE=1 </div><div class="line">-DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 </div><div class="line">-DWITHOUT_FEDERATED_STORAGE_ENGINE=1 </div><div class="line">-DDEFAULT_CHARSET=utf8 </div><div class="line">-DDEFAULT_COLLATION=utf8_general_ci </div><div class="line">-DWITH_EXTRA_CHARSETS=all </div><div class="line">-DENABLED_LOCAL_INFILE=1 </div><div class="line">-DWITH_READLINE=1 </div><div class="line">-DMYSQL_UNIX_ADDR=/usr/local/mysql/mysql.sock </div><div class="line">-DMYSQL_TCP_PORT=3306 </div><div class="line">-DMYSQL_USER=mysql </div><div class="line">-DCOMPILATION_COMMENT=&quot;lq-edition&quot;</div><div class="line">-DENABLE_DTRACE=0 </div><div class="line">-DOPTIMIZER_TRACE=1 </div><div class="line">-DWITH_DEBUG=1</div><div class="line"></div><div class="line">cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DMYSQL_DATADIR=/usr/local/mysql/data -DSYSCONFDIR=/etc -DWITH_INNOBASE_STORAGE_ENGINE=1 -DWITH_ARCHIVE_STORAGE_ENGINE=1 -DWITH_BLACKHOLE_STORAGE_ENGINE=1 -DWITH_PARTITION_STORAGE_ENGINE=1 -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 -DWITHOUT_FEDERATED_STORAGE_ENGINE=1 -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_EXTRA_CHARSETS=all -DENABLED_LOCAL_INFILE=1 -DWITH_READLINE=1 -DMYSQL_UNIX_ADDR=/usr/local/mysql/mysql.sock -DMYSQL_TCP_PORT=3306 -DMYSQL_USER=mysql -DCOMPILATION_COMMENT=&quot;lq-edition&quot; -DENABLE_DTRACE=0 -DOPTIMIZER_TRACE=1 -DWITH_DEBUG=1</div><div class="line"></div><div class="line">参数说明：</div><div class="line"></div><div class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql          //安装目录</div><div class="line">-DINSTALL_DATADIR=/usr/local/mysql/data          //数据库存放目录</div><div class="line">-DDEFAULT_CHARSET=utf8                    　　　　//使用utf8字符</div><div class="line">-DDEFAULT_COLLATION=utf8_general_ci              //校验字符</div><div class="line">-DWITH_EXTRA_CHARSETS=all                        //安装所有扩展字符集</div><div class="line">-DENABLED_LOCAL_INFILE=1                    　　  //允许从本地导入数据</div><div class="line"></div><div class="line">编译：</div><div class="line">make</div><div class="line"></div><div class="line">安装：</div><div class="line">sudo make install</div><div class="line"></div><div class="line">配置MySQL</div><div class="line">（1）新建运行Mysql的用户和组</div><div class="line">sudo groupadd mysql</div><div class="line">sudo useradd -g mysql mysql</div><div class="line"></div><div class="line">登录mysql用户</div><div class="line">先修改mysql用户的密码</div><div class="line">passwd mysql</div><div class="line"></div><div class="line">（2）设置Mysql安装目录的权限</div><div class="line">cd /usr/local/mysql</div><div class="line">sudo chown -R mysql:mysql ./</div><div class="line"></div><div class="line">（3）建立配置文件</div><div class="line">cp support-files/my-default.cnf /etc/my.cnf</div><div class="line">sudo chown mysql:mysql /etc/my.cnf</div><div class="line">修改配置文件：</div><div class="line">sudo vi /etc/my.cnf</div><div class="line">[client]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/data/mysql.sock</div><div class="line">[mysqld]</div><div class="line">port = 3306</div><div class="line">socket = /usr/local/mysql/data/mysql.sock</div><div class="line">basedir = /usr/local/mysql</div><div class="line">datadir  = /usr/local/mysql/data</div><div class="line"></div><div class="line">（4）初始化数据库</div><div class="line">cd /usr/local/mysql</div><div class="line">sudo ./scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data/</div><div class="line"></div><div class="line">（5）启动mysql服务</div><div class="line">方法1：</div><div class="line">直接启动</div><div class="line">bin/mysqld_safe &amp;</div><div class="line">检查MySQL服务是否启动：</div><div class="line">ps -ef |grep mysql</div><div class="line"></div><div class="line">（6）配置环境变量</div><div class="line">为了直接调用mysql，需要将mysql的bin目录加入PATH环境变量。</div><div class="line">编辑/etc/profile文件：</div><div class="line">sudo vim /etc/profile</div><div class="line">在文件最后 添加如下两行：</div><div class="line">PATH=$PATH:/usr/local/mysql/bin</div><div class="line">export PATH</div><div class="line">关闭文件，运行下面的命令，让配置立即生效：</div><div class="line">source /etc/profile</div><div class="line"></div><div class="line">（7）修改root密码（因为默认密码为空）</div><div class="line">$ mysql -u root -p</div><div class="line">mysql&gt; UPDATE user SET Password=PASSWORD(&apos;你想要的密码&apos;) where USER=&apos;root&apos;;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line"></div><div class="line">（8）授权root账户远程登录</div><div class="line">$ mysql -u root -p</div><div class="line">mysql&gt; grant ALL PRIVILEGES ON *.* to root@&quot;%&quot; identified by &quot;root&quot; WITH GRANT OPTION;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div></pre></td></tr></table></figure>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/ubuntu:mysql</div><div class="line"># desc : 当前版本安装的MySQL</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 tools 镜像</div><div class="line">FROM birdben/ubuntu:tools</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line">RUN echo &quot;export LC_ALL=C&quot;</div><div class="line"></div><div class="line"># 替换ubuntu软件更新的源服务器的sources.list文件</div><div class="line">COPY sources.list /etc/apt/sources.list</div><div class="line"></div><div class="line"># 安装升级gcc</div><div class="line">RUN sudo rm -rf /var/lib/apt/lists/*</div><div class="line">RUN sudo apt-get update</div><div class="line">RUN sudo apt-get install -y make cmake gcc g++ bison libncurses5-dev build-essential</div><div class="line"></div><div class="line"># 复制 mysql-5.6.22 文件到镜像中（mysql-5.6.22文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD mysql-5.6.22 /software/downloads/mysql-5.6.22</div><div class="line"></div><div class="line">RUN cd /software/downloads/mysql-5.6.22 &amp;&amp; cmake . -DCMAKE_INSTALL_PREFIX=/software/mysql-5.6.22 -DMYSQL_DATADIR=/software/mysql-5.6.22/data -DSYSCONFDIR=/etc -DWITH_INNOBASE_STORAGE_ENGINE=1 -DWITH_ARCHIVE_STORAGE_ENGINE=1 -DWITH_BLACKHOLE_STORAGE_ENGINE=1 -DWITH_PARTITION_STORAGE_ENGINE=1 -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 -DWITHOUT_FEDERATED_STORAGE_ENGINE=1 -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_EXTRA_CHARSETS=all -DENABLED_LOCAL_INFILE=1 -DWITH_READLINE=1 -DMYSQL_UNIX_ADDR=/software/mysql-5.6.22/mysql.sock -DMYSQL_TCP_PORT=3306 -DMYSQL_USER=mysql -DCOMPILATION_COMMENT=&quot;lq-edition&quot; -DENABLE_DTRACE=0 -DOPTIMIZER_TRACE=1 -DWITH_DEBUG=1 &amp;&amp; make &amp;&amp; make install</div><div class="line"></div><div class="line"># 添加测试用户mysql，密码mysql，并且将此用户添加到sudoers里</div><div class="line">RUN useradd mysql</div><div class="line">RUN echo &quot;mysql:mysql&quot; | chpasswd</div><div class="line">RUN echo &quot;mysql   ALL=(ALL)       ALL&quot; &gt;&gt; /etc/sudoers</div><div class="line"></div><div class="line"># 设置Mysql安装目录的权限</div><div class="line">RUN cd /software/mysql-5.6.22 &amp;&amp; sudo chown -R mysql:mysql ./</div><div class="line"></div><div class="line"># 复制已经准备好的my.cnf文件到Docker容器</div><div class="line">COPY my.cnf /etc/my.cnf</div><div class="line">RUN sudo chown mysql:mysql /etc/my.cnf</div><div class="line"></div><div class="line"># 初始化数据库</div><div class="line">RUN cd /software/mysql-5.6.22 &amp;&amp; sudo ./scripts/mysql_install_db --user=mysql --basedir=/software/mysql-5.6.22 --datadir=/software/mysql-5.6.22/data/</div><div class="line"></div><div class="line"># 设置MySQL的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV MYSQL_HOME /software/mysql-5.6.22</div><div class="line"></div><div class="line"># （不推荐下面的路径直接建立在Docker虚拟机上，推荐使用volume挂载方式）</div><div class="line"># 在宿主机上创建一个数据库目录存储Mysql的数据文件</div><div class="line"># sudo mkdir -p /docker/mysql/data</div><div class="line"></div><div class="line"># VOLUME 选项是将本地的目录挂在到容器中　此处要注意：当你运行-v　＜hostdir&gt;:&lt;Containerdir&gt; 时要确保目录内容相同否则会出现数据丢失</div><div class="line"># 对应关系如下</div><div class="line"># mysql:/docker/mysql/data</div><div class="line">VOLUME [&quot;/software/mysql-5.6.22/data&quot;]</div><div class="line"></div><div class="line"># 容器需要开放MySQL 3306端口</div><div class="line">EXPOSE 3306</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/mysql/Dockerfile">https://github.com/birdben/birdDocker/blob/master/mysql/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:mysqld]</div><div class="line"># 这里使用mysqld_safe &amp;方式启动MySQL服务，但是不知道为什么后面加上&amp;启动MySQL会报错，不加&amp;就能正常启动了，后来看了一遍自己以前安装ES的博客才发现，mysql启动必须改成非daemon启动方式，这样supervisor就可以监控到了，所以要去掉&amp;</div><div class="line">command=./software/mysql-5.6.22/bin/mysqld_safe --user=mysql</div></pre></td></tr></table></figure>
<h5 id="my-cnf（复制MySQL-HOME-support-files-my-default-cnf文件修改如下）"><a href="#my-cnf（复制MySQL-HOME-support-files-my-default-cnf文件修改如下）" class="headerlink" title="my.cnf（复制MySQL_HOME/support-files/my-default.cnf文件修改如下）"></a>my.cnf（复制MySQL_HOME/support-files/my-default.cnf文件修改如下）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[client]</div><div class="line">port = 3306</div><div class="line">socket = /software/mysql-5.6.22/data/mysql.sock</div><div class="line">[mysqld]</div><div class="line">port = 3306</div><div class="line">socket = /software/mysql-5.6.22/data/mysql.sock</div><div class="line">basedir = /software/mysql-5.6.22</div><div class="line">datadir  = /software/mysql-5.6.22/data</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/mysql:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -p 3306:3306 -t -i -v /docker/mysql/data:/software/mysql-5.6.22/data birdben/mysql:v1</div><div class="line"></div><div class="line"></div><div class="line"># 可以ssh远程登录，然后登录mysql就大功告成了</div><div class="line">$ ssh admin@10.211.55.4 -p 9999</div><div class="line"># root账号的默认密码是空</div><div class="line">$ cd /software/mysql-5.6.22/bin</div><div class="line">$ mysql -u root -p</div><div class="line"></div><div class="line"># 修改root密码（因为默认密码为空）</div><div class="line">mysql&gt; use mysql;</div><div class="line">mysql&gt; UPDATE user SET Password=PASSWORD(&apos;你想要的密码&apos;) where USER=&apos;root&apos;;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div><div class="line"></div><div class="line"># 授权root账户远程登录，然后就可以通过navicat或者其他客户端工具连接到MySQL服务器了</div><div class="line">mysql&gt; grant ALL PRIVILEGES ON *.* to root@&quot;%&quot; identified by &quot;root&quot; WITH GRANT OPTION;</div><div class="line">mysql&gt; FLUSH PRIVILEGES;</div></pre></td></tr></table></figure>
<p>参考文章</p>
<ul>
<li><a href="http://www.linuxdiyf.com/linux/14453.html" target="_blank" rel="external">http://www.linuxdiyf.com/linux/14453.html</a></li>
<li><a href="http://linux.it.net.cn/e/data/mysql/2016/0103/19536.html" target="_blank" rel="external">http://linux.it.net.cn/e/data/mysql/2016/0103/19536.html</a></li>
<li><a href="http://blog.itpub.net/29071259/viewspace-1368508/" target="_blank" rel="external">http://blog.itpub.net/29071259/viewspace-1368508/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（十二）Docker安装ElasticSearch集群环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/15/Docker/Docker实战（十二）Docker安装ElasticSearch集群环境/" class="article-date">
  	<time datetime="2016-01-14T18:14:25.000Z" itemprop="datePublished">2016-01-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/15/Docker/Docker实战（十二）Docker安装ElasticSearch集群环境/">Docker实战（十二）Docker安装ElasticSearch集群环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ES集群需要配置几个地方，最简单的是配置集群名称和Node名称，其他的基本使用默认值就可以了，下面是elasticsearch.yml配置文件部分属性的用法，可以参考使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"># 集群名称，默认为elasticsearch</div><div class="line">cluster.name: birdESCluster</div><div class="line"></div><div class="line"># 节点Node名称，ES启动时会自动创建节点名称，默认的是从ES的，但你也可进行配置</div><div class="line">node.name: &quot;birdESNode01&quot;</div><div class="line"></div><div class="line"># 是否作为主节点，每个节点都可以被配置成为主节点，默认值为true</div><div class="line">node.master: true</div><div class="line"></div><div class="line"># 是否存储数据，即存储索引片段，默认值为true</div><div class="line">node.data: true</div><div class="line"></div><div class="line"># master和data同时配置会产生一些奇异的效果：</div><div class="line">1) 当master为false，而data为true时，会对该节点产生严重负荷；</div><div class="line">2) 当master为true，而data为false时，该节点作为一个协调者；</div><div class="line">3) 当master为false，data也为false时，该节点就变成了一个负载均衡器。</div><div class="line">你可以通过连接来查看集群状态</div><div class="line">http://localhost:9200/_cluster/health</div><div class="line">http://localhost:9200/_cluster/nodes</div><div class="line">或者使用插件来查看集群状态</div><div class="line">http://github.com/lukas-vlcek/bigdesk</div><div class="line">http://mobz.github.com/elasticsearch-head</div><div class="line"></div><div class="line"># 设置一个索引的碎片数量，默认值为5</div><div class="line">index.number_of_shards: 5</div><div class="line"></div><div class="line"># 设置一个索引可被复制的数量，默认值为1</div><div class="line">index.number_of_replicas: 1</div><div class="line"></div><div class="line"># 当你想要禁用公布式时，你可以进行如下设置：</div><div class="line">index.number_of_shards: 1</div><div class="line">index.number_of_replicas: 0</div><div class="line"></div><div class="line">这两个属性的设置直接影响集群中索引和搜索操作的执行。假设你有足够的机器来持有碎片和复制品，那么可以按如下规则设置这两个值：</div><div class="line">1) 拥有更多的碎片可以提升索引执行能力，并允许通过机器分发一个大型的索引；</div><div class="line">2) 拥有更多的复制器能够提升搜索执行能力以及集群能力。</div><div class="line">对于一个索引来说，number_of_shards只能设置一次，而number_of_replicas可以使用索引更新设置API在任何时候被增加或者减少。</div><div class="line">ElasticSearch关注加载均衡、迁移、从节点聚集结果等等。可以尝试多种设计来完成这些功能。</div><div class="line">可以连接http://localhost:9200/A/_status来检测索引的状态。</div><div class="line"></div><div class="line"># 配置文件所在的位置，即elasticsearch.yml和logging.yml所在的位置</div><div class="line">path.conf: /path/to/conf</div><div class="line"></div><div class="line"># 分配给当前节点的索引数据所在的位置</div><div class="line">path.data: /path/to/data</div><div class="line"></div><div class="line"># 可以可选择的包含一个以上的位置，使得数据在文件级别跨越位置，这样在创建时就有更多的自由路径</div><div class="line">path.data: /path/to/data1,/path/to/data2</div><div class="line"></div><div class="line"># 日志文件所在位置</div><div class="line">path.logs: /path/to/logs</div><div class="line"></div><div class="line"># 临时文件位置</div><div class="line">path.work: /path/to/work</div><div class="line"></div><div class="line"># 插件安装位置</div><div class="line">path.plugins: /path/to/plugins</div><div class="line"></div><div class="line">#  默认情况下，ElasticSearch使用0.0.0.0地址（也就是说如果这个机子有几个网卡，则ElasticSearch都可以通过这些IP来使用其服务。所以如果我们的服务器有网卡绑定在外网时一定要注意设置ElasticSearch的属性），并为http传输开启9200-9300端口，为节点到节点的通信开启9300-9400端口，也可以自行设置IP地址：</div><div class="line">network.bind_host: 192.168.0.1</div><div class="line"></div><div class="line"># publish_host设置其他节点连接此节点的地址，如果不设置的话，则自动获取，publish_host的地址必须为真实地址：</div><div class="line">network.publish_host: 192.168.0.1</div><div class="line"></div><div class="line"># bind_host和publish_host可以一起设置：（如果不想外网访问ES，可以设置这个）</div><div class="line">network.host: 192.168.0.1</div><div class="line"></div><div class="line"># 可以定制该节点与其他节点交互的端口：</div><div class="line">transport.tcp.port: 9300</div><div class="line"></div><div class="line"># 节点间交互时，可以设置是否压缩，转为为不压缩：</div><div class="line">transport.tcp.compress: true</div><div class="line"></div><div class="line"># 可以为Http传输监听定制端口：</div><div class="line">http.port: 9200</div><div class="line"></div><div class="line"># 设置内容的最大长度：</div><div class="line">http.max_content_length: 100mb</div><div class="line"></div><div class="line"># 禁止HTTP</div><div class="line">http.enabled: false</div><div class="line"></div><div class="line"># 允许在N个节点启动后恢复过程：</div><div class="line">gateway.recover_after_nodes: 1</div><div class="line"></div><div class="line"># 设置初始化恢复过程的超时时间：</div><div class="line">gateway.recover_after_time: 5m</div><div class="line"></div><div class="line"># 设置ping其他节点时的超时时间，网络比较慢时可将该值设大：</div><div class="line">discovery.zen.ping.timeout: 3s</div><div class="line"></div><div class="line"># 禁止当前节点发现多个集群节点，默认值为true：</div><div class="line">discovery.zen.ping.multicast.enabled: false</div><div class="line"></div><div class="line"># 设置新节点被启动时能够发现的主节点列表：</div><div class="line">discovery.zen.ping.unicast.hosts: [&quot;10.0.0.28:9300&quot;, &quot;10.0.0.28:9500&quot;]</div><div class="line"></div><div class="line"># 设置是否可以通过正则或者_all删除或者关闭索引</div><div class="line">action.destructive_requires_name 默认false 允许 可设置true不允许</div><div class="line"></div><div class="line"># 下面是一些查询时的慢日志参数设置</div><div class="line">index.search.slowlog.level: TRACE</div><div class="line">index.search.slowlog.threshold.query.warn: 10s</div><div class="line">index.search.slowlog.threshold.query.info: 5s</div><div class="line">index.search.slowlog.threshold.query.debug: 2s</div><div class="line">index.search.slowlog.threshold.query.trace: 500ms</div><div class="line">index.search.slowlog.threshold.fetch.warn: 1s</div><div class="line">index.search.slowlog.threshold.fetch.info: 800ms</div><div class="line">index.search.slowlog.threshold.fetch.debug:500ms</div><div class="line">index.search.slowlog.threshold.fetch.trace: 200ms</div></pre></td></tr></table></figure>
<h5 id="elasticsearch-yml源文件链接："><a href="#elasticsearch-yml源文件链接：" class="headerlink" title="elasticsearch.yml源文件链接："></a>elasticsearch.yml源文件链接：</h5><ul>
<li><a href="https://github.com/birdben/birdDocker/blob/master/escluster/elasticsearch_01.yml">https://github.com/birdben/birdDocker/blob/master/escluster/elasticsearch_01.yml</a></li>
</ul>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/escluster:v1</div><div class="line"># desc : 当前版本安装的escluster</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 jdk7 镜像</div><div class="line">FROM birdben/jdk7:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line">RUN echo &quot;export LC_ALL=C&quot;</div><div class="line"></div><div class="line"># 设置 ES 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV ES_HOME /software/elasticsearch-1.7.2</div><div class="line"></div><div class="line"># 复制 elasticsearch-1.7.2 文件到镜像中（elasticsearch-1.7.2文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD elasticsearch-1.7.2 /software/elasticsearch-1.7.2</div><div class="line"></div><div class="line"># 挂载/software/elasticsearch-1.7.2/config和/escluster目录</div><div class="line">VOLUME [&quot;/software/elasticsearch-1.7.2/config&quot;]</div><div class="line">VOLUME [&quot;/escluster&quot;]</div><div class="line"></div><div class="line"># 容器需要开放ES的9200和9300端口</div><div class="line">EXPOSE 9200</div><div class="line">EXPOSE 9300</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/escluster/Dockerfile">https://github.com/birdben/birdDocker/blob/master/escluster/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line"># 修改supervisor配置方式如下，修改为不自动重启ES，并且改成非daemon，DFOREGROUND的方式运行，supervisor就可以监控到了</div><div class="line">[program:elasticsearch]</div><div class="line">command=/bin/bash -c &quot;exec $&#123;ES_HOME&#125;/bin/elasticsearch -DFOREGROUND&quot;</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/escluster:v1&quot; .</div><div class="line"># 执行已经构件好的镜像，这里启动了两个ES的镜像，只是ES的端口号不同，挂载在宿主机器的存储路径也不同</div><div class="line">$ docker run -p 9999:22 -p 9200:9200 -p 9300:9300 -v /docker/escluster01:/escluster -v /docker/escluster01/config:/software/elasticsearch-1.7.2/config -t -i &apos;birdben/escluster:v1&apos;</div><div class="line">$ docker run -p 9998:22 -p 9201:9200 -p 9301:9300 -v /docker/escluster02:/escluster -v /docker/escluster02/config:/software/elasticsearch-1.7.2/config -t -i &apos;birdben/escluster:v1&apos;</div></pre></td></tr></table></figure>
<h5 id="访问ElasticSearch集群的插件测试"><a href="#访问ElasticSearch集群的插件测试" class="headerlink" title="访问ElasticSearch集群的插件测试"></a>访问ElasticSearch集群的插件测试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 访问9201和9201端口都能分别访问</div><div class="line">http://10.211.55.4:9200/_plugin/head/</div><div class="line">http://10.211.55.4:9201/_plugin/head/</div><div class="line"># 在Node1上创建索引会自动同步到Node2上，而且对应的data和logs目录也存储在挂载的目录中</div></pre></td></tr></table></figure>
<h5 id="ES集群的访问方式"><a href="#ES集群的访问方式" class="headerlink" title="ES集群的访问方式"></a>ES集群的访问方式</h5><h5 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h5><p>Elasticsearch为Java用户提供了两种内置客户端：<br>需要在项目中引入elasticsearch.jar，这个jar中有两种ES提供的Client</p>
<h5 id="节点客户端-（Node-Client）"><a href="#节点客户端-（Node-Client）" class="headerlink" title="节点客户端 （Node Client）"></a>节点客户端 （Node Client）</h5><p><img src="http://img.blog.csdn.net/20160124142752454?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="NodeClient"></p>
<p>Instantiating a node based client is the simplest way to get a Client that can execute operations against elasticsearch.</p>
<p>Embedding a node client into your application is the easiest way to connect to an Elasticsearch cluster</p>
<p>Node Client加入ES集群是一个没有数据的Node，就是这个Node不存储任何数据，但是这个Node知道数据存储在ES集群的哪个Node，可以把请求转发到正确的Node上去</p>
<p>注意：</p>
<p>实际上Node Client是在我们的系统，单元测试中启动了一个Embedded ElasticSearch，这个Embedded ElasticSearch是我们不存储任何数据的Node加入ES集群，我们的系统通过它来和ES集群进行通信，最好关闭Embedded Node的http端口（9200端口）防止http请求直接访问，因为Node Client与ES集群Node的通信都是使用的9300端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import static org.elasticsearch.node.NodeBuilder.*;</div><div class="line"></div><div class="line">// on startup</div><div class="line"></div><div class="line">Node node = nodeBuilder().node();</div><div class="line">Client client = node.client();</div><div class="line"></div><div class="line">// on shutdown</div><div class="line"></div><div class="line">node.close();</div><div class="line"></div><div class="line">// 设置ES的集群名称，在Java代码中</div><div class="line">Node node = nodeBuilder().clusterName(&quot;yourclustername&quot;).node();</div><div class="line">Client client = node.client();</div><div class="line"></div><div class="line">// 也可以设置cluster.name在/src/main/resources/elasticsearch.yml配置文件</div></pre></td></tr></table></figure>
<h5 id="传输客户端-（Transport-Client）"><a href="#传输客户端-（Transport-Client）" class="headerlink" title="传输客户端 （Transport Client）"></a>传输客户端 （Transport Client）</h5><p><img src="http://img.blog.csdn.net/20160124142859440?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="TransportClient"></p>
<p>The TransportClient connects remotely to an Elasticsearch cluster using the transport module. It does not join the cluster, but simply gets one or more initial transport addresses and communicates with them in round robin fashion on each action (though most actions will probably be “two hop” operations).</p>
<p>Transport Client不会加入集群，只是负责把请求转发给ES集群的Node</p>
<p>Java Client和ES集群通信通过9300端口，使用native ElasticSearch transport protocol， ES集群的Node也使用9300端口进行通信。（如果ES集群的9300端口没有开通，你的Nodes无法构建成一个集群）</p>
<p>注意：Java Client必须和ES集群的Node版本一致（也就是jar包的版本要和ES集群的版本对应一致），否则无法通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// on startup</div><div class="line"></div><div class="line">Client client = TransportClient.builder().build()</div><div class="line">        .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(&quot;host1&quot;), 9300))</div><div class="line">        .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(&quot;host2&quot;), 9300));</div><div class="line"></div><div class="line">// on shutdown</div><div class="line"></div><div class="line">client.close();</div><div class="line"></div><div class="line">// 设置集群名称</div><div class="line">Settings settings = Settings.settingsBuilder()</div><div class="line">        .put(&quot;cluster.name&quot;, &quot;myClusterName&quot;).build();</div><div class="line">Client client = TransportClient.builder().settings(settings).build();</div><div class="line">//Add transport addresses and do something with the client...</div><div class="line"></div><div class="line">// 也可以设置cluster.name在/src/main/resources/elasticsearch.yml配置文件，如Node Client</div></pre></td></tr></table></figure>
<p>注意：addTransportAddress方法</p>
<p>Adds a transport address that will be used to connect to.The Node this transport address represents will be used if its possible to connect to it. If it is unavailable, it will be automatically connected to once it is up.In order to get the list of all the current connected nodes, please see connectedNodes().</p>
<p>当一个ES Node（对应一个transportAddress）不可用时，client会自动发现当前可用的nodes（the current connected nodes），从以下这段代码可知：</p>
<p>TransportClientNodesService</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">int index = randomNodeGenerator.incrementAndGet();</div><div class="line">if (index &lt; 0) &#123;</div><div class="line">    index = 0;</div><div class="line">    randomNodeGenerator.set(0);</div><div class="line">&#125;</div><div class="line">RetryListener&lt;Response&gt; retryListener = new RetryListener&lt;Response&gt;(callback, listener, nodes, index);</div><div class="line">try &#123;</div><div class="line">    callback.doWithNode(nodes.get((index) % nodes.size()), retryListener);</div><div class="line">&#125; catch (ElasticsearchException e) &#123;</div><div class="line">    if (e.unwrapCause() instanceof ConnectTransportException) &#123;</div><div class="line">        retryListener.onFailure(e);</div><div class="line">    &#125; else &#123;</div><div class="line">        throw e;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="RESTFUL-API"><a href="#RESTFUL-API" class="headerlink" title="RESTFUL API"></a>RESTFUL API</h5><p>其他语言都可以使用RESTFUL API通过9200端口和ES进行通信，甚至可以通过命令行使用curl命令</p>
<p>HTTP Request格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -X&lt;VERB&gt; &apos;&lt;PROTOCOL&gt;://&lt;HOST&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;&apos; -d &apos;&lt;BODY&gt;&apos;</div><div class="line"></div><div class="line">VERB 			: HTTP方法（GET, POST, PUT, HEAD or DELETE）</div><div class="line">PROTOCOL 		: HTTP 或者 HTTPS协议（如果有一个HTTPS的代理在ES前端）</div><div class="line">HOST 			: ES集群名称或者IP地址</div><div class="line">PORT 			: 端口号运行着ES的HTTP服务，默认是9200</div><div class="line">QUERY_STRING 	: 查询参数（例如：?pretty）</div><div class="line">BODY 			: A JSON-encoded request body</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://my.oschina.net/xiaohui249/blog/228748" target="_blank" rel="external">http://my.oschina.net/xiaohui249/blog/228748</a></li>
<li><a href="http://blog.csdn.net/geloin/article/details/8444972" target="_blank" rel="external">http://blog.csdn.net/geloin/article/details/8444972</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/client.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/client.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/node-client.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/node-client.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/transport-client.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/transport-client.html</a></li>
<li><a href="http://www.cnblogs.com/huangfox/p/3543134.html" target="_blank" rel="external">http://www.cnblogs.com/huangfox/p/3543134.html</a></li>
<li><a href="http://es.xiaoleilu.com/010_Intro/15_API.html" target="_blank" rel="external">http://es.xiaoleilu.com/010_Intro/15_API.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElasticSearch/">ElasticSearch</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（十一）Docker安装ELK环境（二）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/08/Docker/Docker实战（十一）Docker安装ELK环境（二）/" class="article-date">
  	<time datetime="2016-01-07T22:40:33.000Z" itemprop="datePublished">2016-01-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/08/Docker/Docker实战（十一）Docker安装ELK环境（二）/">Docker实战（十一）Docker安装ELK环境（二）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>日志收集系统架构<br><img src="http://img.blog.csdn.net/20160103152529612?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="日志收集系统架构"></p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/current/deploying-and-scaling.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/current/deploying-and-scaling.html</a></li>
<li><a href="http://dockone.io/article/505#rd?sukey=fc78a68049a14bb21970769bd4cdecc8f803567ce85b9148150a8f086c5ea01b195498f33b858ddf9c93183f1c09d255" target="_blank" rel="external">http://dockone.io/article/505#rd?sukey=fc78a68049a14bb21970769bd4cdecc8f803567ce85b9148150a8f086c5ea01b195498f33b858ddf9c93183f1c09d255</a></li>
<li><a href="http://mp.weixin.qq.com/s?__biz=MzA4NDM0OTQ0NA==&amp;mid=400670251&amp;idx=1&amp;sn=dec80ffddf9b6b0619a89605c397a2c2&amp;scene=1&amp;srcid=1201EdUMaGhzFetS4f7Pe8QX&amp;key=ac89cba618d2d9767d9841c0e75232b77db8e3d08ed0c4bd45b9796dc6c27292d6f9776642a755bcf64dfeededbede63&amp;ascene=0&amp;uin=OTIxOTMxODgw&amp;devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.10.3+build(14D136)&amp;version=11020201&amp;pass_ticket=wAdeTXAnaEoTmxMJDYGfZiYPEQFQiUuMEieo5%2F72eVKwxLRWIshfT3nzlOwtjLDy" target="_blank" rel="external">http://mp.weixin.qq.com/s?__biz=MzA4NDM0OTQ0NA==&amp;mid=400670251&amp;idx=1&amp;sn=dec80ffddf9b6b0619a89605c397a2c2&amp;scene=1&amp;srcid=1201EdUMaGhzFetS4f7Pe8QX&amp;key=ac89cba618d2d9767d9841c0e75232b77db8e3d08ed0c4bd45b9796dc6c27292d6f9776642a755bcf64dfeededbede63&amp;ascene=0&amp;uin=OTIxOTMxODgw&amp;devicetype=iMac+MacBookPro12%2C1+OSX+OSX+10.10.3+build(14D136)&amp;version=11020201&amp;pass_ticket=wAdeTXAnaEoTmxMJDYGfZiYPEQFQiUuMEieo5%2F72eVKwxLRWIshfT3nzlOwtjLDy</a></li>
</ul>
<h5 id="日志收集系统架构简介"><a href="#日志收集系统架构简介" class="headerlink" title="日志收集系统架构简介"></a>日志收集系统架构简介</h5><ul>
<li>Logstash Agent/Flume：采集各个业务系统的日志，然后发送给Redis/Kafka消息队列。</li>
<li>Redis/Kafka：接收用户日志的消息队列，临时存储日志并且起到缓冲的作用，防止日志量上来之后，拖垮Logstash Indexer。</li>
<li>Logstash Indexer：做日志解析，统一成JSON输出给Elasticsearch。</li>
<li>Elasticsearch：实时日志分析服务的核心技术，一个schemaless，实时的数据存储服务，通过index组织数据，兼具强大的搜索和统计功能。</li>
<li>Kibana：基于Elasticsearch的数据可视化组件，超强的数据可视化能力是众多公司选择ELK stack的重要原因。</li>
</ul>
<p>这里实现的是 ELK + Redis 收集 Nginx 的 access.log<br>我们这里是把各个组件拆开，模拟每个组件是一个集群，每个集群部署在一台机器上</p>
<p>1.Nginx + Logstash agent<br>2.Redis<br>3.Logstash indexer<br>4.ElasticSearch<br>5.Kibana</p>
<h5 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">daemon off;</div><div class="line">master_process off;</div><div class="line">error_log  logs/error.log;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line">    </div><div class="line">    # 设置nginx日志格式，格式的名称logstash</div><div class="line">    log_format  logstash  &apos;$http_host $server_addr $remote_addr [$time_local] &quot;$request&quot; $request_body $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; $request_time $upstream_response_time&apos;;</div><div class="line">    </div><div class="line">    # 设置access_log日志输出的文件路径，以及使用的日志格式名称</div><div class="line">    access_log  logs/access.log  logstash;</div><div class="line">    </div><div class="line">    # 以下内容省略</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="logstash-agent的配置文件logstash-conf"><a href="#logstash-agent的配置文件logstash-conf" class="headerlink" title="logstash agent的配置文件logstash.conf"></a>logstash agent的配置文件logstash.conf</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">        file &#123;</div><div class="line">                type =&gt; &quot;nginx_access&quot;</div><div class="line">                path =&gt; [&quot;/usr/local/nginx/logs/access.log&quot;]</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">output &#123;</div><div class="line">        redis &#123;</div><div class="line">                host =&gt; &quot;10.211.55.4&quot;</div><div class="line">                port =&gt; 6379</div><div class="line">                password =&gt; admin</div><div class="line">                data_type =&gt; &quot;list&quot;</div><div class="line">                key =&gt; &quot;logstash:redis&quot;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>这里配置就是往redis队列中塞入日志就行，所以input的来源是Nginx的log文件，output的目标设置为redis，这里redis充当MQ消息队列的作用。</p>
<h5 id="logstash-indexer的配置文件logstash-conf"><a href="#logstash-indexer的配置文件logstash-conf" class="headerlink" title="logstash indexer的配置文件logstash.conf"></a>logstash indexer的配置文件logstash.conf</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">		redis &#123;</div><div class="line">				host =&gt; &quot;10.211.55.4&quot;</div><div class="line">				port =&gt; 6379</div><div class="line">				password =&gt; admin</div><div class="line">				data_type =&gt; &quot;list&quot;</div><div class="line">				key =&gt; &quot;logstash:redis&quot;</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">		grok &#123;</div><div class="line">				match =&gt; [</div><div class="line">					&quot;message&quot;, &quot;%&#123;IPORHOST:http_host&#125; %&#123;IPORHOST:server_ip&#125; %&#123;IPORHOST:client_ip&#125; \[%&#123;HTTPDATE:timestamp&#125;\] \&quot;%&#123;WORD:http_verb&#125; (?:%&#123;PATH:baseurl&#125;\?%&#123;NOTSPACE:params&#125;(?: HTTP/%&#123;NUMBER:http_version&#125;)?|%&#123;DATA:raw_http_request&#125;)\&quot; (%&#123;NOTSPACE:params&#125;)?|- %&#123;NUMBER:http_status_code&#125; (?:%&#123;NUMBER:bytes_read&#125;|-) %&#123;QS:referrer&#125; %&#123;QS:agent&#125; %&#123;NUMBER:time_duration:float&#125; %&#123;NUMBER:time_backend_response:float&#125;&quot;</div><div class="line">			]</div><div class="line">		&#125;</div><div class="line">		kv &#123;</div><div class="line">				prefix =&gt; &quot;params.&quot;</div><div class="line">				field_split =&gt; &quot;&amp;&quot;</div><div class="line">				source =&gt; &quot;params&quot;</div><div class="line">		&#125;</div><div class="line">		urldecode &#123;</div><div class="line">				all_fields =&gt; true</div><div class="line">		&#125;</div><div class="line">		date &#123;</div><div class="line">				locale =&gt; &quot;en&quot;</div><div class="line">				match =&gt; [&quot;timestamp&quot; , &quot;dd/MMM/YYYY:HH:mm:ss Z&quot;]</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">		elasticsearch &#123;</div><div class="line">				embedded =&gt; false				codec =&gt; &quot;json&quot;				protocol =&gt; &quot;http&quot;				host =&gt; &quot;10.211.55.4&quot;				port =&gt; 9200				index =&gt; &quot;birdlogstash&quot;		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h5><p>logstash indexer的配置文件就比较麻烦了，需要配置的有三个部分</p>
<ul>
<li>input: 负责从redis中获取日志数据</li>
<li>filter: 负责对日志数据进行分析和结构化</li>
<li>output: 负责将结构化的数据存储进入elasticsearch</li>
</ul>
<p>这里配置就是从redis队列中获取日志，对日志进行相应地过滤，所以input的来源是Redis的list队列，其中的redis配置当然要和logstash agent的配置一致了。output的目标设置为ES搜索引擎的索引，在通过kibana图形界面化的展示ES的查询索引。</p>
<h5 id="kibana-yml配置文件"><a href="#kibana-yml配置文件" class="headerlink" title="kibana.yml配置文件"></a>kibana.yml配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 这里配置Kibana访问ES集群的地址</div><div class="line"># The Elasticsearch instance to use for all your queries.</div><div class="line">elasticsearch_url: &quot;http://10.211.55.4:9200&quot;</div></pre></td></tr></table></figure>
<h5 id="elk-log-agent的Dockerfile文件"><a href="#elk-log-agent的Dockerfile文件" class="headerlink" title="elk_log_agent的Dockerfile文件"></a>elk_log_agent的Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/elk_log_agent:v1</div><div class="line"># desc : 当前版本安装的elk_log_agent</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 jdk7 镜像</div><div class="line">FROM birdben/jdk7:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 设置 LOGSTASH 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV LOGSTASH_HOME /software/logstash-1.5.4</div><div class="line"></div><div class="line"># 复制 logstash-1.5.4 文件到镜像中（logstash-1.5.4 文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD logstash-1.5.4 /software/logstash-1.5.4</div><div class="line"></div><div class="line"># 解决环境问题，否则logstash无法从log文件中采集日志。具体环境： Logstash 1.5, Ubuntu 14.04, Oracle JDK7</div><div class="line">RUN ln -s /lib/x86_64-linux-gnu/libcrypt.so.1 /usr/lib/x86_64-linux-gnu/libcrypt.so</div><div class="line"></div><div class="line"># 安装升级gcc</div><div class="line">RUN sudo rm -rf /var/lib/apt/lists/*</div><div class="line">RUN sudo apt-get update</div><div class="line"></div><div class="line">RUN sudo apt-get -y install \</div><div class="line">build-essential</div><div class="line"></div><div class="line">RUN sudo mkdir -p /software/temp</div><div class="line">RUN wget http://nginx.org/download/nginx-1.8.0.tar.gz &amp;&amp; tar -zxvf nginx-1.8.0.tar.gz -C /software/temp</div><div class="line">RUN wget http://zlib.net/zlib-1.2.8.tar.gz &amp;&amp; tar -zxvf zlib-1.2.8.tar.gz -C /software/temp</div><div class="line">RUN wget http://www.openssl.org/source/openssl-1.0.1q.tar.gz &amp;&amp; tar -zxvf openssl-1.0.1q.tar.gz -C /software/temp</div><div class="line">RUN wget http://downloads.sourceforge.net/project/pcre/pcre/8.37/pcre-8.37.tar.gz &amp;&amp; tar -zxvf pcre-8.37.tar.gz -C /software/temp</div><div class="line">RUN cd /software/temp/nginx-1.8.0 &amp;&amp; sudo ./configure --sbin-path=/software/nginx-1.8.0/nginx --conf-path=/software/nginx-1.8.0/nginx.conf --pid-path=/software/nginx-1.8.0/nginx.pid --with-http_ssl_module --with-pcre=/software/temp/pcre-8.37 --with-zlib=/software/temp/zlib-1.2.8 --with-openssl=/software/temp/openssl-1.0.1q &amp;&amp; sudo make &amp;&amp; sudo make install</div><div class="line"></div><div class="line"># 设置nginx是非daemon启动</div><div class="line">RUN echo &apos;daemon off;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line">RUN echo &apos;master_process off;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line">RUN echo &apos;error_log  logs/error.log;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line"></div><div class="line"># 设置 NGINX 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV NGINX_HOME /software/nginx-1.8.0</div><div class="line"></div><div class="line"># 挂载/logstash目录</div><div class="line">VOLUME [&quot;/logstash&quot;]</div><div class="line"></div><div class="line"># 容器需要开放Nginx 80端口</div><div class="line">EXPOSE 80</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="elk-log-agent的supervisord-conf配置文件"><a href="#elk-log-agent的supervisord-conf配置文件" class="headerlink" title="elk_log_agent的supervisord.conf配置文件"></a>elk_log_agent的supervisord.conf配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:nginx]</div><div class="line">command=/software/nginx-1.8.0/nginx -c /software/nginx-1.8.0/nginx.conf</div><div class="line"></div><div class="line">[program:logstash]</div><div class="line"># 指定配置文件时，一定要使用绝对路径，相对路径是不好用的，这个坑已经踩过两次了。。</div><div class="line">command=/software/logstash-1.5.4/bin/logstash -f /logstash/logstash_agent.conf</div></pre></td></tr></table></figure>
<h5 id="elk-log-agent的控制台终端"><a href="#elk-log-agent的控制台终端" class="headerlink" title="elk_log_agent的控制台终端"></a>elk_log_agent的控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/elk_log_agent:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -p 8888:80 -t -i -v /docker/logstash:/logstash &quot;birdben/elk_log_agent:v1&quot;</div></pre></td></tr></table></figure>
<h5 id="logstash的Dockerfile文件"><a href="#logstash的Dockerfile文件" class="headerlink" title="logstash的Dockerfile文件"></a>logstash的Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/logstash:v1</div><div class="line"># desc : 当前版本安装的logstash</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 jdk7 镜像</div><div class="line">FROM birdben/jdk7:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 设置 LOGSTASH 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV LOGSTASH_HOME /software/logstash-1.5.4</div><div class="line"></div><div class="line"># 复制 logstash-1.5.4 文件到镜像中（logstash-1.5.4文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD logstash-1.5.4 /software/logstash-1.5.4</div><div class="line"></div><div class="line"># 解决环境问题，否则logstash无法从log文件中采集日志。具体环境： Logstash 1.5, Ubuntu 14.04, Oracle JDK7</div><div class="line">RUN ln -s /lib/x86_64-linux-gnu/libcrypt.so.1 /usr/lib/x86_64-linux-gnu/libcrypt.so</div><div class="line"></div><div class="line"># 挂载/logstash目录</div><div class="line">VOLUME [&quot;/logstash&quot;]</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="logstash的supervisord-conf配置文件"><a href="#logstash的supervisord-conf配置文件" class="headerlink" title="logstash的supervisord.conf配置文件"></a>logstash的supervisord.conf配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:logstash]</div><div class="line"># 指定配置文件时，一定要使用绝对路径，相对路径是不好用的，这个坑已经踩过两次了。。</div><div class="line">command=/software/logstash-1.5.4/bin/logstash -f /logstash/logstash.conf</div></pre></td></tr></table></figure>
<h5 id="logstash的控制台终端"><a href="#logstash的控制台终端" class="headerlink" title="logstash的控制台终端"></a>logstash的控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/logstash:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -t -i -v /docker/logstash:/logstash &quot;birdben/logstash:v1&quot;</div></pre></td></tr></table></figure>
<h5 id="kibana的Dockerfile文件"><a href="#kibana的Dockerfile文件" class="headerlink" title="kibana的Dockerfile文件"></a>kibana的Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/kibana:v1</div><div class="line"># desc : 当前版本安装的kibana</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 tools 镜像</div><div class="line">FROM birdben/tools:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 设置 KIBANA 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV KIBANA_HOME /software/kibana-4.1.2</div><div class="line"></div><div class="line"># 复制 kibana-4.1.2 文件到镜像中（kibana-4.1.2文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD kibana-4.1.2 /software/kibana-4.1.2</div><div class="line"></div><div class="line"># 容器需要开放Kibana的5601端口</div><div class="line">EXPOSE 5601</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="kibana的supervisord-conf配置文件"><a href="#kibana的supervisord-conf配置文件" class="headerlink" title="kibana的supervisord.conf配置文件"></a>kibana的supervisord.conf配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:kibana]</div><div class="line">command=/software/kibana-4.1.2/bin/kibana</div></pre></td></tr></table></figure>
<h5 id="kibana的控制台终端"><a href="#kibana的控制台终端" class="headerlink" title="kibana的控制台终端"></a>kibana的控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/kibana:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -p 5601:5601 -t -i &quot;birdben/kibana:v1&quot;</div></pre></td></tr></table></figure>
<h5 id="注意-2"><a href="#注意-2" class="headerlink" title="注意"></a>注意</h5><p>ES和Redis如之前的文章介绍部署即可</p>
<h5 id="验证日志收集"><a href="#验证日志收集" class="headerlink" title="验证日志收集"></a>验证日志收集</h5><blockquote>
<p>访问Nginx主页，查看access.log中的日志是否按照指定的日志格式输出，之后access.log会被log_agent收集到Redis中，如果log_indexer是可用状态的，就会从Redis中消费掉日志信息，如果log_indexer是不可用的，日志信息就会保存在Redis中。log_indexer从Redis中消费掉日志后，就会在ES中创建相应地索引，最后在Kibana中进行查询显示</p>
</blockquote>
<p>参考文章：</p>
<ul>
<li><a href="http://www.cnblogs.com/yjf512/p/4568190.html" target="_blank" rel="external">http://www.cnblogs.com/yjf512/p/4568190.html</a></li>
<li><a href="http://www.cnblogs.com/yjf512/p/4199105.html" target="_blank" rel="external">http://www.cnblogs.com/yjf512/p/4199105.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（十）Docker安装Nginx" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/02/Docker/Docker实战（十）Docker安装Nginx/" class="article-date">
  	<time datetime="2016-01-02T09:43:04.000Z" itemprop="datePublished">2016-01-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/02/Docker/Docker实战（十）Docker安装Nginx/">Docker实战（十）Docker安装Nginx</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>安装Nginx可以选择直接使用ubuntu的apt-get install nginx命令来安装，这种安装方式最简单方便，但是Nginx的版本可能是比较老的版本，所以这里我选择编译安装的方式。</p>
<h5 id="Nginx需要依赖下面3个包"><a href="#Nginx需要依赖下面3个包" class="headerlink" title="Nginx需要依赖下面3个包"></a>Nginx需要依赖下面3个包</h5><ol>
<li>gzip 模块需要 zlib 库 ( 下载: <a href="http://www.zlib.net/" target="_blank" rel="external">http://www.zlib.net/</a> )  zlib-1.2.8.tar.gz</li>
<li>rewrite 模块需要 pcre 库 ( 下载: <a href="http://www.pcre.org/" target="_blank" rel="external">http://www.pcre.org/</a> )  pcre-8.37.tar.gz</li>
<li>ssl 功能需要 openssl 库 ( 下载: <a href="http://www.openssl.org/" target="_blank" rel="external">http://www.openssl.org/</a> )  openssl-1.0.1q.tar.gz</li>
</ol>
<h5 id="编译方式安装Nginx"><a href="#编译方式安装Nginx" class="headerlink" title="编译方式安装Nginx"></a>编译方式安装Nginx</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"># 下载nginx安装依赖的包</div><div class="line">$ wget http://zlib.net/zlib-1.2.8.tar.gz</div><div class="line">$ wget http://www.openssl.org/source/openssl-1.0.1q.tar.gz</div><div class="line">$ wget http://downloads.sourceforge.net/project/pcre/pcre/8.37/pcre-8.37.tar.gz</div><div class="line">$ wget http://nginx.org/download/nginx-1.8.0.tar.gz</div><div class="line"></div><div class="line"># nginx-1.8.0，pcre-8.37，zlib-1.2.8，openssl-1.0.1q这几个解压的文件夹是放在/temp文件夹下，nginx按照的目录是/software/nginx-1.8.0$ cd /temp/nginx-1.8.0/$ sudo ./configure --sbin-path=/software/nginx-1.8.0/nginx --conf-path=/software/nginx-1.8.0/nginx.conf --pid-path=/software/nginx-1.8.0/nginx.pid --with-http_ssl_module --with-pcre=/temp/pcre-8.37 --with-zlib=/temp/zlib-1.2.8 --with-openssl=/temp/openssl-1.0.1q</div><div class="line">$ sudo make</div><div class="line">$ sudo make install</div><div class="line"></div><div class="line"># 检查80端口是否被占用</div><div class="line">$ netstat -ano|grep 80</div><div class="line"></div><div class="line"># 启动nginx</div><div class="line">$ cd /software/nginx-1.8.0/</div><div class="line">$ sudo ./nginx</div><div class="line"></div><div class="line"># 不指定配置文件地址</div><div class="line">$ cd /software/nginx-1.8.0</div><div class="line">$ ./nginx</div><div class="line"></div><div class="line"># 指定配置文件地址</div><div class="line">$ cd /software/nginx-1.8.0</div><div class="line">$ ./nginx -c /software/nginx-1.8.0/nginx.conf</div><div class="line"></div><div class="line"># 停止服务</div><div class="line">$ sudo kill &apos;cat /software/nginx-1.8.0/nginx.pid&apos;</div><div class="line"></div><div class="line"># 检测配置文件</div><div class="line">$ cd /software/nginx-1.8.0</div><div class="line">$ ./nginx -t</div><div class="line"></div><div class="line"># 重新加载配置文件(不停止服务)</div><div class="line">$ cd /software/nginx-1.8.0</div><div class="line">$ ./nginx -s reload</div></pre></td></tr></table></figure>
<h5 id="编译安装Nginx可能会遇到的问题和解决方法"><a href="#编译安装Nginx可能会遇到的问题和解决方法" class="headerlink" title="编译安装Nginx可能会遇到的问题和解决方法"></a>编译安装Nginx可能会遇到的问题和解决方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"># 编译安装Nginx的时候需要指定相关参数，否则会遇到下面的问题</div><div class="line">./configure: error: the HTTP rewrite module requires the PCRE library.You can either disable the module by using --without-http_rewrite_moduleoption, or install the PCRE library into the system, or build the PCRE librarystatically from the source with nginx by using --with-pcre=&lt;path&gt; option.</div><div class="line"></div><div class="line"># Nginx编译参数</div><div class="line">–prefix 						#nginx安装目录，默认在/usr/local/nginx</div><div class="line">–pid-path 						#pid问件位置，默认在logs目录</div><div class="line">–lock-path 						#lock问件位置，默认在logs目录</div><div class="line">–with-http_ssl_module 			#开启HTTP SSL模块，以支持HTTPS请求。</div><div class="line">–with-http_dav_module 			#开启WebDAV扩展动作模块，可为文件和目录指定权限</div><div class="line">–with-http_flv_module 			#支持对FLV文件的拖动播放</div><div class="line">–with-http_realip_module 		#支持显示真实来源IP地址</div><div class="line">–with-http_gzip_static_module 	#预压缩文件传前检查，防止文件被重复压缩</div><div class="line">–with-http_stub_status_module 	#取得一些nginx的运行状态</div><div class="line">–with-mail 						#允许POP3/IMAP4/SMTP代理模块</div><div class="line">–with-mail_ssl_module 			#允许POP3／IMAP／SMTP可以使用SSL／TLS</div><div class="line">–with-pcre=../pcre-8.11 		#注意是未安装的pcre路径</div><div class="line">–with-zlib=../zlib-1.2.5 		#注意是未安装的zlib路径</div><div class="line">–with-debug 					#允许调试日志</div><div class="line">–http-client-body-temp-path 	#客户端请求临时文件路径</div><div class="line">–http-proxy-temp-path 			#设置http proxy临时文件路径</div><div class="line">–http-fastcgi-temp-path 		#设置http fastcgi临时文件路径</div><div class="line">–http-uwsgi-temp-path=/var/tmp/nginx/uwsgi #设置uwsgi 临时文件路径</div><div class="line">–http-scgi-temp-path=/var/tmp/nginx/scgi #设置scgi 临时文件路径# 我用pcre2替代了pcre会遇到如下的问题，最后还是换成pcre</div><div class="line">出现了错误：src/core/ngx_regex.h:15:18: fatal error: pcre.h: No such file or directory #include &lt;pcre.h&gt;                  ^compilation terminated.make[1]: *** [objs/src/core/nginx.o] Error 1make[1]: Leaving directory `/home/ben/dev/nginx-1.8.0&apos;make: *** [build] Error 2</div><div class="line"></div><div class="line"></div><div class="line"># 如果遇到下面的问题最好升级一下gcc</div><div class="line">$ sudo rm -rf /var/lib/apt/lists/*</div><div class="line">$ apt-get update</div><div class="line"></div><div class="line">configure: error: You need a C++ compiler for C++ support.make[1]: *** [/home/ben/dev/pcre-8.37/Makefile] Error 1make[1]: Leaving directory `/home/ben/dev/nginx-1.8.0&apos;make: *** [build] Error 2</div></pre></td></tr></table></figure>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/nginx:v1</div><div class="line"># desc : 当前版本安装的nginx</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 tools 镜像</div><div class="line">FROM birdben/tools:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 安装升级gcc</div><div class="line">RUN sudo rm -rf /var/lib/apt/lists/*</div><div class="line">RUN sudo apt-get update</div><div class="line"></div><div class="line">RUN sudo apt-get -y install \</div><div class="line">build-essential</div><div class="line"></div><div class="line">RUN sudo mkdir -p /software/temp</div><div class="line">RUN wget http://nginx.org/download/nginx-1.8.0.tar.gz &amp;&amp; tar -zxvf nginx-1.8.0.tar.gz -C /software/temp</div><div class="line">RUN wget http://zlib.net/zlib-1.2.8.tar.gz &amp;&amp; tar -zxvf zlib-1.2.8.tar.gz -C /software/temp</div><div class="line">RUN wget http://www.openssl.org/source/openssl-1.0.1q.tar.gz &amp;&amp; tar -zxvf openssl-1.0.1q.tar.gz -C /software/temp</div><div class="line">RUN wget http://downloads.sourceforge.net/project/pcre/pcre/8.37/pcre-8.37.tar.gz &amp;&amp; tar -zxvf pcre-8.37.tar.gz -C /software/temp</div><div class="line">RUN cd /software/temp/nginx-1.8.0 &amp;&amp; sudo ./configure --sbin-path=/software/nginx-1.8.0/nginx --conf-path=/software/nginx-1.8.0/nginx.conf --pid-path=/software/nginx-1.8.0/nginx.pid --with-http_ssl_module --with-pcre=/software/temp/pcre-8.37 --with-zlib=/software/temp/zlib-1.2.8 --with-openssl=/software/temp/openssl-1.0.1q &amp;&amp; sudo make &amp;&amp; sudo make install</div><div class="line"></div><div class="line"># 设置nginx是非daemon启动</div><div class="line">RUN echo &apos;daemon off;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line">RUN echo &apos;master_process off;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line">RUN echo &apos;error_log  logs/error.log;&apos; &gt;&gt; /software/nginx-1.8.0/nginx.conf</div><div class="line"></div><div class="line"># 设置 NGINX 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV NGINX_HOME /software/nginx-1.8.0</div><div class="line"></div><div class="line"># 容器需要开放Nginx 80端口</div><div class="line">EXPOSE 80</div><div class="line"></div><div class="line"># 执行run.sh文件</div><div class="line"># CMD [&quot;/run.sh&quot;]</div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/nginx/Dockerfile">https://github.com/birdben/birdDocker/blob/master/nginx/Dockerfile</a></p>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 编译安装Nginx方式构建Docker镜像遇到几个比较坑的问题</div><div class="line">1. supervisor无法启动Nginx，必须设置nginx是非daemon启动，这个问题之前安装ES的时候已经遇到过了，因为没有注意还是被这个问题困扰了一段时间。Nginx设置非daemon启动需要在nginx.conf配置文件中设置daemon false即可。</div><div class="line">参考文章：</div><div class="line">http://comments.gmane.org/gmane.comp.sysutils.supervisor.general/1233</div><div class="line">http://nginx.org/en/docs/ngx_core_module.html#daemon</div><div class="line">http://serverfault.com/questions/647357/running-and-monitoring-nginx-with-supervisord</div><div class="line">http://www.v2ex.com/t/123152</div><div class="line"></div><div class="line">2. 编译安装Nginx时，总是提示lib-dev64相对的版本不匹配，即使执行apt-get -y install build-essential安装gcc也是如此，最终发现是因为之前继承的tools镜像在安装ssh时有改过ubuntu的sourcelist文件，直接继承ubuntu 14.04的镜像就不会有lib-dev64版本不匹配的问题。</div><div class="line">参考文章：</div><div class="line">http://www.oschina.net/question/220489_160699</div><div class="line">http://www.cnblogs.com/linxiong945/p/4180565.html</div><div class="line">http://blog.csdn.net/xhz1234/article/details/37044531</div></pre></td></tr></table></figure>
<h5 id="Supervisor-conf"><a href="#Supervisor-conf" class="headerlink" title="Supervisor.conf"></a>Supervisor.conf</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:nginx]</div><div class="line">command=/software/nginx-1.8.0/nginx -c /software/nginx-1.8.0/nginx.conf</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">docker build -t=&quot;birdben/nginx:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">docker run -p 9999:22 -p 8888:80 -t -i birdben/nginx:v1</div></pre></td></tr></table></figure>
<h5 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.211.55.4:8888/</div></pre></td></tr></table></figure>
<p>参考文章</p>
<ul>
<li><a href="http://nginx.org/en/docs/configure.html" target="_blank" rel="external">http://nginx.org/en/docs/configure.html</a></li>
<li><a href="http://www.cnblogs.com/skynet/p/4146083.html" target="_blank" rel="external">http://www.cnblogs.com/skynet/p/4146083.html</a></li>
<li><a href="http://www.nginx.cn/install" target="_blank" rel="external">http://www.nginx.cn/install</a></li>
<li><a href="http://www.cnblogs.com/siqi/p/3572695.html" target="_blank" rel="external">http://www.cnblogs.com/siqi/p/3572695.html</a></li>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/installoptions/" target="_blank" rel="external">https://www.nginx.com/resources/wiki/start/topics/tutorials/installoptions/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（七）Docker安装MongoDB" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/02/Docker/Docker实战（七）Docker安装MongoDB/" class="article-date">
  	<time datetime="2016-01-02T09:39:56.000Z" itemprop="datePublished">2016-01-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/02/Docker/Docker实战（七）Docker安装MongoDB/">Docker实战（七）Docker安装MongoDB</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="大概步骤："><a href="#大概步骤：" class="headerlink" title="大概步骤："></a>大概步骤：</h5><ol>
<li>上传Mongo到宿主机，或者在宿主机中下载</li>
<li>编写Dockerfile构建镜像 </li>
<li>编写supervisor配置文件</li>
<li>build和run</li>
</ol>
<h5 id="MongoDB安装"><a href="#MongoDB安装" class="headerlink" title="MongoDB安装"></a>MongoDB安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># 下载Mongo</div><div class="line">$ curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1404-3.0.7.tgz</div><div class="line"></div><div class="line"># 解压Mongo压缩包</div><div class="line">$ tar -zxvf mongodb-linux-x86_64-ubuntu1404-3.0.7.tgz</div><div class="line"></div><div class="line"># 重命名一下Mongo的安装目录</div><div class="line">$ mv mongodb-linux-x86_64-ubuntu1404-3.0.7/ mongodb-3.0.7</div><div class="line"></div><div class="line"># （不推荐下面的路径直接建立在Docker虚拟机上，推荐使用volume挂载方式）</div><div class="line"># 在宿主机上创建一个数据库目录存储Mongo的数据文件</div><div class="line">$ sudo mkdir -p /docker/mongo/data</div><div class="line"></div><div class="line"># 在宿主机上创建一个日志目录存储Mongo的Log文件</div><div class="line">$ sudo mkdir -p /docker/mongo/log</div><div class="line"></div><div class="line"># 在&#123;MONGO_HOME&#125;下创建一个Mongo启动的配置文件</div><div class="line">$ sudo touch mongodb.conf</div><div class="line"></div><div class="line">############# mongodb.conf ################</div><div class="line">port=30000</div><div class="line">dbpath=/mongo/data</div><div class="line">logpath=/mongo/log/mongodb.log</div><div class="line">logappend=true</div><div class="line">############# mongodb.conf ################</div><div class="line"></div><div class="line"># 启动mongo时，指定config配置文件</div><div class="line">$ sudo ./mongod -f ../mongodb.conf</div><div class="line"></div><div class="line"># 参考：</div><div class="line">https://docs.mongodb.org/master/tutorial/install-mongodb-on-linux/</div><div class="line">http://my.oschina.net/aarongo/blog/349061</div></pre></td></tr></table></figure>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/mongodb:v1</div><div class="line"># desc : 当前版本安装的mongodb</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 tools 镜像</div><div class="line">FROM birdben/tools:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line"># 设置 mongo 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV MONGO_HOME /software/mongodb-3.0.7</div><div class="line">ENV LC_ALL C</div><div class="line"></div><div class="line"># 复制 mongodb-3.0.7 文件到镜像中（mongodb-3.0.7 文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD mongodb-3.0.7 /software/mongodb-3.0.7</div><div class="line"></div><div class="line"># VOLUME 选项是将本地的目录挂在到容器中　此处要注意：当你运行-v　＜hostdir&gt;:&lt;Containerdir&gt; 时要确保目录内容相同否则会出现数据丢失</div><div class="line"># 对应关系如下</div><div class="line"># mongo:/docker/mongodb</div><div class="line">VOLUME [&quot;/mongodb&quot;]</div><div class="line"></div><div class="line"># 容器需要开放Mongo 30000端口</div><div class="line">EXPOSE 30000</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/mongo/Dockerfile">https://github.com/birdben/birdDocker/blob/master/mongo/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line">[program:mongo]</div><div class="line"># 注意这里指定的mongodb.conf文件路径，必须是绝对路径</div><div class="line">command=/software/mongodb-3.0.7/bin/mongod -f /mongodb/mongodb.conf</div></pre></td></tr></table></figure>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/mongodb:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -p 30000:30000 -t -i -v /docker/mongodb:/mongodb &quot;birdben/mongodb:v1&quot;</div><div class="line"></div><div class="line"></div><div class="line"># 可以ssh远程登录，然后查看mongo的log是否有变化，然后就大功告成了</div><div class="line">$ ssh root@10.211.55.4 -p 9999</div><div class="line">$ cd /mongo/log</div><div class="line">$ tailf mongodb.log</div></pre></td></tr></table></figure>
<h5 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 如果遇到mongo启动问题Failed global initialization: BadValue Invalid or no user locale set. Please ensure LANG and/or LC_* environment variables are set correctly.</div><div class="line"># 需要配置如下的环境变量</div><div class="line"></div><div class="line">export LC_ALL=C</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://my.oschina.net/aarongo/blog/349061" target="_blank" rel="external">http://my.oschina.net/aarongo/blog/349061</a></li>
<li><a href="http://dockone.io/article/128" target="_blank" rel="external">http://dockone.io/article/128</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（九）Docker安装ELK环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/24/Docker/Docker实战（九）Docker安装ELK环境/" class="article-date">
  	<time datetime="2015-12-23T20:19:47.000Z" itemprop="datePublished">2015-12-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/24/Docker/Docker实战（九）Docker安装ELK环境/">Docker实战（九）Docker安装ELK环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ELK实际上就是ElasticSearch，Logstash，Kibana的缩写，是日志收集分析的一种解决方案。</p>
<ul>
<li>Elasticsearch一个开源的搜索引擎框架（支持群集架构方式）</li>
<li>Logstash集成各种收集日志插件，还是一个比较优秀的正则切割日志工具</li>
<li>Kibana一个免费的web应用，支持在web端查看ES的搜索结果</li>
</ul>
<p>elk是目前比较新也发展比较快的一套数据分析套件，其中Elasticsearch是用来作为存储和查询引擎的，kibana则是位于其之上的一个UI（更偏向于聚合汇总分析），而logstash则是属于ETL工具（数据的提取转换插入）。<br>在具体的使用过程中，目前觉得logstash算是比较鸡肋的，因为适用的场景有限，而且要扩展必须自己实现。个人建议，如果对es比较熟悉的，完全可以不需要用这个。自己用es加个river插件，那个效果也不错。</p>
<p>ELK简单架构<br><img src="http://img.blog.csdn.net/20151224033735994?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="ELK_Simple"></p>
<p>日志收集系统架构整体架构<br><img src="http://img.blog.csdn.net/20160103152529612?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="日志收集系统架构"></p>
<p>简单来讲他具体的工作流程就是Logstash agent监控并过滤日志，将过滤后的日志内容发给redis(这里的redis只处理队列不做存储)，Logstash index将日志收集在一起交给全文搜索服务ElasticSearch，可以用ElasticSearch进行自定义搜索，通过Kibana来结合 自定义搜索进行页面展示</p>
<p>此外 logstash 的收集方式分为 standalone 和 centralized。<br>standalone 是所有功能都在一个服务器上面，自发自收，centralized 就是集中收集，一台服务器接收所有shipper(个人理解就是logstash agent)的日志。<br>其实 logstash本身不分 什么 shipper 和 collector ，只不过就是配置文件不同而已，我们这次按照集中的方式来测试</p>
<p>这里的Logstash分为index和agent两种角色，也可以说是收集方式分为standalone和centralized两种。standalone是所有功能都在一个服务器上面，自发自收，centralized就是集中收集，一台服务器接收所有shipper(个人理解就是logstash agent)的日志。（其实logstash本身不分什么shipper和collector ，只不过就是配置文件不同而已）。Logstash的agent和indexer分开部署，多台agent负责监控、过滤日志，index负责收集日志并将日志交给ElasticSearch做搜索，通过Kibana来结合自定义搜索进行页面展示。Redis实际上是起到了缓冲消峰的作用，否则并发访问量大的时候ES会被拖垮的。使用redis的push和pop做队列，然后有个logstash_indexer来从队列中pop数据分析插入elasticsearch。这样做的好处是可扩展，logstash_agent只需要收集log进入队列即可，比较可能会有瓶颈的log分析使用logstash_indexer来做，而这个logstash_indexer又是可以水平扩展的，我可以在单独的机器上跑多个indexer来进行日志分析存储。</p>
<p>192.168.0.1 logstash index，ElasticSearch，kibana，JDK<br>192.168.0.2 logstash agent，JDK<br>192.168.0.3 redis</p>
<p>因为上一篇文章已经写过Docker如何安装ES环境了，这里我们直接继承上一次安装好的Docker镜像，所以重点只介绍Logstash和Kibana的安装，本文只是简单的单机ELK环境，后续会逐步完善ELK+Redis的环境，甚至会把ELK单独拆开三个Docker镜像使用</p>
<h5 id="安装Logstash（本文使用的是logstash的1-5-4版本）"><a href="#安装Logstash（本文使用的是logstash的1-5-4版本）" class="headerlink" title="安装Logstash（本文使用的是logstash的1.5.4版本）"></a>安装Logstash（本文使用的是logstash的1.5.4版本）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 下载Logstash</div><div class="line">$ curl -O https://download.elastic.co/logstash/logstash/logstash-1.5.4.tar.gz</div><div class="line"></div><div class="line"># 解压ES压缩包</div><div class="line">$ tar -zxvf logstash-1.5.4.tar.gz</div><div class="line"></div><div class="line"># 在&#123;LOGSTASH_HOME&#125;下新建一个conf目录，在里面新建一个配置文件logstash.conf </div><div class="line">$ cd logstash-1.5.4</div><div class="line">$ mkdir conf</div><div class="line">$ cd conf</div><div class="line"></div><div class="line"># 编辑logstash.conf如下面的配置</div><div class="line">$ vi logstash.conf</div><div class="line"></div><div class="line"># 启动logstash</div><div class="line">$ cd &#123;LOGSTASH_HOME&#125;/bin/</div><div class="line">$ ./logstash -f ../conf/logstash.conf</div></pre></td></tr></table></figure>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>因为java的默认heap size,回收机制等原因,logstash从1.4.0开始不再使用jar运行方式.</p>
<ul>
<li>以前方式:<br>java -jar logstash-1.3.3-flatjar.jar agent -f logstash.conf</li>
<li>现在方式:<br>bin/logstash -f logstash.conf</li>
</ul>
<h5 id="logstash-conf配置文件"><a href="#logstash-conf配置文件" class="headerlink" title="logstash.conf配置文件"></a>logstash.conf配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">	# 来自控制台	stdin &#123;       type =&gt; &quot;web&quot;			# ES索引的type		codec =&gt; &quot;json&quot;			# 输入格式是json	&#125;</div><div class="line">	# 来自文件	file &#123;</div><div class="line">		# 文件所在的绝对路径		path =&gt; &quot;/software/logstash-1.5.4/test.log&quot;</div><div class="line">		# ES索引的type		type =&gt; &quot;system&quot;</div><div class="line">		# 文件格式是json		codec =&gt; &quot;json&quot;</div><div class="line">		# 从文件的什么位置开始采集       start_position =&gt; &quot;beginning&quot;	&#125;&#125;output &#123;</div><div class="line">	# 输出到控制台	stdout &#123;		codec =&gt; rubydebug	&#125;</div><div class="line">	# 输出到ES	elasticsearch &#123;</div><div class="line">		# 不使用logstash内嵌的ES		embedded =&gt; false		codec =&gt; &quot;json&quot;		protocol =&gt; &quot;http&quot;		host =&gt; &quot;10.211.55.4&quot;		port =&gt; 9200</div><div class="line">		# 指定创建的索引名称		index =&gt; &quot;birdlogstash&quot;	&#125;&#125;</div></pre></td></tr></table></figure>
<h5 id="test-log文件内容，放在-LOGSTASH-HOME-目录下"><a href="#test-log文件内容，放在-LOGSTASH-HOME-目录下" class="headerlink" title="test.log文件内容，放在{LOGSTASH_HOME}目录下"></a>test.log文件内容，放在{LOGSTASH_HOME}目录下</h5><pre><code>bird hello
bird test
bird bye
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 安装Kibana（本文使用的是kibana的4.1.2版本）</div></pre></td></tr></table></figure>

# 下载Kibana
$ curl -O https://download.elastic.co/kibana/kibana/kibana-4.1.2-linux-x64.tar.gz

# 解压ES压缩包
$ tar -zxvf kibana-4.1.2-linux-x64.tar.gz

# 重命名一下
$ mv kibana-4.1.2-linux-x64 kibana-4.1.2

# 启动Kibana
$ cd {KIBANA_HOME}/bin
$ ./kibana

# 访问http://192.168.1.120:5601/ 配置一个ElasticSearch索引 
# 在logstach里面添加数据 

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 注意</div></pre></td></tr></table></figure>

如果Kibana和ES不在同一台机器上，需要在kibana.yml文件中指定ES集群的地址
# The Elasticsearch instance to use for all your queries.
elasticsearch_url: &quot;http://10.211.55.4:9200&quot;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### Dockerfile文件</div></pre></td></tr></table></figure>

############################################
# version : birdben/elk:v1
# desc : 当前版本安装的elk
############################################
# 设置继承自我们创建的 elasticsearch 镜像
FROM birdben/elasticsearch:v1

# 下面是一些创建者的基本信息
MAINTAINER birdben (191654006@163.com)

# 设置环境变量，所有操作都是非交互式的
ENV DEBIAN_FRONTEND noninteractive

# 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

RUN echo &quot;export LC_ALL=C&quot;

# 设置 ES 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。
ENV LOGSTASH_HOME /software/logstash-1.5.4
ENV KIBANA_HOME /software/kibana-4.1.2

# 复制 logstash-1.5.4, kibana-4.1.2 文件到镜像中（logstash-1.5.4, kibana-4.1.2文件夹要和Dockerfile文件在同一路径）
ADD logstash-1.5.4 /software/logstash-1.5.4
ADD kibana-4.1.2 /software/kibana-4.1.2

# 解决环境问题，否则logstash无法从log文件中采集日志。具体环境： Logstash 1.5, Ubuntu 14.04, Oracle JDK7
RUN ln -s /lib/x86_64-linux-gnu/libcrypt.so.1 /usr/lib/x86_64-linux-gnu/libcrypt.so

# 挂载/logstash目录
VOLUME [&quot;/logstash&quot;]

# 容器需要开放Kibana的5601端口
EXPOSE 5601

# 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。
CMD [&quot;/usr/bin/supervisord&quot;]
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### Dockerfile源文件链接：</div><div class="line">https://github.com/birdben/birdDocker/blob/master/elk/Dockerfile</div><div class="line"></div><div class="line">##### supervisor配置文件内容</div></pre></td></tr></table></figure>

# 配置文件包含目录和进程
# 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。
# 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。

[supervisord]
nodaemon=true

[program:sshd]
command=/usr/sbin/sshd -D

[program:elasticsearch]
command=/bin/bash -c &quot;exec ${ES_HOME}/bin/elasticsearch -DFOREGROUND&quot;

[program:logstash]
# 指定配置文件时，一定要使用绝对路径，相对路径是不好用的，这个坑已经踩过两次了。。
command=/software/logstash-1.5.4/bin/logstash -f /logstash/logstash.conf

[program:kibana]
command=/software/kibana-4.1.2/bin/kibana
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 注意</div></pre></td></tr></table></figure>

# 之前一直在supervisor使用如下配置来启动logstash，但是发现logstash刚启动起来自己就挂了，然后不断的在尝试重启。后来发现是配置文件没有找到，因为使用supervisor来配置服务的命令时，指定配置文件时，一定要使用绝对路径，相对路径是不好用的，这个坑已经踩过两次了。。这里再次鄙视一下自己。。

INFO success: logstash entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)
INFO exited: logstash (exit status 1; not expected)
INFO spawned: &apos;logstash&apos; with pid 12
INFO exited: logstash (exit status 1; not expected)
INFO spawned: &apos;logstash&apos; with pid 13
INFO exited: logstash (exit status 1; not expected)
INFO gave up: logstash entered FATAL state, too many start retries too quickly

# 这里使用supervisorctl status查看supervisor监控的所有服务，就会发现ES没有处于被监控状态
$ supervisorctl status
logstash                           FATAL      Exited too quickly (process log may have details)
sshd                             RUNNING    pid 6, uptime 0:01:49
elasticsearch                    RUNNING    pid 8, uptime 0:01:49
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">##### 控制台终端</div></pre></td></tr></table></figure>

# 构建镜像
$ docker build -t=&quot;birdben/elk:v1&quot; .
# 执行已经构件好的镜像
$ docker run -p 9999:22 -p 9200:9200 -p 9300:9300 -p 5601:5601 -t -i -v /docker/logstash:/logstash &quot;birdben/elk:v1&quot;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 测试Logstash</div></pre></td></tr></table></figure>

# 这里我们要测试几种方式的logstash输入和输出
logstash启动的参数
-e：代表控制台以字符串的方式输入conf配置
-f：代表指定文件的方式conf配置

############## logstash从控制台读取 ##############

# 只在CMD启动的进程export设置变量，而不是将变量赋值命令写入/etc/profile等脚本里，因此通过ssh方式登录容器获得的shell是没有这个变量的，所以ssh登录要提前设置JAVA_HOME环境变量
$ export JAVA_HOME=/software/jdk7

# 测试运行前端输出
$ {LOGSTASH_HOME}/bin/logstash -e &apos;input { stdin { } } output { stdout {} }&apos;
Logstash startup completed
hello
2015-12-20T08:17:06.312Z c7f05b587d11 hello

# 也可以使用rubydebug的形式输出到控制台
$ {LOGSTASH_HOME}/bin/logstash -e &apos;input { stdin { } } output { stdout {codec=&gt;rubydebug} }&apos;
Logstash startup completed
hello
{
       &quot;message&quot; =&gt; &quot;hello&quot;,
      &quot;@version&quot; =&gt; &quot;1&quot;,
    &quot;@timestamp&quot; =&gt; &quot;2015-12-20T13:35:38.996Z&quot;,
          &quot;host&quot; =&gt; &quot;40421a32fbc5&quot;
}

# 还可以将控制台的输入，输出到ES并且创建对应的索引
$ {LOGSTASH_HOME}/bin/logstash -e &apos;input { stdin { type =&gt; &quot;web&quot; codec =&gt; &quot;json&quot; } } output { stdout { codec =&gt; rubydebug } elasticsearch { embedded =&gt; false codec =&gt; &quot;json&quot; protocol =&gt; &quot;http&quot; host =&gt; &quot;10.211.55.4&quot; port =&gt; 9200 } }&apos;
Logstash startup completed
{&quot;name&quot;:&quot;bird&quot;}
{
          &quot;name&quot; =&gt; &quot;bird&quot;,
      &quot;@version&quot; =&gt; &quot;1&quot;,
    &quot;@timestamp&quot; =&gt; &quot;2015-12-20T13:35:38.996Z&quot;,
          &quot;type&quot; =&gt; &quot;web&quot;,
          &quot;host&quot; =&gt; &quot;40421a32fbc5&quot;
}

# 执行之后，可以查询ES的索引，会自动创建一个logstash的索引，并且会有一个对应的属性name，它的值是bird
$ curl -XPOST &apos;http://10.211.55.4:9200/_search?pretty&apos; -d &apos;{&quot;query&quot;:{&quot;match_all&quot;:{}}}&apos;

############## logstash从文件中读取 ##############

$ {LOGSTASH_HOME}/bin/logstash -f /logstash/logstash.conf

# 从文件中读取日志，可能会遇到下面的问题
NotImplementedError: block device detection unsupported or native support failed to load
    from org/jruby/RubyFileTest.java:67:in `blockdev?&apos;
    from (irb):1:in `evaluate&apos;
    from org/jruby/RubyKernel.java:1107:in `eval&apos;
    from org/jruby/RubyKernel.java:1507:in `loop&apos;
    from org/jruby/RubyKernel.java:1270:in `catch&apos;
    from org/jruby/RubyKernel.java:1270:in `catch&apos;
    from /home/ubuntu/logstash-1.5.0-rc3/lib/logstash/runner.rb:77:in `run&apos;
    from org/jruby/RubyProc.java:271:in `call&apos;
    from /home/ubuntu/logstash-1.5.0-rc3/lib/logstash/runner.rb:131:in `run&apos;
    from org/jruby/RubyProc.java:271:in `call&apos;
    from /home/ubuntu/logstash-1.5.0-rc3/vendor/bundle/jruby/1.9/gems/stud-0.0.19/lib/stud/task.rb:12:in `initialize&apos;

# 上面的问题原因是环境问题，解决方案是先执行下面的语句，然后在运行logstash
ln -s /lib/x86_64-linux-gnu/libcrypt.so.1 /usr/lib/x86_64-linux-gnu/libcrypt.so

# 参考文章：
https://github.com/elastic/logstash/issues/3127#issuecomment-101068714

# 改好上面的问题之后logstash就会将文件的内容读取并输出到ES，使用下面的语句进行查询，就可以看到之前test.log中的3行记录，被ES创建了3条索引记录
$ curl -XPOST &apos;http://10.211.55.4:9200/_search?pretty&apos; -d &apos;{&quot;query&quot;:{&quot;match_all&quot;:{}}}&apos;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 测试Kibana</div></pre></td></tr></table></figure>

# 浏览器直接访问
http://10.211.55.4:5601

# 如果ES还没有索引，你需要告诉它你打算探索哪个 Elasticsearch 索引。第一次访问 Kibana 的时候，你会被要求定义一个 index pattern 用来匹配一个或者多个索引名。好了。这就是你需要做的全部工作。以后你还可以随时从 Settings 标签页添加更多的 index pattern。

# 因为我们在Logstash配置了从log文件中读取数据并且输出到ES的索引上，配置文件中已经指定了索引的名称&quot;birdlogstash&quot;，这样我们在Kibana只要指定这个索引名称就可以了，同理我们也可以在Logstash中改成按照日期分割的方式，Kibana也可以按照这种方式来配置。

# 指定创建的索引名称
index =&gt; &quot;birdlogstash&quot;

# 指定创建的索引名称（按照索引类型和日期分割）
index =&gt; &quot;logstash-%{type}-%{+YYYY.MM.dd}&quot;

# 默认情况下，Kibana 会连接运行在 localhost 的 Elasticsearch。要连接其他 Elasticsearch 实例，修改 kibana.yml 里的 Elasticsearch URL，然后重启 Kibana。如何在生产环境下使用 Kibana，阅读生产环境部署章节。
http://kibana.logstash.es/content/kibana/v4/production.html
</code></pre><p>参考文章：</p>
<ul>
<li><a href="http://www.iyunv.com/thread-73371-1-1.html" target="_blank" rel="external">http://www.iyunv.com/thread-73371-1-1.html</a></li>
<li><a href="http://kibana.logstash.es/content/logstash/plugins/output/elasticsearch.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/plugins/output/elasticsearch.html</a></li>
<li><a href="http://langke.name/2014/12/18/elk-2.html" target="_blank" rel="external">http://langke.name/2014/12/18/elk-2.html</a></li>
<li><a href="http://blog.chinaunix.net/uid-532511-id-4836683.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-532511-id-4836683.html</a></li>
<li><a href="http://www.wklken.me/posts/2015/04/26/elk-for-nginx-log.html#3-supervisor" target="_blank" rel="external">http://www.wklken.me/posts/2015/04/26/elk-for-nginx-log.html#3-supervisor</a></li>
<li><a href="http://ju.outofmemory.cn/entry/108925" target="_blank" rel="external">http://ju.outofmemory.cn/entry/108925</a></li>
<li><a href="http://article.yeeyan.org/view/536432/459461" target="_blank" rel="external">http://article.yeeyan.org/view/536432/459461</a></li>
<li><a href="http://qindongliang.iteye.com/blog/2250776www" target="_blank" rel="external">http://qindongliang.iteye.com/blog/2250776www</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/">ELK</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Docker/Docker实战（八）Docker安装ElasticSearch环境" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/20/Docker/Docker实战（八）Docker安装ElasticSearch环境/" class="article-date">
  	<time datetime="2015-12-19T16:56:34.000Z" itemprop="datePublished">2015-12-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/20/Docker/Docker实战（八）Docker安装ElasticSearch环境/">Docker实战（八）Docker安装ElasticSearch环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基本步骤和之前几篇文章一样，请参考前面的相关文章</p>
<h5 id="ElasticSearch安装"><a href="#ElasticSearch安装" class="headerlink" title="ElasticSearch安装"></a>ElasticSearch安装</h5><ul>
<li>1.安装ES</li>
<li>2.安装head,bigdesk插件</li>
<li>3.安装ik插件</li>
<li>4.配置ES集群</li>
</ul>
<h5 id="安装ES（本文使用的是elasticsearch的1-7-2版本）"><a href="#安装ES（本文使用的是elasticsearch的1-7-2版本）" class="headerlink" title="安装ES（本文使用的是elasticsearch的1.7.2版本）"></a>安装ES（本文使用的是elasticsearch的1.7.2版本）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 下载ES</div><div class="line">$ curl -O https://download.elastic.co/elasticsearch/elasticsearch/elasticsearch-1.7.2.tar.gz</div><div class="line"></div><div class="line"># 解压ES压缩包</div><div class="line">$ tar -zxvf elasticsearch-1.7.2.tar.gz</div><div class="line"></div><div class="line"># 启动ES</div><div class="line">$ sudo ./elasticsearch -d</div></pre></td></tr></table></figure>
<h5 id="安装head-bigdesk-HQ-kopf插件（可选择安装，建议安装head和bigdesk）"><a href="#安装head-bigdesk-HQ-kopf插件（可选择安装，建议安装head和bigdesk）" class="headerlink" title="安装head,bigdesk,HQ,kopf插件（可选择安装，建议安装head和bigdesk）"></a>安装head,bigdesk,HQ,kopf插件（可选择安装，建议安装head和bigdesk）</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ $&#123;ES_HOME&#125;/bin/plugin --install mobz/elasticsearch-head</div><div class="line"># 安装完成访问：http://localhost:9200/_plugin/head/</div><div class="line"></div><div class="line">$ $&#123;ES_HOME&#125;/bin/plugin --install lukas-vlcek/bigdesk</div><div class="line"># 安装完成访问：http://localhost:9200/_plugin/bigdesk/#nodes</div><div class="line"></div><div class="line">$ $&#123;ES_HOME&#125;/bin/plugin -install royrusso/elasticsearch-HQ</div><div class="line"># 安装完成访问：http://localhost:9200/_plugin/HQ/</div><div class="line"></div><div class="line">$ $&#123;ES_HOME&#125;/bin/plugin -install lmenezes/elasticsearch-kopf</div><div class="line"># 安装完成访问：http://localhost:9200/_plugin/kopf/#!/cluster</div></pre></td></tr></table></figure>
<h5 id="安装ik插件"><a href="#安装ik插件" class="headerlink" title="安装ik插件"></a>安装ik插件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 因为我使用的是老版本的ES，所以ik插件也使用的是对应老版本的</div><div class="line">$ git clone https://github.com/medcl/elasticsearch-analysis-ik</div><div class="line">$ cd elasticsearch-analysis-ik</div><div class="line">$ mvn clean</div><div class="line">$ mvn compile</div><div class="line">$ mvn package</div><div class="line">$ cd target</div><div class="line">$ cp elasticsearch-analysis-ik-xxx.jar $&#123;ES_HOME&#125;/plugins/ik/</div><div class="line"></div><div class="line">$ cd elasticsearch-analysis-ik</div><div class="line">$ cp config/ik $&#123;ES_HOME&#125;/config/</div></pre></td></tr></table></figure>
<h5 id="配置elasticsearch-yml文件，在文件的最后添加下面的配置"><a href="#配置elasticsearch-yml文件，在文件的最后添加下面的配置" class="headerlink" title="配置elasticsearch.yml文件，在文件的最后添加下面的配置"></a>配置elasticsearch.yml文件，在文件的最后添加下面的配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">index:</div><div class="line">  analysis:</div><div class="line">    analyzer:</div><div class="line">      ik:</div><div class="line">          alias: [ik_analyzer]</div><div class="line">          type: org.elasticsearch.index.analysis.IkAnalyzerProvider</div><div class="line">      ik_max_word:</div><div class="line">          type: ik</div><div class="line">          use_smart: false</div><div class="line">      ik_smart:</div><div class="line">          type: ik</div><div class="line">          use_smart: true</div><div class="line"></div><div class="line">index.analysis.analyzer.default.type: ik</div><div class="line">index.store.type: niofs</div></pre></td></tr></table></figure>
<h5 id="设置ES的内存大小"><a href="#设置ES的内存大小" class="headerlink" title="设置ES的内存大小"></a>设置ES的内存大小</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ &#123;ES_HOME&#125;/bin</div><div class="line">$ vi elasticsearch</div><div class="line"></div><div class="line"># 设置ES的最大内存，最小内存</div><div class="line">ES_MIN_MEM=4g</div><div class="line">ES_MAX_MEM=4g</div></pre></td></tr></table></figure>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>如果这里不设置ES的内存大小，后面整合ELK环境的时候，Logstash会无法批量在ES创建索引而报错，具体错误信息如下。所以在ES启动时设置ES的内存大小，建议是实际内存的一半</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Got error to send bulk of actions: Connection reset &#123;:level=&gt;:error&#125;</div></pre></td></tr></table></figure>
<p>这个内存配置不能随便设置，必须根据实际情况进行设置，否则设置之后ES就启动不起来了，报内存溢出的错误，建议尽量不要随意修改此配置</p>
<h5 id="Dockerfile文件"><a href="#Dockerfile文件" class="headerlink" title="Dockerfile文件"></a>Dockerfile文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">############################################</div><div class="line"># version : birdben/elasticsearch:v1</div><div class="line"># desc : 当前版本安装的elasticsearch</div><div class="line">############################################</div><div class="line"># 设置继承自我们创建的 jdk7 镜像</div><div class="line">FROM birdben/jdk7:v1</div><div class="line"></div><div class="line"># 下面是一些创建者的基本信息</div><div class="line">MAINTAINER birdben (191654006@163.com)</div><div class="line"></div><div class="line"># 设置环境变量，所有操作都是非交互式的</div><div class="line">ENV DEBIAN_FRONTEND noninteractive</div><div class="line"></div><div class="line"># 添加 supervisord 的配置文件，并复制配置文件到对应目录下面。（supervisord.conf文件和Dockerfile文件在同一路径）</div><div class="line">COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf</div><div class="line"></div><div class="line">RUN echo &quot;export LC_ALL=C&quot;</div><div class="line"></div><div class="line"># 设置 ES 的环境变量，若读者有其他的环境变量需要设置，也可以在这里添加。</div><div class="line">ENV ES_HOME /software/elasticsearch-1.7.2</div><div class="line"></div><div class="line"># 复制 elasticsearch-1.7.2 文件到镜像中（elasticsearch-1.7.2文件夹要和Dockerfile文件在同一路径）</div><div class="line">ADD elasticsearch-1.7.2 /software/elasticsearch-1.7.2</div><div class="line"></div><div class="line"># 容器需要开放ES的9200和9300端口</div><div class="line">EXPOSE 9200</div><div class="line">EXPOSE 9300</div><div class="line"></div><div class="line"># 执行supervisord来同时执行多个命令，使用 supervisord 的可执行路径启动服务。</div><div class="line">CMD [&quot;/usr/bin/supervisord&quot;]</div></pre></td></tr></table></figure>
<h5 id="Dockerfile源文件链接："><a href="#Dockerfile源文件链接：" class="headerlink" title="Dockerfile源文件链接："></a>Dockerfile源文件链接：</h5><p><a href="https://github.com/birdben/birdDocker/blob/master/elasticsearch/Dockerfile">https://github.com/birdben/birdDocker/blob/master/elasticsearch/Dockerfile</a></p>
<h5 id="supervisor配置文件内容"><a href="#supervisor配置文件内容" class="headerlink" title="supervisor配置文件内容"></a>supervisor配置文件内容</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 配置文件包含目录和进程</div><div class="line"># 第一段 supervsord 配置软件本身，使用 nodaemon 参数来运行。</div><div class="line"># 第二段包含要控制的 2 个服务。每一段包含一个服务的目录和启动这个服务的命令。</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">nodaemon=true</div><div class="line"></div><div class="line">[program:sshd]</div><div class="line">command=/usr/sbin/sshd -D</div><div class="line"></div><div class="line"># 修改supervisor配置方式如下，修改为不自动重启ES，并且改成非daemon，DFOREGROUND的方式运行，supervisor就可以监控到了</div><div class="line">[program:elasticsearch]</div><div class="line">command=/bin/bash -c &quot;exec $&#123;ES_HOME&#125;/bin/elasticsearch -DFOREGROUND&quot;</div></pre></td></tr></table></figure>
<h5 id="注意supervisor配置"><a href="#注意supervisor配置" class="headerlink" title="注意supervisor配置"></a>注意supervisor配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># 之前一直在supervisor使用如下配置来启动ES，但是仔细观察Docker的控制台输出会发现如下的错误</div><div class="line">[program:elasticsearch]</div><div class="line">command=/&#123;ES_HOME&#125;/bin/elasticsearch -d</div><div class="line"></div><div class="line">INFO success: elasticsearch entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)</div><div class="line">INFO exited: elasticsearch (exit status 1; not expected)</div><div class="line">INFO spawned: &apos;elasticsearch&apos; with pid 12</div><div class="line">INFO exited: elasticsearch (exit status 1; not expected)</div><div class="line">INFO spawned: &apos;elasticsearch&apos; with pid 13</div><div class="line">INFO exited: elasticsearch (exit status 1; not expected)</div><div class="line">INFO gave up: elasticsearch entered FATAL state, too many start retries too quickly</div><div class="line"></div><div class="line"># 这里使用supervisorctl status查看supervisor监控的所有服务，就会发现ES没有处于被监控状态</div><div class="line">$ supervisorctl status</div><div class="line">elasticsearch                    FATAL      Exited too quickly (process log may have details)</div><div class="line">sshd                             RUNNING    pid 6, uptime 0:01:49</div><div class="line">tomcat                           RUNNING    pid 8, uptime 0:01:49</div><div class="line"></div><div class="line"># 所以这里修改supervisor配置方式如下，修改为不自动重启ES，并且改成非daemon，DFOREGROUND的方式运行，supervisor就可以监控到了</div><div class="line">[program:elasticsearch]startsecs = 0autorestart = falsecommand=/bin/bash -c &quot;exec $&#123;ES_HOME&#125;/bin/elasticsearch -DFOREGROUND&quot;</div><div class="line"></div><div class="line"># 这里说明一下supervisor启动多个服务，要求所有启动的服务都是非daemon的方式启动，否则就会遇到如上的问题，autorestart设置为false只是为了让supervisor启动报错的时候不会重复启动，只要改成非daemon的方式启动ES，可以设置autorestart为true</div></pre></td></tr></table></figure>
<p>参考文章</p>
<ul>
<li><a href="http://www.dedoimedo.com/computers/docker-supervisord.html" target="_blank" rel="external">http://www.dedoimedo.com/computers/docker-supervisord.html</a></li>
<li><a href="http://dockerpool.com/static/books/docker_practice/cases/supervisor.html" target="_blank" rel="external">http://dockerpool.com/static/books/docker_practice/cases/supervisor.html</a></li>
<li><a href="http://charlesleifer.com/blog/setting-up-elasticsearch-with-basic-auth-and-ssl-for-use-with-python/" target="_blank" rel="external">http://charlesleifer.com/blog/setting-up-elasticsearch-with-basic-auth-and-ssl-for-use-with-python/</a></li>
</ul>
<h5 id="控制台终端"><a href="#控制台终端" class="headerlink" title="控制台终端"></a>控制台终端</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 构建镜像</div><div class="line">$ docker build -t=&quot;birdben/elasticsearch:v1&quot; .</div><div class="line"># 执行已经构件好的镜像</div><div class="line">$ docker run -p 9999:22 -p 9200:9200 -p 9300:9300 -t -i &apos;birdben/elasticsearch:v1&apos;</div></pre></td></tr></table></figure>
<h5 id="访问ElasticSearch的插件测试"><a href="#访问ElasticSearch的插件测试" class="headerlink" title="访问ElasticSearch的插件测试"></a>访问ElasticSearch的插件测试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://10.211.55.4:9200/_plugin/head/</div><div class="line">http://10.211.55.4:9200/_plugin/bigdesk/#nodes</div></pre></td></tr></table></figure>
<h5 id="User索引的mapping"><a href="#User索引的mapping" class="headerlink" title="User索引的mapping"></a>User索引的mapping</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;user&quot;: &#123;</div><div class="line">    &quot;dynamic&quot; : &quot;strict&quot;,</div><div class="line">    &quot;properties&quot;: &#123;</div><div class="line">      &quot;id&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;string&quot;,</div><div class="line">        &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;name&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;string&quot;,</div><div class="line">        &quot;index_analyzer&quot;: &quot;ik&quot;,</div><div class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;age&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;integer&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;job&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;string&quot;,</div><div class="line">        &quot;index_analyzer&quot;: &quot;ik&quot;,</div><div class="line">        &quot;search_analyzer&quot;: &quot;ik_smart&quot;</div><div class="line">      &#125;,</div><div class="line">      &quot;createTime&quot;: &#123;</div><div class="line">        &quot;type&quot;: &quot;long&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="新建索引测试ik分词"><a href="#新建索引测试ik分词" class="headerlink" title="新建索引测试ik分词"></a>新建索引测试ik分词</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># 尝试创建user索引</div><div class="line">$ curl -XPOST &apos;http://10.211.55.4:9200/user?pretty&apos; -d &apos;@user.json&apos;</div><div class="line"></div><div class="line"># 如果遇到下面的错误，原因是$&#123;ES_HOME&#125;/lib/下需要引入httpclient-4.5.jar, httpcore-4.4.1.jar</div><div class="line">&#123;</div><div class="line">  &quot;error&quot; : &quot;IndexCreationException[[user] failed to create index]; nested: NoClassDefFoundError[org/apache/http/client/ClientProtocolException]; nested: ClassNotFoundException[org.apache.http.client.ClientProtocolException]; &quot;,</div><div class="line">  &quot;status&quot; : 500</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 创建索引成功后，查看索引信息</div><div class="line">$ curl -XGET &apos;http://10.211.55.4:9200/_cat/indices?pretty&apos;</div><div class="line">green open user 5 1 0 0 970b 575b</div><div class="line"></div><div class="line"># 测试ik分词效果</div><div class="line">$ curl -XGET &apos;http://10.211.55.4:9200/goods/_analyze?analyzer=ik&amp;pretty=true&apos; -d &apos;&#123;&quot;text&quot;:&quot;世界如此之大&quot;&#125;&apos;</div><div class="line"></div><div class="line"># 测试ik_smart分词效果</div><div class="line">$ curl -XGET &apos;http://10.211.55.4:9200/user/_analyze?analyzer=ik_smart&amp;pretty=true&apos; -d &apos;&#123;&quot;text&quot;:&quot;世界如此之大&quot;&#125;&apos;</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
<li><a href="http://my.oschina.net/xiaohui249/blog/232784" target="_blank" rel="external">http://my.oschina.net/xiaohui249/blog/232784</a></li>
<li><a href="http://my.oschina.net/xiaohui249/blog/228748" target="_blank" rel="external">http://my.oschina.net/xiaohui249/blog/228748</a></li>
<li><a href="http://www.mamicode.com/info-detail-943587.html" target="_blank" rel="external">http://www.mamicode.com/info-detail-943587.html</a></li>
<li><a href="http://ask.csdn.net/questions/154112" target="_blank" rel="external">http://ask.csdn.net/questions/154112</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dockerfile/">Dockerfile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker命令/">Docker命令</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ElasticSearch/">ElasticSearch</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Docker/">Docker</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/11/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/13/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 birdben
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82900755-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>