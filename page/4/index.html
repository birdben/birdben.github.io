<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>birdben</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="birdben">
<meta property="og:url" content="https://github.com/birdben/page/4/index.html">
<meta property="og:site_name" content="birdben">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="birdben">
  
    <link rel="alternative" href="/atom.xml" title="birdben" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260188951'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260188951' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/logo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">birdben</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/AWK/" style="font-size: 10.83px;">AWK</a> <a href="/tags/Akka/" style="font-size: 10.83px;">Akka</a> <a href="/tags/Dockerfile/" style="font-size: 20px;">Dockerfile</a> <a href="/tags/Docker命令/" style="font-size: 19.17px;">Docker命令</a> <a href="/tags/Docker环境/" style="font-size: 15px;">Docker环境</a> <a href="/tags/ELK/" style="font-size: 16.67px;">ELK</a> <a href="/tags/ElasticSearch/" style="font-size: 10.83px;">ElasticSearch</a> <a href="/tags/Elasticsearch/" style="font-size: 12.5px;">Elasticsearch</a> <a href="/tags/Flume/" style="font-size: 17.5px;">Flume</a> <a href="/tags/Git命令/" style="font-size: 13.33px;">Git命令</a> <a href="/tags/Go/" style="font-size: 14.17px;">Go</a> <a href="/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/tags/HDFS/" style="font-size: 18.33px;">HDFS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Hadoop原理架构体系/" style="font-size: 13.33px;">Hadoop原理架构体系</a> <a href="/tags/Hive/" style="font-size: 16.67px;">Hive</a> <a href="/tags/JVM/" style="font-size: 11.67px;">JVM</a> <a href="/tags/Java-Web，Socket，Python/" style="font-size: 10px;">Java Web，Socket，Python</a> <a href="/tags/Jenkins环境/" style="font-size: 10px;">Jenkins环境</a> <a href="/tags/Kafka/" style="font-size: 15.83px;">Kafka</a> <a href="/tags/Kibana/" style="font-size: 14.17px;">Kibana</a> <a href="/tags/Linux命令/" style="font-size: 12.5px;">Linux命令</a> <a href="/tags/Logstash/" style="font-size: 15.83px;">Logstash</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/MapReduce/" style="font-size: 11.67px;">MapReduce</a> <a href="/tags/Maven配置/" style="font-size: 11.67px;">Maven配置</a> <a href="/tags/MongoDB/" style="font-size: 11.67px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shadowsocks/" style="font-size: 10px;">Shadowsocks</a> <a href="/tags/Shell/" style="font-size: 16.67px;">Shell</a> <a href="/tags/Spring/" style="font-size: 10.83px;">Spring</a> <a href="/tags/Storm/" style="font-size: 12.5px;">Storm</a> <a href="/tags/Zookeeper/" style="font-size: 12.5px;">Zookeeper</a> <a href="/tags/其他/" style="font-size: 10px;">其他</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/birdben">我的CSDN的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">birdben</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/logo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">birdben</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Linux/Linux常用命令（四）" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/26/Linux/Linux常用命令（四）/" class="article-date">
  	<time datetime="2016-12-26T06:02:50.000Z" itemprop="datePublished">2016-12-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/26/Linux/Linux常用命令（四）/">Linux常用命令（四）</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="kill命令"><a href="#kill命令" class="headerlink" title="kill命令"></a>kill命令</h3><p>kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。</p>
<ol>
<li><p>命令格式：<br>kill[参数][进程号]</p>
</li>
<li><p>命令功能：<br>发送指定的信号到相应进程。不指定信号将发送SIGTERM（15）终止指定进程。如果任无法终止该程序可用“-KILL” 参数，其发送的信号为SIGKILL(9) ，将强制结束进程，使用ps命令或者jobs 命令可以查看进程号。root用户将影响用户的进程，非root用户只能影响自己的进程。</p>
</li>
<li><p>命令参数：</p>
</li>
</ol>
<ul>
<li>-l  信号，若果不加信号的编号参数，则使用“-l”参数会列出全部的信号名称</li>
<li>-a  当处理当前进程时，不限制命令名和进程号的对应关系</li>
<li>-p  指定kill 命令只打印相关进程的进程号，而不发送任何信号</li>
<li>-s  指定发送信号</li>
<li>-u  指定用户</li>
</ul>
<p>注意：</p>
<ol>
<li><p>kill命令可以带信号号码选项，也可以不带。如果没有信号号码，kill命令就会发出终止信号(15)，这个信号可以被进程捕获，使得进程在退出之前可以清理并释放资源。也可以用kill向进程发送特定的信号。例如：<br>kill -2 123<br>它的效果等同于在前台运行PID为123的进程时按下Ctrl+C键。但是，普通用户只能使用不带signal参数的kill命令或最多使用-9信号。</p>
</li>
<li><p>-9信号使进程强行终止，这常会带来一些副作用，如数据丢失或者终端无法恢复到正常状态。发送信号时必须小心，只有在万不得已时，才用kill信号(9)，因为进程不能首先捕获它。要撤销所有的后台作业，可以输入kill 0。因为有些在后台运行的命令会启动多个进程，跟踪并找到所有要杀掉的进程的PID是件很麻烦的事。这时，使用kill 0来终止所有由当前shell启动的进程，是个有效的方法。</p>
</li>
<li><p>特殊用法：kill -0 pid 不发送任何信号，但是系统会进行错误检查。所以经常用来检查一个进程是否存在，存在返回0；不存在返回1</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 以下的方式都是使用TERM方式终止进程</div><div class="line">$ kill pid</div><div class="line">$ kill -15 pid</div><div class="line">$ kill -TERM pid</div><div class="line">$ kill -SIGTERM pid</div><div class="line"></div><div class="line"># 以下的方式都是使用KILL方式终止进程</div><div class="line">$ kill -9 pid</div><div class="line">$ kill -KILL pid</div><div class="line">$ kill -SIGKILL pid</div></pre></td></tr></table></figure>
<h4 id="kill-pid与kill-9-pid的区别"><a href="#kill-pid与kill-9-pid的区别" class="headerlink" title="kill pid与kill -9 pid的区别"></a>kill pid与kill -9 pid的区别</h4><ul>
<li>kill pid的作用是向进程号为pid的进程发送SIGTERM（这是kill默认发送的信号），该信号是一个结束进程的信号且可以被应用程序捕获。若应用程序没有捕获并响应该信号的逻辑代码，则该信号的默认动作是kill掉进程。这是终止指定进程的推荐做法。</li>
</ul>
<p>一旦进程接收到了SIGTERM信号，会有下面几种情况发生</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">the process may stop immediately</div><div class="line">the process may stop after a short delay after cleaning up resources</div><div class="line">the process may keep running indefinitely</div></pre></td></tr></table></figure>
<p>当接收到SIGTERM信号应用程序可以决定它自己如何处理，大多数的应用程序将会清理他们的资源并且停止运行，有一些则不是。当接收到SIGTERM信号一个应用程序可能会被配置做的事情完全不同。如果这个应用程序正处于一个不好的状态，例如等待磁盘IO，它可能无法相应我们发送的SIGTERM信号。</p>
<ul>
<li>kill -9 pid则是向进程号为pid的进程发送SIGKILL（该信号的编号为9），从本文上面的说明可知，SIGKILL既不能被应用程序捕获，也不能被阻塞或忽略，其动作是立即结束指定进程。通俗地说，应用程序根本无法“感知”SIGKILL信号，它在完全无准备的情况下，就被收到SIGKILL信号的操作系统给干掉了，显然，在这种“暴力”情况下，应用程序完全没有释放当前占用资源的机会。事实上，SIGKILL信号是直接发给init进程的，它收到该信号后，负责终止pid指定的进程。在某些情况下（如进程已经hang死，无法响应正常信号），就可以使用kill -9来结束进程。</li>
</ul>
<p>若通过kill结束的进程是一个创建过子进程的父进程，则其子进程就会成为孤儿进程（Orphan Process），这种情况下，子进程的退出状态就不能再被应用进程捕获（因为作为父进程的应用程序已经不存在了），不过应该不会对整个linux系统产生什么不利影响。</p>
<h4 id="应用程序如何优雅退出"><a href="#应用程序如何优雅退出" class="headerlink" title="应用程序如何优雅退出"></a>应用程序如何优雅退出</h4><p>Linux Server端的应用程序经常会长时间运行，在运行过程中，可能申请了很多系统资源，也可能保存了很多状态，在这些场景下，我们希望进程在退出前，可以释放资源或将当前状态dump到磁盘上或打印一些重要的日志，也就是希望进程优雅退出（exit gracefully）。</p>
<p>从上面的介绍不难看出，优雅退出可以通过捕获SIGTERM来实现。具体来讲，通常只需要两步动作：</p>
<p>1）注册SIGTERM信号的处理函数并在处理函数中做一些进程退出的准备。信号处理函数的注册可以通过signal()或sigaction()来实现，其中，推荐使用后者来实现信号响应函数的设置。信号处理函数的逻辑越简单越好，通常的做法是在该函数中设置一个bool型的flag变量以表明进程收到了SIGTERM信号，准备退出。</p>
<p>2）在主进程的main()中，通过类似于while(!bQuit)的逻辑来检测那个flag变量，一旦bQuit在signal handler function中被置为true，则主进程退出while()循环，接下来就是一些释放资源或dump进程当前状态或记录日志的动作，完成这些后，主进程退出。</p>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/pecywang/article/details/8558968" target="_blank" rel="external">http://blog.csdn.net/pecywang/article/details/8558968</a></li>
<li><a href="http://www.cnblogs.com/peida/archive/2012/12/20/2825837.html" target="_blank" rel="external">http://www.cnblogs.com/peida/archive/2012/12/20/2825837.html</a></li>
<li><a href="http://blog.csdn.net/slvher/article/details/8977338" target="_blank" rel="external">http://blog.csdn.net/slvher/article/details/8977338</a></li>
<li><a href="https://major.io/2010/03/18/sigterm-vs-sigkill/" target="_blank" rel="external">https://major.io/2010/03/18/sigterm-vs-sigkill/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux命令/">Linux命令</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Linux/">Linux</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Elasticsearch/Elasticsearch学习（一）集群red状态的处理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/22/Elasticsearch/Elasticsearch学习（一）集群red状态的处理/" class="article-date">
  	<time datetime="2016-12-22T13:25:14.000Z" itemprop="datePublished">2016-12-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/22/Elasticsearch/Elasticsearch学习（一）集群red状态的处理/">Elasticsearch学习（一）集群red状态的处理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天刚刚搭建好公司的日志收集系统，晚上的时候根据Kafka的生产和消费速度情况适当的调节了一下Logstash和ES的配置，做了一些配置的优化。但是没过多久居然出现了集群red状态的情况。突然感觉好慌张，通过head插件看了一下当前集群的问题，发现有两个索引的shared是无法分配的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 查看集群的索引情况</div><div class="line">curl -XGET &apos;http://localhost:9200/_cluster/health?level=indices&amp;pretty&apos;</div><div class="line"></div><div class="line"># 查看集群的分片情况</div><div class="line">curl -XGET &apos;http://localhost:9200/_cluster/health?level=shards&amp;pretty&apos;</div></pre></td></tr></table></figure>
<p>根据ES的集群API查看一下索引和分片的健康情况<br>以前遇到这种情况通常手动做reroute操作就可以分配了，但是这次的情况有些特殊。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/_cluster/reroute?pretty&apos; -d &apos;&#123;</div><div class="line">    &quot;commands&quot; : [ &#123;</div><div class="line">        &quot;allocate&quot; : &#123;</div><div class="line">            &quot;index&quot; : &quot;node_access_logs_index_2016.12.21&quot;,</div><div class="line">            &quot;shard&quot; : 0,</div><div class="line">            &quot;node&quot; : &quot;node-1&quot;,</div><div class="line">            &quot;allow_primary&quot; : true</div><div class="line">        &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;&apos;</div></pre></td></tr></table></figure>
<p>尝试了reroute操作后，报错如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;state&quot; : &quot;INITIALIZING&quot;,</div><div class="line">  &quot;primary&quot; : true,</div><div class="line">  &quot;node&quot; : &quot;MsryV3-fTOCdgolwpxd0_w&quot;,</div><div class="line">  &quot;relocating_node&quot; : null,</div><div class="line">  &quot;shard&quot; : 0,</div><div class="line">  &quot;index&quot; : &quot;node_track_logs_index_2016.12.21&quot;,</div><div class="line">  &quot;version&quot; : 3,</div><div class="line">  &quot;allocation_id&quot; : &#123;</div><div class="line">    &quot;id&quot; : &quot;lOUerCpGQTWcX0grHWLr0Q&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;unassigned_info&quot; : &#123;</div><div class="line">    &quot;reason&quot; : &quot;INDEX_CREATED&quot;,</div><div class="line">    &quot;at&quot; : &quot;2016-12-22T13:03:08.686Z&quot;,</div><div class="line">    &quot;details&quot; : &quot;force allocation from previous reason ALLOCATION_FAILED, failed to create shard, failure ElasticsearchException[failed to create shard]; nested: ElasticsearchParseException[Failed to parse setting [index.refresh_interval] with value [10] as a time value: unit is missing or unrecognized]; &quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过上面的错误信息，我们能够看出来其实这个问题是我马虎造成的，配置我们的Logstash创建索引的Template模板参数错误没有带时间单位，正确的配置应该是”index.refresh_interval”: “10s”，我之前的配置少了单位秒，所以ES重新分片的时候会报错[Failed to parse setting [index.refresh_interval] with value [10] as a time value: unit is missing or unrecognized]</p>
<p>知道问题的原因之后，我尝试直接修改线上索引Mapping的setting设置，将”index.refresh_interval”: “10s”的单位加上，发现报错如下，提示是当前索引的primary shared不可用，所以无法修改Mapping。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">curl -XPOST &apos;localhost:9200/node_track_logs_index_2016.12.21/_settings?pretty&apos; -d&apos;</div><div class="line">&#123;</div><div class="line">      &quot;index.number_of_replicas&quot;: &quot;1&quot;,</div><div class="line">      &quot;index.number_of_shards&quot;: &quot;5&quot;,</div><div class="line">      &quot;index.refresh_interval&quot;: &quot;10s&quot;</div><div class="line">&#125;&apos;</div><div class="line">&#123;</div><div class="line">  &quot;error&quot; : &#123;</div><div class="line">    &quot;root_cause&quot; : [ &#123;</div><div class="line">      &quot;type&quot; : &quot;unavailable_shards_exception&quot;,</div><div class="line">      &quot;reason&quot; : &quot;[node_track_logs_index_2016.12.21][0] primary shard is not active Timeout: [1m], request: [index &#123;[node_track_logs_index_2016.12.21]</div><div class="line">[_settings][AVkmqvF1jCuNyx9kvqWT], source[\n&#123;\n      \&quot;index.number_of_replicas\&quot;: \&quot;1\&quot;,\n      \&quot;index.number_of_shards\&quot;: \&quot;5\&quot;,\n      \&quot;index.refresh_interval\&quot;: \&quot;10s\&quot;\n&#125;]&#125;]&quot;</div><div class="line">    &#125; ],</div><div class="line">    &quot;type&quot; : &quot;unavailable_shards_exception&quot;,</div><div class="line">    &quot;reason&quot; : &quot;[node_track_logs_index_2016.12.21][0] primary shard is not active Timeout: [1m], request: [index &#123;[node_track_logs_index_2016.12.21][_settings][AVkmqvF1jCuNyx9kvqWT], source[\n&#123;\n      \&quot;index.number_of_replicas\&quot;: \&quot;1\&quot;,\n      \&quot;index.number_of_shards\&quot;: \&quot;5\&quot;,\n      \&quot;index.refresh_interval\&quot;: \&quot;10s\&quot;\n&#125;]&#125;]&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;status&quot; : 503</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>后来仔细想了一下我们这个Template是在Logstash按天创建索引的的时候才会使用的，所以我们unassign的node_track_logs_index_2016.12.21和node_proxy_logs_index_2016.12.21索引其实是正好需要按天创建新索引创建的，所以直接删除掉该索引，重启Logstash按照新的Template创建索引的Mapping就好了。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_cluster_health.html#_drilling_deeper_finding_problematic_indices" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/current/_cluster_health.html#_drilling_deeper_finding_problematic_indices</a></li>
<li><a href="http://www.searchtech.pro/elasticsearch-manual-allocate-shard" target="_blank" rel="external">http://www.searchtech.pro/elasticsearch-manual-allocate-shard</a></li>
<li><a href="http://openskill.cn/article/107" target="_blank" rel="external">http://openskill.cn/article/107</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Search/">Search</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Logstash/Logstash学习（六）elasticsearch插件——设置ES的Template" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/22/Logstash/Logstash学习（六）elasticsearch插件——设置ES的Template/" class="article-date">
  	<time datetime="2016-12-22T06:55:58.000Z" itemprop="datePublished">2016-12-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/22/Logstash/Logstash学习（六）elasticsearch插件——设置ES的Template/">Logstash学习（六）elasticsearch插件——设置ES的Template</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们使用ElasticSearch时一般需要自己创建ElasticSearch的索引的Mapping，当索引非常多的时候，可能需要配置一个索引模板Template来对类似的索引做统一配置，让索引模板Template中配置匹配索引的规则，来确定该Template会被应用到哪些索引上。</p>
<p>当Logstash在整合ElasticSearch的时候，会有下面三种方式的Template配置：</p>
<h3 id="Template配置方式"><a href="#Template配置方式" class="headerlink" title="Template配置方式"></a>Template配置方式</h3><h5 id="1-使用ElasticSearch默认自带的索引模板"><a href="#1-使用ElasticSearch默认自带的索引模板" class="headerlink" title="1. 使用ElasticSearch默认自带的索引模板"></a>1. 使用ElasticSearch默认自带的索引模板</h5><p>ElasticSearch默认自带了一个名字为”logstash”的模板，默认应用于Logstash写入数据到ElasticSearch使用</p>
<ul>
<li>优点：最简单，无须任何配置</li>
<li>缺点：无法自定义一些配置，例如：分词方式</li>
</ul>
<h5 id="2-在Logstash-Indexer端自定义配置索引模板"><a href="#2-在Logstash-Indexer端自定义配置索引模板" class="headerlink" title="2. 在Logstash Indexer端自定义配置索引模板"></a>2. 在Logstash Indexer端自定义配置索引模板</h5><p>Logstash的output插件中使用template指定本机器上的一个模板json文件路径，可以在json文件中设置对应的Template模板信息。例如：template =&gt; “/tmp/logstash.json”</p>
<ul>
<li>优点：配置简单</li>
<li>缺点：因为分散在Logstash Indexer机器上，维护起来比较麻烦</li>
</ul>
<h5 id="3-在ElasticSearch服务端自定义配置索引模板"><a href="#3-在ElasticSearch服务端自定义配置索引模板" class="headerlink" title="3. 在ElasticSearch服务端自定义配置索引模板"></a>3. 在ElasticSearch服务端自定义配置索引模板</h5><p>由ElasticSearch负责加载模板。这种方式需要在ElasticSearch的集群中的config/templates路径下配置模板json。而且ElasticSearch提供了Restful API接口维护索引模板信息。</p>
<ul>
<li>优点：维护比较容易，可动态更改，全局生效。</li>
<li>缺点：需要注意模板的命名规则，比较容易通过看Template名字就能够确定模板应用到哪些索引</li>
</ul>
<p>这里可能使用第三种方式统一管理Template最好，推荐使用第三种方式，但是具体问题具体分析。例如我现在的场景就使用的第二种方式，因为我们的Logstash Indexer和ElasticSearch只有一台服务器，所以在Logstash Indexer端维护Template文件也可以。</p>
<h3 id="模板类型"><a href="#模板类型" class="headerlink" title="模板类型"></a>模板类型</h3><p>ElasticSearch的模板类型主要由两种：静态模板和动态模板</p>
<h5 id="静态模板"><a href="#静态模板" class="headerlink" title="静态模板"></a>静态模板</h5><p>适合索引字段数据固定的场景，一旦配置完成，不能向里面加入多余的字段，否则会报错</p>
<ul>
<li>优点：scheam已知，业务场景明确，不容易出现因字段随便映射从而造成元数据撑爆es内存，从而导致es集群全部宕机</li>
<li>缺点：字段数多的情况下配置稍繁琐，针对于每个索引可能需要的模板都不同，很有可能需要配置很多个模板</li>
</ul>
<h5 id="动态模板"><a href="#动态模板" class="headerlink" title="动态模板"></a>动态模板</h5><p>适合字段数不明确，大量字段的配置类型相同的场景，可以按照类型规则动态添加新字段，新加字段不会报错。主要需要配置”dynamic_templates”</p>
<ul>
<li>优点：可动态添加任意字段，无须改动schema</li>
<li>缺点：无标准schema导致数据不规则，如果添加的字段非常多，有可能造成ES集群宕机</li>
</ul>
<p>需要注意：模板在设置生效后，仅对ES集群中新建立的索引生效，而对已存在的索引及时索引名满足模板的匹配规则，也不会生效，因此如果需要改变现有索引的Mapping信息，仍需要在正确的Mapping基础上建立新的索引，并将数据从原索引拷贝至新索引，变更新索引别名为原索引这种方式来实现。</p>
<h5 id="模板结构"><a href="#模板结构" class="headerlink" title="模板结构"></a>模板结构</h5><p>模板的结构大致分四部分：</p>
<p>第一部分：通用设置，主要是模板匹配索引的过滤规则，影响该模板对哪些索引生效；</p>
<p>第二部分：settings：配置索引的公共参数，比如索引的replicas，以及分片数shards等参数；</p>
<p>第三部分：mappings：最重要的一部分，在这部分中配置每个type下的每个field的相关属性，比如field类型（string,long,date等等），是否分词，是否在内存中缓存等等属性都在这部分配置；</p>
<p>第四部分：aliases：索引别名，索引别名可用在索引数据迁移等用途上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;logstash&quot; : &#123;</div><div class="line">    &quot;order&quot; : 0,</div><div class="line">    &quot;template&quot; : &quot;logstash-*&quot;,</div><div class="line">    &quot;settings&quot; : &#123;</div><div class="line">      &quot;index&quot; : &#123;</div><div class="line">        &quot;refresh_interval&quot; : &quot;5s&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;mappings&quot; : &#123;</div><div class="line">      &quot;_default_&quot; : &#123;</div><div class="line">        &quot;dynamic_templates&quot; : [ &#123;</div><div class="line">          &quot;message_field&quot; : &#123;</div><div class="line">            &quot;mapping&quot; : &#123;</div><div class="line">              &quot;fielddata&quot; : &#123;</div><div class="line">                &quot;format&quot; : &quot;disabled&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;index&quot; : &quot;analyzed&quot;,</div><div class="line">              &quot;omit_norms&quot; : true,</div><div class="line">              &quot;type&quot; : &quot;string&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;match_mapping_type&quot; : &quot;string&quot;,</div><div class="line">            &quot;match&quot; : &quot;message&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">          &quot;string_fields&quot; : &#123;</div><div class="line">            &quot;mapping&quot; : &#123;</div><div class="line">              &quot;fielddata&quot; : &#123;</div><div class="line">                &quot;format&quot; : &quot;disabled&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;index&quot; : &quot;analyzed&quot;,</div><div class="line">              &quot;omit_norms&quot; : true,</div><div class="line">              &quot;type&quot; : &quot;string&quot;,</div><div class="line">              &quot;fields&quot; : &#123;</div><div class="line">                &quot;raw&quot; : &#123;</div><div class="line">                  &quot;ignore_above&quot; : 256,</div><div class="line">                  &quot;index&quot; : &quot;not_analyzed&quot;,</div><div class="line">                  &quot;type&quot; : &quot;string&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;match_mapping_type&quot; : &quot;string&quot;,</div><div class="line">            &quot;match&quot; : &quot;*&quot;</div><div class="line">          &#125;</div><div class="line">        &#125; ],</div><div class="line">        &quot;_all&quot; : &#123;</div><div class="line">          &quot;omit_norms&quot; : true,</div><div class="line">          &quot;enabled&quot; : true</div><div class="line">        &#125;,</div><div class="line">        &quot;properties&quot; : &#123;</div><div class="line">          &quot;@timestamp&quot; : &#123;</div><div class="line">            &quot;type&quot; : &quot;date&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;geoip&quot; : &#123;</div><div class="line">            &quot;dynamic&quot; : true,</div><div class="line">            &quot;properties&quot; : &#123;</div><div class="line">              &quot;ip&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;ip&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;latitude&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;float&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;location&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;geo_point&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;longitude&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;float&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &quot;@version&quot; : &#123;</div><div class="line">            &quot;index&quot; : &quot;not_analyzed&quot;,</div><div class="line">            &quot;type&quot; : &quot;string&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;aliases&quot; : &#123; &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>总结：</p>
<p>定制索引模板，是搜索业务中一项比较重要的步骤，需要注意的地方有很多，比如：</p>
<ul>
<li>字段数固定吗</li>
<li>字段类型是什么</li>
<li>分不分词</li>
<li>索引不索引</li>
<li>存储不存储</li>
<li>排不排序</li>
<li>是否加权</li>
</ul>
<p>除了这些还有其他的一些因素，比如，词库的维护改动，搜索架构的变化等等。如果前提没有充分的规划好，后期改变的话，改动其中任何一项，都需要重建索引，这个代价是非常大和耗时的，尤其是在一些数据量大的场景中。</p>
<h3 id="Logstash整合ElasticSearch模板实例"><a href="#Logstash整合ElasticSearch模板实例" class="headerlink" title="Logstash整合ElasticSearch模板实例"></a>Logstash整合ElasticSearch模板实例</h3><p>首先我们通过ElasticSearch的Restful API接口查询一下ElasticSearch中一共创建了多少个索引模板，默认情况下ElasticSearch应该会有一个名字为”logstash”的Template，这个Template匹配了所有”logstash-*”的索引，也就是说所有以”logstash-“开头的索引都默认使用了这个”logstash”的Template。这个Template就是一个动态模板。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">curl -XGET localhost:9200/_template?pretty</div><div class="line"></div><div class="line">&#123;</div><div class="line">  &quot;logstash&quot; : &#123;</div><div class="line">    &quot;order&quot; : 0,</div><div class="line">    &quot;template&quot; : &quot;logstash-*&quot;,</div><div class="line">    &quot;settings&quot; : &#123;</div><div class="line">      &quot;index&quot; : &#123;</div><div class="line">        &quot;refresh_interval&quot; : &quot;5s&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;mappings&quot; : &#123;</div><div class="line">      &quot;_default_&quot; : &#123;</div><div class="line">        &quot;dynamic_templates&quot; : [ &#123;</div><div class="line">          &quot;message_field&quot; : &#123;</div><div class="line">            &quot;mapping&quot; : &#123;</div><div class="line">              &quot;fielddata&quot; : &#123;</div><div class="line">                &quot;format&quot; : &quot;disabled&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;index&quot; : &quot;analyzed&quot;,</div><div class="line">              &quot;omit_norms&quot; : true,</div><div class="line">              &quot;type&quot; : &quot;string&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;match_mapping_type&quot; : &quot;string&quot;,</div><div class="line">            &quot;match&quot; : &quot;message&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;, &#123;</div><div class="line">          &quot;string_fields&quot; : &#123;</div><div class="line">            &quot;mapping&quot; : &#123;</div><div class="line">              &quot;fielddata&quot; : &#123;</div><div class="line">                &quot;format&quot; : &quot;disabled&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;index&quot; : &quot;analyzed&quot;,</div><div class="line">              &quot;omit_norms&quot; : true,</div><div class="line">              &quot;type&quot; : &quot;string&quot;,</div><div class="line">              &quot;fields&quot; : &#123;</div><div class="line">                &quot;raw&quot; : &#123;</div><div class="line">                  &quot;ignore_above&quot; : 256,</div><div class="line">                  &quot;index&quot; : &quot;not_analyzed&quot;,</div><div class="line">                  &quot;type&quot; : &quot;string&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;,</div><div class="line">            &quot;match_mapping_type&quot; : &quot;string&quot;,</div><div class="line">            &quot;match&quot; : &quot;*&quot;</div><div class="line">          &#125;</div><div class="line">        &#125; ],</div><div class="line">        &quot;_all&quot; : &#123;</div><div class="line">          &quot;omit_norms&quot; : true,</div><div class="line">          &quot;enabled&quot; : true</div><div class="line">        &#125;,</div><div class="line">        &quot;properties&quot; : &#123;</div><div class="line">          &quot;@timestamp&quot; : &#123;</div><div class="line">            &quot;type&quot; : &quot;date&quot;</div><div class="line">          &#125;,</div><div class="line">          &quot;geoip&quot; : &#123;</div><div class="line">            &quot;dynamic&quot; : true,</div><div class="line">            &quot;properties&quot; : &#123;</div><div class="line">              &quot;ip&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;ip&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;latitude&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;float&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;location&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;geo_point&quot;</div><div class="line">              &#125;,</div><div class="line">              &quot;longitude&quot; : &#123;</div><div class="line">                &quot;type&quot; : &quot;float&quot;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          &quot;@version&quot; : &#123;</div><div class="line">            &quot;index&quot; : &quot;not_analyzed&quot;,</div><div class="line">            &quot;type&quot; : &quot;string&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;aliases&quot; : &#123; &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们创建一个自定义Template动态模板，这个模板指定匹配所有以”go_logs<em>index</em>“开始的索引，并且指定允许添加新字段，匹配所有string类型的新字段会创建一个raw的嵌套字段，这个raw嵌套字段类型也是string，但是是not_analyzed不分词的（主要用于解决一些analyzed的string字段无法做统计，但可以使用这个raw嵌套字段做统计）</p>
<h4 id="go-logs-template-json"><a href="#go-logs-template-json" class="headerlink" title="go_logs_template.json"></a>go_logs_template.json</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;template&quot;: &quot;go_logs_index_*&quot;,</div><div class="line">  &quot;order&quot;:0,</div><div class="line">  &quot;settings&quot;: &#123;</div><div class="line">      &quot;index.number_of_replicas&quot;: &quot;1&quot;,</div><div class="line">      &quot;index.number_of_shards&quot;: &quot;5&quot;,</div><div class="line">      &quot;index.refresh_interval&quot; : &quot;10s&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;mappings&quot;: &#123;</div><div class="line">    &quot;_default_&quot;: &#123;</div><div class="line">      &quot;_all&quot;: &#123;</div><div class="line">        &quot;enabled&quot;: false</div><div class="line">      &#125;,</div><div class="line">      &quot;dynamic_templates&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;my_template&quot;: &#123;</div><div class="line">            &quot;match_mapping_type&quot;: &quot;string&quot;,</div><div class="line">            &quot;mapping&quot;: &#123;</div><div class="line">              &quot;type&quot;: &quot;string&quot;,</div><div class="line">              &quot;fields&quot;: &#123;</div><div class="line">                &quot;raw&quot;: &#123;</div><div class="line">                  &quot;type&quot;: &quot;string&quot;,</div><div class="line">                  &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &quot;go&quot;: &#123;</div><div class="line">      &quot;properties&quot;: &#123;</div><div class="line">        &quot;timestamp&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;msg&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;analyzer&quot;: &quot;ik&quot;,</div><div class="line">          &quot;search_analyzer&quot;: &quot;ik_smart&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;file&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;line&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;threadid&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;info&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;type&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@timestamp&quot;: &#123;</div><div class="line">          &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;,</div><div class="line">          &quot;type&quot;: &quot;date&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;@version&quot;: &#123;</div><div class="line">          &quot;type&quot;: &quot;string&quot;,</div><div class="line">          &quot;index&quot;: &quot;not_analyzed&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们看看Logstash是如何使用Template的。首先我们需要准备好Logstash要使用的Template文件，其实这里我们也可以在ES直接创建好Template，然后都在ES维护Template，就是前面说的推荐的第三种方式，但是对于我们单个Logstash Indexer和ElasticSearch节点，方式二和方式三配置都很简单。</p>
<p>在Logstash的配置文件中添加template相关的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    elasticsearch &#123;</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        hosts =&gt; [&quot;hadoop1:9200&quot;, &quot;hadoop2:9200&quot;, &quot;hadoop3:9200&quot;]</div><div class="line">        index =&gt; &quot;go_logs_index_%&#123;+YYYY.MM.dd&#125;&quot;</div><div class="line">        document_type =&gt; &quot;%&#123;type&#125;&quot;</div><div class="line">        template =&gt; &quot;/usr/local/elasticsearch/template/go_logs_template.json&quot;</div><div class="line">        template_name =&gt; &quot;go_logs_template&quot;</div><div class="line">        template_overwrite =&gt; true</div><div class="line">        workers =&gt; 1</div><div class="line">        flush_size =&gt; 20000</div><div class="line">        idle_flush_time =&gt; 10</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 配置说明：</div><div class="line"># template : 指定template模板文件</div><div class="line"># template_name : 指定在ES中创建template的名称，默认是logstash</div><div class="line"># template_overwrite : 是否覆盖ES中的template，默认是false</div></pre></td></tr></table></figure>
<p>这样我们使用Logstash创建的索引”go_logs<em>index</em>%{+YYYY.MM.dd}”就会匹配到我们的Template，就会使用Template中的配置，所以使用Template之后就不需要每新创建一个索引就自己手动创建Mapping了，可以直接使用Template为一类的索引创建默认Mapping配置。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-elasticsearch.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-outputs-elasticsearch.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/indices-templates.html#indices-templates" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/2.3/indices-templates.html#indices-templates</a></li>
<li><a href="http://www.cnblogs.com/JiaK/p/6134397.html" target="_blank" rel="external">http://www.cnblogs.com/JiaK/p/6134397.html</a></li>
<li><a href="http://qindongliang.iteye.com/blog/2290384" target="_blank" rel="external">http://qindongliang.iteye.com/blog/2290384</a></li>
<li><a href="http://xiaorui.cc/2015/12/17/elasticsearch如何修改mapping和template的方法/" target="_blank" rel="external">http://xiaorui.cc/2015/12/17/elasticsearch如何修改mapping和template的方法/</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logstash/">Logstash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Logstash/Logstash学习（五）Logstash的file插件使用技巧" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/21/Logstash/Logstash学习（五）Logstash的file插件使用技巧/" class="article-date">
  	<time datetime="2016-12-21T08:19:46.000Z" itemprop="datePublished">2016-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/21/Logstash/Logstash学习（五）Logstash的file插件使用技巧/">Logstash学习（五）Logstash的file插件使用技巧</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在使用Logstash做Shipper端收集go，node，php多种日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [&quot;/home/yunyu/Downloads/*.log.*&quot;, &quot;/home/yunyu/Downloads/lumen.log&quot;]</div><div class="line">        codec =&gt; &quot;plain&quot;</div><div class="line">        # 多个日志文件的offset信息都会记录到这个sincedb文件中，会记录成多行</div><div class="line">        sincedb_path =&gt; &quot;/data/logstash_sincedb/php/.sincedb_php&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">        # 设置是否忽略太旧的日志的</div><div class="line">        # 如果没设置该属性可能会导致读取不到文件内容，因为我们的日志大部分是好几个月前的，所以这里设置为不忽略</div><div class="line">        ignore_older =&gt; 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    kafka &#123;</div><div class="line">        # 指定Kafka集群地址</div><div class="line">        bootstrap_servers =&gt; &quot;hadoop1:9092,hadoop2:9092,hadoop3:9092&quot;</div><div class="line">        # 指定Kafka的Topic</div><div class="line">        topic_id =&gt; &quot;php_log&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># path : 指定要采集的日志文件路径，多个日志文件可以使用通配符，也可以使用数组</div><div class="line"># sincedb_path : sincedb文件是用于存储Logstash读取文件的位置，每行表示一个文件，每行有两个数字，第一个表示文件的inode，第二个表示文件读取到的位置（byteoffset），默认为$HOME/.sincedb*，文件名是日志文件路径MD5加密后的结果。sincedb_path只能指定为具体的file文件，不能是path目录。</div><div class="line"># sincedb_write_interval : Logstash每隔多久写一次sincedb文件，默认是15秒。</div><div class="line"># ignore_older : 在每次检查文件列表的时候，如果一个文件的最后修改时间超过这个值，就忽略这个文件。默认是86400秒，即一天。</div><div class="line"># start_position : Logstash从什么位置开始读取文件数据，默认是结束位置，也就是说Logstash进程会以类似tail -F的形式运行。如果你是要导入原有数据，把这个设定改成&quot;beginning&quot;，logstash进程就从头开始读取。</div></pre></td></tr></table></figure>
<p>这里php日志文件按照类型拆分成多个日志文件，这些日志文件都需要收集，所以需要我们在Logstash配置path使用了通配符来处理读取多个日志文件。这里和之前读取go和node日志不同，go和node的日志通常只有一个日志文件，这里php的日志文件按照类型分别写入到不同的日志文件，那我们指定的sincedb_path又只能指定一个file而不是path，那如何记录多个文件的读取进度呢？我在日志系统收集的过程中特意查看了一下sincedb文件，发现是如果Logstash file path指定了读取多个文件，这样sincedb文件就会存储多行，每行代表一个日志文件的读取进度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># cat /data/logstash_sincedb/php/.sincedb_php</div><div class="line">1058198 0 51713 976040</div><div class="line">1058229 0 51713 151513</div><div class="line">1056857 0 51713 970977345</div><div class="line">1058215 0 51713 115587</div><div class="line">1057737 0 51713 873729227</div><div class="line">1058197 0 51713 1108533</div><div class="line">1058230 0 51713 595155</div><div class="line">1058110 0 51713 1085851</div><div class="line">1048702 0 51713 10036</div><div class="line">1057753 0 51713 206711384</div><div class="line">1057777 0 51713 1607939699</div><div class="line">1052414 0 51713 359573</div><div class="line">1056858 0 51713 1015625306</div><div class="line">1058201 0 51713 341179</div><div class="line">1058233 0 51713 449755</div><div class="line">1048838 0 51713 90406</div><div class="line">1058196 0 51713 234060588</div><div class="line"></div><div class="line"># 这四列的内容分别是：inode, major number, minor number, pos</div><div class="line"># 可以参考文章：</div><div class="line"># http://unix.stackexchange.com/questions/73988/linux-major-and-minor-device-numbers</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-inputs-file.html#plugins-inputs-file-sincedb_path" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-inputs-file.html#plugins-inputs-file-sincedb_path</a></li>
<li><a href="http://kibana.logstash.es/content/logstash/plugins/input/file.html" target="_blank" rel="external">http://kibana.logstash.es/content/logstash/plugins/input/file.html</a></li>
<li><a href="http://blog.csdn.net/hengyunabc/article/details/25665877" target="_blank" rel="external">http://blog.csdn.net/hengyunabc/article/details/25665877</a></li>
<li><a href="http://www.voidcn.com/blog/sdulibh/article/p-6234930.html" target="_blank" rel="external">http://www.voidcn.com/blog/sdulibh/article/p-6234930.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logstash/">Logstash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Logstash/Logstash学习（四）Logstash的Grok使用技巧" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/21/Logstash/Logstash学习（四）Logstash的Grok使用技巧/" class="article-date">
  	<time datetime="2016-12-21T07:46:57.000Z" itemprop="datePublished">2016-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/21/Logstash/Logstash学习（四）Logstash的Grok使用技巧/">Logstash学习（四）Logstash的Grok使用技巧</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在使用Logstash解析日志的时候遇到了很多问题，需要处理多种特殊情况，下面会列举一下我遇到的特殊情况以及处理方式。</p>
<p>如何检查数组是否为空数组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if [tags] == [] &#123;</div><div class="line">  mutate &#123;</div><div class="line">    remove_field =&gt; [&quot;tags&quot;]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>判断json中是否有foo这个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">if [foo] &#123;</div><div class="line">    ...</div><div class="line">&#125; else &#123;</div><div class="line">    drop &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if ![foo] &#123;</div><div class="line">    drop &#123;&#125;</div><div class="line">&#125; else &#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ruby &#123;</div><div class="line">    code =&gt; &quot;</div><div class="line">        if event[&apos;column16&apos;] == nil</div><div class="line">            event[&apos;log_type&apos;] = &apos;type2&apos;</div><div class="line">        else</div><div class="line">            event[&apos;log_type&apos;] = &apos;type1&apos;</div><div class="line">        end	</div><div class="line">    &quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if &quot;_jsonparsefailure&quot; in [tags] &#123;</div><div class="line">    drop &#123;&#125;</div><div class="line">&#125; else &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://stackoverflow.com/questions/30309096/logstash-check-if-field-exists" target="_blank" rel="external">http://stackoverflow.com/questions/30309096/logstash-check-if-field-exists</a></li>
<li><a href="https://discuss.elastic.co/t/how-can-i-check-if-the-tags-array-is-empty/27856" target="_blank" rel="external">https://discuss.elastic.co/t/how-can-i-check-if-the-tags-array-is-empty/27856</a></li>
<li><a href="https://discuss.elastic.co/t/check-existence-of-a-field-and-checking-null-value-in-field/24968/4" target="_blank" rel="external">https://discuss.elastic.co/t/check-existence-of-a-field-and-checking-null-value-in-field/24968/4</a></li>
<li><a href="https://github.com/elastic/logstash/issues/1867">https://github.com/elastic/logstash/issues/1867</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logstash/">Logstash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Kafka/Kafka学习（四）指定Kafka的data和logs路径" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/15/Kafka/Kafka学习（四）指定Kafka的data和logs路径/" class="article-date">
  	<time datetime="2016-12-15T03:16:39.000Z" itemprop="datePublished">2016-12-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/15/Kafka/Kafka学习（四）指定Kafka的data和logs路径/">Kafka学习（四）指定Kafka的data和logs路径</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h3><ul>
<li>zookeeper-3.4.8</li>
<li>kafka_2.11-0.9.0.0</li>
</ul>
<p>最近公司在做日志收集系统，主要基于Elastic Stack做的，其中用到了Kafka服务器作缓冲，今天主要说的问题就是因为上了日志收集系统之后，大量的线上日志写入到Kafka，导致Kafka磁盘写满。后来发现是因为当时运维安装Kafka环境的时候将Kafka的data和logs都挂在了系统盘下，而且系统盘容量很小只有20G，所以出现了磁盘不够用的情况。</p>
<p>解决办法也很简单，将Kafka的data和logs分别写到挂在的数据磁盘即可。这里需要简单修改一下Kafka的配置文件。</p>
<h4 id="修改Kafka的data目录"><a href="#修改Kafka的data目录" class="headerlink" title="修改Kafka的data目录"></a>修改Kafka的data目录</h4><p>Kafka的data目录是存储Kafka的数据文件的目录，是在${KAFKA_HOME}/config/server.properties中修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">log.dirs=/data/kafka_data</div></pre></td></tr></table></figure>
<p>注意：log.dirs可以配置多个目录，需要用逗号分隔开</p>
<h4 id="修改Kafka的logs目录"><a href="#修改Kafka的logs目录" class="headerlink" title="修改Kafka的logs目录"></a>修改Kafka的logs目录</h4><p>Kafka运行的时候都会通过log4j打印很多日志文件，如：server.log, controller.log, state-change.log等，默认都会将其输出到${KAFKA_HOME}/logs目录下，这样很不利于线上运维，因为经常容易出现写满文件系统（尤其是挂在到系统盘的情况），所以一般运维都会建议将Kafka（或者其他环境）都安装在/usr/local系统盘下（方便clone系统镜像），一般系统盘都比较小，而数据和日志会指定到另一个或多个更大空间的挂在数据盘。</p>
<p>修改Kafka的logs目录是在${KAFKA_HOME}/bin/kafka-run-class.sh中修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Log directory to use</div><div class="line">if [ &quot;x$LOG_DIR&quot; = &quot;x&quot; ]; then</div><div class="line">    # LOG_DIR=&quot;$base_dir/logs&quot;</div><div class="line">    LOG_DIR=&quot;/data/kafka_logs&quot;</div><div class="line">fi</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka/">Kafka</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/MQ/">MQ</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Kibana/Kibana学习（四）时区差8小时问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/05/Kibana/Kibana学习（四）时区差8小时问题/" class="article-date">
  	<time datetime="2016-12-05T10:35:36.000Z" itemprop="datePublished">2016-12-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/05/Kibana/Kibana学习（四）时区差8小时问题/">Kibana学习（四）时区差8小时问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Kibana连接ES查询数据的时候，会有时差8小时的问题。先来描述一下问题的具体情况，我们先来看看Logstash默认写入到ES的索引数据。timestamp是我们App上报日志的时间戳字段，这个字段是客户端写入日志的时间。@timestamp是使用Logstash写入ES的时候默认自带的时间戳（即Logstash生成ES索引的时间戳）。这里我们的这条日志是2016-10-08由App记录的，由Logstash收集到ES服务器的时间是2016-12-05。但是我们发现@timestamp并不是我们系统的当前时间，而是比我们当前的系统时间小了8小时，这就是我们想要解决的8小时时差问题。</p>
<p>原因是Logstash中默认插入的@timestamp时间字段是按照UTC 00:00标准时区的时间转换成long型的时间戳保存在ES中，而我们系统的时间是中国时区UTC +08:00，由ES查询出来的long型的时间戳再按照UTC +08:00转换成时间就正好相差了8小时。因为@timestamp的long型字段在ES中是不可取回的，所以我们在ES的返回值中是看不到这个long型字段的，只能看到@timestamp根据我们的时区转换后的结果”2016-12-05T11:30:40.911Z”，这个结果正好和我们的系统时间相差了8小时。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_index&quot;: &quot;api_logs_index_1&quot;,</div><div class="line">    &quot;_type&quot;: &quot;command&quot;,</div><div class="line">    &quot;_id&quot;: &quot;AVjOwAt_jL-eD07Ygku1&quot;,</div><div class="line">    &quot;_version&quot;: 1,</div><div class="line">    &quot;_score&quot;: 1,</div><div class="line">    &quot;_source&quot;: &#123;</div><div class="line">        &quot;logs&quot;: &#123;</div><div class="line">            &quot;timestamp&quot;: &quot;1475912701768&quot;,</div><div class="line">            &quot;rpid&quot;: &quot;65351516503932930&quot;,</div><div class="line">            &quot;name&quot;: &quot;rp.hb.ad.click_ad&quot;,</div><div class="line">            &quot;bid&quot;: 0,</div><div class="line">            &quot;uid&quot;: 0,</div><div class="line">            &quot;did&quot;: 0,</div><div class="line">            &quot;duid&quot;: 0,</div><div class="line">            &quot;hb_uid&quot;: 0,</div><div class="line">            &quot;ua&quot;: &quot;&quot;,</div><div class="line">            &quot;device_id&quot;: &quot;&quot;,</div><div class="line">            &quot;server_timestamp&quot;: 1475912715001</div><div class="line">        &#125;,</div><div class="line">        &quot;level&quot;: &quot;info&quot;,</div><div class="line">        &quot;message&quot;: &quot;logs&quot;,</div><div class="line">        &quot;timestamp&quot;: &quot;2016-10-08T07:45:15.001Z&quot;,</div><div class="line">        &quot;@version&quot;: &quot;1&quot;,</div><div class="line">        &quot;@timestamp&quot;: &quot;2016-12-05T11:30:40.911Z&quot;,</div><div class="line">        &quot;path&quot;: &quot;/home/yunyu/Downloads/track.log&quot;,</div><div class="line">        &quot;host&quot;: &quot;hadoop1&quot;,</div><div class="line">        &quot;type&quot;: &quot;command&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面简单的描述了一下问题。我们需要解决下面两个问题：</p>
<ol>
<li>如何让Kibana查询和统计使用的是App写入日志的时间，而不是Logstash写入ES的时间（因为Logstash写入ES时间上会有延迟）</li>
<li>解决时差相差8小时问题</li>
</ol>
<p>一般我们App上报日志都会带有一个timestamp时间戳字段，这个字段是客户端写入日志的时间。当Logstash收集App上报日志的时候，会将timestamp字段保存到ES中，Kibana通过该字段当做统计的字段进行各种按日期统计的查询。</p>
<p>这里Kibana要求所有ES的索引必须要有一个时间字段作为统计查询的日期字段使用，如果没有ES的索引没有时间或者日期字段，是无法在Kibana中创建索引的。所以默认Kibana也会给一个默认的时间字段@timestamp，这样当我们在Kibana创建api_logs_index索引的时候，就会出现有两个时间字段，一个是timestamp，一个是@timestamp。</p>
<p><img src="http://img.blog.csdn.net/20161205190259403?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Kibana"></p>
<p>在Kibana创建索引时，设置索引使用@timestamp字段，但是需要在Logstash中配置@timestamp的值从timestamp取出来的。Logstash中可以指定@timestamp字段的值是从App上报日志的timestamp字段来的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">date &#123;</div><div class="line">    match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;]</div><div class="line">    target =&gt; &quot;@timestamp&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面用我们这条日志举例，下面的表格是系统时间和UTC时间戳根据北京时区的转换对照表。这里的系统时间转换程UTC时间戳是带有北京时区的。</p>
<table>
<thead>
<tr>
<th>系统时间</th>
<th>UTC时间戳</th>
<th>ES返回（显示）的时间</th>
<th>ES存储的时间（long）</th>
</tr>
</thead>
<tbody>
<tr>
<td>2016/10/18 15:45:15.001Z</td>
<td>1475912715001</td>
<td></td>
<td>timestamp : 1475912715001</td>
</tr>
<tr>
<td>2016/10/18 7:45:15.001Z</td>
<td>1475883915001</td>
<td>timestamp : 2016/10/18 7:45:15.001Z</td>
<td>@timestamp : 1475883915001</td>
</tr>
<tr>
<td>2016/10/17 23:45:15.001Z</td>
<td></td>
<td>@timestamp : 2016/10/17 23:45:15.001Z</td>
</tr>
</tbody>
</table>
<p>Logstash将timestamp的时间2016/10/18 7:45:15.001Z按照默认的标准时区UTC 00:00将timestamp转换成long类型1475912715001存储到ES，而对于@timestamp字段的值，是将timestamp的时间2016/10/18 7:45:15.001Z按照北京时区UTC +08:00将timestamp转换成long类型1475883915001并且赋值给@timestamp并且存储到ES。（为什么要加上北京时区UTC +08:00的原因不清楚，也尝试过不带有Z时区设置的时间格式，转换成的时间戳结果一样）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">date &#123;</div><div class="line">    match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]</div><div class="line">    target =&gt; &quot;@timestamp&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ES存储的时间long型到ES返回(显示)时间是按照UTC 00:00标准时间转换的。下面是取回的结果。</p>
<ul>
<li>ES将timestamp的long类型1475912715001按照UTC 00:00标准时间转换回时间2016/10/18 7:45:15.001Z</li>
<li>ES将@timestamp的long类型1475883915001按照UTC 00:00标准时间转换回时间2016-10-07T23:45:15.001Z</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_index&quot;: &quot;api_logs_index_1&quot;,</div><div class="line">    &quot;_type&quot;: &quot;command&quot;,</div><div class="line">    &quot;_id&quot;: &quot;AVjOwAt_jL-eD07Ygku1&quot;,</div><div class="line">    &quot;_version&quot;: 1,</div><div class="line">    &quot;_score&quot;: 1,</div><div class="line">    &quot;_source&quot;: &#123;</div><div class="line">        &quot;logs&quot;: &#123;</div><div class="line">            &quot;timestamp&quot;: &quot;1475912701768&quot;,</div><div class="line">            &quot;rpid&quot;: &quot;65351516503932930&quot;,</div><div class="line">            &quot;name&quot;: &quot;rp.hb.ad.click_ad&quot;,</div><div class="line">            &quot;bid&quot;: 0,</div><div class="line">            &quot;uid&quot;: 0,</div><div class="line">            &quot;did&quot;: 0,</div><div class="line">            &quot;duid&quot;: 0,</div><div class="line">            &quot;hb_uid&quot;: 0,</div><div class="line">            &quot;ua&quot;: &quot;&quot;,</div><div class="line">            &quot;device_id&quot;: &quot;&quot;,</div><div class="line">            &quot;server_timestamp&quot;: 1475912715001</div><div class="line">        &#125;,</div><div class="line">        &quot;level&quot;: &quot;info&quot;,</div><div class="line">        &quot;message&quot;: &quot;logs&quot;,</div><div class="line">        &quot;timestamp&quot;: &quot;2016-10-08T07:45:15.001Z&quot;,</div><div class="line">        &quot;@version&quot;: &quot;1&quot;,</div><div class="line">        &quot;@timestamp&quot;: &quot;2016-10-07T23:45:15.001Z&quot;,</div><div class="line">        &quot;path&quot;: &quot;/home/yunyu/Downloads/track.log&quot;,</div><div class="line">        &quot;host&quot;: &quot;hadoop1&quot;,</div><div class="line">        &quot;type&quot;: &quot;command&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以看到Kibana的查询Request，下面是我选择的时间区间条件</p>
<ul>
<li>2016/10/8 7:30:0：按照北京时区UTC +08:00转换为1475883000000</li>
<li>2016/10/8 8:0:0：按照北京时区UTC +08:00转换为1475884800000</li>
</ul>
<p>Kibana Request</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;size&quot;: 500,</div><div class="line">  &quot;sort&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;@timestamp&quot;: &#123;</div><div class="line">        &quot;order&quot;: &quot;desc&quot;,</div><div class="line">        &quot;unmapped_type&quot;: &quot;boolean&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  &quot;query&quot;: &#123;</div><div class="line">    &quot;filtered&quot;: &#123;</div><div class="line">      &quot;query&quot;: &#123;</div><div class="line">        &quot;query_string&quot;: &#123;</div><div class="line">          &quot;analyze_wildcard&quot;: true,</div><div class="line">          &quot;query&quot;: &quot;*&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &quot;filter&quot;: &#123;</div><div class="line">        &quot;bool&quot;: &#123;</div><div class="line">          &quot;must&quot;: [</div><div class="line">            &#123;</div><div class="line">              &quot;range&quot;: &#123;</div><div class="line">                &quot;@timestamp&quot;: &#123;</div><div class="line">                  &quot;gte&quot;: 1475883000000,</div><div class="line">                  &quot;lte&quot;: 1475884800000,</div><div class="line">                  &quot;format&quot;: &quot;epoch_millis&quot;</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          ],</div><div class="line">          &quot;must_not&quot;: []</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;highlight&quot;: &#123;</div><div class="line">    &quot;pre_tags&quot;: [</div><div class="line">      &quot;@kibana-highlighted-field@&quot;</div><div class="line">    ],</div><div class="line">    &quot;post_tags&quot;: [</div><div class="line">      &quot;@/kibana-highlighted-field@&quot;</div><div class="line">    ],</div><div class="line">    &quot;fields&quot;: &#123;</div><div class="line">      &quot;*&quot;: &#123;&#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;require_field_match&quot;: false,</div><div class="line">    &quot;fragment_size&quot;: 2147483647</div><div class="line">  &#125;,</div><div class="line">  &quot;aggs&quot;: &#123;</div><div class="line">    &quot;2&quot;: &#123;</div><div class="line">      &quot;date_histogram&quot;: &#123;</div><div class="line">        &quot;field&quot;: &quot;@timestamp&quot;,</div><div class="line">        &quot;interval&quot;: &quot;30s&quot;,</div><div class="line">        &quot;time_zone&quot;: &quot;Asia/Shanghai&quot;,</div><div class="line">        &quot;min_doc_count&quot;: 0,</div><div class="line">        &quot;extended_bounds&quot;: &#123;</div><div class="line">          &quot;min&quot;: 1475883000000,</div><div class="line">          &quot;max&quot;: 1475884800000</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;fields&quot;: [</div><div class="line">    &quot;*&quot;,</div><div class="line">    &quot;_source&quot;</div><div class="line">  ],</div><div class="line">  &quot;script_fields&quot;: &#123;&#125;,</div><div class="line">  &quot;fielddata_fields&quot;: [</div><div class="line">    &quot;timestamp&quot;,</div><div class="line">    &quot;@timestamp&quot;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的Request可以看出来我们Kibana Request是将查询时间区间的条件先按照Browser的时区（北京时区UTC +08:00）转换成long型时间戳，然后当成条件查询的@timestamp字段。</p>
<p>这里的fields就是ES存储的long类型数值。</p>
<ul>
<li>timestamp 1475912715001：按照标准时区UTC +00:00转换为2016/10/8 7:45:15</li>
<li>@timestamp 1475883915001：按照标准时区UTC +00:00转换为2016/10/7 23:45:15</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;fields&quot;: &#123;</div><div class="line">  &quot;timestamp&quot;: [</div><div class="line">    1475912715001</div><div class="line">  ],</div><div class="line">  &quot;@timestamp&quot;: [</div><div class="line">    1475883915001</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Kibana Response</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;took&quot;: 7,</div><div class="line">  &quot;hits&quot;: &#123;</div><div class="line">    &quot;hits&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;_index&quot;: &quot;api_logs_index_1&quot;,</div><div class="line">        &quot;_type&quot;: &quot;command&quot;,</div><div class="line">        &quot;_id&quot;: &quot;AVjPhBGGUk8QUkLwTRVu&quot;,</div><div class="line">        &quot;_score&quot;: null,</div><div class="line">        &quot;_source&quot;: &#123;</div><div class="line">          &quot;logs&quot;: &#123;</div><div class="line">            &quot;timestamp&quot;: &quot;1475912701768&quot;,</div><div class="line">            &quot;rpid&quot;: &quot;65351516503932930&quot;,</div><div class="line">            &quot;name&quot;: &quot;rp.hb.ad.click_ad&quot;,</div><div class="line">            &quot;bid&quot;: 0,</div><div class="line">            &quot;uid&quot;: 0,</div><div class="line">            &quot;did&quot;: 0,</div><div class="line">            &quot;duid&quot;: 0,</div><div class="line">            &quot;hb_uid&quot;: 0,</div><div class="line">            &quot;ua&quot;: &quot;&quot;,</div><div class="line">            &quot;device_id&quot;: &quot;&quot;,</div><div class="line">            &quot;server_timestamp&quot;: 1475912715001</div><div class="line">          &#125;,</div><div class="line">          &quot;level&quot;: &quot;info&quot;,</div><div class="line">          &quot;message&quot;: &quot;logs&quot;,</div><div class="line">          &quot;timestamp&quot;: &quot;2016-10-08T07:45:15.001Z&quot;,</div><div class="line">          &quot;@version&quot;: &quot;1&quot;,</div><div class="line">          &quot;@timestamp&quot;: &quot;2016-10-07T23:45:15.001Z&quot;,</div><div class="line">          &quot;path&quot;: &quot;/home/yunyu/Downloads/track.log&quot;,</div><div class="line">          &quot;host&quot;: &quot;hadoop1&quot;,</div><div class="line">          &quot;type&quot;: &quot;command&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;fields&quot;: &#123;</div><div class="line">          &quot;timestamp&quot;: [</div><div class="line">            1475912715001</div><div class="line">          ],</div><div class="line">          &quot;@timestamp&quot;: [</div><div class="line">            1475883915001</div><div class="line">          ]</div><div class="line">        &#125;,</div><div class="line">        &quot;sort&quot;: [</div><div class="line">          1475883915001</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;max_score&quot;: 0</div><div class="line">  &#125;,</div><div class="line">  &quot;aggregations&quot;: &#123;</div><div class="line">    &quot;2&quot;: &#123;</div><div class="line">      &quot;buckets&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:30:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883000000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:30:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883030000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:31:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883060000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:31:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883090000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:32:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883120000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:32:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883150000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:33:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883180000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:33:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883210000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:34:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883240000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:34:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883270000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:35:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883300000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:35:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883330000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:36:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883360000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:36:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883390000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:37:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883420000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:37:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883450000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:38:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883480000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:38:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883510000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:39:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883540000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:39:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883570000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:40:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883600000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:40:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883630000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:41:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883660000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:41:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883690000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:42:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883720000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:42:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883750000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:43:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883780000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:43:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883810000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:44:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883840000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:44:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883870000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:45:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883900000,</div><div class="line">          &quot;doc_count&quot;: 1</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:45:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883930000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:46:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883960000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:46:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475883990000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:47:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884020000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:47:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884050000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:48:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884080000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:48:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884110000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:49:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884140000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:49:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884170000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:50:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884200000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:50:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884230000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:51:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884260000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:51:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884290000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:52:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884320000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:52:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884350000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:53:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884380000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:53:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884410000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:54:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884440000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:54:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884470000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:55:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884500000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:55:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884530000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:56:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884560000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:56:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884590000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:57:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884620000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:57:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884650000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:58:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884680000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:58:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884710000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:59:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884740000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T07:59:30.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884770000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          &quot;key_as_string&quot;: &quot;2016-10-08T08:00:00.000+08:00&quot;,</div><div class="line">          &quot;key&quot;: 1475884800000,</div><div class="line">          &quot;doc_count&quot;: 0</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ES返回的结果时间是按照标准时区UTC +00:00转换的。这里Kibana还会根据创建索引所选择的时间戳，再将@timestamp的结果转换成Browser默认的时区（即：UTC +08:00）显示出来，也就是在ES返回的@timestamp时间上再加8小时。</p>
<p>如果timestamp字段没有带有时区设置，我们可以在Logstash中指定locale和timezone属性来设置timestamp的字段的时区，这样就知道timestamp的时间应该按照指定的timezone时区解析成long型时间戳，这样my_timestamp字段在ES中是一个使用+08:00中国时区的long类型时间戳，方便使用ES API直接查询timestamp字段，因为一般人都使用+08:00中国时区将时间转换为long类型的时间戳。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">date &#123;</div><div class="line">    match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]</div><div class="line">    target =&gt; &quot;my_timestamp&quot;</div><div class="line">    locale =&gt; &quot;en&quot;</div><div class="line">    timezone =&gt; &quot;+08:00&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">date &#123;</div><div class="line">    # 如果日志中的timestamp时间戳带有时区，而且是UTC标准时区，不是中国时区，我们可以使用指定timezone来转换成long类型的@timestamp</div><div class="line">    match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;]</div><div class="line">    target =&gt; &quot;@timestamp&quot;</div><div class="line">    locale =&gt; &quot;en&quot;</div><div class="line">    timezone =&gt; &quot;+00:00&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Logstash创建索引所使用的YYYY-MM-DD也是使用的@timestamp字段的时间</p>
<p>参考文章：</p>
<ul>
<li><a href="https://discuss.elastic.co/t/elk-logstash-default-timezone-cause-index-splitting-problem-in-different-timezones/26615" target="_blank" rel="external">https://discuss.elastic.co/t/elk-logstash-default-timezone-cause-index-splitting-problem-in-different-timezones/26615</a></li>
<li><a href="http://blog.csdn.net/bright_fu/article/details/48439367" target="_blank" rel="external">http://blog.csdn.net/bright_fu/article/details/48439367</a></li>
<li><a href="https://1024tools.com/timestamp" target="_blank" rel="external">https://1024tools.com/timestamp</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kibana/">Kibana</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Go/Go学习（一）开发环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/29/Go/Go学习（一）开发环境搭建/" class="article-date">
  	<time datetime="2016-11-29T07:08:30.000Z" itemprop="datePublished">2016-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/29/Go/Go学习（一）开发环境搭建/">Go学习（一）开发环境搭建</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我这里是Mac系统，不同的操作系统安装略有不同，请知晓</p>
<h3 id="Go安装"><a href="#Go安装" class="headerlink" title="Go安装"></a>Go安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 我这里直接使用homebrew安装Go，非常的简单</div><div class="line">$ brew install go</div><div class="line"></div><div class="line"># 安装成功后，查看Go的环境</div><div class="line">$ go env</div><div class="line">GOARCH=&quot;amd64&quot;</div><div class="line">GOBIN=&quot;&quot;</div><div class="line">GOEXE=&quot;&quot;</div><div class="line">GOHOSTARCH=&quot;amd64&quot;</div><div class="line">GOHOSTOS=&quot;darwin&quot;</div><div class="line">GOOS=&quot;darwin&quot;</div><div class="line">GOPATH=&quot;&quot;</div><div class="line">GORACE=&quot;&quot;</div><div class="line">GOROOT=&quot;/usr/local/Cellar/go/1.7.3/libexec&quot;</div><div class="line">GOTOOLDIR=&quot;/usr/local/Cellar/go/1.7.3/libexec/pkg/tool/darwin_amd64&quot;</div><div class="line">CC=&quot;clang&quot;</div><div class="line">GOGCCFLAGS=&quot;-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/var/folders/0h/jtjrr7g95mv2pt4ts1tgmzyh0000gn/T/go-build273829653=/tmp/go-build -gno-record-gcc-switches -fno-common&quot;</div><div class="line">CXX=&quot;clang++&quot;</div><div class="line">CGO_ENABLED=&quot;1&quot;</div></pre></td></tr></table></figure>
<h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GOPATH=/Users/yunyu/workspace_go</div><div class="line">GOROOT=/usr/local/Cellar/go/1.7.3/libexec</div><div class="line"></div><div class="line">export GOPATH</div><div class="line">export GOROOT</div></pre></td></tr></table></figure>
<p>在我们以前熟悉的各种语言中都有这样几个概念：系统路径,官方包路径,第三方包路径,项目路径。</p>
<p>Go中只有两个路径：</p>
<ul>
<li>GOROOT: Go的安装路径,官方包路径根据这个设置自动匹配</li>
<li>GOPATH: 工作路径(其实不应该用中文翻译解释，直接说GOPATH更合适)</li>
</ul>
<p>问题：项目路径和第三方包路径呢？ 首先：Go中是没有项目这个概念的，只有包。可执行包只是特殊的一种，类似我们常说的项目GOPATH可以设置多个，不管是可执行包，还是非可执行包，通通都应该在某个$GOPATH/src下。</p>
<p>$GOPATH可以包含多个工作目录，取决于你的个人情况。如果你设置了多个工作目录，那么当你在之后使用 go get（远程包安装命令）时远程包将会被安装在第一个目录下。</p>
<p>以上都可以在Go对于gopath和importpath的help使用说明中查看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ go help gopath</div><div class="line">$ go help importpath</div></pre></td></tr></table></figure>
<h3 id="Go的目录结构"><a href="#Go的目录结构" class="headerlink" title="Go的目录结构"></a>Go的目录结构</h3><p>以上$GOPATH目录约定有三个子目录：</p>
<ol>
<li>src 存放源代码（比如：.go .c .h .s等）。src 子目录通常包会含多种版本控制的代码仓库（例如Git或Mercurial）， 以此来跟踪一个或多个源码包的开发。</li>
<li>pkg 编译后生成的包文件（比如：.a）</li>
<li>bin 编译后生成的可执行文件</li>
</ol>
<h3 id="编写helloworld-go"><a href="#编写helloworld-go" class="headerlink" title="编写helloworld.go"></a>编写helloworld.go</h3><h5 id="helloworld-go"><a href="#helloworld-go" class="headerlink" title="helloworld.go"></a>helloworld.go</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">//引入fmt库</div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    fmt.Println(&quot;Hello World!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="程序入口点-entry-point-和包-package"><a href="#程序入口点-entry-point-和包-package" class="headerlink" title="程序入口点(entry point)和包(package)"></a>程序入口点(entry point)和包(package)</h3><p>Go保持了与C家族语言一致的风格：即目标为可执行程序的Go源码中务必要有一个名为main的函数，该函数即为可执行程序的入口点。除此之外Go还增加了一个约束：作为入口点的main函数必须在名为main的package中。正如上面helloworld.go源文件中的那样，在源码第一行就声明了该文件所归属的package为main。</p>
<p>Go去除了头文件的概念，而借鉴了很多主流语言都采用的package的源码组织方式。package是个逻辑概念，与文件没有一一对应的关系。 如果多个源文件都在开头声明自己属于某个名为foo的包，那这些源文件中的代码在逻辑上都归属于包foo(这些文件最好在同一个目录下，至少目前的Go版本还无法支持不同目录下的源文件归属于同一个包)。</p>
<p>我们看到helloworld.go中import一个名为fmt的包，并利用该包内的Println函数输出”Hello World!”。直觉告诉我们fmt包似乎是一个标准库中的包。没错，fmt包提供了格式化文本输出以及读取格式化输入的相关函数，与C中的printf或scanf等类似。我们通过import语句将fmt包导入我们的源文件后就可以使用该fmt包导出(export)的功能函数了(比如 Printf)。</p>
<p>在C中，我们通过static来标识局部函数还是全局函数。而在Go中，包中的函数是否可以被外部调用，要看该函数名的首母是否为大写。这是一种Go语言固化的约定：首母大写的函数被认为是导出的函数，可以被包之外的代码调用；而小写字母开头的函数则仅能在包内使用。在例子中你也看到了fmt包的Println函数其首母就是大写的。</p>
<h5 id="hello-go"><a href="#hello-go" class="headerlink" title="hello.go"></a>hello.go</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">package hello</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line"></div><div class="line">func Hello() &#123;</div><div class="line">    fmt.Println(&quot;Hello World!&quot;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;hello&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    hello.Hello()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用go build编译main.go，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 执行run或者build都会报错</div><div class="line">$ go run main.go</div><div class="line">main.go:4:5: cannot find package &quot;hello&quot; in any of:</div><div class="line">	/usr/local/Cellar/go/1.7.3/libexec/src/hello (from $GOROOT)</div><div class="line">	/Users/yunyu/workspace_go/src/hello (from $GOPATH)</div><div class="line"></div><div class="line">$ go build main.go</div><div class="line">main.go:4:5: cannot find package &quot;hello&quot; in any of:</div><div class="line">	/usr/local/Cellar/go/1.7.3/libexec/src/hello (from $GOROOT)</div><div class="line">	/Users/yunyu/workspace_go/src/hello (from $GOPATH)</div></pre></td></tr></table></figure>
<p>编译器居然提示无法找到hello这个package，而hello.go中明明定义了package hello了。这是怎么回事呢？原来go compiler搜索package的方式与我们常规理解的有不同，Go在这方面也有一套约定，这里面涉及到一个重要的环境变量：GOPATH。我们可以使用go help gopath来查看一下有关gopath的manual。</p>
<p>Go compiler的package搜索顺序是这样的，以搜索hello这个package为例：</p>
<ul>
<li>首先，Go compiler会在GO安装目录(GOROOT，这里是Mac环境安装路径是/usr/local/Cellar/go/1.7.3/libexec，如果是Linux安装目录可能是/usr/local/go)下查找是否有src/pkg/hello相关包源码；如果没有则继续；</li>
<li>如果export GOPATH=PATH1:PAHT2，则Go compiler会依次查找是否存在PATH1/src/hello、PATH2/src/hello；配置在GOPATH中的PATH1和PATH2被称作workplace（类似Java项目中的project）；</li>
<li>如果在上述几个位置均无法找到hello这个package，则提示出错。</li>
</ul>
<p>在本例子中，我设置的GOPATH环境变量有问题，之前把GOPATH理解成了Java中的workspace了，也没有建立类似PATH1/src/hello（workspace_go/src/hello）这样的路径，因此Go compiler显然无法找到hello这个package了。我们来修改一下GOPATH变量并建立相关目录：</p>
<p>修改环境变量如下：</p>
<h5 id="etc-profile或者-bash-profile"><a href="#etc-profile或者-bash-profile" class="headerlink" title="/etc/profile或者~/.bash_profile"></a>/etc/profile或者~/.bash_profile</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">export TEST_PATH=/Users/yunyu/workspace_go/TestGo</div><div class="line">export DEMO_PATH=/Users/yunyu/workspace_go/GoDemo</div><div class="line">export GOPATH=$TEST_PATH:$DEMO_PATH</div></pre></td></tr></table></figure>
<p>目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">workspace_go</div><div class="line">     |</div><div class="line">     |--- TestGo</div><div class="line">     |      |</div><div class="line">     |      |--- src</div><div class="line">     |            |</div><div class="line">     |            |--- hello</div><div class="line">     |            |      |</div><div class="line">     |            |      |--- hello.go</div><div class="line">     |            |</div><div class="line">     |            |--- main.go</div><div class="line">     |</div><div class="line">     |-- GoDemo</div></pre></td></tr></table></figure>
<p>再次执行run或者build都能正常运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ go run main.go</div><div class="line">Hello World!</div><div class="line"></div><div class="line">$ go build main.go</div><div class="line">$ ./main</div><div class="line">Hello World!</div></pre></td></tr></table></figure>
<p>我们将main.go移入到main目录下，这样目录结构更加合理。目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">workspace_go</div><div class="line">     |</div><div class="line">     |--- TestGo</div><div class="line">     |      |</div><div class="line">     |      |--- src</div><div class="line">     |            |</div><div class="line">     |            |--- hello</div><div class="line">     |            |      |</div><div class="line">     |            |      |--- hello.go</div><div class="line">     |            |</div><div class="line">     |            |--- main</div><div class="line">     |                   |</div><div class="line">     |                   |--- main.go</div><div class="line">     |</div><div class="line">     |-- GoDemo</div></pre></td></tr></table></figure>
<p>Go提供了install命令，与build命令相比，install命令在编译源码后还会将可执行文件或库文件安装到约定的目录下。我们以main目录为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ cd main</div><div class="line">$ go install</div></pre></td></tr></table></figure>
<p>install命令执行后，我们发现main目录下没有任何变化，原先build时产生的main可执行文件也不见了踪影。别急，前面说过Go install也有一套自己的约定：</p>
<ul>
<li>go install(在src/DIR下)编译出的可执行文件以其所在目录名(DIR)命名</li>
<li>go install将可执行文件安装到与src同级别的bin目录下，bin目录由go install自动创建</li>
<li>go install将可执行文件依赖的各种package编译后，放在与src同级别的pkg目录下</li>
</ul>
<p>现在我们来看看bin目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ ls /Users/yunyu/workspace_go/TestGo</div><div class="line">bin</div><div class="line">src</div><div class="line">pkg</div><div class="line"></div><div class="line">$ cd /Users/yunyu/workspace_go/TestGo</div><div class="line">$ ls bin</div><div class="line">main</div></pre></td></tr></table></figure>
<p>的确出现一个bin目录和一个pkg目录，并且刚刚编译的程序main在bin下面。</p>
<p>hello.go编译后并非可执行程序，在编译main的同时，由于main依赖hello package，因此hello也被关联编译了。这与单独在hello目录下执行install的结果是一样的，只是单独安装的时候我们只创建了pkg目录，没有bin目录（因为bin目录是install main.go产生的），我们试试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ cd /Users/yunyu/workspace_go/TestGo/src/hello</div><div class="line">$ go install</div><div class="line">$ ls /Users/yunyu/workspace_go/TestGo</div><div class="line">bin</div><div class="line">pkg</div><div class="line">src</div></pre></td></tr></table></figure>
<p>在我们的workspace(TestGo目录)下出现了一个pkg目录，pkg目录下是一个名为darwin_amd64的子目录(这个目录和操作系统有关系)，其下面有一个文件：hello.a。这就是我们install的结果。hello.go被编译为hello.a并安装到pkg/darwin_amd64目录下了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">workspace_go</div><div class="line">     |</div><div class="line">     |--- TestGo</div><div class="line">     |      |</div><div class="line">     |      |--- src</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- hello</div><div class="line">     |      |     |      |</div><div class="line">     |      |     |      |--- hello.go</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- main</div><div class="line">     |      |            |</div><div class="line">     |      |            |--- main.go</div><div class="line">     |      |</div><div class="line">     |      |--- bin</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- main</div><div class="line">     |      |</div><div class="line">     |      |</div><div class="line">     |      |--- pkg</div><div class="line">     |            |</div><div class="line">     |            |--- hello.a</div><div class="line">     |</div><div class="line">     |-- GoDemo</div></pre></td></tr></table></figure>
<p>.a这个后缀名让我们想起了静态共享库，但这里的.a却是Go独有的文件格式，与传统的静态共享库并不兼容。但Go语言的设计者使用这个后缀名似乎是希望这个.a文件也承担起Go语言中”静态共享库”的角色。我们不妨来试试，看看这个hello.a是否可以被Go compiler当作”静态共享库”来对待。我们移除src中的hello目录，然后在main目录下执行go build：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go build</div><div class="line">main.go:4:5: cannot find package &quot;hello&quot; in any of:</div><div class="line">	/usr/local/Cellar/go/1.7.3/libexec/src/hello (from $GOROOT)</div><div class="line">	/Users/yunyu/workspace_go/TestGo/src/hello (from $GOPATH)</div></pre></td></tr></table></figure>
<p>Go编译器提示无法找到hello这个包，可见目前版本的Go编译器似乎不理pkg下的.a文件。<a href="http://code.google.com/p/go/issues/detail?id=2775" target="_blank" rel="external">http://code.google.com/p/go/issues/detail?id=2775</a> 这个issue也印证了这一点，不过后续Go版本很可能会支持链接.a文件。毕竟我们在使用第三方package的时候，很可能无法得到其源码，并且在每个项目中都保存一份第三方包的源码也十分不利于项目源码的后期维护。</p>
<h3 id="像脚本一样运行Go源码"><a href="#像脚本一样运行Go源码" class="headerlink" title="像脚本一样运行Go源码"></a>像脚本一样运行Go源码</h3><p>Go具有很高的编译效率，这得益于其设计者对该目标的重视以及设计过程中细节方面的把控，当然这不是本文要关注的话题。正是由于go具有极速的编译，我们才可以像使用运行脚本语言那样使用它。</p>
<p>目前Go提供了run命令来直接运行源文件。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ go run main.go</div><div class="line">Hello World!</div></pre></td></tr></table></figure>
<p>go run实际上是一个将编译源码和运行编译后的二进制程序结合在一起的命令。但目前go源文件尚不支持作成Shebang Script，因为Go compiler尚不识别#!符号，下面的源码文件运行起来会出错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#! /usr/local/bin/go run</div><div class="line"></div><div class="line">package main</div><div class="line"></div><div class="line">import (</div><div class="line">    &quot;hello&quot;</div><div class="line">)</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">    hello.Hello()</div><div class="line">&#125;</div><div class="line"></div><div class="line">$ go run main.go</div><div class="line">package main:</div><div class="line">main.go:1:1: illegal character U+0023 &apos;#&apos;</div></pre></td></tr></table></figure>
<p>不过我们可以可借助一些第三方工具来运行Shebang Go scripts，比如gorun。</p>
<h3 id="go-run，-go-build，-go-install的区别"><a href="#go-run，-go-build，-go-install的区别" class="headerlink" title="go run， go build， go install的区别"></a>go run， go build， go install的区别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">go run helloworld.go</div><div class="line">go build helloworld.go</div><div class="line">go install</div></pre></td></tr></table></figure>
<h4 id="go-build"><a href="#go-build" class="headerlink" title="go build"></a>go build</h4><p>通过go build加上要编译的Go源文件名，我们即可得到一个可执行文件，默认情况下这个文件的名字为源文件名字去掉.go后缀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go build helloworld.go</div><div class="line">$ ls</div><div class="line">helloworld</div><div class="line">helloworld.go</div></pre></td></tr></table></figure>
<p>当然我们也 可以通过-o选项来指定其他名字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go build -o newworld helloworld.go</div><div class="line">$ ls</div><div class="line">newworld</div><div class="line">helloworld.go</div></pre></td></tr></table></figure>
<p>如果我们在当前目录(src)下直接执行go build命令，后面不带文件名，我们将得到一个与目录名同名的可执行文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ go build</div><div class="line">$ ls</div><div class="line">src</div><div class="line">helloworld.go</div></pre></td></tr></table></figure>
<h4 id="go-install"><a href="#go-install" class="headerlink" title="go install"></a>go install</h4><p>与build命令相比，install命令在编译源码后还会将可执行文件或库文件安装到约定的目录下。</p>
<p>go install编译出的可执行文件以其所在目录名(DIR)命名<br>go install将可执行文件安装到与src同级别的bin目录下，bin目录由go install自动创建<br>go install将可执行文件依赖的各种package编译后，放在与src同级别的pkg目录下。</p>
<h4 id="go-run"><a href="#go-run" class="headerlink" title="go run"></a>go run</h4><p>go run实际上是一个将编译源码和运行编译后的二进制程序结合在一起的命令。</p>
<p>go run helloworld.go = go build helloworld.go + ./helloworld</p>
<h3 id="引用第三方包"><a href="#引用第三方包" class="headerlink" title="引用第三方包"></a>引用第三方包</h3><p>若你在包的导入路径中包含了代码仓库的URL，go get就会自动地获取、构建并安装它：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ go get github.com/golang/glog</div></pre></td></tr></table></figure>
<p>若指定的包不在工作空间中，go get就会将会将它放到GOPATH指定的第一个工作空间内。（若该包已存在，go get就会跳过远程获取，其行为与go install相同）</p>
<p>在执行完上面的go get命令后，工作空间的目录树看起来应该是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">workspace_go</div><div class="line">     |</div><div class="line">     |--- TestGo</div><div class="line">     |      |</div><div class="line">     |      |--- src</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- github.com</div><div class="line">     |      |     |      |</div><div class="line">     |      |     |      |--- golang</div><div class="line">     |      |     |             |</div><div class="line">     |      |     |             |--- glog</div><div class="line">     |      |     |                    |</div><div class="line">     |      |     |                    |--- LICENSE</div><div class="line">     |      |     |                    |</div><div class="line">     |      |     |                    |--- README</div><div class="line">     |      |     |                    |</div><div class="line">     |      |     |                    |--- glog.go</div><div class="line">     |      |     |                    |</div><div class="line">     |      |     |                    |--- glog_file.go</div><div class="line">     |      |     |                    |</div><div class="line">     |      |     |                    |--- glog_test.go</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- hello</div><div class="line">     |      |     |      |</div><div class="line">     |      |     |      |--- hello.go</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- main</div><div class="line">     |      |            |</div><div class="line">     |      |            |--- main.go</div><div class="line">     |      |</div><div class="line">     |      |--- bin</div><div class="line">     |      |     |</div><div class="line">     |      |     |--- main</div><div class="line">     |      |</div><div class="line">     |      |</div><div class="line">     |      |--- pkg</div><div class="line">     |            |</div><div class="line">     |            |--- github.com</div><div class="line">     |            |      |</div><div class="line">     |            |      |--- golang</div><div class="line">     |            |             |</div><div class="line">     |            |             |--- glog.a</div><div class="line">     |            |</div><div class="line">     |            |--- hello.a</div><div class="line">     |</div><div class="line">     |-- GoDemo</div></pre></td></tr></table></figure>
<p>hello.go</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">package hello</div><div class="line"></div><div class="line">import &quot;fmt&quot;</div><div class="line">import &quot;flag&quot;</div><div class="line">import &quot;github.com/golang/glog&quot;</div><div class="line"></div><div class="line">func Hello() &#123;</div><div class="line">    flag.Parse()</div><div class="line">    fmt.Println(&quot;Hello World!&quot;)</div><div class="line">    glog.Info(&quot;glog Hello World!&quot;)</div><div class="line">    glog.Flush()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意事项:  </p>
<ol>
<li>因为是使用时依参数配置，所以需在main()中加上flag.Parse()</li>
<li>需在结尾加上glog.Flush()</li>
<li>依级别生成不同的日志文件，但级别高的日志信息会同时在级别低的日志文件中输出</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ go run main.go -log_dir=./</div><div class="line">Hello World!</div><div class="line">$ ll</div><div class="line">lrwxr-xr-x  1 yunyu  staff   51 12 27 11:44 main.INFO -&gt; main.localhost.yunyu.log.INFO.20161227-114425.19830</div><div class="line">-rw-r--r--  1 yunyu  staff   72 12 22 14:39 main.go</div><div class="line">-rw-r--r--  1 yunyu  staff  186 12 27 11:44 main.localhost.yunyu.log.INFO.20161227-114425.19830</div><div class="line"></div><div class="line">$ vi main.INFO</div><div class="line">Log file created at: 2016/12/27 11:48:08</div><div class="line">Running on machine: localhost</div><div class="line">Binary: Built with gc go1.7.3 for darwin/amd64</div><div class="line">Log line format: [IWEF]mmdd hh:mm:ss.uuuuuu threadid file:line] msg</div><div class="line">I1227 11:48:08.088596   19951 hello.go:10] glog Hello World!</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://tonybai.com/2012/08/17/hello-go/" target="_blank" rel="external">http://tonybai.com/2012/08/17/hello-go/</a></li>
<li><a href="http://docscn.studygolang.com/doc/code.html" target="_blank" rel="external">http://docscn.studygolang.com/doc/code.html</a></li>
<li><a href="http://blog.csdn.net/xcl168/article/details/44650019" target="_blank" rel="external">http://blog.csdn.net/xcl168/article/details/44650019</a></li>
<li><a href="http://www.oschina.net/translate/go-at-google-language-design-in-the-service-of-software-engineering?lang=chs&amp;page=1#" target="_blank" rel="external">http://www.oschina.net/translate/go-at-google-language-design-in-the-service-of-software-engineering?lang=chs&amp;page=1#</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/">Go</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Go/">Go</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Shell/Shell脚本学习（九）简单的启动脚本" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/24/Shell/Shell脚本学习（九）简单的启动脚本/" class="article-date">
  	<time datetime="2016-11-24T08:53:09.000Z" itemprop="datePublished">2016-11-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/24/Shell/Shell脚本学习（九）简单的启动脚本/">Shell脚本学习（九）简单的启动脚本</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近部署了日志收集服务，发现好多服务都要自己写启动脚本，刚刚开始学习Shell只能一边学一边写，就拿简单的Kibana服务来写个启动脚本吧。</p>
<p>一般服务的启动脚本，都需要实现下面的几点：</p>
<ol>
<li>需要设置服务的内存使用大小（特别是Java服务）</li>
<li>后台启动（一些服务支持后台启动，例如：ElasticSearch）</li>
<li>限制启动用户（最好限定启动服务的用户，防止其他用户误操作）</li>
<li>设置PID文件目录（一些服务可以在配置文件中设置PID文件目录，例如：Kibana）</li>
<li>设置服务的logs目录（一些服务可以在配置文件中设置logs目录，例如：ElasticSearch）</li>
</ol>
<p>（下面的Kibana启动脚本可能不是最新的，因为目前一直在更新）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"># Kibana Issue : https://github.com/elastic/kibana/issues/5170</div><div class="line">export NODE_OPTIONS=&quot;$&#123;NODE_OPTIONS:=--max-old-space-size=200&#125;&quot;</div><div class="line"></div><div class="line">RETVAL=0</div><div class="line">SYS_USER=&quot;elk&quot;</div><div class="line">SYS_USER_ID=&quot;501&quot;</div><div class="line"></div><div class="line">KB_NAME=&quot;kibana&quot;</div><div class="line">KB_DESC=&quot;Kibana 4.5.4&quot;</div><div class="line">KB_PID_FOLDER=&quot;/var/run/kibana&quot;</div><div class="line">KB_PID_FILE=&quot;$&#123;KB_PID_FOLDER&#125;/$&#123;KB_NAME&#125;.pid&quot;</div><div class="line">KB_LOG_FOLDER=&quot;$&#123;KB_HOME&#125;/logs&quot;</div><div class="line"></div><div class="line"># 限制启动用户</div><div class="line">if [ `id -u` -ne &quot;$&#123;SYS_USER_ID&#125;&quot; ]; then</div><div class="line">    echo &quot;You need $&#123;SYS_USER&#125; privileges to run this script&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># 启动服务</div><div class="line">start() &#123;</div><div class="line">    status</div><div class="line">    RETVAL=$?</div><div class="line">    if [ $RETVAL -eq 0 ]; then</div><div class="line">        echo &quot;$&#123;KB_NAME&#125; is already running&quot;</div><div class="line">        exit $RETVAL</div><div class="line">    fi</div><div class="line"></div><div class="line">    echo &quot;Starting $&#123;KB_DESC&#125; : &quot;</div><div class="line">    if [ ! -d &quot;$&#123;KB_PID_FOLDER&#125;&quot; ] ; then</div><div class="line">        mkdir -p $&#123;KB_PID_FOLDER&#125;</div><div class="line">    fi</div><div class="line">    if [ ! -d &quot;$&#123;KB_LOG_FOLDER&#125;&quot; ] ; then</div><div class="line">        mkdir -p $&#123;KB_LOG_FOLDER&#125;</div><div class="line">    fi</div><div class="line"></div><div class="line">    cd $&#123;KB_HOME&#125;/bin</div><div class="line">    nohup kibana 1&gt;$&#123;KB_LOG_FOLDER&#125;/$&#123;KB_NAME&#125;.out 2&gt;$&#123;KB_LOG_FOLDER&#125;/$&#123;KB_NAME&#125;.err &amp;</div><div class="line">    sleep 3</div><div class="line">    PID=`cat &quot;$&#123;KB_PID_FILE&#125;&quot;`</div><div class="line">    echo &quot;$&#123;KB_NAME&#125; started. PID:$PID&quot; </div><div class="line">    return 0 </div><div class="line">&#125;</div><div class="line"></div><div class="line"># 停止服务</div><div class="line">stop() &#123;</div><div class="line">    echo &quot;Stopping $&#123;KB_DESC&#125; : &quot;</div><div class="line">    if status ; then</div><div class="line">    PID=`cat &quot;$&#123;KB_PID_FILE&#125;&quot;`</div><div class="line">    echo &quot;Killing $&#123;KB_NAME&#125; (PID:$PID) with SIGTERM&quot;</div><div class="line">    kill -TERM $PID &gt;/dev/null 2&gt;&amp;1</div><div class="line">    sleep 1</div><div class="line">    if status &amp;&amp; sleep 1 ; then</div><div class="line">        echo &quot;$&#123;KB_NAME&#125; stop failed; still running. Will force kill $&#123;KB_NAME&#125;&quot;</div><div class="line">        kill -KILL $PID &gt;/dev/null 2&gt;&amp;1</div><div class="line">        sleep 1</div><div class="line">        if status &amp;&amp; sleep 1 ; then</div><div class="line">        	echo &quot;$&#123;KB_NAME&#125; stop failed; still running.&quot; </div><div class="line">        else</div><div class="line">            echo &quot;$&#123;KB_NAME&#125; stopped.&quot;</div><div class="line">            rm -f $&#123;KB_PID_FILE&#125;</div><div class="line">        fi</div><div class="line">    else</div><div class="line">        echo &quot;$&#123;KB_NAME&#125; stopped.&quot;</div><div class="line">        rm -f $&#123;KB_PID_FILE&#125;</div><div class="line">    fi</div><div class="line">  fi</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 检查服务状态</div><div class="line">status() &#123;</div><div class="line">    if [ -f &quot;$&#123;KB_PID_FILE&#125;&quot; ] ; then</div><div class="line">        PID=`cat &quot;$&#123;KB_PID_FILE&#125;&quot;`</div><div class="line">        if kill -0 $PID &gt; /dev/null 2&gt; /dev/null ; then</div><div class="line">            return 0</div><div class="line">        else</div><div class="line">        	# program is dead but pid file exists</div><div class="line">            return 2</div><div class="line">        fi</div><div class="line">    else</div><div class="line">    	# program is not running</div><div class="line">        return 3</div><div class="line">    fi</div><div class="line">&#125;</div><div class="line"></div><div class="line">case &quot;$1&quot; in</div><div class="line">    start)</div><div class="line">        start</div><div class="line">        ;;</div><div class="line">    stop)</div><div class="line">        stop</div><div class="line">        ;;</div><div class="line">    status)</div><div class="line">        status</div><div class="line">        RETVAL=$?</div><div class="line">        if [ $RETVAL -eq 0 ] ; then</div><div class="line">            PID=`cat &quot;$&#123;KB_PID_FILE&#125;&quot;`</div><div class="line">            echo &quot;$&#123;KB_NAME&#125; is running. PID:$PID&quot;</div><div class="line">        else</div><div class="line">            echo &quot;$&#123;KB_NAME&#125; is not running&quot;</div><div class="line">        fi</div><div class="line">        exit $RETVAL</div><div class="line">        ;;</div><div class="line">    restart)</div><div class="line">        stop &amp;&amp; start</div><div class="line">        ;;</div><div class="line">    *)</div><div class="line">        # Invalid Arguments, print the following message.</div><div class="line">        echo &quot;Usage: $0 &#123;start|stop|status|restart&#125;&quot; &gt;&amp;2</div><div class="line">        exit 2</div><div class="line">        ;;</div><div class="line">esac</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Shell/">Shell</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Logstash/Logstash学习（三）Logstash的Grok表达式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/23/Logstash/Logstash学习（三）Logstash的Grok表达式/" class="article-date">
  	<time datetime="2016-11-23T04:52:53.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/23/Logstash/Logstash学习（三）Logstash的Grok表达式/">Logstash学习（三）Logstash的Grok表达式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天遇到个比较奇葩的日志解析问题，我们的日志文件内容是标准的JSON格式的，但是在使用Logstash解析的时候，我们希望也能够保存原始的日志字符串到ES</p>
<h3 id="track-log日志文件"><a href="#track-log日志文件" class="headerlink" title="track.log日志文件"></a>track.log日志文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475114816071&quot;,&quot;rpid&quot;:&quot;65351516503932932&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475914829286&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:20:29.286Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475114827206&quot;,&quot;rpid&quot;:&quot;65351516503932930&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475914840425&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:20:40.425Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475915077351&quot;,&quot;rpid&quot;:&quot;65351516503932934&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475915090579&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:24:50.579Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475914816133&quot;,&quot;rpid&quot;:&quot;65351516503932928&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475914829332&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:20:29.332Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475914827284&quot;,&quot;rpid&quot;:&quot;65351516503932936&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475914840498&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:20:40.499Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475915077585&quot;,&quot;rpid&quot;:&quot;65351516503932932&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475915090789&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:24:50.789Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475912701768&quot;,&quot;rpid&quot;:&quot;65351516503932930&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;status&quot;:&quot;succeeded&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475912715001&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T07:45:15.001Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475913832349&quot;,&quot;rpid&quot;:&quot;65351516503932934&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;errorStatus&quot;:200,&quot;errorCode&quot;:&quot;0000&quot;,&quot;errorMsg&quot;:&quot;操作成功&quot;,&quot;status&quot;:&quot;failed&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475913845544&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:04:05.544Z&quot;&#125;</div><div class="line">&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475915080561&quot;,&quot;rpid&quot;:&quot;65351516503932928&quot;,&quot;name&quot;:&quot;birdben.api.call&quot;,&quot;request&quot;:&quot;GET /api/test/settings&quot;,&quot;errorStatus&quot;:200,&quot;errorCode&quot;:&quot;0000&quot;,&quot;errorMsg&quot;:&quot;操作成功&quot;,&quot;status&quot;:&quot;failed&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475915093792&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:24:53.792Z&quot;&#125;</div></pre></td></tr></table></figure>
<p>我开始的想法是从track.log日志文件中读取日志信息，因为track.log日志是标准的JSON格式的，所以直接将codec设置成json，因为logs是一个内嵌的数组，然后在filter根据logs做split，会把logs的数组拆分出多条日志信息，然后在匹配指定格式的timestamp并生成新的字段@timestamp。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [&quot;/home/yunyu/Downloads/track.log&quot;]</div><div class="line">        type =&gt; &quot;api&quot;</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">        ignore_older =&gt; 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    split &#123;</div><div class="line">        field =&gt; &quot;logs&quot;</div><div class="line">    &#125;</div><div class="line">    date &#123;</div><div class="line">        match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;]</div><div class="line">        target =&gt; &quot;@timestamp&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    elasticsearch &#123;</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        hosts =&gt; [&quot;hadoop1:9200&quot;, &quot;hadoop2:9200&quot;, &quot;hadoop3:9200&quot;]</div><div class="line">        index =&gt; &quot;api_logs_index&quot;</div><div class="line">        document_type =&gt; &quot;%&#123;type&#125;&quot;</div><div class="line">        workers =&gt; 1</div><div class="line">        flush_size =&gt; 20000</div><div class="line">        idle_flush_time =&gt; 10</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述做法的确能够将track.log日志解析成功并且写入到ES中，但是没有办法获取到原日志信息，对我们来说是无法满足要求的。</p>
<p>为什么没办法获取到原日志信息呢？这里再次梳理下Logstash的处理流程。</p>
<p>原来一直以为是</p>
<ul>
<li>input –&gt; filter –&gt; output</li>
</ul>
<p>应该补上decode/encode</p>
<ul>
<li>input –&gt; decode –&gt; filter –&gt; encode –&gt; output</li>
</ul>
<p>decode/encode就是解码器和编码器</p>
<ul>
<li>input的codec是设置decode解码器<ul>
<li>codec =&gt; json：把json字符串转换成json对象</li>
</ul>
</li>
<li>ouput的codec是设置encode编码器（大部分output都默认codec是json，例如：ES，Kafka等等）<ul>
<li>codec =&gt; json：把json对象转换成json字符串</li>
</ul>
</li>
</ul>
<p>分析了一下codec =&gt; json的作用，就是直接输入预定义好的JSON数据，这样就可以省略掉filter/grok配置，其实就是可以省略在filter/grok中配置json插件配置了，codec默认值是plain，plain是一个空的解析器，它可以让用户自己指定格式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        ...</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">等价于</div><div class="line"></div><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        ...</div><div class="line">        codec =&gt; json &#123;</div><div class="line">            charset =&gt; [&quot;UTF-8&quot;] (optional), default: &quot;UTF-8&quot;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">等价于</div><div class="line"></div><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        ...</div><div class="line">        # 默认值是plain</div><div class="line">        codec =&gt; &quot;plain&quot;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match &#123;</div><div class="line">            &quot;message&quot; =&gt; &quot;%&#123;MATCH_ALL:@message&#125;&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    json &#123;</div><div class="line">        source =&gt; &quot;@message&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MATCH_ALL是在{LOGSTASH_HOME}/patterns/postfix配置的grok表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># MATCH_ALL就是匹配任意的字符串</div><div class="line">MATCH_ALL (.*)</div></pre></td></tr></table></figure>
<p>也可以自己指定一个format格式，转换成String输出到指定端（ES，Kafka等等），注意format只对output生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">output &#123;</div><div class="line">    kafka &#123;</div><div class="line">        codec =&gt; plain &#123;</div><div class="line">            format =&gt; &quot;%&#123;message&#125;&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，仍然不解为何使用codec =&gt; “json”后，filter就获取不到原日志信息</p>
<p>再次尝试，仍然使用codec =&gt; “json”，但是在filter中添加match表达式，通过match中的”message”来获取原日志信息，然后把值复制给@message新字段，后续进行split拆分等等其他操作。具体配置文件修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        ...</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        match =&gt; &#123;</div><div class="line">            &quot;message&quot; =&gt; &quot;%&#123;MATCH_ALL:@message&#125;&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    split &#123;</div><div class="line">        field =&gt; &quot;logs&quot;</div><div class="line">    &#125;</div><div class="line">    date &#123;</div><div class="line">        match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;]</div><div class="line">        target =&gt; &quot;@timestamp&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>尝试的结果并不是我们预期的，@message中获取的其实是我们track.log中的message字段的值”logs”。这里有个特殊情况就是我们track.log日志中带有message这个字段，但是为什么这里match表达式却获取到track.log日志中的message字段了呢？原因是我们input设置使用codec解码器为json（也就是将Logstash读取到我们file的原日志信息解析成json对象），match这里接收到的其实就是json对象中的message字段（就是我们track.log日志中的message字段），简单的理解match =&gt; {“message” =&gt; “%{MATCH_ALL:@message}”}就是通过”message”这个key获取filter接收的数据源（json对象或者原日志字符串）中的value，如果codec设置成json就是读取的json对象中的”message”的属性值，如果codec设置成plain，”message”是获取的原日志的字符串信息匹配grok表达式的值。</p>
<p>所以这里我们为了能够让match的”message”获取到原日志信息，而不是我们解析好的json日志中的message属性，我们把input的codec =&gt; “json”改成codec =&gt; “plain”，这样就会在input就将原日志解析成json对象了，而是我们在filter自己来处理。具体配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">input &#123;</div><div class="line">    file &#123;</div><div class="line">        path =&gt; [&quot;/home/yunyu/Downloads/track.log&quot;]</div><div class="line">        type =&gt; &quot;api&quot;</div><div class="line">        start_position =&gt; &quot;beginning&quot;</div><div class="line">        ignore_older =&gt; 0</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">filter &#123;</div><div class="line">    grok &#123;</div><div class="line">        # MATCH_ALL为了匹配所有的字符串，然后将值复制给新字段@message</div><div class="line">        match =&gt; &#123;</div><div class="line">            &quot;message&quot; =&gt; &quot;%&#123;MATCH_ALL:@message&#125;&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    # json的作用可以将日志字符串中是json字符串的部分解析转换成json对象</div><div class="line">    # 再将新字段@message转换成json对象</div><div class="line">    json &#123;</div><div class="line">        source =&gt; &quot;@message&quot;</div><div class="line">    &#125;</div><div class="line">    # split拆分转化好的json对象中的logs数组</div><div class="line">    split &#123;</div><div class="line">        field =&gt; &quot;logs&quot;</div><div class="line">    &#125;</div><div class="line">    date &#123;</div><div class="line">        match =&gt; [&quot;timestamp&quot;, &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;]</div><div class="line">        target =&gt; &quot;@timestamp&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">output &#123;</div><div class="line">    stdout &#123;</div><div class="line">        codec =&gt; rubydebug</div><div class="line">    &#125;</div><div class="line">    elasticsearch &#123;</div><div class="line">        codec =&gt; &quot;json&quot;</div><div class="line">        hosts =&gt; [&quot;hadoop1:9200&quot;, &quot;hadoop2:9200&quot;, &quot;hadoop3:9200&quot;]</div><div class="line">        index =&gt; &quot;api_logs_index&quot;</div><div class="line">        document_type =&gt; &quot;%&#123;type&#125;&quot;</div><div class="line">        workers =&gt; 1</div><div class="line">        flush_size =&gt; 20000</div><div class="line">        idle_flush_time =&gt; 10</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ES中的索引数据"><a href="#ES中的索引数据" class="headerlink" title="ES中的索引数据"></a>ES中的索引数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_index&quot;: &quot;api_logs_index&quot;,</div><div class="line">    &quot;_type&quot;: &quot;api&quot;,</div><div class="line">    &quot;_id&quot;: &quot;AViQYVbFlnhRMZdfbXco&quot;,</div><div class="line">    &quot;_version&quot;: 1,</div><div class="line">    &quot;_score&quot;: 1,</div><div class="line">    &quot;_source&quot;: &#123;</div><div class="line">        &quot;message&quot;: &quot;logs&quot;,</div><div class="line">        &quot;@version&quot;: &quot;1&quot;,</div><div class="line">        &quot;@timestamp&quot;: &quot;2016-10-08T15:20:29.286Z&quot;,</div><div class="line">        &quot;path&quot;: &quot;/home/yunyu/Downloads/birdben.log&quot;,</div><div class="line">        &quot;host&quot;: &quot;hadoop1&quot;,</div><div class="line">        &quot;type&quot;: &quot;api&quot;,</div><div class="line">        &quot;@message&quot;: &quot;&#123;&quot;logs&quot;:[&#123;&quot;timestamp&quot;:&quot;1475114816071&quot;,&quot;rpid&quot;:&quot;65351516503932932&quot;,&quot;name&quot;:&quot;birdben.ad.open_hb&quot;,&quot;bid&quot;:0,&quot;uid&quot;:0,&quot;did&quot;:0,&quot;duid&quot;:0,&quot;hb_uid&quot;:0,&quot;ua&quot;:&quot;&quot;,&quot;device_id&quot;:&quot;&quot;,&quot;server_timestamp&quot;:1475914829286&#125;],&quot;level&quot;:&quot;info&quot;,&quot;message&quot;:&quot;logs&quot;,&quot;timestamp&quot;:&quot;2016-10-08T08:20:29.286Z&quot;&#125;&quot;,</div><div class="line">        &quot;logs&quot;: &#123;</div><div class="line">            &quot;timestamp&quot;: &quot;1475114816071&quot;,</div><div class="line">            &quot;rpid&quot;: &quot;65351516503932932&quot;,</div><div class="line">            &quot;name&quot;: &quot;birdben.ad.open_hb&quot;,</div><div class="line">            &quot;bid&quot;: 0,</div><div class="line">            &quot;uid&quot;: 0,</div><div class="line">            &quot;did&quot;: 0,</div><div class="line">            &quot;duid&quot;: 0,</div><div class="line">            &quot;hb_uid&quot;: 0,</div><div class="line">            &quot;ua&quot;: &quot;&quot;,</div><div class="line">            &quot;device_id&quot;: &quot;&quot;,</div><div class="line">            &quot;server_timestamp&quot;: 1475914829286</div><div class="line">        &#125;,</div><div class="line">        &quot;level&quot;: &quot;info&quot;,</div><div class="line">        &quot;timestamp&quot;: &quot;2016-10-08T08:20:29.286Z&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里在使用split插件的过程中还发现了个Logstash的Bug，Split拆分的过程中如果遇到不是String和Array类型就会直接导致Logstash Crash，这里正确的做法应该类似grok一样，给对应的日志添加一个_jsonparsefailure的Tag，而不是导致Logstash直接崩溃，这个问题已经有人在GitHub上提了一个issue，貌似要等到Logstash 5.x的版本才会被修复。</p>
<p>具体地址：<a href="https://github.com/logstash-plugins/logstash-filter-split/issues/17">https://github.com/logstash-plugins/logstash-filter-split/issues/17</a></p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-grok.html#plugins-filters-grok-match" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-grok.html#plugins-filters-grok-match</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-codecs-json.html" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-codecs-json.html</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-json.html#plugins-filters-json-source" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-json.html#plugins-filters-json-source</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-split.html#plugins-filters-split-field" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/plugins-filters-split.html#plugins-filters-split-field</a></li>
<li><a href="https://www.elastic.co/guide/en/logstash/2.3/configuration-file-structure.html#codec" target="_blank" rel="external">https://www.elastic.co/guide/en/logstash/2.3/configuration-file-structure.html#codec</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Logstash/">Logstash</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 birdben
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82900755-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>