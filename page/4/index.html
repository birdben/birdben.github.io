<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>birdben</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="birdben">
<meta property="og:url" content="https://github.com/birdben/page/4/index.html">
<meta property="og:site_name" content="birdben">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="birdben">
  
    <link rel="alternative" href="/atom.xml" title="birdben" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260188951'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260188951' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/images/logo.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">birdben</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Akka/" style="font-size: 11.11px;">Akka</a> <a href="/tags/Dockerfile/" style="font-size: 20px;">Dockerfile</a> <a href="/tags/Docker命令/" style="font-size: 18.89px;">Docker命令</a> <a href="/tags/Docker环境/" style="font-size: 13.33px;">Docker环境</a> <a href="/tags/ELK/" style="font-size: 11.11px;">ELK</a> <a href="/tags/ElasticSearch/" style="font-size: 11.11px;">ElasticSearch</a> <a href="/tags/Flume/" style="font-size: 17.78px;">Flume</a> <a href="/tags/Git命令/" style="font-size: 13.33px;">Git命令</a> <a href="/tags/HBase/" style="font-size: 10px;">HBase</a> <a href="/tags/HDFS/" style="font-size: 16.67px;">HDFS</a> <a href="/tags/Hadoop/" style="font-size: 10px;">Hadoop</a> <a href="/tags/Hadoop原理架构体系/" style="font-size: 10px;">Hadoop原理架构体系</a> <a href="/tags/Hive/" style="font-size: 15.56px;">Hive</a> <a href="/tags/Jenkins环境/" style="font-size: 10px;">Jenkins环境</a> <a href="/tags/Kafka/" style="font-size: 12.22px;">Kafka</a> <a href="/tags/Kibana/" style="font-size: 11.11px;">Kibana</a> <a href="/tags/Linux命令/" style="font-size: 12.22px;">Linux命令</a> <a href="/tags/Maven配置/" style="font-size: 12.22px;">Maven配置</a> <a href="/tags/MongoDB/" style="font-size: 12.22px;">MongoDB</a> <a href="/tags/MySQL/" style="font-size: 10px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shadowsocks/" style="font-size: 10px;">Shadowsocks</a> <a href="/tags/Shell/" style="font-size: 14.44px;">Shell</a> <a href="/tags/Spring/" style="font-size: 11.11px;">Spring</a> <a href="/tags/Storm/" style="font-size: 11.11px;">Storm</a> <a href="/tags/Zookeeper/" style="font-size: 13.33px;">Zookeeper</a> <a href="/tags/其他/" style="font-size: 10px;">其他</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/birdben">我的CSDN的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">birdben</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/images/logo.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">birdben</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/birdben" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Flume/Flume学习（七）Flume整合Elasticsearch2.x" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/27/Flume/Flume学习（七）Flume整合Elasticsearch2.x/" class="article-date">
  	<time datetime="2016-08-27T08:17:39.000Z" itemprop="datePublished">2016-08-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/27/Flume/Flume学习（七）Flume整合Elasticsearch2.x/">Flume学习（七）Flume整合Elasticsearch2.x</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h3><ul>
<li>JDK1.7.0_79</li>
<li>Flume1.6.0</li>
<li>Elasticsearch2.0.0</li>
</ul>
<h3 id="Flume不支持Elasticsearch2-x版本"><a href="#Flume不支持Elasticsearch2-x版本" class="headerlink" title="Flume不支持Elasticsearch2.x版本"></a>Flume不支持Elasticsearch2.x版本</h3><p>目前官方Flume最新的版本是1.6.0，该版本只支持Elasticsearch1.7.x的版本，暂时不支持Elasticsearch2.x版本，因为Elasticsearch2.x版本做了比较大的改动，很多API都已经废弃不用了，具体可以参考下面的连接</p>
<ul>
<li><a href="https://github.com/elastic/elasticsearch/issues/14187">https://github.com/elastic/elasticsearch/issues/14187</a></li>
</ul>
<h3 id="第三方ElasticsearchSink2支持2-x版本"><a href="#第三方ElasticsearchSink2支持2-x版本" class="headerlink" title="第三方ElasticsearchSink2支持2.x版本"></a>第三方ElasticsearchSink2支持2.x版本</h3><p>这里我找到了一个第三方开源的FlumeSink插件来支持Elasticsearch2.x版本</p>
<ul>
<li><a href="https://github.com/lucidfrontier45/ElasticsearchSink2">https://github.com/lucidfrontier45/ElasticsearchSink2</a></li>
</ul>
<p>但是这个项目是使用Gradle编译打包的，所以下面先简单介绍下Gradle的安装和使用</p>
<p>我这里使用的Mac，所以安装Gradle很简单。但是Gradle是依赖于JVM的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ brew install gradle</div><div class="line">$ gradle -v</div></pre></td></tr></table></figure>
<p>然后从github下载ElasticsearchSink2的源代码，并且导入到idea中，然后执行下面gradle命令构建项目（下面这两个脚本是ElasticsearchSink2项目自带的），会在ElasticsearchSink2/build/libs/目录下生成对应的jar包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 构建标准的jar包</div><div class="line">$ ./gradlew build</div><div class="line"></div><div class="line"># 构建包含Elasticsearch依赖的jar包</div><div class="line">$ ./gradlew assembly</div></pre></td></tr></table></figure>
<p>添加刚才构建好的elasticsearch-sink2-1.0.jar到Flume的classpath或者是Flume的lib目录，删除Flume的lib目录下的guava-<em>.jar，jackson-core-</em>.jar。</p>
<h3 id="具体的配置文件"><a href="#具体的配置文件" class="headerlink" title="具体的配置文件"></a>具体的配置文件</h3><h4 id="Flume-Collector端的flume-collector-es2-conf配置"><a href="#Flume-Collector端的flume-collector-es2-conf配置" class="headerlink" title="Flume Collector端的flume_collector_es2.conf配置"></a>Flume Collector端的flume_collector_es2.conf配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">agentX.sources = flume-avro-sink</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = flume-es-sink</div><div class="line"></div><div class="line">agentX.sources.flume-avro-sink.channels = chX</div><div class="line">agentX.sources.flume-avro-sink.type = avro</div><div class="line">agentX.sources.flume-avro-sink.bind = 127.0.0.1</div><div class="line">agentX.sources.flume-avro-sink.port = 41414</div><div class="line">agentX.sources.flume-avro-sink.threads = 8</div><div class="line">agentX.sources.flume-avro-sink.interceptors = es_interceptor</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.type = regex_extractor</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\&quot;([^,^\&quot;]+)\&quot;:\&quot;([^:^\&quot;]+)\&quot;)|(\&quot;([^,^\&quot;]+)\&quot;:([\\d]+))</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\\d):(\\d):(\\d):(\\d):(\\d):(\\d)</div><div class="line"></div><div class="line"># mapping不正确没有匹配成功</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (TIME:(.*?)),(HOSTNAME:(.*?)),(LI:(.*?)),(LU:(.*?)),(NU:(.*?)),(CMD:(.*?))</div><div class="line"># mapping正确，数据匹配不正确包含了多余的字段名</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\&quot;TIME\&quot;:(.*?)),(\&quot;HOSTNAME\&quot;:(.*?)),(\&quot;LI\&quot;:(.*?)),(\&quot;LU\&quot;:(.*?)),(\&quot;NU\&quot;:(.*?)),(\&quot;CMD\&quot;:(.*?))</div><div class="line"># mapping正确，数据也正确（&#123;&#125;需要转义，转义符是\\）</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = &quot;TIME&quot;:(.*?),&quot;HOSTNAME&quot;:(.*?),&quot;LI&quot;:(.*?),&quot;LU&quot;:(.*?),&quot;NU&quot;:(.*?),&quot;CMD&quot;:(.*?)</div><div class="line"></div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers = s1 s2 s3 s4 s5 s6</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s1.name = aaa</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s2.name = bbb</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s3.name = s3</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s4.name = s4</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s5.name = s5</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s6.name = s6</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line">agentX.sinks.flume-es-sink.channel = chX</div><div class="line">agentX.sinks.flume-es-sink.type = com.frontier45.flume.sink.elasticsearch2.ElasticSearchSink</div><div class="line"># 每个事务写入多少个Event</div><div class="line">agentX.sinks.flume-es-sink.batchSize = 100</div><div class="line">agentX.sinks.flume-es-sink.hostNames = 127.0.0.1:9300</div><div class="line"># 注意：indexName必须小写</div><div class="line">agentX.sinks.flume-es-sink.indexName = command_index</div><div class="line">agentX.sinks.flume-es-sink.indexType = logs</div><div class="line">agentX.sinks.flume-es-sink.clusterName = ben-es</div><div class="line"># ttl 的时间，过期了会自动删除文档，如果没有设置则永不过期，ttl使用integer或long型，单位可以是：ms (毫秒), s (秒), m (分), h (小时), d (天) and w (周)。例如：a1.sinks.k1.ttl = 5d则表示5天后过期。这里没用到</div><div class="line"># agentX.sinks.flume-es-sink.ttl = 5d</div><div class="line">agentX.sinks.flume-es-sink.serializer = com.frontier45.flume.sink.elasticsearch2.ElasticSearchLogStashEventSerializer</div></pre></td></tr></table></figure>
<h4 id="flume-collector-es2-conf这里的配置需要修改"><a href="#flume-collector-es2-conf这里的配置需要修改" class="headerlink" title="flume_collector_es2.conf这里的配置需要修改"></a>flume_collector_es2.conf这里的配置需要修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sink.type = com.frontier45.flume.sink.elasticsearch2.ElasticSearchSink</div><div class="line">sink.serializer = com.frontier45.flume.sink.elasticsearch2.ElasticSearchLogStashEventSerializer</div></pre></td></tr></table></figure>
<h4 id="Flume-Agent端的flume-agent-file-conf配置"><a href="#Flume-Agent端的flume-agent-file-conf配置" class="headerlink" title="Flume Agent端的flume_agent_file.conf配置"></a>Flume Agent端的flume_agent_file.conf配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">agent3.sources = command-logfile-source</div><div class="line">agent3.channels = ch3</div><div class="line">agent3.sinks = flume-avro-sink</div><div class="line"></div><div class="line">agent3.sources.command-logfile-source.channels = ch3</div><div class="line">agent3.sources.command-logfile-source.type = exec</div><div class="line">agent3.sources.command-logfile-source.command = tail -F /Users/yunyu/Downloads/command.log</div><div class="line"></div><div class="line">agent3.channels.ch3.type = memory</div><div class="line">agent3.channels.ch3.capacity = 1000</div><div class="line">agent3.channels.ch3.transactionCapacity = 100</div><div class="line"></div><div class="line">agent3.sinks.flume-avro-sink.channel = ch3</div><div class="line">agent3.sinks.flume-avro-sink.type = avro</div><div class="line">agent3.sinks.flume-avro-sink.hostname = 127.0.0.1</div><div class="line">agent3.sinks.flume-avro-sink.port = 41414</div></pre></td></tr></table></figure>
<h4 id="启动ES服务"><a href="#启动ES服务" class="headerlink" title="启动ES服务"></a>启动ES服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/elasticseach -d</div></pre></td></tr></table></figure>
<h4 id="启动Flume-Collector端"><a href="#启动Flume-Collector端" class="headerlink" title="启动Flume Collector端"></a>启动Flume Collector端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_collector_es2.conf -Dflume.root.logger=DEBUG,console -n agentX</div></pre></td></tr></table></figure>
<h4 id="启动Flume-Agent端"><a href="#启动Flume-Agent端" class="headerlink" title="启动Flume Agent端"></a>启动Flume Agent端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_agent_file.conf -Dflume.root.logger=DEBUG,console -n agentX</div></pre></td></tr></table></figure>
<p>启动Flume Agent可能会遇到如下的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">2016-08-27 14:25:58,045 (lifecycleSupervisor-1-1) [ERROR - org.apache.flume.lifecycle.LifecycleSupervisor$MonitorRunnable.run(LifecycleSupervisor.java:253)] Unable to start SinkRunner: &#123; policy:org.apache.flume.sink.DefaultSinkProcessor@76d45adb counterGroup:&#123; name:null counters:&#123;&#125; &#125; &#125; - Exception follows.</div><div class="line">java.lang.NoSuchFieldError: LUCENE_5_3_1</div><div class="line">	at org.elasticsearch.Version.&lt;clinit&gt;(Version.java:279)</div><div class="line">	at org.elasticsearch.client.transport.TransportClient$Builder.build(TransportClient.java:131)</div><div class="line">	at com.frontier45.flume.sink.elasticsearch2.client.ElasticSearchTransportClient.openClient(ElasticSearchTransportClient.java:198)</div></pre></td></tr></table></figure>
<p>出现上面的错误是因为lucene的版本不对，这里我开始尝试安装的是下面的几个版本：</p>
<ul>
<li>Elasticsearch-2.2.2：没有选择Elasticsearch-2.2.2版本是因为ik分词插件没有对应的版本</li>
<li>Elasticsearch-2.2.1：没有选择Elasticsearch-2.2.1版本是因为报错没有找到LUCENE_5_3_1对应的Lucene-5.3.1版本，但是这里下载Elasticsearch-2.2.1版本中的jar包依赖的是Lucene-5.4.1版本，所以找不到Lucene-5.3.1版本。这里可能是因为ElasticsearchSink2的问题，暂时先换成ElasticsearchSink2使用的2.0.0版本，后续在尝试单独升级Lucene-5.4.1试试。</li>
<li>Elasticsearch-2.0.0：ElasticsearchSink2使用的此版本</li>
</ul>
<p>检查一下ES源码的pom文件就可以知道ES和Lucene的版本对应关系如下：</p>
<table>
<thead>
<tr>
<th>ES版本</th>
<th>Lucene版本</th>
<th>ik插件版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>Elasticsearch-2.2.2</td>
<td>Lucene-5.4.1</td>
<td>无</td>
</tr>
<tr>
<td>Elasticsearch-2.2.1</td>
<td>Lucene-5.4.1</td>
<td>1.8.1</td>
</tr>
<tr>
<td>Elasticsearch-2.0.0</td>
<td>Lucene-5.2.1</td>
<td>1.5.0</td>
</tr>
</tbody>
</table>
<h4 id="检查ES的索引数据"><a href="#检查ES的索引数据" class="headerlink" title="检查ES的索引数据"></a>检查ES的索引数据</h4><p>如下图所示，ES的mapping和索引数据都正确，说明我们使用ElasticsearchSink2的方式成功将Flume1.6.0采集的command.log日志数据写入到Elasticsearch2.0.0版本里</p>
<p><img src="http://img.blog.csdn.net/20160827161437043?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="mapping"></p>
<p><img src="http://img.blog.csdn.net/20160827161523009?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="data"></p>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/lucidfrontier45/ElasticsearchSink2">https://github.com/lucidfrontier45/ElasticsearchSink2</a></li>
<li><a href="https://github.com/elastic/elasticsearch/issues/14187">https://github.com/elastic/elasticsearch/issues/14187</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（六）Flume整合Elasticsearch1.x" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/26/Flume/Flume学习（六）Flume整合Elasticsearch1.x/" class="article-date">
  	<time datetime="2016-08-26T15:11:56.000Z" itemprop="datePublished">2016-08-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/26/Flume/Flume学习（六）Flume整合Elasticsearch1.x/">Flume学习（六）Flume整合Elasticsearch1.x</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="环境简介"><a href="#环境简介" class="headerlink" title="环境简介"></a>环境简介</h3><ul>
<li>JDK1.7.0_79</li>
<li>Flume1.6.0</li>
<li>Elasticsearch1.7.3</li>
</ul>
<h3 id="ES的安装和配置"><a href="#ES的安装和配置" class="headerlink" title="ES的安装和配置"></a>ES的安装和配置</h3><p>这里不做重点介绍，请参考之前关于ES的文章</p>
<h3 id="Flume整合ES的相关配置"><a href="#Flume整合ES的相关配置" class="headerlink" title="Flume整合ES的相关配置"></a>Flume整合ES的相关配置</h3><h4 id="flume-collector-es1-conf配置文件"><a href="#flume-collector-es1-conf配置文件" class="headerlink" title="flume_collector_es1.conf配置文件"></a>flume_collector_es1.conf配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">agentX.sources = flume-avro-sink</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = flume-es-sink</div><div class="line"></div><div class="line">agentX.sources.flume-avro-sink.channels = chX</div><div class="line">agentX.sources.flume-avro-sink.type = avro</div><div class="line">agentX.sources.flume-avro-sink.bind = 10.10.1.23</div><div class="line">agentX.sources.flume-avro-sink.port = 41414</div><div class="line">agentX.sources.flume-avro-sink.threads = 8</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line">agentX.sinks.flume-es-sink.channel = chX</div><div class="line">agentX.sinks.flume-es-sink.type = org.apache.flume.sink.elasticsearch.ElasticSearchSink</div><div class="line"># 每个事务写入多少个Event</div><div class="line">agentX.sinks.flume-es-sink.batchSize = 100</div><div class="line">agentX.sinks.flume-es-sink.hostNames = 10.10.1.23:9300</div><div class="line"># 注意：indexName必须小写</div><div class="line">agentX.sinks.flume-es-sink.indexName = command_index</div><div class="line">agentX.sinks.flume-es-sink.indexType = logs</div><div class="line">agentX.sinks.flume-es-sink.clusterName = es</div><div class="line"># ttl 的时间，过期了会自动删除文档，如果没有设置则永不过期，ttl使用integer或long型，单位可以是：ms (毫秒), s (秒), m (分), h (小时), d (天) and w (周)。例如：a1.sinks.k1.ttl = 5d则表示5天后过期。这里没用到</div><div class="line"># agentX.sinks.flume-es-sink.ttl = 5d</div><div class="line">agentX.sinks.flume-es-sink.serializer = org.apache.flume.sink.elasticsearch.ElasticSearchLogStashEventSerializer</div></pre></td></tr></table></figure>
<p>然后我们先启动ES，然后再启动Flume来收集command.log日志并且写入到ES。</p>
<h4 id="Flume启动报错"><a href="#Flume启动报错" class="headerlink" title="Flume启动报错"></a>Flume启动报错</h4><p>如果启动Flume的时候，报如下的错误，说明缺少ES相关依赖的jar包。需要将${ES_HOME}/lib/lucene-core-4.10.4.jar，${ES_HOME}/lib/elasticsearch-1.7.3.jar这两个包复制到${FLUME_HOME}/lib/下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">2016-08-25 10:37:50,303 (conf-file-poller-0) [ERROR - org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherRunnable.run(PollingPropertiesFileConfigurationProvider.java:145)] Failed to start agent because dependencies were not found in classpath. Error follows.</div><div class="line">java.lang.NoClassDefFoundError: org/elasticsearch/common/io/BytesStream</div><div class="line">	at java.lang.Class.forName0(Native Method)</div><div class="line">	at java.lang.Class.forName(Class.java:191)</div><div class="line">	at org.apache.flume.sink.elasticsearch.ElasticSearchSink.configure(ElasticSearchSink.java:286)</div><div class="line">	at org.apache.flume.conf.Configurables.configure(Configurables.java:41)</div><div class="line">	at org.apache.flume.node.AbstractConfigurationProvider.loadSinks(AbstractConfigurationProvider.java:413)</div><div class="line">	at org.apache.flume.node.AbstractConfigurationProvider.getConfiguration(AbstractConfigurationProvider.java:98)</div><div class="line">	at org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherRunnable.run(PollingPropertiesFileConfigurationProvider.java:140)</div><div class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)</div><div class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)</div><div class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.lang.ClassNotFoundException: org.elasticsearch.common.io.BytesStream</div><div class="line">	at java.net.URLClassLoader$1.run(URLClassLoader.java:366)</div><div class="line">	at java.net.URLClassLoader$1.run(URLClassLoader.java:355)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at java.net.URLClassLoader.findClass(URLClassLoader.java:354)</div><div class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:425)</div><div class="line">	at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)</div><div class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:358)</div><div class="line">	... 14 more</div></pre></td></tr></table></figure>
<h4 id="日志解析问题"><a href="#日志解析问题" class="headerlink" title="日志解析问题"></a>日志解析问题</h4><p>当command.log有日志不断输出时，我们会看到Flume控制台会不断收集到ES，但是在ES端查询command_index的mapping却和我们想象的mapping不太一样，这里我们需要解析command.log日志中的日志格式，将具体的日志字段解析出来并且对应ES mapping中的字段。我之前有用过ELK的方式来做command.log日志的收集，Logstash通过filter的grok表达式的方式来解析日志格式很简单，并且可以对收集的日志字段进行一些特殊处理（如：类型转换，删除字段，重命名字段等等）。在Flume里是通过Interceptors来实现Logstash的filter grok表达式功能的。</p>
<p><img src="http://img.blog.csdn.net/20160825104414733?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="ES_Mapping"></p>
<h4 id="Flume的Interceptors配置"><a href="#Flume的Interceptors配置" class="headerlink" title="Flume的Interceptors配置"></a>Flume的Interceptors配置</h4><p>下面是我们command.log的日志文件截取，可以看出我们command.log日志的格式比较简单。修改我们的flume_es.conf配置文件，添加interceptors的配置，指定正则表达式解析我们的日志格式。</p>
<h5 id="command-log日志文件"><a href="#command-log日志文件" class="headerlink" title="command.log日志文件"></a>command.log日志文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">598  &#123;&quot;TIME&quot;:&quot;2016-08-24 19:07:49&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;8844&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;java -version&quot;&#125;</div><div class="line">598  &#123;&quot;TIME&quot;:&quot;2016-08-24 19:07:49&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;8844&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;java -version&quot;&#125;</div><div class="line">599  &#123;&quot;TIME&quot;:&quot;2016-08-24 19:15:19&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;8844&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;cd ~/dev/elasticsearch-1.7.3/config/&quot;&#125;</div><div class="line">600  &#123;&quot;TIME&quot;:&quot;2016-08-24 19:15:21&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;8844&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;sublime elasticsearch.yml &quot;&#125;</div><div class="line">515  &#123;&quot;TIME&quot;:&quot;2016-08-25 10:00:07&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;6601&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;ls&quot;&#125;</div><div class="line">515  &#123;&quot;TIME&quot;:&quot;2016-08-25 10:00:07&quot;,&quot;HOSTNAME&quot;:&quot;localhost&quot;,&quot;LI&quot;:&quot;6601&quot;,&quot;LU&quot;:&quot;yunyu&quot;,&quot;NU&quot;:&quot;yunyu&quot;,&quot;CMD&quot;:&quot;ls&quot;&#125;</div></pre></td></tr></table></figure>
<p>我擦，我被Flume的interceptors配置给坑了，官网给了一个interceptors的例子非常的简单，根本就不知道怎么支持我上面的日志格式（主要是我正则表达式学的太烂了）。感觉Flume对于日志的处理方面没有Logstash灵活易用。</p>
<p>先来看一下官网给的interceptors例子吧</p>
<p>If the Flume event body contained 1:2:3.4foobar5 and the following configuration was used</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># ()号中的是从日志记录中提取出来的value，这个value会对应serializers中定义的field名称</div><div class="line">a1.sources.r1.interceptors.i1.regex = (\\d):(\\d):(\\d)</div><div class="line">a1.sources.r1.interceptors.i1.serializers = s1 s2 s3</div><div class="line">a1.sources.r1.interceptors.i1.serializers.s1.name = one</div><div class="line">a1.sources.r1.interceptors.i1.serializers.s2.name = two</div><div class="line">a1.sources.r1.interceptors.i1.serializers.s3.name = three</div></pre></td></tr></table></figure>
<p>The extracted event will contain the same body but the following headers will have been added one=&gt;1, two=&gt;2, three=&gt;3</p>
<p>上面官网的例子就是从日志1:2:3.4foobar5中按照我们的格式用”:”号分割并且提取后面的1位数字，并且按照提取出来的值顺序对应字段名称为：one，two，three，最后转换出来的结果就是one=&gt;1, two=&gt;2, three=&gt;3</p>
<p>但是我们上面的日志文件格式要稍微复杂一点，我们的日志一个json格式的字符串，所以第一次用Flume提取日志记录中的值还有点费事，我也是一边修改正则表达式，一边测试结果。</p>
<h5 id="mapping不正确没有匹配成功"><a href="#mapping不正确没有匹配成功" class="headerlink" title="mapping不正确没有匹配成功"></a>mapping不正确没有匹配成功</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (TIME:(.*?)),(HOSTNAME:(.*?)),(LI:(.*?)),(LU:(.*?)),(NU:(.*?)),(CMD:(.*?))</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160825172129720?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="mapping"></p>
<p><img src="http://img.blog.csdn.net/20160825172217307?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="data"></p>
<h5 id="mapping正确，数据匹配不正确包含了多余的字段名"><a href="#mapping正确，数据匹配不正确包含了多余的字段名" class="headerlink" title="mapping正确，数据匹配不正确包含了多余的字段名"></a>mapping正确，数据匹配不正确包含了多余的字段名</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\&quot;TIME\&quot;:(.*?)),(\&quot;HOSTNAME\&quot;:(.*?)),(\&quot;LI\&quot;:(.*?)),(\&quot;LU\&quot;:(.*?)),(\&quot;NU\&quot;:(.*?)),(\&quot;CMD\&quot;:(.*?))</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160825172611373?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="mapping"></p>
<p><img src="http://img.blog.csdn.net/20160825172633442?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="data"></p>
<h5 id="mapping正确，数据也正确（特殊字符需要转义，转义符是-）"><a href="#mapping正确，数据也正确（特殊字符需要转义，转义符是-）" class="headerlink" title="mapping正确，数据也正确（特殊字符需要转义，转义符是\）"></a>mapping正确，数据也正确（特殊字符需要转义，转义符是\）</h5><p>最后终于调试正确了，是因为我修改Flume的正则表达式改错了，发现es.log中的错误信息提示的bulk参数，我发现bulk的参数居然解析了两次时间字段{“TIME”:”2016-08-25 16:09:10”}，我们定义的aaa字段包含了TIME字段名还有value，但是bbb字段却只有TIME字段的value，而不是预想中第二个字段的值。所以这里我发现了一个很重要的规则，就是正则表达式中”()号”中的是从日志记录中提取出来的value，这个value会对应serializers中定义的field名称，我上一个表达式之所以会解析两边TIME字段就是因为正则表达式中带了两个”()号”，如：(TIME:(.*?))，这样就会把TIME的value提取出来一次，再把TIME:value这样的字符串当成值提取出来一次，所以就会出现上面的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">failed to execute bulk item (index) index &#123;[command_index-2016-08-25][logs][AVbAvyBwi0A7kguFbmpj], source[&#123;&quot;@message&quot;:537,&quot;@fields&quot;:&#123;&quot;aaa&quot;:&#123;&quot;TIME&quot;:&quot;2016-08-25 16:09:10&quot;&#125;,&quot;aaa&quot;:&quot;&#123;\&quot;TIME\&quot;:\&quot;2016-08-25 16:09:10\&quot;&quot;,&quot;s5&quot;:&quot;\&quot;LI\&quot;:\&quot;5573\&quot;&quot;,&quot;s6&quot;:&quot;\&quot;5573\&quot;&quot;,&quot;bbb&quot;:&quot;\&quot;2016-08-25 16:09:10\&quot;&quot;,&quot;s3&quot;:&quot;\&quot;HOSTNAME\&quot;:\&quot;localhost\&quot;&quot;,&quot;s4&quot;:&quot;\&quot;localhost\&quot;&quot;&#125;&#125;]&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = &quot;TIME&quot;:(.*?),&quot;HOSTNAME&quot;:(.*?),&quot;LI&quot;:(.*?),&quot;LU&quot;:(.*?),&quot;NU&quot;:(.*?),&quot;CMD&quot;:(.*?)</div></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20160825164926247?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="mapping"></p>
<p><img src="http://img.blog.csdn.net/20160825164958191?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="data"></p>
<h5 id="flume-collector-es1-conf配置文件-1"><a href="#flume-collector-es1-conf配置文件-1" class="headerlink" title="flume_collector_es1.conf配置文件"></a>flume_collector_es1.conf配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">agentX.sources = flume-avro-sink</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = flume-es-sink</div><div class="line"></div><div class="line">agentX.sources.flume-avro-sink.channels = chX</div><div class="line">agentX.sources.flume-avro-sink.type = avro</div><div class="line">agentX.sources.flume-avro-sink.bind = 10.10.1.23</div><div class="line">agentX.sources.flume-avro-sink.port = 41414</div><div class="line">agentX.sources.flume-avro-sink.threads = 8</div><div class="line">agentX.sources.flume-avro-sink.interceptors = es_interceptor</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.type = regex_extractor</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\&quot;([^,^\&quot;]+)\&quot;:\&quot;([^:^\&quot;]+)\&quot;)|(\&quot;([^,^\&quot;]+)\&quot;:([\\d]+))</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\\d):(\\d):(\\d):(\\d):(\\d):(\\d)</div><div class="line"></div><div class="line"># mapping不正确没有匹配成功</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (TIME:(.*?)),(HOSTNAME:(.*?)),(LI:(.*?)),(LU:(.*?)),(NU:(.*?)),(CMD:(.*?))</div><div class="line"># mapping正确，数据匹配不正确包含了多余的字段名</div><div class="line">#agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = (\&quot;TIME\&quot;:(.*?)),(\&quot;HOSTNAME\&quot;:(.*?)),(\&quot;LI\&quot;:(.*?)),(\&quot;LU\&quot;:(.*?)),(\&quot;NU\&quot;:(.*?)),(\&quot;CMD\&quot;:(.*?))</div><div class="line"># mapping正确，数据也正确（&#123;&#125;需要转义，转义符是\\）</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.regex = &quot;TIME&quot;:(.*?),&quot;HOSTNAME&quot;:(.*?),&quot;LI&quot;:(.*?),&quot;LU&quot;:(.*?),&quot;NU&quot;:(.*?),&quot;CMD&quot;:(.*?)</div><div class="line"></div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers = s1 s2 s3 s4 s5 s6</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s1.name = aaa</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s2.name = bbb</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s3.name = s3</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s4.name = s4</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s5.name = s5</div><div class="line">agentX.sources.flume-avro-sink.interceptors.es_interceptor.serializers.s6.name = s6</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line">agentX.sinks.flume-es-sink.channel = chX</div><div class="line">agentX.sinks.flume-es-sink.type = org.apache.flume.sink.elasticsearch.ElasticSearchSink</div><div class="line"># 每个事务写入多少个Event</div><div class="line">agentX.sinks.flume-es-sink.batchSize = 100</div><div class="line">agentX.sinks.flume-es-sink.hostNames = 10.10.1.23:9300</div><div class="line"># 注意：indexName必须小写</div><div class="line">agentX.sinks.flume-es-sink.indexName = command_index</div><div class="line">agentX.sinks.flume-es-sink.indexType = logs</div><div class="line">agentX.sinks.flume-es-sink.clusterName = es</div><div class="line"># ttl 的时间，过期了会自动删除文档，如果没有设置则永不过期，ttl使用integer或long型，单位可以是：ms (毫秒), s (秒), m (分), h (小时), d (天) and w (周)。例如：a1.sinks.k1.ttl = 5d则表示5天后过期。这里没用到</div><div class="line"># agentX.sinks.flume-es-sink.ttl = 5d</div><div class="line">agentX.sinks.flume-es-sink.serializer = org.apache.flume.sink.elasticsearch.ElasticSearchLogStashEventSerializer</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/yangruihong/article/details/17245359" target="_blank" rel="external">http://blog.csdn.net/yangruihong/article/details/17245359</a></li>
<li><a href="http://flume.apache.org/FlumeUserGuide.html#zookeeper-based-configuration" target="_blank" rel="external">http://flume.apache.org/FlumeUserGuide.html#zookeeper-based-configuration</a></li>
<li><a href="http://blog.csdn.net/xiao_jun_0820/article/details/38333171" target="_blank" rel="external">http://blog.csdn.net/xiao_jun_0820/article/details/38333171</a></li>
<li><a href="http://www.voidcn.com/blog/lanmo555/article/p-4974586.html" target="_blank" rel="external">http://www.voidcn.com/blog/lanmo555/article/p-4974586.html</a></li>
<li><a href="http://blog.csdn.net/sunflower_cao/article/details/39929931" target="_blank" rel="external">http://blog.csdn.net/sunflower_cao/article/details/39929931</a></li>
<li><a href="http://blog.csdn.net/u010022051/article/details/50515725" target="_blank" rel="external">http://blog.csdn.net/u010022051/article/details/50515725</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（五）Flume编译安装" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/26/Flume/Flume学习（五）Flume编译安装/" class="article-date">
  	<time datetime="2016-08-26T05:07:11.000Z" itemprop="datePublished">2016-08-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/26/Flume/Flume学习（五）Flume编译安装/">Flume学习（五）Flume编译安装</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="下载Flume源码"><a href="#下载Flume源码" class="headerlink" title="下载Flume源码"></a>下载Flume源码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ curl -o apache-flume-1.6.0-src.tar.gz http://mirrors.hust.edu.cn/apache/flume/1.6.0/apache-flume-1.6.0-src.tar.gz</div><div class="line">$ tar -zxvf apache-flume-1.6.0-src.tar.gz</div><div class="line">$ cd apache-flume-1.6.0-src</div></pre></td></tr></table></figure>
<h3 id="使用Maven编辑打包"><a href="#使用Maven编辑打包" class="headerlink" title="使用Maven编辑打包"></a>使用Maven编辑打包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ mvn clean</div><div class="line">$ mvn install -DskipTests -Dtar</div></pre></td></tr></table></figure>
<p>编译过程中，下载ua-parser-1.3.0.pom可能会失败，出现类似下面的错误，无法连接到<a href="http://maven.twttr.com:80，会重复尝试几次连接不上就build" target="_blank" rel="external">http://maven.twttr.com:80，会重复尝试几次连接不上就build</a> failed了。这个可能是因为<a href="http://maven.twttr.com:80地址被墙了" target="_blank" rel="external">http://maven.twttr.com:80地址被墙了</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Building Flume NG Morphline Solr Sink 1.6.0</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">Downloading: http://10.10.1.10:8082/content/groups/public/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">Downloading: https://repository.cloudera.com/artifactory/cloudera-repos/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">Downloading: http://repo1.maven.org/maven2/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">Downloading: http://repository.jboss.org/nexus/content/groups/public/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">Downloading: https://repo.maven.apache.org/maven2/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">Downloading: http://maven.twttr.com/ua_parser/ua-parser/1.3.0/ua-parser-1.3.0.pom</div><div class="line">八月 26, 2016 12:11:25 下午 org.apache.maven.wagon.providers.http.httpclient.impl.execchain.RetryExec execute</div><div class="line">信息: I/O exception (java.net.NoRouteToHostException) caught when processing request to &#123;&#125;-&gt;http://maven.twttr.com:80: No route to host</div><div class="line">八月 26, 2016 12:11:25 下午 org.apache.maven.wagon.providers.http.httpclient.impl.execchain.RetryExec execute</div><div class="line">信息: Retrying request to &#123;&#125;-&gt;http://maven.twttr.com:80</div></pre></td></tr></table></figure>
<p>我把网上解决无法连接<a href="http://maven.twttr.com的办法汇总了一下，需要在Flume的pom文件中最上面添加下面这些repository地址，来下载ua-parser-1.3.0.pom" target="_blank" rel="external">http://maven.twttr.com的办法汇总了一下，需要在Flume的pom文件中最上面添加下面这些repository地址，来下载ua-parser-1.3.0.pom</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;repositories&gt;</div><div class="line">	&lt;repository&gt;</div><div class="line">	  &lt;id&gt;maven.tempo-db.com&lt;/id&gt;</div><div class="line">	  &lt;url&gt;http://maven.oschina.net/service/local/repositories/sonatype-public-grid/content/&lt;/url&gt;</div><div class="line">	&lt;/repository&gt;</div><div class="line">	&lt;repository&gt;</div><div class="line">	  &lt;id&gt;p2.jfrog.org&lt;/id&gt;</div><div class="line">	  &lt;url&gt;http://p2.jfrog.org/libs-releases&lt;/url&gt;</div><div class="line">	&lt;/repository&gt;</div><div class="line">	&lt;repository&gt;</div><div class="line">	  &lt;id&gt;nexus.axiomalaska.com&lt;/id&gt;</div><div class="line">	  &lt;url&gt;http://nexus.axiomalaska.com/nexus/content/repositories/public&lt;/url&gt;</div><div class="line">	&lt;/repository&gt;</div><div class="line">&lt;/repositories&gt;</div></pre></td></tr></table></figure>
<p>添加后如下图所示</p>
<p><img src="http://img.blog.csdn.net/20160826121945067?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Maven"></p>
<p>再次编译打包后，就成功了。可以在apache-flume-1.6.0-src/flume-ng-dist/target/路径下找到我们打包好的apache-flume-1.6.0-bin.tar.gz，这样我们就可以在flume的源代码上进行自己的修改并且可以打包应用了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Reactor Summary:</div><div class="line">[INFO]</div><div class="line">[INFO] Apache Flume ....................................... SUCCESS [  0.928 s]</div><div class="line">[INFO] Flume NG SDK ....................................... SUCCESS [  3.490 s]</div><div class="line">[INFO] Flume NG Configuration ............................. SUCCESS [  1.329 s]</div><div class="line">[INFO] Flume Auth ......................................... SUCCESS [  4.949 s]</div><div class="line">[INFO] Flume NG Core ...................................... SUCCESS [  8.924 s]</div><div class="line">[INFO] Flume NG Sinks ..................................... SUCCESS [  0.050 s]</div><div class="line">[INFO] Flume NG HDFS Sink ................................. SUCCESS [  2.947 s]</div><div class="line">[INFO] Flume NG IRC Sink .................................. SUCCESS [  1.002 s]</div><div class="line">[INFO] Flume NG Channels .................................. SUCCESS [  0.041 s]</div><div class="line">[INFO] Flume NG JDBC channel .............................. SUCCESS [  1.691 s]</div><div class="line">[INFO] Flume NG file-based channel ........................ SUCCESS [  6.320 s]</div><div class="line">[INFO] Flume NG Spillable Memory channel .................. SUCCESS [  1.323 s]</div><div class="line">[INFO] Flume NG Node ...................................... SUCCESS [  2.382 s]</div><div class="line">[INFO] Flume NG Embedded Agent ............................ SUCCESS [  1.458 s]</div><div class="line">[INFO] Flume NG HBase Sink ................................ SUCCESS [  3.763 s]</div><div class="line">[INFO] Flume NG ElasticSearch Sink ........................ SUCCESS [  1.914 s]</div><div class="line">[INFO] Flume NG Morphline Solr Sink ....................... SUCCESS [02:41 min]</div><div class="line">[INFO] Flume Kafka Sink ................................... SUCCESS [  1.194 s]</div><div class="line">[INFO] Flume NG Kite Dataset Sink ......................... SUCCESS [  2.804 s]</div><div class="line">[INFO] Flume NG Hive Sink ................................. SUCCESS [  2.462 s]</div><div class="line">[INFO] Flume Sources ...................................... SUCCESS [  0.030 s]</div><div class="line">[INFO] Flume Scribe Source ................................ SUCCESS [  1.081 s]</div><div class="line">[INFO] Flume JMS Source ................................... SUCCESS [  1.362 s]</div><div class="line">[INFO] Flume Twitter Source ............................... SUCCESS [  0.895 s]</div><div class="line">[INFO] Flume Kafka Source ................................. SUCCESS [  1.066 s]</div><div class="line">[INFO] flume-kafka-channel ................................ SUCCESS [  1.093 s]</div><div class="line">[INFO] Flume legacy Sources ............................... SUCCESS [  0.028 s]</div><div class="line">[INFO] Flume legacy Avro source ........................... SUCCESS [  0.998 s]</div><div class="line">[INFO] Flume legacy Thrift Source ......................... SUCCESS [  1.248 s]</div><div class="line">[INFO] Flume NG Clients ................................... SUCCESS [  0.026 s]</div><div class="line">[INFO] Flume NG Log4j Appender ............................ SUCCESS [  3.208 s]</div><div class="line">[INFO] Flume NG Tools ..................................... SUCCESS [  0.902 s]</div><div class="line">[INFO] Flume NG distribution .............................. SUCCESS [ 12.454 s]</div><div class="line">[INFO] Flume NG Integration Tests ......................... SUCCESS [  1.278 s]</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] BUILD SUCCESS</div><div class="line">[INFO] ------------------------------------------------------------------------</div><div class="line">[INFO] Total time: 03:57 min</div><div class="line">[INFO] Finished at: 2016-08-26T12:24:44+08:00</div><div class="line">[INFO] Final Memory: 411M/868M</div><div class="line">[INFO] ------------------------------------------------------------------------</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/yydcj/article/details/38824823" target="_blank" rel="external">http://blog.csdn.net/yydcj/article/details/38824823</a></li>
<li><a href="https://www.iteblog.com/archives/1043" target="_blank" rel="external">https://www.iteblog.com/archives/1043</a></li>
<li><a href="http://blog.csdn.net/qianshangding0708/article/details/48087911" target="_blank" rel="external">http://blog.csdn.net/qianshangding0708/article/details/48087911</a></li>
<li><a href="http://blog.csdn.net/yeruby/article/details/50751927" target="_blank" rel="external">http://blog.csdn.net/yeruby/article/details/50751927</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（四）Failover和LoadBalance模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/25/Flume/Flume学习（四）Failover和LoadBalance模式/" class="article-date">
  	<time datetime="2016-08-25T05:18:47.000Z" itemprop="datePublished">2016-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/25/Flume/Flume学习（四）Failover和LoadBalance模式/">Flume学习（四）Failover和LoadBalance模式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://img.blog.csdn.net/20160824170052276?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Failover"></p>
<p>Flume内置支持Failover和LoadBalance两种模式，这两种模式都支持Sink配置一个Group，Failover的Group具有故障转移的功能，LoadBalance的Group具有负载均衡的功能</p>
<ul>
<li>Failover支持故障转移</li>
<li>LoadBalance支持负载均衡</li>
</ul>
<h3 id="Failover模式"><a href="#Failover模式" class="headerlink" title="Failover模式"></a>Failover模式</h3><p>我这里是用本机模拟此架构，Agent是采集端，分别写入Sink1和Sink2，Collector1和Collector2是Collect端。此架构允许Collector1和Collector2部分停机，需要在采集层（Agent）每一个Sink同时指向Collect层的2个相同的Flume Agent（Collector1和Collector2）。所以使用failover架构就是为了防止Collect层Flume Agent（Collector1和Collector2）因为故障或例行停机维护。</p>
<h5 id="Agent节点的flume-failover-agent-conf配置"><a href="#Agent节点的flume-failover-agent-conf配置" class="headerlink" title="Agent节点的flume_failover_agent.conf配置"></a>Agent节点的flume_failover_agent.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">agentX.sources = sX</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = sk1 sk2</div><div class="line"></div><div class="line">agentX.sources.sX.channels = chX</div><div class="line">agentX.sources.sX.type = exec</div><div class="line">agentX.sources.sX.command = tail -F /Users/yunyu/Downloads/command.log</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line"># 配置sinks，这里我们指定了2个相同的Agent（即Collector1和Collector2，这里我们使用本机测试，所以是两个相同的Agent进程，hostname都是本机IP，只是port不同用于区分）</div><div class="line">agentX.sinks.sk1.channel = chX</div><div class="line">agentX.sinks.sk1.type = avro</div><div class="line">agentX.sinks.sk1.hostname = 10.10.1.23</div><div class="line">agentX.sinks.sk1.port = 44441</div><div class="line"></div><div class="line">agentX.sinks.sk2.channel = chX</div><div class="line">agentX.sinks.sk2.type = avro</div><div class="line">agentX.sinks.sk2.hostname = 10.10.1.23</div><div class="line">agentX.sinks.sk2.port = 44442</div><div class="line"></div><div class="line"># 配置failover组信息，把上面的两个sink配置成一个group，并且指定类型为failover</div><div class="line">agentX.sinkgroups = g1</div><div class="line">agentX.sinkgroups.g1.sinks = sk1 sk2</div><div class="line">agentX.sinkgroups.g1.processor.type = failover</div><div class="line"># 此处建议设置priority优先级，数值越大优先级越高，优先级低的作为容灾使用，sk1正常情况，sk2是不消费的</div><div class="line">agentX.sinkgroups.g1.processor.priority.sk1 = 9</div><div class="line">agentX.sinkgroups.g1.processor.priority.sk2 = 7</div><div class="line">agentX.sinkgroups.g1.processor.maxpenalty = 10000</div></pre></td></tr></table></figure>
<h5 id="Collector1节点的flume-failover-collector1-conf配置"><a href="#Collector1节点的flume-failover-collector1-conf配置" class="headerlink" title="Collector1节点的flume_failover_collector1.conf配置"></a>Collector1节点的flume_failover_collector1.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">agent1.sources = s1</div><div class="line">agent1.channels = ch1</div><div class="line">agent1.sinks = sk1</div><div class="line"></div><div class="line">agent1.sources.s1.channels = ch1</div><div class="line">agent1.sources.s1.type = avro</div><div class="line">agent1.sources.s1.bind = 10.10.1.23</div><div class="line">agent1.sources.s1.port = 44441</div><div class="line"></div><div class="line">agent1.channels.ch1.type = memory</div><div class="line">agent1.channels.ch1.capacity = 1000</div><div class="line">agent1.channels.ch1.transactionCapacity = 100</div><div class="line"></div><div class="line">agent1.sinks.sk1.channel = ch1</div><div class="line">agent1.sinks.sk1.type = logger</div></pre></td></tr></table></figure>
<h5 id="Collector2节点的flume-failover-collector2-conf配置"><a href="#Collector2节点的flume-failover-collector2-conf配置" class="headerlink" title="Collector2节点的flume_failover_collector2.conf配置"></a>Collector2节点的flume_failover_collector2.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">agent2.sources = s2</div><div class="line">agent2.channels = ch2</div><div class="line">agent2.sinks = sk2</div><div class="line"></div><div class="line">agent2.sources.s2.channels = ch2</div><div class="line">agent2.sources.s2.type = avro</div><div class="line">agent2.sources.s2.bind = 10.10.1.23</div><div class="line">agent2.sources.s2.port = 44442</div><div class="line"></div><div class="line">agent2.channels.ch2.type = memory</div><div class="line">agent2.channels.ch2.capacity = 1000</div><div class="line">agent2.channels.ch2.transactionCapacity = 100</div><div class="line"></div><div class="line">agent2.sinks.sk2.channel = ch2</div><div class="line">agent2.sinks.sk2.type = logger</div></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>如果是多台机器实验，Collector1和Collector2的flume.conf配置其实可以是一样的，只是我这里使用的本机测试，所以需要指定不同的port来模拟2台不同的机器，flume.conf配置文件也分开了。</li>
</ul>
<h5 id="启动Flume"><a href="#启动Flume" class="headerlink" title="启动Flume"></a>启动Flume</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 启动采集端，AgentX</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_failover_agent.conf -Dflume.root.logger=DEBUG,console -n agentX</div><div class="line"></div><div class="line"># 启动2个Collect端，Collector1和Collector2</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_failover_collector1.conf -Dflume.root.logger=DEBUG,console -n agent1</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_failover_collector2.conf -Dflume.root.logger=DEBUG,console -n agent2</div></pre></td></tr></table></figure>
<p>这时候我们发现采集的日志都在Agent1中的控制台输出，Agent2并没有日志输出。但是我们查看44441和44442端口号发现AgentX和Agent1，Agent2都保持TCP连接的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep flume</div><div class="line">  501  8446  6602   0  5:45PM ttys000    0:01.02 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_2/conf:/Users/yunyu/dev/flume-1.6.0_agent_2/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_failover_collector2.conf -n agent2</div><div class="line">  501  8455  4754   0  5:45PM ttys001    0:01.21 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_failover_agent.conf -n agentX</div><div class="line">  501  8436  5574   0  5:45PM ttys003    0:01.28 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_1/conf:/Users/yunyu/dev/flume-1.6.0_agent_1/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_failover_collector1.conf -n agent1</div><div class="line">  501  8466  5608   0  5:45PM ttys005    0:00.00 grep flume</div><div class="line"></div><div class="line">$ lsof -i:44441</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    8436 yunyu  156u  IPv6 0xd0e0ada8bdad6435      0t0  TCP localhost:44441 (LISTEN)</div><div class="line">java    8436 yunyu  161u  IPv6 0xd0e0ada8c2f7d3d5      0t0  TCP localhost:44441-&gt;localhost:52471 (ESTABLISHED)</div><div class="line">java    8455 yunyu  210u  IPv6 0xd0e0ada8c3175955      0t0  TCP localhost:52471-&gt;localhost:44441 (ESTABLISHED)</div><div class="line"></div><div class="line">$ lsof -i:44442</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    8446 yunyu  156u  IPv6 0xd0e0ada8e3f0b3f5      0t0  TCP localhost:44442 (LISTEN)</div><div class="line">java    8446 yunyu  161u  IPv6 0xd0e0ada8bdad43f5      0t0  TCP localhost:44442-&gt;localhost:52470 (ESTABLISHED)</div><div class="line">java    8455 yunyu  156u  IPv6 0xd0e0ada8c3152955      0t0  TCP localhost:52470-&gt;localhost:44442 (ESTABLISHED)</div></pre></td></tr></table></figure>
<p>此时我们杀掉Agent1的进程，我们会看到AgentX的控制台会报错提示：Connection Refused无法连接到Agent1。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># flume Collector1的进程已经没有了</div><div class="line">$ ps -ef | grep flume</div><div class="line">  501  8446  6602   0  5:45PM ttys000    0:05.13 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_2/conf:/Users/yunyu/dev/flume-1.6.0_agent_2/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_failover_collector2.conf -n agent2</div><div class="line">  501  8455  4754   0  5:45PM ttys001    0:07.85 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_failover_agent.conf -n agentX</div><div class="line">  501  8732  5608   0  6:08PM ttys005    0:00.00 grep flume</div><div class="line"></div><div class="line"># 再次查看44441端口发现TCP连接已经断开了</div><div class="line">$ lsof -i:44441</div></pre></td></tr></table></figure>
<p>这个时候我们再有日志采集会发现日志都输出到Collector2的控制台了，说明我们的failover机制生效了。</p>
<h3 id="LoadBalance模式"><a href="#LoadBalance模式" class="headerlink" title="LoadBalance模式"></a>LoadBalance模式</h3><p>同Failover一样，AgentX是采集端，分别写入Sink1和Sink2，Collector1和Collector2是Collect端。此架构支持负载均衡分发处理，需要在采集层（AgentX）每一个Sink同时指向Collect层的2个相同的Flume Agent（Collector1和Collector2）。所以使用loadBalance架构就是为了流量分发，防止流量过于集中到其中某些机器导致服务器负载不均衡或者过载。</p>
<h5 id="Agent节点的flume-loadbalance-agent-conf配置"><a href="#Agent节点的flume-loadbalance-agent-conf配置" class="headerlink" title="Agent节点的flume_loadbalance_agent.conf配置"></a>Agent节点的flume_loadbalance_agent.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">agentX.sources = sX</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = sk1 sk2</div><div class="line"></div><div class="line">agentX.sources.sX.channels = chX</div><div class="line">agentX.sources.sX.type = exec</div><div class="line">agentX.sources.sX.command = tail -F /Users/yunyu/Downloads/command.log</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line"># Configure sinks</div><div class="line">agentX.sinks.sk1.channel = chX</div><div class="line">agentX.sinks.sk1.type = avro</div><div class="line">agentX.sinks.sk1.hostname = 10.10.1.46</div><div class="line">agentX.sinks.sk1.port = 44441</div><div class="line"></div><div class="line">agentX.sinks.sk2.channel = chX</div><div class="line">agentX.sinks.sk2.type = avro</div><div class="line">agentX.sinks.sk2.hostname = 10.10.1.46</div><div class="line">agentX.sinks.sk2.port = 44442</div><div class="line"></div><div class="line"># Configure loadbalance</div><div class="line">agentX.sinkgroups = g1</div><div class="line">agentX.sinkgroups.g1.sinks = sk1 sk2</div><div class="line">agentX.sinkgroups.g1.processor.type = load_balance</div><div class="line">agentX.sinkgroups.g1.processor.backoff=true</div><div class="line">agentX.sinkgroups.g1.processor.selector=round_robin</div></pre></td></tr></table></figure>
<h5 id="Collector1节点的flume-loadbalance-collector1-conf配置"><a href="#Collector1节点的flume-loadbalance-collector1-conf配置" class="headerlink" title="Collector1节点的flume_loadbalance_collector1.conf配置"></a>Collector1节点的flume_loadbalance_collector1.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">agent1.sources = s1</div><div class="line">agent1.channels = ch1</div><div class="line">agent1.sinks = sk1</div><div class="line"></div><div class="line">agent1.sources.s1.channels = ch1</div><div class="line">agent1.sources.s1.type = avro</div><div class="line">agent1.sources.s1.bind = 10.10.1.46</div><div class="line">agent1.sources.s1.port = 44441</div><div class="line"></div><div class="line">agent1.channels.ch1.type = memory</div><div class="line">agent1.channels.ch1.capacity = 1000</div><div class="line">agent1.channels.ch1.transactionCapacity = 100</div><div class="line"></div><div class="line">agent1.sinks.sk1.channel = ch1</div><div class="line">agent1.sinks.sk1.type = logger</div></pre></td></tr></table></figure>
<h5 id="Collector2节点的flume-loadbalance-collector2-conf配置"><a href="#Collector2节点的flume-loadbalance-collector2-conf配置" class="headerlink" title="Collector2节点的flume_loadbalance_collector2.conf配置"></a>Collector2节点的flume_loadbalance_collector2.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">agent2.sources = s2</div><div class="line">agent2.channels = ch2</div><div class="line">agent2.sinks = sk2</div><div class="line"></div><div class="line">agent2.sources.s2.channels = ch2</div><div class="line">agent2.sources.s2.type = avro</div><div class="line">agent2.sources.s2.bind = 10.10.1.23</div><div class="line">agent2.sources.s2.port = 44442</div><div class="line"></div><div class="line">agent2.channels.ch2.type = memory</div><div class="line">agent2.channels.ch2.capacity = 1000</div><div class="line">agent2.channels.ch2.transactionCapacity = 100</div><div class="line"></div><div class="line">agent2.sinks.sk2.channel = ch2</div><div class="line">agent2.sinks.sk2.type = logger</div></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>如果是多台机器实验，Collector1和Collector2的flume.conf配置其实可以是一样的，只是我这里使用的本机测试，所以需要指定不同的port来模拟2台不同的机器，flume.conf配置文件也分开了。</li>
</ul>
<h5 id="启动Flume-1"><a href="#启动Flume-1" class="headerlink" title="启动Flume"></a>启动Flume</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 启动采集端，AgentX</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_loadbalance_agent.conf -Dflume.root.logger=DEBUG,console -n agentX</div><div class="line"></div><div class="line"># 启动2个Collect端，Collector1和Collector2</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_loadbalance_collector1.conf -Dflume.root.logger=DEBUG,console -n agent1</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_loadbalance_collector2.conf -Dflume.root.logger=DEBUG,console -n agent2</div></pre></td></tr></table></figure>
<p>这个时候只要我们不断有日志采集会发现日志会分别输出到Collector1和Collector2的控制台了，说明我们的loadbalance机制生效了。</p>
<p>最后给出别人博客总结的三种模式的对比图，看完就非常清晰明了了</p>
<p><img src="http://img.blog.csdn.net/20160923160614674?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Default"></p>
<p><img src="http://img.blog.csdn.net/20160923160704878?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Failover"></p>
<p><img src="http://img.blog.csdn.net/20160923160718087?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="LoadBalance"></p>
<p>参考文章：</p>
<ul>
<li><a href="http://shiyanjun.cn/archives/1497.html" target="_blank" rel="external">http://shiyanjun.cn/archives/1497.html</a></li>
<li><a href="http://tech.meituan.com/mt-log-system-arch.html" target="_blank" rel="external">http://tech.meituan.com/mt-log-system-arch.html</a></li>
<li><a href="http://www.cnblogs.com/lishouguang/p/4558790.html" target="_blank" rel="external">http://www.cnblogs.com/lishouguang/p/4558790.html</a></li>
<li><a href="http://blog.csdn.net/qianshangding0708/article/details/49300427" target="_blank" rel="external">http://blog.csdn.net/qianshangding0708/article/details/49300427</a></li>
<li><a href="http://www.aboutyun.com/blog-70-465.html" target="_blank" rel="external">http://www.aboutyun.com/blog-70-465.html</a></li>
<li><a href="http://jinnianshilongnian.iteye.com/blog/2261225" target="_blank" rel="external">http://jinnianshilongnian.iteye.com/blog/2261225</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（三）Flume多个Agent架构" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/24/Flume/Flume学习（三）Flume多个Agent架构/" class="article-date">
  	<time datetime="2016-08-24T13:48:19.000Z" itemprop="datePublished">2016-08-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/24/Flume/Flume学习（三）Flume多个Agent架构/">Flume学习（三）Flume多个Agent实例</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="多个Agent的数据汇聚到同一个Agent"><a href="#多个Agent的数据汇聚到同一个Agent" class="headerlink" title="多个Agent的数据汇聚到同一个Agent"></a>多个Agent的数据汇聚到同一个Agent</h5><p><img src="http://7xnrdo.com1.z0.glb.clouddn.com/2014/flume-join-agent.png" alt="多个Agent的数据汇聚到同一个Agent"></p>
<p>我这里是用本机模拟此架构，三个日志收集Flume Agent节点和一个日志Flume Collector节点</p>
<h5 id="Agent1节点的flume-conf配置"><a href="#Agent1节点的flume-conf配置" class="headerlink" title="Agent1节点的flume.conf配置"></a>Agent1节点的flume.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">agent1.sources = system-logfile-source</div><div class="line">agent1.channels = ch1</div><div class="line">agent1.sinks = flume-avro-sink</div><div class="line"></div><div class="line"># 这里收集的是/var/log/system.log日志文件</div><div class="line">agent1.sources.system-logfile-source.channels = ch1</div><div class="line">agent1.sources.system-logfile-source.type = exec</div><div class="line">agent1.sources.system-logfile-source.command = tail -F /var/log/system.log</div><div class="line"></div><div class="line">agent1.channels.ch1.type = memory</div><div class="line">agent1.channels.ch1.capacity = 1000</div><div class="line">agent1.channels.ch1.transactionCapacity = 100</div><div class="line"></div><div class="line"># Agent1设置sink的hostname是10.10.1.23（我本机的IP地址），也就是该Agent要向10.10.1.23主机发送数据</div><div class="line">agent1.sinks.flume-avro-sink.channel = ch1</div><div class="line">agent1.sinks.flume-avro-sink.type = avro</div><div class="line">agent1.sinks.flume-avro-sink.hostname = 10.10.1.23</div><div class="line">agent1.sinks.flume-avro-sink.port = 41414</div></pre></td></tr></table></figure>
<h5 id="Agent2节点的flume-conf配置"><a href="#Agent2节点的flume-conf配置" class="headerlink" title="Agent2节点的flume.conf配置"></a>Agent2节点的flume.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">agent2.sources = install-logfile-source</div><div class="line">agent2.channels = ch2</div><div class="line">agent2.sinks = flume-avro-sink</div><div class="line"></div><div class="line"># 这里收集的是/var/log/install.log日志文件</div><div class="line">agent2.sources.install-logfile-source.channels = ch2</div><div class="line">agent2.sources.install-logfile-source.type = exec</div><div class="line">agent2.sources.install-logfile-source.command = tail -F /var/log/install.log</div><div class="line"></div><div class="line">agent2.channels.ch2.type = memory</div><div class="line">agent2.channels.ch2.capacity = 1000</div><div class="line">agent2.channels.ch2.transactionCapacity = 100</div><div class="line"></div><div class="line"># Agent2设置sink的hostname是10.10.1.23（我本机的IP地址），也就是该Agent要向10.10.1.23主机发送数据</div><div class="line">agent2.sinks.flume-avro-sink.channel = ch2</div><div class="line">agent2.sinks.flume-avro-sink.type = avro</div><div class="line">agent2.sinks.flume-avro-sink.hostname = 10.10.1.23</div><div class="line">agent2.sinks.flume-avro-sink.port = 41414</div></pre></td></tr></table></figure>
<h5 id="Agent3节点的flume-conf配置"><a href="#Agent3节点的flume-conf配置" class="headerlink" title="Agent3节点的flume.conf配置"></a>Agent3节点的flume.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">agent3.sources = command-logfile-source</div><div class="line">agent3.channels = ch3</div><div class="line">agent3.sinks = flume-avro-sink</div><div class="line"></div><div class="line"># 这里收集的是/Users/yunyu/Downloads/command.log日志文件，这个日志文件是我自己定义的（请根据自己的实际环境配置相应的log日志文件）</div><div class="line">agent3.sources.command-logfile-source.channels = ch3</div><div class="line">agent3.sources.command-logfile-source.type = exec</div><div class="line">agent3.sources.command-logfile-source.command = tail -F /Users/yunyu/Downloads/command.log</div><div class="line"></div><div class="line">agent3.channels.ch3.type = memory</div><div class="line">agent3.channels.ch3.capacity = 1000</div><div class="line">agent3.channels.ch3.transactionCapacity = 100</div><div class="line"></div><div class="line"># Agent3设置sink的hostname是10.10.1.23（我本机的IP地址），也就是该Agent要向10.10.1.23主机发送数据</div><div class="line">agent3.sinks.flume-avro-sink.channel = ch3</div><div class="line">agent3.sinks.flume-avro-sink.type = avro</div><div class="line">agent3.sinks.flume-avro-sink.hostname = 10.10.1.23</div><div class="line">agent3.sinks.flume-avro-sink.port = 41414</div></pre></td></tr></table></figure>
<h5 id="Collector节点的flume-collect-conf配置"><a href="#Collector节点的flume-collect-conf配置" class="headerlink" title="Collector节点的flume_collect.conf配置"></a>Collector节点的flume_collect.conf配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">agentX.sources = flume-avro-sink</div><div class="line">agentX.channels = chX</div><div class="line">agentX.sinks = flume-collect-sink</div><div class="line"></div><div class="line"># 监听的IP地址是10.10.1.23。三个Agent节点的sinks的传输协议类型要和Collector节点的sources的传输协议类型一致，这里传输协议都是avro。</div><div class="line">agentX.sources.flume-avro-sink.channels = chX</div><div class="line">agentX.sources.flume-avro-sink.type = avro</div><div class="line">agentX.sources.flume-avro-sink.bind = 10.10.1.23</div><div class="line">agentX.sources.flume-avro-sink.port = 41414</div><div class="line">agentX.sources.flume-avro-sink.threads = 8</div><div class="line"></div><div class="line">agentX.channels.chX.type = memory</div><div class="line">agentX.channels.chX.capacity = 1000</div><div class="line">agentX.channels.chX.transactionCapacity = 100</div><div class="line"></div><div class="line"># 这里是将接收到的数据，以文件的形式存储起来，保存路径是/Users/yunyu/Downloads/sinkout/</div><div class="line">agentX.sinks.flume-collect-sink.channel = chX</div><div class="line">agentX.sinks.flume-collect-sink.type = file_roll</div><div class="line">agentX.sinks.flume-collect-sink.batchSize = 100</div><div class="line">agentX.sinks.flume-collect-sink.serializer = TEXT</div><div class="line">agentX.sinks.flume-collect-sink.sink.directory = /Users/yunyu/Downloads/sinkout/</div></pre></td></tr></table></figure>
<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><p>这里需要注意一下sources和sinks的配置，我们在三个Agent节点都指定了sinks的hostname=10.10.1.23，但是Collector节点指定的sources的bind=10.10.1.23，这两个参数需要注意下，我开始的时候就配置错了，在sinks使用的bind=10.10.1.23，而没有使用hostname参数，Flume启动的时候就会提示”java.lang.IllegalStateException: No hostname specified”这个错误，后来查了一下官网的配置，发现是我自己把sources和sinks的绑定主机的参数搞混了</p>
<ul>
<li>sources使用的是bind（意思是监听主机）</li>
<li>sinks使用的是hostname（意思是传输数据的主机）</li>
</ul>
<h5 id="分别启动Collector和三个Agent节点"><a href="#分别启动Collector和三个Agent节点" class="headerlink" title="分别启动Collector和三个Agent节点"></a>分别启动Collector和三个Agent节点</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 最好先启动Collector</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume_collect.conf -Dflume.root.logger=DEBUG,console -n agentX</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume.conf -Dflume.root.logger=DEBUG,console -n agent1</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume.conf -Dflume.root.logger=DEBUG,console -n agent2</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume.conf -Dflume.root.logger=DEBUG,console -n agent3</div></pre></td></tr></table></figure>
<h5 id="启动三个Agent节点分别会看到如下输出信息"><a href="#启动三个Agent节点分别会看到如下输出信息" class="headerlink" title="启动三个Agent节点分别会看到如下输出信息"></a>启动三个Agent节点分别会看到如下输出信息</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2016-08-24 15:35:31,144 (New I/O server boss #1 ([id: 0x0c4ee010, /10.10.1.23:41414])) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xad3b4304, /10.10.1.23:50791 =&gt; /10.10.1.23:41414] OPEN</div><div class="line">2016-08-24 15:35:31,146 (New I/O  worker #1) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xad3b4304, /10.10.1.23:50791 =&gt; /10.10.1.23:41414] BOUND: /10.10.1.23:41414</div><div class="line">2016-08-24 15:35:31,146 (New I/O  worker #1) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xad3b4304, /10.10.1.23:50791 =&gt; /10.10.1.23:41414] CONNECTED: /10.10.1.23:50791</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2016-08-24 15:36:03,623 (New I/O server boss #1 ([id: 0x0c4ee010, /10.10.1.23:41414])) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xdda0a0fd, /10.10.1.23:50797 =&gt; /10.10.1.23:41414] OPEN</div><div class="line">2016-08-24 15:36:03,623 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xdda0a0fd, /10.10.1.23:50797 =&gt; /10.10.1.23:41414] BOUND: /10.10.1.23:41414</div><div class="line">2016-08-24 15:36:03,623 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0xdda0a0fd, /10.10.1.23:50797 =&gt; /10.10.1.23:41414] CONNECTED: /10.10.1.23:50797</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2016-08-24 15:38:27,270 (New I/O server boss #1 ([id: 0x0c4ee010, /10.10.1.23:41414])) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x909310e6, /10.10.1.23:50822 =&gt; /10.10.1.23:41414] OPEN</div><div class="line">2016-08-24 15:38:27,270 (New I/O  worker #3) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x909310e6, /10.10.1.23:50822 =&gt; /10.10.1.23:41414] BOUND: /10.10.1.23:41414</div><div class="line">2016-08-24 15:38:27,271 (New I/O  worker #3) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x909310e6, /10.10.1.23:50822 =&gt; /10.10.1.23:41414] CONNECTED: /10.10.1.23:50822</div></pre></td></tr></table></figure>
<p>我们会看到每个Agent实际上是启动了一个NettyServer进行通信，三个Agent的启动log都会在本机IP：10.10.1.23上开启一个端口号与Collector的端口号41414进行通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">10.10.1.23:50791 =&gt; /10.10.1.23:41414</div><div class="line">10.10.1.23:50797 =&gt; /10.10.1.23:41414</div><div class="line">10.10.1.23:50822 =&gt; /10.10.1.23:41414</div></pre></td></tr></table></figure>
<p>我们在分别查询一下当前flume的所有进程和上面对应的三个端口号，会发现50791, 50797, 50822这三个端口号正如上面所说的是Agent1 -&gt; AgentX, Agent2 -&gt; AgentX, Agent3 -&gt; AgentX的通信端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ ps -ef | grep flume</div><div class="line">  501  7824  6602   0  3:36PM ttys000    0:02.20 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_2/conf:/Users/yunyu/dev/flume-1.6.0_agent_2/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume.conf -n agent2</div><div class="line">  501  7804  4754   0  3:35PM ttys001    0:01.96 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume_collect.conf -n agentX</div><div class="line">  501  7921  7903   0  3:39PM ttys002    0:00.00 grep flume</div><div class="line">  501  7814  5574   0  3:35PM ttys003    0:02.57 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_1/conf:/Users/yunyu/dev/flume-1.6.0_agent_1/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume.conf -n agent1</div><div class="line">  501  7886  5608   0  3:38PM ttys005    0:01.58 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0_agent_3/conf:/Users/yunyu/dev/flume-1.6.0_agent_3/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume.conf -n agent3</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ lsof -i:50791</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    7804 yunyu  162u  IPv6 0xd0e0ada8bdad6435      0t0  TCP localhost:41414-&gt;localhost:50791 (ESTABLISHED)</div><div class="line">java    7814 yunyu  156u  IPv6 0xd0e0ada8c2f7e955      0t0  TCP localhost:50791-&gt;localhost:41414 (ESTABLISHED)</div><div class="line"></div><div class="line">$ lsof -i:50797</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    7804 yunyu  164u  IPv6 0xd0e0ada8bdad43f5      0t0  TCP localhost:41414-&gt;localhost:50797 (ESTABLISHED)</div><div class="line">java    7824 yunyu  156u  IPv6 0xd0e0ada8c3152955      0t0  TCP localhost:50797-&gt;localhost:41414 (ESTABLISHED)</div><div class="line"></div><div class="line">$ lsof -i:50822</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    7804 yunyu  165u  IPv6 0xd0e0ada8c3175955      0t0  TCP localhost:41414-&gt;localhost:50822 (ESTABLISHED)</div><div class="line">java    7886 yunyu  156u  IPv6 0xd0e0ada8c3175eb5      0t0  TCP localhost:50822-&gt;localhost:41414 (ESTABLISHED)</div></pre></td></tr></table></figure>
<h5 id="验证结果"><a href="#验证结果" class="headerlink" title="验证结果"></a>验证结果</h5><p>这时候我们只要在system.log, install.log, command.log中产生任何日志，都会输出对应的日志文件到/Users/yunyu/Downloads/sinkout/路径</p>
<p>参考文章：</p>
<ul>
<li><a href="http://shiyanjun.cn/archives/915.html" target="_blank" rel="external">http://shiyanjun.cn/archives/915.html</a></li>
<li><a href="http://blog.javachen.com/2014/07/22/flume-ng.html" target="_blank" rel="external">http://blog.javachen.com/2014/07/22/flume-ng.html</a></li>
<li><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="external">http://flume.apache.org/FlumeUserGuide.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（二）Flume架构分析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/24/Flume/Flume学习（二）Flume架构分析/" class="article-date">
  	<time datetime="2016-08-24T06:14:59.000Z" itemprop="datePublished">2016-08-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/24/Flume/Flume学习（二）Flume架构分析/">Flume学习（二）Flume架构分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Flume-NG架构"><a href="#Flume-NG架构" class="headerlink" title="Flume NG架构"></a>Flume NG架构</h4><h5 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h5><p><img src="http://flume.apache.org/_images/UserGuide_image00.png" alt="基础架构"></p>
<h5 id="多个Agent顺序连接"><a href="#多个Agent顺序连接" class="headerlink" title="多个Agent顺序连接"></a>多个Agent顺序连接</h5><p>可以将多个Agent顺序连接起来，将最初的数据源经过收集，存储到最终的存储系统中。这是最简单的情况，一般情况下，应该控制这种顺序连接的Agent的数量，因为数据流经的路径变长了，如果不考虑failover的话，出现故障将影响整个Flow上的Agent收集服务。</p>
<p><img src="http://7xnrdo.com1.z0.glb.clouddn.com/2014/flume-multiseq-agents.png" alt="多个Agent顺序连接"></p>
<h5 id="多个Agent的数据汇聚到同一个Agent"><a href="#多个Agent的数据汇聚到同一个Agent" class="headerlink" title="多个Agent的数据汇聚到同一个Agent"></a>多个Agent的数据汇聚到同一个Agent</h5><p>这种情况应用的场景比较多，比如要收集Web网站的用户行为日志，Web网站为了可用性使用的负载均衡的集群模式，每个节点都产生用户行为日志，可以为每个节点都配置一个Agent来单独收集日志数据，然后多个Agent将数据最终汇聚到一个用来存储数据存储系统，如HDFS上。</p>
<p><img src="http://7xnrdo.com1.z0.glb.clouddn.com/2014/flume-join-agent.png" alt="多个Agent的数据汇聚到同一个Agent"></p>
<h5 id="多路（Multiplexing）Agent"><a href="#多路（Multiplexing）Agent" class="headerlink" title="多路（Multiplexing）Agent"></a>多路（Multiplexing）Agent</h5><p>这种模式，有两种方式，一种是用来复制（Replication），另一种是用来分流（Multiplexing）。Replication方式，可以将最前端的数据源复制多份，分别传递到多个channel中，每个channel接收到的数据都是相同的，配置格式，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># List the sources, sinks and channels for the agent</div><div class="line">&lt;Agent&gt;.sources = &lt;Source1&gt;</div><div class="line">&lt;Agent&gt;.sinks = &lt;Sink1&gt; &lt;Sink2&gt;</div><div class="line">&lt;Agent&gt;.channels = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line"></div><div class="line"># set list of channels for source (separated by space)</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.channels = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line"></div><div class="line"># set channel for sinks</div><div class="line">&lt;Agent&gt;.sinks.&lt;Sink1&gt;.channel = &lt;Channel1&gt;</div><div class="line">&lt;Agent&gt;.sinks.&lt;Sink2&gt;.channel = &lt;Channel2&gt;</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.type = replicating</div></pre></td></tr></table></figure>
<p>上面指定了selector的type的值为replication，其他的配置没有指定，使用的Replication方式，Source1会将数据分别存储到Channel1和Channel2，这两个channel里面存储的数据是相同的，然后数据被传递到Sink1和Sink2。<br>Multiplexing方式，selector可以根据header的值来确定数据传递到哪一个channel，配置格式，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># Mapping for multiplexing selector</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.type = multiplexing</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.header = &lt;someHeader&gt;</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.mapping.&lt;Value1&gt; = &lt;Channel1&gt;</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.mapping.&lt;Value2&gt; = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.mapping.&lt;Value3&gt; = &lt;Channel2&gt;</div><div class="line"></div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.selector.default = &lt;Channel2&gt;</div></pre></td></tr></table></figure>
<p>上面selector的type的值为multiplexing，同时配置selector的header信息，还配置了多个selector的mapping的值，即header的值：如果header的值为Value1、Value2，数据从Source1路由到Channel1；如果header的值为Value2、Value3，数据从Source1路由到Channel2。</p>
<p><img src="http://7xnrdo.com1.z0.glb.clouddn.com/2014/flume-multiplexing-agent.png" alt="多路（Multiplexing）Agent"></p>
<h5 id="实现load-balance功能"><a href="#实现load-balance功能" class="headerlink" title="实现load balance功能"></a>实现load balance功能</h5><p>Load balancing Sink Processor能够实现load balance功能，下图Agent1是一个路由节点，负责将Channel暂存的Event均衡到对应的多个Sink组件上，而每个Sink组件分别连接到一个独立的Agent上，示例配置，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">a1.sinkgroups = g1</div><div class="line">a1.sinkgroups.g1.sinks = k1 k2 k3</div><div class="line">a1.sinkgroups.g1.processor.type = load_balance</div><div class="line">a1.sinkgroups.g1.processor.backoff = true</div><div class="line">a1.sinkgroups.g1.processor.selector = round_robin</div><div class="line">a1.sinkgroups.g1.processor.selector.maxTimeOut=10000</div></pre></td></tr></table></figure>
<p><img src="http://7xnrdo.com1.z0.glb.clouddn.com/2014/flume-load-balance-agents.png" alt="实现load balance功能"></p>
<h5 id="实现failover功能"><a href="#实现failover功能" class="headerlink" title="实现failover功能"></a>实现failover功能</h5><p>Failover Sink Processor能够实现failover功能，具体流程类似load balance，但是内部处理机制与load balance完全不同：Failover Sink Processor维护一个优先级Sink组件列表，只要有一个Sink组件可用，Event就被传递到下一个组件。如果一个Sink能够成功处理Event，则会加入到一个Pool中，否则会被移出Pool并计算失败次数，设置一个惩罚因子，示例配置如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">a1.sinkgroups = g1</div><div class="line">a1.sinkgroups.g1.sinks = k1 k2 k3</div><div class="line">a1.sinkgroups.g1.processor.type = failover</div><div class="line">a1.sinkgroups.g1.processor.priority.k1 = 5</div><div class="line">a1.sinkgroups.g1.processor.priority.k2 = 7</div><div class="line">a1.sinkgroups.g1.processor.priority.k3 = 6</div><div class="line">a1.sinkgroups.g1.processor.maxpenalty = 20000</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://shiyanjun.cn/archives/915.html" target="_blank" rel="external">http://shiyanjun.cn/archives/915.html</a></li>
<li><a href="http://blog.javachen.com/2014/07/22/flume-ng.html" target="_blank" rel="external">http://blog.javachen.com/2014/07/22/flume-ng.html</a></li>
<li><a href="http://flume.apache.org/FlumeUserGuide.html" target="_blank" rel="external">http://flume.apache.org/FlumeUserGuide.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Flume/Flume学习（一）Flume环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/23/Flume/Flume学习（一）Flume环境搭建/" class="article-date">
  	<time datetime="2016-08-23T06:21:09.000Z" itemprop="datePublished">2016-08-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/23/Flume/Flume学习（一）Flume环境搭建/">Flume学习（一）Flume环境搭建</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="Flume安装"><a href="#Flume安装" class="headerlink" title="Flume安装"></a>Flume安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ wget http://apache.fayea.com/flume/1.6.0/apache-flume-1.6.0-bin.tar.gz</div><div class="line">$ tar -xvf apache-flume-1.6.0-bin.tar</div><div class="line">$ mv apache-flume-1.6.0-bin flume-1.6.0</div><div class="line">$ cd flume-1.6.0</div><div class="line"></div><div class="line"># 修改flume配置文件</div><div class="line">$ cp conf/flume-conf.properties.template conf/flume.conf</div><div class="line">$ cp conf/flume-env.sh.template conf/flume-env.sh</div></pre></td></tr></table></figure>
<h4 id="Flume组件介绍"><a href="#Flume组件介绍" class="headerlink" title="Flume组件介绍"></a>Flume组件介绍</h4><ul>
<li>Event：一个数据单元，带有一个可选的消息头</li>
<li>Flow：Event从源点到达目的点的迁移的抽象</li>
<li>Client：操作位于源点处的Event，将其发送到Flume Agent（下面介绍的AvroClient用法）</li>
<li>Agent：一个独立的Flume进程，包含组件Source、Channel、Sink</li>
<li>Source：用来消费传递到该组件的Event（从数据源获取生成event data）</li>
<li>Channel：中转Event的一个临时存储，保存有Source组件传递过来的Event（接收source给put来的event data）</li>
<li>Sink：从Channel中读取并移除Event（从channel取走event data），将Event传递到Flow Pipeline中的下一个Agent（如果有的话）</li>
</ul>
<p><img src="http://flume.apache.org/_images/UserGuide_image00.png" alt="Flume组件图"></p>
<ul>
<li>参考下面的图比较容易理解AvroClient和Flume Agent的关系</li>
</ul>
<p><img src="https://blogs.apache.org/flume/mediaresource/ab0d50f6-a960-42cc-971e-3da38ba3adad" alt="Flume Client"></p>
<h4 id="Flume配置文件格式"><a href="#Flume配置文件格式" class="headerlink" title="Flume配置文件格式"></a>Flume配置文件格式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># list the sources, sinks and channels for the agent</div><div class="line">&lt;Agent&gt;.sources = &lt;Source1&gt; &lt;Source2&gt;</div><div class="line">&lt;Agent&gt;.sinks = &lt;Sink1&gt; &lt;Sink2&gt;</div><div class="line">&lt;Agent&gt;.channels = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line"></div><div class="line"># set channel for source</div><div class="line">&lt;Agent&gt;.sources.&lt;Source1&gt;.channels = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line">&lt;Agent&gt;.sources.&lt;Source2&gt;.channels = &lt;Channel1&gt; &lt;Channel2&gt;</div><div class="line"></div><div class="line"># set channel</div><div class="line">&lt;Agent&gt;.channels.&lt;Channel1&gt;.XXX = XXX</div><div class="line">&lt;Agent&gt;.channels.&lt;Channel2&gt;.XXX = XXX</div><div class="line"></div><div class="line"># set channel for sink</div><div class="line">&lt;Agent&gt;.sinks.&lt;Sink1&gt;.channel = &lt;Channel1&gt;</div><div class="line">&lt;Agent&gt;.sinks.&lt;Sink2&gt;.channel = &lt;Channel2&gt;</div></pre></td></tr></table></figure>
<h4 id="Flume配置文件"><a href="#Flume配置文件" class="headerlink" title="Flume配置文件"></a>Flume配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># 这里对比上面的Flume组件图来看此配置信息就比较容易理解了</div><div class="line"># 定义当前Agent的所有的组件（sources,channels,sinks），Flume这里的组件和Logstash的input，filter，output非常类似</div><div class="line">agent1.sources = avro-source1</div><div class="line">agent1.channels = ch1</div><div class="line">agent1.sinks = log-sink1</div><div class="line"></div><div class="line"># 定义sources组件的具体配置</div><div class="line"># 设置source的目标是哪个channel</div><div class="line">agent1.sources.avro-source1.channels = ch1</div><div class="line"># 设置source的输入信息类型，表示该source接收的数据协议为avro（也就是说resource要通过avro-cliet向其发送数据）</div><div class="line">agent1.sources.avro-source1.type = avro</div><div class="line"># 设置source的监听主机的IP地址，或者hostname</div><div class="line"># 这里我使用的是本机IP：10.10.1.23，如果是本机测试也可以使用localhost</div><div class="line">agent1.sources.avro-source1.bind = 10.10.1.23</div><div class="line"># 设置source的监听主机的port</div><div class="line">agent1.sources.avro-source1.port = 41414</div><div class="line"></div><div class="line"># 定义channels组件的具体配置</div><div class="line"># 设置Channel的类型</div><div class="line">agent1.channels.ch1.type = memory</div><div class="line"></div><div class="line"># 定义sinks组件的具体配置</div><div class="line"># 设置sink的来源于哪个channel</div><div class="line">agent1.sinks.log-sink1.channel = ch1</div><div class="line"># 设置sink的输出信息类型，将数据输出至Flume的日志中(也就是打印在屏幕上)</div><div class="line">agent1.sinks.log-sink1.type = logger</div></pre></td></tr></table></figure>
<p>Avro协议参考：</p>
<ul>
<li><a href="http://langyu.iteye.com/blog/708568" target="_blank" rel="external">http://langyu.iteye.com/blog/708568</a></li>
</ul>
<h4 id="启动Flume-Agent端"><a href="#启动Flume-Agent端" class="headerlink" title="启动Flume Agent端"></a>启动Flume Agent端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"># 这里指定的agent1名称必须和flume.conf配置文件中的agent名称一致</div><div class="line"># 这里的启动命令是./bin/flume-ng agent，开始监听41414端口</div><div class="line">$ ./bin/flume-ng agent --conf ./conf/ -f conf/flume.conf -Dflume.root.logger=DEBUG,console -n agent1</div><div class="line"></div><div class="line">+ exec /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp &apos;/Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/*&apos; -Djava.library.path= org.apache.flume.node.Application -f conf/flume.conf -n agent1</div><div class="line">2016-08-24 10:15:05,547 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.node.PollingPropertiesFileConfigurationProvider.start(PollingPropertiesFileConfigurationProvider.java:61)] Configuration provider starting</div><div class="line">2016-08-24 10:15:05,551 (lifecycleSupervisor-1-0) [DEBUG - org.apache.flume.node.PollingPropertiesFileConfigurationProvider.start(PollingPropertiesFileConfigurationProvider.java:78)] Configuration provider started</div><div class="line">2016-08-24 10:15:05,553 (conf-file-poller-0) [DEBUG - org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherRunnable.run(PollingPropertiesFileConfigurationProvider.java:126)] Checking file:conf/flume.conf for changes</div><div class="line">2016-08-24 10:15:05,555 (conf-file-poller-0) [INFO - org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherRunnable.run(PollingPropertiesFileConfigurationProvider.java:133)] Reloading configuration file:conf/flume.conf</div><div class="line">2016-08-24 10:15:05,559 (conf-file-poller-0) [INFO - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)] Processing:log-sink1</div><div class="line">2016-08-24 10:15:05,559 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1021)] Created context for log-sink1: type</div><div class="line">2016-08-24 10:15:05,560 (conf-file-poller-0) [INFO - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)] Processing:log-sink1</div><div class="line">2016-08-24 10:15:05,560 (conf-file-poller-0) [INFO - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:931)] Added sinks: log-sink1 Agent: agent1</div><div class="line">2016-08-24 10:15:05,563 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.isValid(FlumeConfiguration.java:314)] Starting validation of configuration for agent: agent1, initial-configuration: AgentConfiguration[agent1]</div><div class="line">SOURCES: &#123;avro-source1=&#123; parameters:&#123;port=41414, channels=ch1, type=avro, bind=10.10.1.23&#125; &#125;&#125;</div><div class="line">CHANNELS: &#123;ch1=&#123; parameters:&#123;type=memory&#125; &#125;&#125;</div><div class="line">SINKS: &#123;log-sink1=&#123; parameters:&#123;type=logger, channel=ch1&#125; &#125;&#125;</div><div class="line"></div><div class="line">2016-08-24 10:15:05,566 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.validateChannels(FlumeConfiguration.java:469)] Created channel ch1</div><div class="line">2016-08-24 10:15:05,573 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.validateSinks(FlumeConfiguration.java:675)] Creating sink: log-sink1 using LOGGER</div><div class="line">2016-08-24 10:15:05,574 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.isValid(FlumeConfiguration.java:372)] Post validation configuration for agent1</div><div class="line">AgentConfiguration created without Configuration stubs for which only basic syntactical validation was performed[agent1]</div><div class="line">SOURCES: &#123;avro-source1=&#123; parameters:&#123;port=41414, channels=ch1, type=avro, bind=10.10.1.23&#125; &#125;&#125;</div><div class="line">CHANNELS: &#123;ch1=&#123; parameters:&#123;type=memory&#125; &#125;&#125;</div><div class="line">AgentConfiguration created with Configuration stubs for which full validation was performed[agent1]</div><div class="line">SINKS: &#123;log-sink1=ComponentConfiguration[log-sink1]</div><div class="line">  CONFIG:</div><div class="line">    CHANNEL:ch1</div><div class="line">&#125;</div><div class="line"></div><div class="line">2016-08-24 10:15:05,574 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:136)] Channels:ch1</div><div class="line"></div><div class="line">2016-08-24 10:15:05,575 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:137)] Sinks log-sink1</div><div class="line"></div><div class="line">2016-08-24 10:15:05,575 (conf-file-poller-0) [DEBUG - org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:138)] Sources avro-source1</div><div class="line"></div><div class="line">2016-08-24 10:15:05,575 (conf-file-poller-0) [INFO - org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:141)] Post-validation flume configuration contains configuration for agents: [agent1]</div><div class="line">2016-08-24 10:15:05,577 (conf-file-poller-0) [INFO - org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:145)] Creating channels</div><div class="line">2016-08-24 10:15:05,584 (conf-file-poller-0) [INFO - org.apache.flume.channel.DefaultChannelFactory.create(DefaultChannelFactory.java:42)] Creating instance of channel ch1 type memory</div><div class="line">2016-08-24 10:15:05,591 (conf-file-poller-0) [INFO - org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:200)] Created channel ch1</div><div class="line">2016-08-24 10:15:05,592 (conf-file-poller-0) [INFO - org.apache.flume.source.DefaultSourceFactory.create(DefaultSourceFactory.java:41)] Creating instance of source avro-source1, type avro</div><div class="line">2016-08-24 10:15:05,610 (conf-file-poller-0) [INFO - org.apache.flume.sink.DefaultSinkFactory.create(DefaultSinkFactory.java:42)] Creating instance of sink: log-sink1, type: logger</div><div class="line">2016-08-24 10:15:05,614 (conf-file-poller-0) [INFO - org.apache.flume.node.AbstractConfigurationProvider.getConfiguration(AbstractConfigurationProvider.java:114)] Channel ch1 connected to [avro-source1, log-sink1]</div><div class="line">2016-08-24 10:15:05,623 (conf-file-poller-0) [INFO - org.apache.flume.node.Application.startAllComponents(Application.java:138)] Starting new configuration:&#123; sourceRunners:&#123;avro-source1=EventDrivenSourceRunner: &#123; source:Avro source avro-source1: &#123; bindAddress: 10.10.1.23, port: 41414 &#125; &#125;&#125; sinkRunners:&#123;log-sink1=SinkRunner: &#123; policy:org.apache.flume.sink.DefaultSinkProcessor@8ae0e27 counterGroup:&#123; name:null counters:&#123;&#125; &#125; &#125;&#125; channels:&#123;ch1=org.apache.flume.channel.MemoryChannel&#123;name: ch1&#125;&#125; &#125;</div><div class="line">2016-08-24 10:15:05,632 (conf-file-poller-0) [INFO - org.apache.flume.node.Application.startAllComponents(Application.java:145)] Starting Channel ch1</div><div class="line">2016-08-24 10:15:05,700 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:120)] Monitored counter group for type: CHANNEL, name: ch1: Successfully registered new MBean.</div><div class="line">2016-08-24 10:15:05,701 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:96)] Component type: CHANNEL, name: ch1 started</div><div class="line">2016-08-24 10:15:05,701 (conf-file-poller-0) [INFO - org.apache.flume.node.Application.startAllComponents(Application.java:173)] Starting Sink log-sink1</div><div class="line">2016-08-24 10:15:05,702 (conf-file-poller-0) [INFO - org.apache.flume.node.Application.startAllComponents(Application.java:184)] Starting Source avro-source1</div><div class="line">2016-08-24 10:15:05,702 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.source.AvroSource.start(AvroSource.java:228)] Starting Avro source avro-source1: &#123; bindAddress: 10.10.1.23, port: 41414 &#125;...</div><div class="line">2016-08-24 10:15:05,702 (SinkRunner-PollingRunner-DefaultSinkProcessor) [DEBUG - org.apache.flume.SinkRunner$PollingRunner.run(SinkRunner.java:143)] Polling sink runner starting</div><div class="line">2016-08-24 10:15:06,036 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:120)] Monitored counter group for type: SOURCE, name: avro-source1: Successfully registered new MBean.</div><div class="line">2016-08-24 10:15:06,036 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:96)] Component type: SOURCE, name: avro-source1 started</div><div class="line">2016-08-24 10:15:06,036 (lifecycleSupervisor-1-0) [INFO - org.apache.flume.source.AvroSource.start(AvroSource.java:253)] Avro source avro-source1 started.</div></pre></td></tr></table></figure>
<h4 id="查看Flume监听的41414端口，等待AvroClient的输入信息"><a href="#查看Flume监听的41414端口，等待AvroClient的输入信息" class="headerlink" title="查看Flume监听的41414端口，等待AvroClient的输入信息"></a>查看Flume监听的41414端口，等待AvroClient的输入信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 查看flume的PID</div><div class="line">$ ps -ef | grep flume</div><div class="line">  501  6931  6602   0 10:27AM ttys000    0:00.00 grep flume</div><div class="line">  501  6734  4754   0 10:15AM ttys001    0:03.61 /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp /Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/* -Djava.library.path= org.apache.flume.node.Application -f conf/flume.conf -n agent1</div><div class="line"></div><div class="line"># 查看一下在监听41414端口的PID</div><div class="line">$ lsof -i:41414</div><div class="line">COMMAND  PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</div><div class="line">java    6734 yunyu  156u  IPv6 0xd0e0ada8c2f7ce75      0t0  TCP localhost:41414 (LISTEN)</div></pre></td></tr></table></figure>
<h4 id="启动Flume-AvroClient端，发送数据到Agent测试"><a href="#启动Flume-AvroClient端，发送数据到Agent测试" class="headerlink" title="启动Flume AvroClient端，发送数据到Agent测试"></a>启动Flume AvroClient端，发送数据到Agent测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 这里我使用的是本机IP：10.10.1.23，如果是本机测试也可以使用localhost</div><div class="line"># 这里的启动命令是./bin/flume-ng avro-client</div><div class="line"># -H：AvroClient指定Flume-ng Agent的IP或者hostname</div><div class="line"># -p：AvroClient指定Avro source正在监听的端口</div><div class="line"># -f：发送指定文件的每行数据给Flume Agent</div><div class="line">$ ./bin/flume-ng avro-client --conf conf -H 10.10.1.23 -p 41414 -F /etc/passwd -Dflume.root.logger=DEBUG,console</div><div class="line"></div><div class="line">+ exec /Library/Java/JavaVirtualMachines/jdk1.7.0_79.jdk/Contents/Home/bin/java -Xmx20m -Dflume.root.logger=DEBUG,console -cp &apos;/Users/yunyu/dev/flume-1.6.0/conf:/Users/yunyu/dev/flume-1.6.0/lib/*&apos; -Djava.library.path= org.apache.flume.client.avro.AvroCLIClient -H 10.10.1.23 -p 41414 -F /etc/passwd</div><div class="line">2016-08-24 10:21:30,468 (main) [DEBUG - org.apache.flume.api.NettyAvroRpcClient.configure(NettyAvroRpcClient.java:499)] Batch size string = 5</div><div class="line">2016-08-24 10:21:30,477 (main) [WARN - org.apache.flume.api.NettyAvroRpcClient.configure(NettyAvroRpcClient.java:634)] Using default maxIOWorkers</div><div class="line">2016-08-24 10:21:30,887 (main) [DEBUG - org.apache.flume.client.avro.AvroCLIClient.run(AvroCLIClient.java:234)] Finished</div><div class="line">2016-08-24 10:21:30,887 (main) [DEBUG - org.apache.flume.client.avro.AvroCLIClient.run(AvroCLIClient.java:237)] Closing reader</div><div class="line">2016-08-24 10:21:30,890 (main) [DEBUG - org.apache.flume.client.avro.AvroCLIClient.run(AvroCLIClient.java:241)] Closing RPC client</div><div class="line">2016-08-24 10:21:30,896 (main) [DEBUG - org.apache.flume.client.avro.AvroCLIClient.main(AvroCLIClient.java:84)] Exiting</div></pre></td></tr></table></figure>
<h4 id="Flume-Agent端控制台"><a href="#Flume-Agent端控制台" class="headerlink" title="Flume Agent端控制台"></a>Flume Agent端控制台</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># Flume Agent端控制台会有类似如下的输出信息</div><div class="line"></div><div class="line">2016-08-24 10:23:26,821 (New I/O server boss #1 ([id: 0x0b65e837, /10.10.1.23:41414])) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 =&gt; /10.10.1.23:41414] OPEN</div><div class="line">2016-08-24 10:23:26,821 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 =&gt; /10.10.1.23:41414] BOUND: /10.10.1.23:41414</div><div class="line">2016-08-24 10:23:26,821 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 =&gt; /10.10.1.23:41414] CONNECTED: /10.10.1.23:63992</div><div class="line">2016-08-24 10:23:27,054 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,073 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,075 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,076 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,077 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,078 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,079 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,081 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,082 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,083 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,084 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,085 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,086 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,087 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,088 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,090 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,092 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,094 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,095 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 5 events.</div><div class="line">2016-08-24 10:23:27,096 (New I/O  worker #2) [DEBUG - org.apache.flume.source.AvroSource.appendBatch(AvroSource.java:371)] Avro source avro-source1: Received avro event batch of 1 events.</div><div class="line">2016-08-24 10:23:27,100 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 :&gt; /10.10.1.23:41414] DISCONNECTED</div><div class="line">2016-08-24 10:23:27,100 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 :&gt; /10.10.1.23:41414] UNBOUND</div><div class="line">2016-08-24 10:23:27,100 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.handleUpstream(NettyServer.java:171)] [id: 0x78d53a57, /10.10.1.23:63992 :&gt; /10.10.1.23:41414] CLOSED</div><div class="line">2016-08-24 10:23:27,100 (New I/O  worker #2) [INFO - org.apache.avro.ipc.NettyServer$NettyServerAvroHandler.channelClosed(NettyServer.java:209)] Connection to /10.10.1.23:63992 disconnected.</div><div class="line">2016-08-24 10:23:28,981 (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)] Event: &#123; headers:&#123;&#125; body: 23 23                                           ## &#125;</div><div class="line">2016-08-24 10:23:28,981 (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)] Event: &#123; headers:&#123;&#125; body: 23 20 55 73 65 72 20 44 61 74 61 62 61 73 65    # User Database &#125;</div><div class="line">2016-08-24 10:23:28,982 (SinkRunner-PollingRunner-DefaultSinkProcessor) [INFO - org.apache.flume.sink.LoggerSink.process(LoggerSink.java:94)] Event: &#123; headers:&#123;&#125; body: 23 20                                           #  &#125;</div></pre></td></tr></table></figure>
<h4 id="官网给出的flume-ng启动参数"><a href="#官网给出的flume-ng启动参数" class="headerlink" title="官网给出的flume-ng启动参数"></a>官网给出的flume-ng启动参数</h4><h5 id="flume-ng-global-options"><a href="#flume-ng-global-options" class="headerlink" title="flume-ng global options"></a>flume-ng global options</h5><table>
<thead>
<tr>
<th>Option</th>
<th>Description        </th>
</tr>
</thead>
<tbody>
<tr>
<td>–classpath,-C <cp></cp></td>
<td>Append to the classpath</td>
</tr>
<tr>
<td>–conf,-c <conf></conf></td>
<td>Use configs in <conf> directory</conf></td>
</tr>
<tr>
<td>–dryrun,-d</td>
<td>Do not actually start Flume, just print the command</td>
</tr>
<tr>
<td>-Dproperty=value</td>
<td>Sets a JDK system property value</td>
</tr>
</tbody>
</table>
<h5 id="flume-ng-agent-options"><a href="#flume-ng-agent-options" class="headerlink" title="flume-ng agent options"></a>flume-ng agent options</h5><table>
<thead>
<tr>
<th>Option</th>
<th>Description        </th>
</tr>
</thead>
<tbody>
<tr>
<td>–conf-file,-f <file></file></td>
<td>Indicates which configuration file you want to run with (required)</td>
</tr>
<tr>
<td>–name,-n <agentname></agentname></td>
<td>Indicates the name of agent on which we’re running (required)</td>
</tr>
</tbody>
</table>
<h5 id="flume-ng-avro-client-options"><a href="#flume-ng-avro-client-options" class="headerlink" title="flume-ng avro-client options"></a>flume-ng avro-client options</h5><table>
<thead>
<tr>
<th>Option</th>
<th>Description        </th>
</tr>
</thead>
<tbody>
<tr>
<td>–host,-H <hostname></hostname></td>
<td>Specifies the hostname of the Flume agent (may be localhost)</td>
</tr>
<tr>
<td>–port,-p <port></port></td>
<td>Specifies the port on which the Avro source is listening</td>
</tr>
<tr>
<td>–filename,-F <filename></filename></td>
<td>Sends each line of <filename> to Flume (optional)</filename></td>
</tr>
<tr>
<td>–headerFile,-F <file></file></td>
<td>Header file containing headers as key/value pairs on each new line</td>
</tr>
</tbody>
</table>
<p>OK，大功告成 ^_^</p>
<p>参考文章：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/FLUME/Getting+Started" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/FLUME/Getting+Started</a></li>
<li><a href="http://shiyanjun.cn/archives/915.html" target="_blank" rel="external">http://shiyanjun.cn/archives/915.html</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flume/">Flume</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Log/">Log</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Shell/Shell脚本学习（六）if语句的格式问题" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/21/Shell/Shell脚本学习（六）if语句的格式问题/" class="article-date">
  	<time datetime="2016-08-21T06:44:03.000Z" itemprop="datePublished">2016-08-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/21/Shell/Shell脚本学习（六）if语句的格式问题/">Shell脚本学习（六）if语句的格式问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天在写Shell启动脚本的时候遇到了个比较奇葩的问题，因为对Shell了解的不够，不是很清楚if语句的格式，if语句不按照指定的格式写可能不会得到你想要的结果。先简单描述下我的问题吧</p>
<p>一个简单的判断字符串的脚本，根据base_version变量的值来输出内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">base_version=&apos;2.x&apos;</div><div class="line"></div><div class="line">if [ $base_version=&apos;1.x&apos; ]; then</div><div class="line">  echo &quot;当前安装的是1.x版本&quot;</div><div class="line">fi</div><div class="line">if [ $base_version=&apos;2.x&apos; ]; then</div><div class="line">  echo &quot;当前安装的是2.x版本&quot;</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>看完上面的脚本之后，我想大家的第一答案应该都是”当前安装的是2.x版本”，但是运行结果却是”当前安装的是1.x版本”和”当前安装的是2.x版本”都输出了。</p>
<p>规范有点严格</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if空格[空格&quot;xx&quot;空格=空格&quot;xx&quot;空格];空格then</div><div class="line">	echo &quot;if&quot;</div><div class="line">elif空格[空格&quot;xx&quot;空格=空格&quot;xx&quot;空格];空格then</div><div class="line">	echo &quot;elseif&quot;</div><div class="line">else</div><div class="line">	echo &quot;else&quot;</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>我的脚本在$base_version=’1.x’等号左右没有加空格，修改之后如下之后，运行结果是”当前安装的是2.x版本”正确的了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">base_version=&apos;2.x&apos;</div><div class="line"></div><div class="line">if [ $base_version = &apos;1.x&apos; ]; then</div><div class="line">  echo &quot;当前安装的是1.x版本&quot;</div><div class="line">fi</div><div class="line">if [ $base_version = &apos;2.x&apos; ]; then</div><div class="line">  echo &quot;当前安装的是2.x版本&quot;</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>接下来介绍一些if语句常用的判断语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 文件表达式</div><div class="line">-e filename：如果filename存在（不论filename是文件名还是目录名），则为真</div><div class="line">-d filename：如果filename存在（filename必须是目录名），则为真</div><div class="line">-f filename：如果filename存在（filename必须是文件名），则为真</div><div class="line">-s filename：如果filename内容不为空（filename必须是文件名），则为真</div><div class="line"></div><div class="line"># 字符串变量表达式</div><div class="line">if [ -z $var ]：如果var的值为空，则为真</div><div class="line">if [ -n $var ]：如果var的值为非空，则为真</div><div class="line">if [ $var ]：如果var的值为非空，则为真</div></pre></td></tr></table></figure>
<p>下面是一些常用的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">filePath=/Users/yunyu/Downloads/test</div><div class="line">if [ -e $filePath ]; then</div><div class="line">	echo &quot;文件/目录存在&quot;</div><div class="line">else </div><div class="line">	echo &quot;文件/目录不存在&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">if [ -d $filePath ]; then</div><div class="line">	echo &quot;目录存在&quot;</div><div class="line">else </div><div class="line">	echo &quot;目录不存在&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">if [ -f $filePath ]; then</div><div class="line">	echo &quot;文件存在&quot;</div><div class="line">else </div><div class="line">	echo &quot;文件不存在&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">if [ -s $filePath ]; then</div><div class="line">	echo &quot;文件内容不为空&quot;</div><div class="line">else </div><div class="line">	echo &quot;文件内容为空&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">#var=&quot;test&quot;;</div><div class="line">var=&quot;&quot;;</div><div class="line"># -z 判断一个变量的值是否为空</div><div class="line">if [ -z &quot;$var&quot; ]; then</div><div class="line">	echo &quot;var is empty&quot;</div><div class="line">else</div><div class="line">	echo &quot;var is $var&quot;</div><div class="line">fi</div><div class="line"></div><div class="line"># -n 判断一个变量是否为非空</div><div class="line">if [ -n &quot;$var&quot; ]; then</div><div class="line">	echo &quot;var is not empty, value is $var&quot;</div><div class="line">else</div><div class="line">	echo &quot;var is empty&quot;</div><div class="line">fi</div><div class="line"></div><div class="line"># ! -n 和 -z 用法一样</div><div class="line">if [ ! -n &quot;$var&quot; ]; then</div><div class="line">	echo &quot;var is empty&quot;</div><div class="line">else</div><div class="line">	echo &quot;var is $var&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">if [ &quot;$var&quot; ]; then</div><div class="line">	echo &quot;if var is $var&quot;</div><div class="line">else</div><div class="line">	echo &quot;if var is blank&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">var1=&quot;1&quot;;</div><div class="line">var2=&quot;2&quot;;</div><div class="line"># 判断两个变量是否相等</div><div class="line">if [ &quot;$var1&quot; = &quot;$var2&quot; ]; then</div><div class="line">	echo &quot;$var1 equals $var2&quot;</div><div class="line">else</div><div class="line">	echo &quot;$var1 not equals $var2&quot;</div><div class="line">fi</div><div class="line"></div><div class="line"># 判断两个变量是否不相等</div><div class="line">if [ &quot;$var1&quot; != &quot;$var2&quot; ]; then</div><div class="line">	echo &quot;$var1 not equals $var2&quot;</div><div class="line">else</div><div class="line">	echo &quot;$var1 equals $var2&quot;</div><div class="line">fi</div><div class="line"></div><div class="line">num1=1;</div><div class="line">num2=2;</div><div class="line"># 算术比较运算符</div><div class="line">if [ &quot;$num1&quot; -eq &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 equals $num2&quot;</div><div class="line">elif [ &quot;$num1&quot; -lt &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 less than $num2&quot;</div><div class="line">elif [ &quot;$num1&quot; -le &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 less than equals $num2&quot;</div><div class="line">elif [ &quot;$num1&quot; -gt &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 great than $num2&quot;</div><div class="line">elif [ &quot;$num1&quot; -ge &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 great than equals $num2&quot;</div><div class="line">elif [ &quot;$num1&quot; -ne &quot;$num2&quot; ]; then</div><div class="line">	echo &quot;$num1 not equals $num2&quot;</div><div class="line">fi</div><div class="line"></div><div class="line"># 判断变量是否模糊匹配</div><div class="line">base_version=&apos;2.2.0&apos;</div><div class="line">if [[ $base_version =~ 1.* ]]; then</div><div class="line">	base_version=&apos;1.x&apos;</div><div class="line">fi</div><div class="line">if [[ $base_version =~ 2.* ]]; then</div><div class="line">	base_version=&apos;2.x&apos;</div><div class="line">fi</div><div class="line">echo $base_version</div></pre></td></tr></table></figure>
<p>参考文章：</p>
<ul>
<li><a href="http://blog.csdn.net/caoyongjunjava/article/details/44560849" target="_blank" rel="external">http://blog.csdn.net/caoyongjunjava/article/details/44560849</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Shell/">Shell</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Git/Git常用命令" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/20/Git/Git常用命令/" class="article-date">
  	<time datetime="2016-08-20T15:25:38.000Z" itemprop="datePublished">2016-08-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/20/Git/Git常用命令/">Git常用命令</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Git区域划分"><a href="#Git区域划分" class="headerlink" title="Git区域划分"></a>Git区域划分</h3><p>在介绍git命令之前，我们先简单了解下git的区域划分，这样有帮助于理解git的命令，可以将git简单的分为三个区域</p>
<ol>
<li>工作区（working directry） </li>
<li>暂缓区（stage index） </li>
<li>历史记录区（history）   </li>
</ol>
<p><img src="http://img.blog.csdn.net/20160820133106483?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Git区域的理解"></p>
<p><img src="http://img.blog.csdn.net/20160820133129026?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="Git区域的理解1"></p>
<h3 id="Git-基础命令"><a href="#Git-基础命令" class="headerlink" title="Git 基础命令"></a>Git 基础命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 本地初始化一个空的本地Git repository in /.git目录</div><div class="line">$ git init</div><div class="line"></div><div class="line"># 查看当前文件的状态</div><div class="line">$ git status</div><div class="line"></div><div class="line"># 添加文件README.md到index暂缓区（就是告诉git要开始记录跟踪README.md文件的修改记录）</div><div class="line">$ git add README.md</div><div class="line">$ git add &apos;*.md&apos;</div><div class="line"></div><div class="line"># index暂缓区的文件还没存储到本地的Git repository，需要commit提交index暂缓区的文件到本地的Git repository</div><div class="line">$ git commit -m &quot;init&quot;</div><div class="line"></div><div class="line"># 在github服务器上创建一个新的远程Git repository，通过git remote add命令给本地的Git repository添加远程Git repository的提交地址，然后git push把本地已经commit的代码推送到远程的Git repository</div><div class="line">$ git remote add origin https://github.com/birdben/birdGit.git</div><div class="line"># -u参数是告诉git记住参数，下次就可以使用git push命令来提交到远程Git repository</div><div class="line">$ git push -u origin master</div><div class="line"></div><div class="line"># 从远端的Git repository pull最新的代码到本地的Git repository</div><div class="line">$ git pull origin master</div></pre></td></tr></table></figure>
<h3 id="Git-比较相关命令"><a href="#Git-比较相关命令" class="headerlink" title="Git 比较相关命令"></a>Git 比较相关命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># 查看当前没有add的内容的修改</div><div class="line"># 此命令比较的是工作目录(Working tree)和暂存区域快照(index)之间的差异</div><div class="line">$ git diff</div><div class="line"></div><div class="line"># 只查看哪些文件做了修改的简单结果，不查看具体的修改内容可以使用--stat参数</div><div class="line">$ git diff --stat</div><div class="line"></div><div class="line"># 查看已经add但没有commit的修改</div><div class="line"># 查看已经暂存起来的文件(index)和上次提交时的快照之间(HEAD)的差异</div><div class="line">$ git diff --cached</div><div class="line">$ git diff --staged</div><div class="line"></div><div class="line"># 上面两条的合并</div><div class="line"># 显示工作版本(Working tree)和HEAD的差别</div><div class="line">$ git diff HEAD</div><div class="line"></div><div class="line"># 查看当前目录和另外一个分支的差别</div><div class="line">$ git diff new_branch</div><div class="line"></div><div class="line"># 指定两个版本比较src文件夹的修改</div><div class="line">$ git diff SHA1 SHA2</div></pre></td></tr></table></figure>
<h3 id="Git-查看历史相关命令"><a href="#Git-查看历史相关命令" class="headerlink" title="Git 查看历史相关命令"></a>Git 查看历史相关命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 查看已经commit的历史记录</div><div class="line">$ git log</div><div class="line"></div><div class="line">commit a3f3ce4ff543e34fc36fb46d7f71ec444c18b9a3</div><div class="line">Author: liuben &lt;191654006@163.com&gt;</div><div class="line">Date:   Thu Aug 18 16:11:05 2016 +0800</div><div class="line"></div><div class="line">添加推荐网址</div><div class="line"></div><div class="line">commit 128da6083a1d10d540dced91732ea04165810bba</div><div class="line">Author: liuben &lt;191654006@163.com&gt;</div><div class="line">Date:   Thu Aug 18 15:17:57 2016 +0800</div><div class="line"></div><div class="line">init</div><div class="line"></div><div class="line"># 只查看最后一次的commit修改的注释</div><div class="line">$ git log -n 1</div><div class="line"></div><div class="line"># 只查看最后一次的commit修改的文件列表</div><div class="line">$ git log -n 1 --stat</div><div class="line"></div><div class="line"># 只查看最后一次的commit修改的文件细节</div><div class="line">$ git log -n 1 -p</div></pre></td></tr></table></figure>
<h3 id="Git-回滚相关"><a href="#Git-回滚相关" class="headerlink" title="Git 回滚相关"></a>Git 回滚相关</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">###### git checkout(working tree内的回滚) ######</div><div class="line"># git checkout : 把index区域中的文件覆盖working tree中的文件</div><div class="line"></div><div class="line"># 回滚单个文件</div><div class="line">$ git checkout file1</div><div class="line"></div><div class="line"># 回滚多个文件，中间用空格隔开即可</div><div class="line">$ git checkout file1 file2 ... fileN</div><div class="line"></div><div class="line"># 回滚当前目录一下的所有working tree内的修改，会递归扫描当前目录下的所有子目录</div><div class="line">$ git checkout .</div><div class="line"></div><div class="line"></div><div class="line"># git checkout HEAD : 会用HEAD指向的master分支中的全部或者部分文件替换index暂存区和以及working tree工作区中的文件。这个命令也是极具危险性的，因为不但会清除working tree工作区中未提交的改动，也会清除index暂存区中未提交的改动 </div><div class="line"></div><div class="line"># 回滚单个文件</div><div class="line">$ git checkout HEAD file1</div><div class="line"></div><div class="line"># 回滚多个文件，中间用空格隔开即可</div><div class="line">$ git checkout HEAD file1 file2 ... fileN</div><div class="line"></div><div class="line"># 回滚当前目录一下的所有working tree内的修改，会递归扫描当前目录下的所有子目录</div><div class="line">$ git checkout HEAD .</div><div class="line"></div><div class="line"></div><div class="line">###### git reset(index内的回滚) ######</div><div class="line"># git reset语法（&lt;commit&gt;必须是没有push到remote端的）</div><div class="line">git reset [-q] [&lt;commit&gt;] [--] &lt;paths&gt;…</div><div class="line">git reset (--patch | -p) [&lt;commit&gt;] [--] [&lt;paths&gt;…]</div><div class="line">git reset (--soft | --mixed | --hard | --merge | --keep) [-q] [&lt;commit&gt;或HEAD]</div><div class="line"></div><div class="line"># 将index区域中修改过的文件移除index，也就是恢复到working tree中</div><div class="line"># 文件被恢复到working tree中，回滚操作就是上面提到的git checkout</div><div class="line"># 回滚单个文件，相当于git add file1的反命令</div><div class="line">$ git reset file1</div><div class="line"></div><div class="line"># 回滚某一个目录，相当于git add .的反命令</div><div class="line">$ git reset .</div><div class="line"></div><div class="line"></div><div class="line">###### git reset(commit之后的回滚（HEAD内的回滚）) ######</div><div class="line"># 修改前一次的提交，并且保持前一次的Change-Id不变（推荐使用）</div><div class="line"># 直接本地修改好上一次commit的文件，再次add，使用commit --amend提交，修改注释即可修改上一次的提交</div><div class="line">$ git commit --amend</div><div class="line"></div><div class="line"># 回滚到某个版本，只回滚了HEAD的信息，不会恢复到index一级。如果还要提交未commit的文件，直接commit即可</div><div class="line"># 参数是git log中每次commit的ID</div><div class="line">$ git reset --soft cb0c40643afa791ea2c7905318cf17b4eac4bce5</div><div class="line"></div><div class="line"># 此为默认方式，不带任何参数的git reset，即时这种方式，它回滚到某个版本，只保留working tree中文件的源码，回滚了HEAD和index的信息</div><div class="line"># 参数是git log中每次commit的ID</div><div class="line">$ git reset --mixed cb0c40643afa791ea2c7905318cf17b4eac4bce5</div><div class="line"></div><div class="line"># 彻底回滚到某个版本，本地working tree的源码也会变为上一个版本的内容</div><div class="line"># 参数是git log中每次commit的ID</div><div class="line">$ git reset --hard cb0c40643afa791ea2c7905318cf17b4eac4bce5</div><div class="line"></div><div class="line"></div><div class="line">###### merge回滚的文件和本地working tree文件 ######</div><div class="line">$ git reset --merge cb0c40643afa791ea2c7905318cf17b4eac4bce5</div><div class="line"></div><div class="line"></div><div class="line"># 下面是git help给出的提示，很清晰的写明会回滚的区域</div><div class="line">--mixed               reset HEAD and index</div><div class="line">--soft                reset only HEAD</div><div class="line">--hard                reset HEAD, index and working tree</div><div class="line">--merge               reset HEAD, index and working tree</div><div class="line"></div><div class="line"></div><div class="line">###### git revert ######</div><div class="line"># 回滚到某一次的commit，但是如果本地working tree有修改需要先merge，然后重新add到index区，再执行git revert --continue回滚到指定版本，同时编辑本地回滚的commit的注释，然后在查看git log就会发现多了一次commit信息，add的文件出现了之前版本的内容修改，需要重新merge在提交</div><div class="line"></div><div class="line"># 回滚到某一次的commit</div><div class="line">$ git revert cb0c40643afa791ea2c7905318cf17b4eac4bce5</div><div class="line"></div><div class="line"># merge完本地working tree中的文件内容重新add并且revert continue</div><div class="line">$ git add file1</div><div class="line">$ git revert --continue</div><div class="line"></div><div class="line"># 查看提交历史记录会发现多了一条revert的记录</div><div class="line">$ git log</div><div class="line"></div><div class="line"></div><div class="line">###### reset和revert的区别 ######</div><div class="line">git reset : git reset是指向原地或者向前移动指针，之前的commit信息会被删除</div><div class="line">git revert : git revert是创建一个commit来覆盖当前的commit，指针向后移动，之前的commit信息会被保留</div></pre></td></tr></table></figure>
<h3 id="Git-branch-分支"><a href="#Git-branch-分支" class="headerlink" title="Git branch 分支"></a>Git branch 分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"># 查看当前有哪些分支</div><div class="line">$ git branch</div><div class="line"></div><div class="line">* master</div><div class="line"></div><div class="line"># 新建一个分支new_branch</div><div class="line">$ git branch new_branch</div><div class="line"></div><div class="line"># 切换到new_branch分支</div><div class="line">$ git checkout new_branch</div><div class="line"></div><div class="line"># 新建并且切换到该分支, 例: new_branch</div><div class="line">$ git checkout -b new_branch</div><div class="line"></div><div class="line"># 再次查看</div><div class="line">$ git branch</div><div class="line"></div><div class="line">* master </div><div class="line">  new_branch</div><div class="line"></div><div class="line"># 添加一个文件testBranch到你的repo</div><div class="line">$ git add testBranch</div><div class="line"></div><div class="line"># commit一个文件</div><div class="line">$ git commit -m &quot;testBranch&quot;</div><div class="line"></div><div class="line"># 将本地分支提交到远程，如果remote_branch不存在则会自动创建分支</div><div class="line">$ git push origin local_branch:remote_branch</div><div class="line">$ git push origin new_branch:new_branch</div><div class="line"></div><div class="line"># 查看远程分支</div><div class="line">$ git branch -r</div><div class="line"></div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/new_branch</div><div class="line"></div><div class="line"># 查看本地和远程所有的分支</div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">  master</div><div class="line">* new_branch</div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/new_branch</div><div class="line"></div><div class="line"># 修改branch的名字</div><div class="line">$ git branch -m new_branch rename_branch</div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">  master</div><div class="line">* rename_branch</div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/new_branch</div><div class="line">  </div><div class="line"># 删除本地分支（删除new_branch之前必须要切换到别的分支上）</div><div class="line">$ git branch -d new_branch</div><div class="line"># 如果new_branch没有合并到当前master分支的内容，需要使用-D参数强制删除</div><div class="line">$ git branch -D new_branch</div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">* master</div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/new_branch</div><div class="line"></div><div class="line"># 删除远程分支new_branch</div><div class="line">$ git push origin --delete new_branch</div><div class="line">$ git push origin  :new_branch</div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">* master</div><div class="line">  remotes/origin/master</div></pre></td></tr></table></figure>
<h3 id="Git-合并分支"><a href="#Git-合并分支" class="headerlink" title="Git 合并分支"></a>Git 合并分支</h3><p>首先切换到想要合并到的分支下，运行’git merge’命令 （例如本例中将test2分支合并到test3分支的话，进入test3分支运行git merge test2命令）如果合并顺利的话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"># 创建test2分支</div><div class="line">$ git branch test2</div><div class="line"># 在test2分支中创建test文件，并且提交到test2分支</div><div class="line">$ git add test</div><div class="line">$ git commit -m &quot;提交test2&quot;</div><div class="line"></div><div class="line"># 创建test3分支</div><div class="line">$ git branch test3</div><div class="line"># 在test3分支中创建test文件，并且提交到test3分支</div><div class="line">$ git add test</div><div class="line">$ git commit -m &quot;提交test3&quot;</div><div class="line"></div><div class="line"># 确保当前分支为test3</div><div class="line">$ git status</div><div class="line"></div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">  master</div><div class="line">  test2</div><div class="line">* test3</div><div class="line">  remotes/origin/master</div><div class="line"></div><div class="line"># merge分支，如果没有文件冲突就会自动合并成功，如果存在合并冲突需要手动merge处理</div><div class="line">$ git merge test2</div><div class="line"></div><div class="line">Already up-to-date. </div><div class="line"></div><div class="line"># 合并冲突处理：</div><div class="line">Automatic merge failed; fix conflicts and then commit the result.</div><div class="line"></div><div class="line"># 修改冲突的文件后，然后git add和git commit，这样就将本地的test2分支merge到test3分支了</div><div class="line">$ git add test</div><div class="line">$ git commit</div><div class="line"></div><div class="line"># 然后将本地test3分支push到远程</div><div class="line">$ git push origin test3:test3</div><div class="line">$ git branch -a</div><div class="line"></div><div class="line">  master</div><div class="line">  test2</div><div class="line">* test3</div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/test3</div><div class="line">  </div><div class="line"># 本地的test2分支如果没有用就可以删除了</div><div class="line">$ git branch -d test2</div><div class="line"></div><div class="line">  master</div><div class="line">* test3</div><div class="line">  remotes/origin/master</div><div class="line">  remotes/origin/test3</div></pre></td></tr></table></figure>
<p>适合git初学者使用：</p>
<ul>
<li><a href="https://try.github.io/levels/1/challenges/1" target="_blank" rel="external">https://try.github.io/levels/1/challenges/1</a></li>
<li><a href="http://rogerdudler.github.io/git-guide/index.zh.html" target="_blank" rel="external">http://rogerdudler.github.io/git-guide/index.zh.html</a></li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="http://jonyfang.com/blog/2015/11/12/git_command_and_git_branching_model/" target="_blank" rel="external">http://jonyfang.com/blog/2015/11/12/git_command_and_git_branching_model/</a></li>
<li><a href="http://www.jianshu.com/p/08ad7e427fec" target="_blank" rel="external">http://www.jianshu.com/p/08ad7e427fec</a></li>
<li><a href="http://blog.csdn.net/wirelessqa/article/category/1522507" target="_blank" rel="external">http://blog.csdn.net/wirelessqa/article/category/1522507</a></li>
<li><a href="http://selfcontroller.iteye.com/blog/1786644" target="_blank" rel="external">http://selfcontroller.iteye.com/blog/1786644</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Git命令/">Git命令</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Git/">Git</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Shell/Shell脚本学习（五）:dev:null的用法" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/17/Shell/Shell脚本学习（五）:dev:null的用法/" class="article-date">
  	<time datetime="2016-08-17T14:47:11.000Z" itemprop="datePublished">2016-08-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/17/Shell/Shell脚本学习（五）:dev:null的用法/">Shell脚本学习（五）/dev/null的用法</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在类似启动Tomcat的Shell脚本中我们经常会看到如：./startup.sh &gt; /dev/null，正常这种用法都是执行./startup.sh启动脚本后，将log输出到控制台的。但是用./start.sh &gt; /dev/null这种方式就类似daemon后台启动Tomcat的效果一样，但是启动的日志不会输出到log文件，也不会输出到控制台，而是输出到/dev/null。可以把/dev/null看作一个”黑洞”，它非常等价于一个只写文件，所有写入它的内容都会永远丢失，而尝试从它那儿读取内容则什么也读不到。所以我们是在任何地方都看不到这个Tomcat的启动log的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">1. 禁止标准输出</div><div class="line"># 将catalina.out日志文件的内容输出到控制台</div><div class="line">cat catalina.out</div><div class="line"># 将catalina.out日志文件的内容输出到test.log文件中</div><div class="line">cat catalina.out &gt; test.log</div><div class="line"># 将catalina.out日志文件的内容输出到/dev/null（黑洞）</div><div class="line">cat catalina.out &gt; /dev/null</div><div class="line"></div><div class="line">2. 禁止输出ls文件列表</div><div class="line"># 输出当前文件夹下的所有文件列表到ls.out文件中</div><div class="line">ls &gt; ls.out</div><div class="line"># 将文件列表实际是输出到/dev/null（黑洞）</div><div class="line">ls &gt; /dev/null</div></pre></td></tr></table></figure>
<p>这里在说明一下 &lt; , &gt; , &gt;&gt; , 2&gt; 的区别</p>
<ul>
<li>由 &lt; 的右边读入参数档案</li>
<li>将原本由屏幕输出的正确数据输出到 &gt; 右边的 file ( 文件名称 ) 或 device ( 装置，如 printer )去</li>
<li>将原本由屏幕输出的正确数据输出到 &gt;&gt; 右边，与 &gt; 不同的是，该档案将不会被覆盖，而新的数据将以『增加的方式』增加到该档案的最后面</li>
<li>将原本应该由屏幕输出的错误数据输出到 2&gt; 的右边去</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 正确的ls命令</div><div class="line">$ ls -al</div><div class="line"># 将显示的数据，不论正确或错误均输出到success.log（注意：2&gt;&amp;1中间不能有空格）</div><div class="line">$ ls -al 1&gt; success.log 2&gt;&amp;1</div><div class="line"># 将显示的数据，正确的输出到success.log，错误的输出则予以丢弃，这里故意将ls命令的参数丢掉，让命令出错！</div><div class="line">$ ls - 1&gt; success.log 2&gt; /dev/null</div><div class="line"># 将显示的数据，正确的输出到success.log，错误的输出到error.log，这里故意将ls命令的参数丢掉，让命令出错！</div><div class="line">$ ls - 1&gt; success.log 2&gt; error.log</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/">Shell</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Shell/">Shell</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 birdben
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82900755-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>